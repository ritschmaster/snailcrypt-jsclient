/*
 * ! OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/layout/Grid","./BasePanel","sap/ui/core/ListItem","sap/m/CustomListItem","sap/m/ComboBox","sap/m/List","sap/m/HBox","sap/m/library","sap/m/Button","sap/base/util/merge",'sap/ui/core/library'],function(G,B,I,C,a,L,H,l,b,m,c){"use strict";var V=c.ValueState;var Q=B.extend("sap.m.p13n.QueryPanel",{metadata:{library:"sap.m",properties:{queryLimit:{type:"int",defaultValue:-1}}},renderer:{apiVersion:2}});var d=l.ListType;var F=l.FlexJustifyContent;var e=l.ButtonType;Q.prototype.init=function(){B.prototype.init.apply(this,arguments);this._bFocusOnRearrange=false;this.setEnableReorder(true);this.addStyleClass("sapMP13nQueryPanel");};Q.prototype.setP13nData=function(p){B.prototype.setP13nData.apply(this,arguments);this._oListControl.removeAllItems();if(p instanceof Array){p.forEach(function(i){if(i[this.PRESENCE_ATTRIBUTE]){this._addQueryRow(i);}}.bind(this));this._addQueryRow();}return this;};Q.prototype.getP13nData=function(O){var i=[];this._oListControl.getItems().forEach(function(f){var k=f.getContent()[0].getContent()[0]._key;if(k){var g=this._getP13nModel().getProperty("/items").find(function(o){return o.name==k;});i.push(g);}}.bind(this));if(!O){this._getP13nModel().getProperty("/items").forEach(function(o){if(i.indexOf(o)===-1){i.push(o);}});}return m([],i);};Q.prototype._allEntriesUsed=function(){return this.getP13nData().length===this.getP13nData(true).length;};Q.prototype._moveTableItem=function(i,n){var f=this._oListControl.getItems().indexOf(i);var M=this._oListControl.getItems().length-1;var q=this.getQueryLimit();if((f!==M||this._allEntriesUsed())&&(q===-1||n<q)){this._oListControl.removeItem(i);this._oListControl.insertItem(i,n);this._updateEnableOfMoveButtons(i,false);this._getP13nModel().checkUpdate(true);this.fireChange({reason:this.CHANGE_REASON_MOVE,item:this._getModelEntry(i)});}};Q.prototype._updateEnableOfMoveButtons=function(t,f){B.prototype._updateEnableOfMoveButtons.apply(this,arguments);if(this._oListControl.getItems().indexOf(t)===(this._oListControl.getItems().length-2)&&!this._allEntriesUsed()){this._getMoveDownButton().setEnabled(false);}};Q.prototype._createInnerListControl=function(){return new L(this.getId()+"-innerP13nList",{itemPress:[this._onItemPressed,this],dragDropConfig:this._getDragDropConfig()});};Q.prototype._getModelEntry=function(r){var k=r.getContent()[0].getContent()[0]._key;var f=this._getP13nModel().getProperty("/items").find(function(o){return o.name==k;});return f;};Q.prototype._getAvailableItems=function(k){var i=this._getP13nModel().getProperty("/items");var A=[];i.forEach(function(n,f){A.push(new I({key:n.name,text:n.label,enabled:{path:this.P13N_MODEL+">/items/"+f+"/"+this.PRESENCE_ATTRIBUTE,formatter:function(q){var o=this.getParent();var s=o.getSelectedItem();var g=s&&o.getItems().indexOf(s);var p=this.getBindingPath("enabled");var h=parseInt(p.split("/")[2]);return!q||g===h;}}}));}.bind(this));return A;};Q.prototype._addQueryRow=function(i){var f=this.getQueryLimit()>-1;var q=this.getQueryLimit()<=this._oListControl.getItems().length;if((f&&q&&!i)||this._allEntriesUsed()){return;}i=i?i:{name:null};var o=this._createQueryRowGrid(i);var r=new C({type:d.Active,content:[o]});if(this.getEnableReorder()&&(this.getQueryLimit()===-1||(this.getQueryLimit()>1&&this._oListControl.getItems().length<this.getQueryLimit()))){this._addHover(r);}r.getContent()[0].getContent()[0]._key=i.name;this._oListControl.addItem(r);var s=!!i.name;var R=this._createRemoveButton(s);r.getContent()[0].addContent(R);return r;};Q.prototype._createQueryRowGrid=function(i){var s=this._createKeySelect(i.name);return new G({containerQuery:true,defaultSpan:"XL6 L6 M6 S6",content:[s]}).addStyleClass("sapUiTinyMargin");};Q.prototype._handleActivated=function(h){var q=h.getContent()[0];if(q){var i=q.getContent().length-1;var o=h.getContent()[0].getContent()[i];if(h&&o.getItems().length<2){o.insertItem(this._getMoveUpButton(),0);o.insertItem(this._getMoveDownButton(),1);this._updateEnableOfMoveButtons(h,false);}}};Q.prototype._getPlaceholderText=function(){return"";};Q.prototype._getRemoveButtonTooltipText=function(){return"";};Q.prototype._createKeySelect=function(k){var t=this;var K=new a({width:"14rem",enabled:{path:this.P13N_MODEL+">/items/",formatter:function(i){if(t.getQueryLimit()<0){return true;}var p=t.getP13nData(true).map(function(o){return o.name;});var k=this._key;var P=p.indexOf(k)+1;return P<=t.getQueryLimit();}},items:this._getAvailableItems(k),selectedKey:k,placeholder:this._getPlaceholderText(),selectionChange:function(E){var o=E.getSource();var s=o.getSelectedItem();if(!s){this._selectKey(o);}}.bind(this),change:function(E){var o=E.getSource();var n=E.getParameter("newValue");this._selectKey(o);o.setValueState(n&&!o.getSelectedItem()?V.Error:V.None);}.bind(this)});return K;};Q.prototype._selectKey=function(o){var n=o.getSelectedKey();var O=o._key;var f=o.getParent().getParent();var i=this._oListControl.getItems().length-1==this._oListControl.getItems().indexOf(f);var g=f.getContent()[0].getContent();var h=g[g.length-1];h.setVisible(!(i&&n==""));if(O){this._updatePresence(O,false,undefined);}o._key=n;this._updatePresence(n,true,this._oListControl.getItems().indexOf(f));if(n!==""&&i){this._addQueryRow();}};Q.prototype._createRemoveButton=function(v){var r=new H({justifyContent:F.End,width:"100%",visible:v,items:[new b({type:e.Transparent,icon:"sap-icon://decline",press:function(E){var R=E.getSource().getParent().getParent().getParent();var q=this._oListControl.getItems().length;var n=q===1||q==this.getP13nData(true).length;this._oListControl.removeItem(R);this._updatePresence(R.getContent()[0].getContent()[0]._key,false,undefined);if(n){this._addQueryRow();}else{var i=this._oListControl.getItems().length-1;this._oListControl.getItems()[i].getContent()[0].getContent()[0].focus();}this._getP13nModel().checkUpdate(true);}.bind(this)})]});if(this._getRemoveButtonTooltipText()){r.getItems()[0].setTooltip(this._getRemoveButtonTooltipText());}return r;};Q.prototype._moveSelectedItem=function(){this._oSelectedItem=this._getMoveUpButton().getParent().getParent().getParent();B.prototype._moveSelectedItem.apply(this,arguments);};Q.prototype._updatePresence=function(k,A,n){var i=this._getP13nModel().getProperty("/items");var r=i.filter(function(o){return o.name===k;});if(r[0]){r[0][this.PRESENCE_ATTRIBUTE]=A;}this._getP13nModel().setProperty("/items",i);this.fireChange({reason:A?this.CHANGE_REASON_ADD:this.CHANGE_REASON_REMOVE,item:r[0]});};return Q;});
