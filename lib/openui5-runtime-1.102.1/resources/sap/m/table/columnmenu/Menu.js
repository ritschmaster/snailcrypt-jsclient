/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/m/ResponsivePopover","sap/m/Button","sap/m/Toolbar","sap/m/ToolbarSpacer","sap/m/library",'sap/ui/Device',"sap/ui/core/Control","sap/ui/core/Core","sap/ui/core/library","sap/ui/thirdparty/jquery","sap/ui/dom/containsOrEquals","sap/ui/events/ControlEvents","sap/base/strings/capitalize","sap/m/p13n/AbstractContainerItem","sap/m/p13n/Container","sap/m/table/columnmenu/MenuRenderer","sap/ui/layout/form/Form","sap/ui/layout/GridData","sap/ui/layout/form/ResponsiveGridLayout","sap/ui/layout/form/FormContainer","sap/ui/layout/form/FormElement","sap/m/Label"],function(R,B,T,b,l,D,C,c,d,q,e,f,g,A,h,M,F,G,i,j,k,L){"use strict";var H=d.aria.HasPopup;var m=C.extend("sap.m.table.columnmenu.Menu",{metadata:{library:"sap.m",interfaces:["sap.ui.core.IColumnHeaderMenu"],aggregations:{quickActions:{type:"sap.m.table.columnmenu.QuickActionBase"},items:{type:"sap.m.table.columnmenu.ItemBase"},_quickActions:{type:"sap.m.table.columnmenu.QuickActionBase",visibility:"hidden"},_items:{type:"sap.m.table.columnmenu.ItemBase",visibility:"hidden"}}},renderer:M});var n="$default";var o=H.Dialog;var p="500px";m.prototype.init=function(){this.fAnyEventHandlerProxy=q.proxy(function(E){if(!this._oPopover.isOpen()||!this.getDomRef()||(E.type!="mousedown"&&E.type!="touchstart")){return;}this.handleOuterEvent(this.getId(),E);},this);};m.prototype.applySettings=function(S){if(S){this._addAllToPrivateAggregation(S,"_quickActions");this._addAllToPrivateAggregation(S,"_items");}C.prototype.applySettings.apply(this,arguments);};m.prototype.openBy=function(a){if(!this.getParent()){c.getUIArea(c.getStaticAreaRef()).addContent(this,true);}this._initPopover();this._createQuickActionGrids();if(this._oItemsContainer){this._oItemsContainer.destroy();this._oItemsContainer=null;}this._initItemsContainer();this._oPopover.openBy(a);f.bindAnyEvent(this.fAnyEventHandlerProxy);};m.prototype.getAriaHasPopupType=function(){return o;};m.prototype.close=function(){this._previousView=null;if(this._oPopover){this._oPopover.close();}f.unbindAnyEvent(this.fAnyEventHandlerProxy);};m.prototype.exit=function(){C.prototype.exit.apply(this,arguments);if(this._oPopover){delete this._oPopover;}if(this._oItemsContainer){delete this._oItemsContainer;}f.unbindAnyEvent(this.fAnyEventHandlerProxy);};m.prototype._addAllToPrivateAggregation=function(S,a){if(S[a]){S[a].forEach(function(I){this.addAggregation(a,I);}.bind(this));delete S[a];}};m.prototype._initPopover=function(){if(this._oPopover){return;}this._oPopover=new R({showArrow:false,showHeader:false,placement:l.PlacementType.Bottom,content:new s({control:this,height:true}),contentWidth:p,horizontalScrolling:false,verticalScrolling:false,afterClose:[this.close,this]});this.addDependent(this._oPopover);this._oPopover.addEventDelegate({"onAfterRendering":this._focusItem},this);if(this.getItems().length===0&&!this.getAggregation("_items")){this._oPopover.attachAfterOpen(this._focusInitialQuickAction.bind(this));}else{this._oPopover.attachAfterOpen(function(){var I=this._oItemsContainer._getNavigationList().getItems().find(function(I){return I.getVisible();});I&&I.focus();}.bind(this));}this._oPopover._oControl.oPopup.setAutoClose(false);};m.prototype.onsapfocusleave=function(E){if(!this._oPopover.isOpen()){return;}this.handleOuterEvent(this.getId(),E);};m.prototype.handleOuterEvent=function(a,E){var t=false,u=D.support.touch||D.system.combi;if(E.type=="mousedown"||E.type=="touchstart"){if(u&&(E.isMarked("delayedMouseEvent")||E.isMarked("cancelAutoClose"))){return;}if(e(this.getDomRef(),E.target)||e(c.getStaticAreaRef(),E.target)||r(this,c.byId(E.target.id))){t=true;}}else if(E.type=="sapfocusleave"){if(u){return;}if(E.relatedControlId){if(e(this.getDomRef(),q(document.getElementById(E.relatedControlId)).get(0))||r(this,c.byId(E.relatedControlId))){t=true;}}}if(!t){this.close();}};function r(P,a){var t=a.getParent();if(!t){return false;}else if(t===P){return true;}return r(P,t);}m.prototype._initItemsContainer=function(){var a=this._getAllEffectiveItems();var t=this._hasQuickActions();var u=this._hasItems();if(!this._oItemsContainer){this._createItemsContainer();}a.forEach(function(v,I){this._addView(v);if(t&&u&&I===0){this._oItemsContainer.addSeparator();}}.bind(this));};var s=C.extend("sap.m.table.columnmenu.AssociativeControl",{metadata:{"final":true,properties:{height:{type:"boolean",defaultValue:false}},associations:{control:{type:"sap.ui.core.Control"}}},renderer:{apiVersion:2,render:function(a,t){a.openStart("div",t);t.getHeight()&&a.style("height","100%");a.openEnd();a.renderControl(sap.ui.getCore().byId(t.getControl()));a.close("div");}}});m.prototype._addView=function(a){var I=new A({content:new s({control:a.getContent(),height:true}),key:a.getId(),text:a.getLabel(),icon:a.getIcon()});this._oItemsContainer.addView(I);this._setItemVisibility(a,a.getVisible());};m.prototype._createItemsContainer=function(){var a=this;this._oBtnCancel=new B({text:this._getResourceText("table.COLUMNMENU_CANCEL"),press:function(){var K=a._oItemsContainer.getCurrentViewKey();if(a._fireEvent(c.byId(K),"cancel")){a.close();}}});this._oBtnOk=new B({text:this._getResourceText("table.COLUMNMENU_CONFIRM"),type:l.ButtonType.Emphasized,press:function(){var K=a._oItemsContainer.getCurrentViewKey();if(a._fireEvent(c.byId(K),"confirm")){a.close();}}});a._oItemsContainer=new h({listLayout:true,defaultView:n,footer:new T({content:[new b(),this._oBtnOk,this._oBtnCancel]}),beforeViewSwitch:function(E){var P=E.getParameters();if(P.target!=="$default"){var t=a._oItemsContainer.getView(P.target);var u=a._getItemFromContainerItem(t);if(u&&!a._fireEvent(u,"press")){E.preventDefault();}}},afterViewSwitch:function(E){var P=E.getParameters();this.oLayout.setShowFooter(P.target!=="$default");a._previousView=P.source;if(P.target!=="$default"){var t=a._oItemsContainer.getView(P.target);if(t){var I=a._getItemFromContainerItem(t);a._updateButtonState(I);a._focusItem();}}else{a._focusItem();this._oPopover&&this._oPopover.invalidate();}}});a._oItemsContainer.getHeader().addContentRight(new B({text:this._getResourceText("table.COLUMNMENU_RESET"),press:function(){a._fireEvent(c.byId(a._oItemsContainer.getCurrentViewKey()),"reset",false);}}));this._oPopover.addDependent(a._oItemsContainer);a.addDependent(a._oItemsContainer);};m.prototype._fireEvent=function(E,a,t){var u=E["on"+g(a)];if(t!==false){var v=q.Event(a);u.call(E,v);return!v.isDefaultPrevented();}else{u.call(E);return true;}};m.prototype._getResourceText=function(t,v){this.oResourceBundle=this.oResourceBundle?this.oResourceBundle:sap.ui.getCore().getLibraryResourceBundle("sap.m");return t?this.oResourceBundle.getText(t,v):this.oResourceBundle;};m.prototype._getAllEffectiveQuickActions=function(){var Q=(this.getAggregation("_quickActions")||[]).concat(this.getQuickActions());return Q.reduce(function(a,t){return a.concat(t.getEffectiveQuickActions());},[]).filter(function(a){return a.getVisible();});};m.prototype._hasQuickActions=function(){return this._getAllEffectiveQuickActions().length>0;};m.prototype._getAllEffectiveItems=function(){var I=(this.getAggregation("_items")||[]).concat(this.getItems());return I.reduce(function(a,t){return a.concat(t.getEffectiveItems());},[]).filter(function(a){return a.getVisible();});};m.prototype._hasItems=function(){return this._getAllEffectiveItems().length>0;};m.prototype._getItemFromContainerItem=function(a){return this._getAllEffectiveItems().find(function(t){return t.getId()===a.getKey();});};m.prototype._updateButtonState=function(I){if(!this._oItemsContainer){return;}if(this._oItemsContainer.getCurrentViewKey()===n){return;}this._oItemsContainer.getHeader().getContentRight()[0].setVisible(I.getButtonSettings()["reset"]["visible"]);this._oItemsContainer.getHeader().getContentRight()[0].setEnabled(I.getButtonSettings()["reset"]["enabled"]);this._oBtnOk.setVisible(I.getButtonSettings()["confirm"]["visible"]);this._oBtnCancel.setVisible(I.getButtonSettings()["cancel"]["visible"]);};m.prototype._focusItem=function(){if(this._previousView==n){this._oItemsContainer._getNavBackBtn().focus();}else{var I=this._oItemsContainer._getNavigationList().getItems().find(function(I){return I.getVisible()&&I._key===this._previousView;}.bind(this));I&&I.focus();}};m.prototype._focusInitialQuickAction=function(){if(this.getItems().length===0&&!this.getAggregation("_items")){var Q=[];if(this.getAggregation("_quickActions")){Q=this.getAggregation("_quickActions")[0].getEffectiveQuickActions();}else if(this.getQuickActions().length>0){Q=this.getQuickActions()[0].getEffectiveQuickActions();}Q.length>0&&Q[0].getContent()[0].focus();}};m.prototype._setItemVisibility=function(I,v){var a=this._oItemsContainer._getNavigationList().getItems();var t=a.find(function(t){return t._key==I.getId();});t&&t.setVisible(v);};m.prototype._createQuickActionGrids=function(){var a;if(this._oForm){a=this._oForm.getFormContainers()[0];a.destroyFormElements();}else{a=new j();this._oForm=new F({layout:new i({labelSpanXL:3,labelSpanL:3,labelSpanM:3,labelSpanS:12,adjustLabelSpan:false}),editable:true,formContainers:a});}var E=this._getAllEffectiveQuickActions();E.forEach(function(t){if(!t.getVisible()){return;}var u=new G({span:"XL4 L4 M4 S12"});var v=new L({text:t.getLabel(),layoutData:u,vAlign:sap.ui.core.VerticalAlign.Middle,wrapping:true}).setWidth("100%");v.addStyleClass("sapMTCMenuQALabel");var w=[];var x=t.getContent();x.forEach(function(I){if(I.getLayoutData()){u=I.getLayoutData().clone();}else{var S=Math.floor(8/x.length);var y=x.length>2?12:Math.floor(12/x.length);u=new G({spanS:y,spanM:S,spanL:S,spanXL:S});}var z=new s({control:I.setWidth("100%")});z.setLayoutData(u);w.push(z);},this);a.addFormElement(new k({label:v,fields:w}));},this);this.addDependent(this._oForm);};return m;});
