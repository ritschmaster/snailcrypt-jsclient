/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['./SinglePlanningCalendarUtilities','sap/ui/core/Control','sap/ui/core/LocaleData','sap/ui/core/Locale','sap/ui/core/InvisibleText','sap/ui/core/format/DateFormat','sap/ui/core/format/TimezoneUtil','sap/ui/core/Core','sap/ui/core/date/UniversalDate','sap/ui/core/dnd/DragInfo','sap/ui/core/dnd/DropInfo','sap/ui/core/dnd/DragDropInfo','sap/ui/unified/library','sap/ui/unified/CalendarAppointment','sap/ui/unified/calendar/DatesRow','sap/ui/unified/calendar/CalendarDate','sap/ui/unified/calendar/CalendarUtils','sap/ui/unified/DateTypeRange','sap/ui/events/KeyCodes','./SinglePlanningCalendarGridRenderer','sap/ui/core/delegate/ItemNavigation',"sap/ui/thirdparty/jquery",'./PlanningCalendarLegend','sap/ui/core/InvisibleMessage','sap/ui/core/library'],function(S,C,L,a,I,D,T,b,U,c,d,e,u,f,g,h,k,l,K,m,n,q,P,o,p){"use strict";var R=4.3125,r=3,B=2.125,s=1.5625,H=3600000/2,O=60*1000,t=0.4375,F=0,v=24,w=p.InvisibleMessageMode;var x=C.extend("sap.m.SinglePlanningCalendarGrid",{metadata:{library:"sap.m",properties:{startDate:{type:"object",group:"Data"},startHour:{type:"int",group:"Data",defaultValue:0},endHour:{type:"int",group:"Data",defaultValue:24},fullDay:{type:"boolean",group:"Data",defaultValue:true},enableAppointmentsDragAndDrop:{type:"boolean",group:"Misc",defaultValue:false},enableAppointmentsResize:{type:"boolean",group:"Misc",defaultValue:false},enableAppointmentsCreate:{type:"boolean",group:"Misc",defaultValue:false},scaleFactor:{type:"float",group:"Data",defaultValue:1}},aggregations:{appointments:{type:"sap.ui.unified.CalendarAppointment",multiple:true,singularName:"appointment",dnd:{draggable:true}},specialDates:{type:"sap.ui.unified.DateTypeRange",multiple:true,singularName:"specialDate"},_columnHeaders:{type:"sap.ui.unified.calendar.DatesRow",multiple:false,visibility:"hidden"},_intervalPlaceholders:{type:"sap.m.SinglePlanningCalendarGrid._internal.IntervalPlaceholder",multiple:true,visibility:"hidden",dnd:{droppable:true}},_blockersPlaceholders:{type:"sap.m.SinglePlanningCalendarGrid._internal.IntervalPlaceholder",multiple:true,visibility:"hidden",dnd:{droppable:true}}},dnd:true,associations:{ariaLabelledBy:{type:"sap.ui.core.Control",multiple:true,singularName:"ariaLabelledBy"},legend:{type:"sap.m.PlanningCalendarLegend",multiple:false}},events:{appointmentSelect:{parameters:{appointment:{type:"sap.ui.unified.CalendarAppointment"},appointments:{type:"sap.ui.unified.CalendarAppointment[]"}}},appointmentDrop:{parameters:{appointment:{type:"sap.ui.unified.CalendarAppointment"},startDate:{type:"object"},endDate:{type:"object"},copy:{type:"boolean"}}},appointmentResize:{parameters:{appointment:{type:"sap.ui.unified.CalendarAppointment"},startDate:{type:"object"},endDate:{type:"object"}}},appointmentCreate:{parameters:{startDate:{type:"object"},endDate:{type:"object"}}},cellPress:{parameters:{startDate:{type:"object"},endDate:{type:"object"}}}}}});x.prototype.init=function(){var i=new Date(),j=new g(this.getId()+"-columnHeaders",{showDayNamesLine:false,showWeekNumbers:false,startDate:i}).addStyleClass("sapMSinglePCColumnHeader"),y=(60-i.getSeconds())*1000,E=this._getCoreLocaleData().getTimePattern("medium");j._setAriaRole("columnheader");this.setAggregation("_columnHeaders",j);this.setStartDate(i);this._setColumns(7);this._configureBlockersDragAndDrop();this._configureAppointmentsDragAndDrop();this._configureAppointmentsResize();this._configureAppointmentsCreate();this._oUnifiedRB=sap.ui.getCore().getLibraryResourceBundle("sap.ui.unified");this._oFormatStartEndInfoAria=D.getDateTimeInstance({pattern:"EEEE dd/MM/yyyy 'at' "+E});this._oFormatAriaFullDayCell=D.getDateTimeInstance({pattern:"EEEE dd/MM/yyyy"});this._sLegendId=undefined;setTimeout(this._updateRowHeaderAndNowMarker.bind(this),y);};x.prototype.exit=function(){if(this._oItemNavigation){this.removeDelegate(this._oItemNavigation);this._oItemNavigation.destroy();delete this._oItemNavigation;}};x.prototype.onBeforeRendering=function(){var i=this._createAppointmentsMap(this.getAppointments()),j=this.getStartDate(),y=h.fromLocalJSDate(j),E=this._getColumns();this._oVisibleAppointments=this._calculateVisibleAppointments(i.appointments,this.getStartDate(),E);this._oAppointmentsToRender=this._calculateAppointmentsLevelsAndWidth(this._oVisibleAppointments);this._aVisibleBlockers=this._calculateVisibleBlockers(i.blockers,y,E);this._oBlockersToRender=this._calculateBlockersLevelsAndWidth(this._aVisibleBlockers);if(this._iOldColumns!==E||this._oOldStartDate!==j){this._createBlockersDndPlaceholders(j,E);this._createAppointmentsDndPlaceholders(j,E);}this._oInvisibleMessage=o.getInstance();};x.prototype.onmousedown=function(E){var i=E.target.classList;this._isResizeHandleBottomMouseDownTarget=i.contains("sapMSinglePCAppResizeHandleBottom");this._isResizeHandleTopMouseDownTarget=i.contains("sapMSinglePCAppResizeHandleTop");};x.prototype._isResizingPerformed=function(){return this._isResizeHandleBottomMouseDownTarget||this._isResizeHandleTopMouseDownTarget;};x.prototype._configureBlockersDragAndDrop=function(){this.addDragDropConfig(new e({sourceAggregation:"appointments",targetAggregation:"_blockersPlaceholders",dragStart:function(E){if(!this.getEnableAppointmentsDragAndDrop()){E.preventDefault();return false;}var i=function(){var $=q(".sapMSinglePCOverlay");setTimeout(function(){$.addClass("sapMSinglePCOverlayDragging");});q(document).one("dragend",function(){$.removeClass("sapMSinglePCOverlayDragging");});};i();}.bind(this),dragEnter:function(E){var i=E.getParameter("dragSession"),j=i.getDragControl(),y=i.getDropControl(),G=this.isAllDayAppointment(j._getStartDateWithTimezoneAdaptation(),j._getEndDateWithTimezoneAdaptation()),J=function(){var $=q(i.getIndicator()),M=j.$().outerHeight(),N=j.$().outerWidth(),Q=y.$().closest(".sapMSinglePCBlockersColumns").get(0).getBoundingClientRect(),V=y.getDomRef().getBoundingClientRect(),W=(V.left+N)-(Q.left+Q.width);if(G){$.css("min-height",M);$.css("min-width",Math.min(N,N-W));}else{$.css("min-height",i.getDropControl().$().outerHeight());$.css("min-width",i.getDropControl().$().outerWidth());}};if(!i.getIndicator()){setTimeout(J,0);}else{J();}}.bind(this),drop:function(E){var i=E.getParameter("dragSession"),j=i.getDragControl(),y=i.getDropControl(),G=y.getDate().getJSDate(),J,M=E.getParameter("browserEvent"),N=(M.metaKey||M.ctrlKey),Q=this.isAllDayAppointment(j._getStartDateWithTimezoneAdaptation(),j._getEndDateWithTimezoneAdaptation());J=new Date(G);if(Q){J.setMilliseconds(j._getEndDateWithTimezoneAdaptation().getTime()-j._getStartDateWithTimezoneAdaptation().getTime());}this.$().find(".sapMSinglePCOverlay").removeClass("sapMSinglePCOverlayDragging");if(Q&&j._getStartDateWithTimezoneAdaptation().getTime()===G.getTime()){return;}this.fireAppointmentDrop({appointment:j,startDate:G,endDate:J,copy:N});}.bind(this)}));};x.prototype._configureAppointmentsDragAndDrop=function(){this.addDragDropConfig(new e({sourceAggregation:"appointments",targetAggregation:"_intervalPlaceholders",dragStart:function(E){if(!this.getEnableAppointmentsDragAndDrop()||this._isResizingPerformed()){E.preventDefault();return false;}var i=function(){var $=q(".sapMSinglePCOverlay");setTimeout(function(){$.addClass("sapMSinglePCOverlayDragging");});q(document).one("dragend",function(){$.removeClass("sapMSinglePCOverlayDragging");});};i();}.bind(this),dragEnter:function(E){var i=E.getParameter("dragSession"),j=i.getDragControl(),y=i.getDropControl(),G=this.isAllDayAppointment(j._getStartDateWithTimezoneAdaptation(),j._getEndDateWithTimezoneAdaptation()),J=function(){var $=q(i.getIndicator()),M=j.$().outerHeight(),N=y.$().closest(".sapMSinglePCColumn").get(0).getBoundingClientRect(),Q=i.getDropControl().getDomRef().getBoundingClientRect(),V=(Q.top+M)-(N.top+N.height);if(G){$.css("min-height",2*i.getDropControl().$().outerHeight());}else{$.css("min-height",Math.min(M,M-V));}};if(!i.getIndicator()){setTimeout(J,0);}else{J();}}.bind(this),drop:function(E){var i=E.getParameter("dragSession"),j=i.getDragControl(),y=i.getDropControl(),G=y.getDate().getJSDate(),J,M=E.getParameter("browserEvent"),N=(M.metaKey||M.ctrlKey),Q=this.isAllDayAppointment(j._getStartDateWithTimezoneAdaptation(),j._getEndDateWithTimezoneAdaptation());J=new Date(G);if(Q){J.setHours(J.getHours()+1);}else{J.setMilliseconds(j._getEndDateWithTimezoneAdaptation().getTime()-j._getStartDateWithTimezoneAdaptation().getTime());}this.$().find(".sapMSinglePCOverlay").removeClass("sapMSinglePCOverlayDragging");if(!Q&&j._getStartDateWithTimezoneAdaptation().getTime()===G.getTime()){return;}this.fireAppointmentDrop({appointment:j,startDate:G,endDate:J,copy:N});}.bind(this)}));};x.prototype._configureAppointmentsResize=function(){var i=new e({sourceAggregation:"appointments",targetAggregation:"_intervalPlaceholders",dragStart:function(E){if(!this.getEnableAppointmentsResize()||!this._isResizingPerformed()){E.preventDefault();return;}var j=E.getParameter("dragSession"),y=j.getDragControl(),G=E.getParameter("browserEvent")&&E.getParameter("browserEvent").target||null;y._sAppointmentPartSuffix=G&&G.id?G.id.replace(y.getId()+"-",""):"";var $=this.$().find(".sapMSinglePCOverlay"),J=q(j.getIndicator()),M=y.$();if(this._isResizeHandleBottomMouseDownTarget){j.setComplexData("bottomHandle","true");}if(this._isResizeHandleTopMouseDownTarget){j.setComplexData("topHandle","true");}J.addClass("sapUiDnDIndicatorHide");setTimeout(function(){$.addClass("sapMSinglePCOverlayDragging");},0);q(document).one("dragend",function(){var N=j.getComplexData("appointmentStartingBoundaries");$.removeClass("sapMSinglePCOverlayDragging");J.removeClass("sapUiDnDIndicatorHide");M.css({top:N.top,height:N.height,"z-index":"auto",opacity:1});});E.getParameter("browserEvent").dataTransfer.setDragImage(z(),0,0);}.bind(this),dragEnter:function(E){var j=E.getParameter("dragSession"),y=j.getDragControl().$().get(0),G=j.getDropControl().getDomRef(),J=j.getComplexData("appointmentStartingBoundaries"),M=function(){var $=q(j.getIndicator());$.addClass("sapUiDnDIndicatorHide");},N,Q,V,W,X;if(!J){J={top:y.offsetTop,bottom:y.offsetTop+y.getBoundingClientRect().height,height:y.getBoundingClientRect().height};j.setComplexData("appointmentStartingBoundaries",J);}W=j.getData("bottomHandle")?J.top:J.bottom;N=Math.min(W,G.offsetTop);Q=Math.max(W,G.offsetTop+G.getBoundingClientRect().height);V=Q-N;X={top:N,height:V,"z-index":1,opacity:0.8};j.getDragControl().$().css(X);if(!j.getIndicator()){setTimeout(M,0);}else{M();}},drop:function(E){var j=E.getParameter("dragSession"),y=j.getDragControl(),G=this.indexOfAggregation("_intervalPlaceholders",j.getDropControl()),J=j.getComplexData("appointmentStartingBoundaries"),M;M=this._calcResizeNewHoursAppPos(y._getStartDateWithTimezoneAdaptation(),y._getEndDateWithTimezoneAdaptation(),G,j.getComplexData("bottomHandle"));this.$().find(".sapMSinglePCOverlay").removeClass("sapMSinglePCOverlayDragging");q(j.getIndicator()).removeClass("sapUiDnDIndicatorHide");y.$().css({top:J.top,height:J.height,"z-index":"auto",opacity:1});if(y._getEndDateWithTimezoneAdaptation().getTime()===M.endDate.getTime()&&y._getStartDateWithTimezoneAdaptation().getTime()===M.startDate.getTime()){return;}this.fireAppointmentResize({appointment:y,startDate:M.startDate,endDate:M.endDate});}.bind(this)});this.addDragDropConfig(i);};x.prototype._configureAppointmentsCreate=function(){this.addDragDropConfig(new e({targetAggregation:"_intervalPlaceholders",dragStart:function(E){if(!this.getEnableAppointmentsCreate()){E.preventDefault();return;}var i=E.getParameter("browserEvent");var $=this.$().find(".sapMSinglePCOverlay");setTimeout(function(){$.addClass("sapMSinglePCOverlayDragging");});q(document).one("dragend",function(){$.removeClass("sapMSinglePCOverlayDragging");q(".sapUiAppCreate").remove();q(".sapUiDnDDragging").removeClass("sapUiDnDDragging");});i.dataTransfer.setDragImage(z(),0,0);var G=E.getParameter("target"),j=G.getAggregation("_intervalPlaceholders"),y=j[0].getDomRef().getBoundingClientRect(),J=y.height,M=Math.floor((y.top-G.getDomRef().getBoundingClientRect().top)/J),N=E.getParameter("dragSession"),Q=Math.floor(i.offsetY/J)-M,V,W;if(this._iColumns===1){V=Q;}else{var X=64,Y=2,Z=Math.floor(j[0].getDomRef().getBoundingClientRect().width)-Y,a1=Math.floor(Math.floor((i.offsetX-X))/Z),b1=j.length/this._iColumns;V=Q+((a1)*b1);}if(V<0){V=0;}W=j[V].getDomRef().getBoundingClientRect();N.setComplexData("startingRectsDropArea",{top:Math.ceil(Q*J),left:W.left});N.setComplexData("startingDropDate",j[V].getDate());}.bind(this),dragEnter:function(E){var i=E.getParameter("dragSession"),j=i.getDropControl(),y=j.getDomRef(),G=y.offsetHeight,J=y.offsetTop,M=J,N=y.getBoundingClientRect().left,Q=N,V=j.$().parents(".sapMSinglePCColumn").get(0),$=q(".sapUiAppCreate");if(!$.get(0)){$=q("<div></div>").addClass("sapUiCalendarApp sapUiCalendarAppType01 sapUiAppCreate");$.appendTo(V);}q(".sapUiDnDDragging").removeClass("sapUiDnDDragging");if(!i.getComplexData("startingRectsDropArea")){i.setComplexData("startingRectsDropArea",{top:J,left:N});i.setComplexData("startingDropDate",j.getDate());}else{M=i.getComplexData("startingRectsDropArea").top;Q=i.getComplexData("startingRectsDropArea").left;}if(N!==Q){E.preventDefault();return false;}j.$().closest(".sapMSinglePCColumn").find(".sapMSinglePCAppointments").addClass("sapUiDnDDragging");$.css({top:Math.min(M,J)+2,height:Math.abs(M-J)+G-4,left:3,right:3,"z-index":2});i.setIndicatorConfig({display:"none"});},drop:function(E){var i=E.getParameter("dragSession"),j=i.getDropControl(),y=(60/(this.getScaleFactor()*2))*60*1000,G=i.getComplexData("startingDropDate").getTime(),J=j.getDate().getJSDate().getTime(),M=Math.min(G,J),N=Math.max(G,J)+y;this.fireAppointmentCreate({startDate:new Date(M),endDate:new Date(N)});q(".sapUiAppCreate").remove();q(".sapUiDnDDragging").removeClass("sapUiDnDDragging");}.bind(this)}));};x.prototype._calcResizeNewHoursAppPos=function(i,j,y,E){var M=(60/(this.getScaleFactor()*2))*60*1000,G=this.getAggregation("_intervalPlaceholders")[y].getDate().getTime(),J=G+M,V=E?i.getTime():j.getTime(),N=Math.min(V,G),Q=Math.max(V,J);return{startDate:new Date(N),endDate:new Date(Q)};};x.prototype._adjustAppointmentsHeightforCompact=function(i,j,y,E){var G,J,M,N,Q,V,W,X,Y=this._getRowHeight(),Z=0;if(this._oAppointmentsToRender[i]){this._oAppointmentsToRender[i].oAppointmentsList.getIterator().forEach(function($){G=$.getData();J=this.getDomRef().querySelector("#"+G.getId()+"-"+E+"_"+Z);M=G._getStartDateWithTimezoneAdaptation();N=G._getEndDateWithTimezoneAdaptation();W=j.getTime()>M.getTime();X=y.getTime()<N.getTime();Q=W?0:this._calculateTopPosition(M);V=X?0:this._calculateBottomPosition(N);J.style["top"]=Q+"rem";J.style["bottom"]=V+"rem";J.querySelector(".sapUiCalendarApp").style["minHeight"]=(Y/2-0.1875)+"rem";++Z;}.bind(this));}};x.prototype._adjustBlockersHeightforCompact=function(){var M=this._getBlockersToRender().iMaxlevel,i=(M+1)*this._getBlockerRowHeight(),j=this._getColumns()===1?i+t:i,y=this._getBlockerRowHeight();if(M>0){j=j+0.1875;}this.$().find(".sapMSinglePCBlockersColumns").css("height",j+"rem");this._oBlockersToRender.oBlockersList.getIterator().forEach(function(E){E.getData().$().css("top",(y*E.level+0.0625)+"rem");});};x.prototype._adjustBlockersHeightforCozy=function(){var M=this._getBlockersToRender()&&this._getBlockersToRender().iMaxlevel,i;if(this._getColumns()===1){i=(M+1)*this._getBlockerRowHeight();this.$().find(".sapMSinglePCBlockersColumns").css("height",(i+t)+"rem");}};x.prototype.onAfterRendering=function(){var j=this._getColumns(),y=this.getStartDate(),E=this._getRowHeight();if(E===r){for(var i=0;i<j;i++){var G=new h(y.getFullYear(),y.getMonth(),y.getDate()+i),J=this._getDateFormatter().format(G.toLocalJSDate()),M=new U(G.getYear(),G.getMonth(),G.getDate(),this._getVisibleStartHour()),N=new U(G.getYear(),G.getMonth(),G.getDate(),this._getVisibleEndHour(),59,59);this._adjustAppointmentsHeightforCompact(J,M,N,i);}this._adjustBlockersHeightforCompact();}else{this._adjustBlockersHeightforCozy();}this._updateRowHeaderAndNowMarker();_.call(this);};x.prototype._appFocusHandler=function(E,i){var j=sap.ui.getCore().byId(E.target.id)||this._findSrcControl(E);if(j&&j.isA("sap.ui.unified.CalendarAppointment")){this.fireAppointmentSelect({appointment:undefined,appointments:this._toggleAppointmentSelection(undefined,true)});this._focusCellWithKeyboard(j,i);E.preventDefault();}};x.prototype._cellFocusHandler=function(E,i){var G=E.target,j=this._getDateFormatter(),y;if(G.classList.contains("sapMSinglePCRow")||G.classList.contains("sapMSinglePCBlockersColumn")){y=j.parse(G.getAttribute("data-sap-start-date"));if(this._isBorderReached(y,i)){this.fireEvent("borderReached",{startDate:y,next:i===K.ARROW_RIGHT,fullDay:G.classList.contains("sapMSinglePCBlockersColumn")});}}};x.prototype.onsapup=function(E){this._appFocusHandler(E,K.ARROW_UP);};x.prototype.onsapdown=function(E){this._appFocusHandler(E,K.ARROW_DOWN);};x.prototype.onsapright=function(E){this._appFocusHandler(E,K.ARROW_RIGHT);this._cellFocusHandler(E,K.ARROW_RIGHT);};x.prototype.onsapleft=function(E){this._appFocusHandler(E,K.ARROW_LEFT);this._cellFocusHandler(E,K.ARROW_LEFT);};x.prototype.setStartDate=function(i){this._oOldStartDate=this.getStartDate();this.getAggregation("_columnHeaders").setStartDate(i);return this.setProperty("startDate",i);};x.prototype.applyFocusInfo=function(y){var V=this._getVisibleBlockers(),E=this._getVisibleAppointments(),G=Object.keys(E),J,i,j;if(this._sSelectedAppointment){this._sSelectedAppointment.focus();return this;}for(i=0;i<V.length;++i){if(V[i].getId()===y.id){V[i].focus();return this;}}for(i=0;i<G.length;++i){J=E[G[i]];for(j=0;j<J.length;++j){if(J[j].getId()===y.id){J[j].focus();return this;}}}return this;};x.prototype.getSelectedAppointments=function(){return this.getAppointments().filter(function(i){return i.getSelected();});};x.prototype._toggleAppointmentSelection=function(j,y){var E=[],G=j&&j.getDomRef(),J,M,i;if(y){J=this.getAppointments();for(i=0,M=J.length;i<M;i++){if((!j||J[i].getId()!==j.getId())&&J[i].getSelected()){J[i].setProperty("selected",false);E.push(J[i]);}}}if(j){j.setProperty("selected",!j.getSelected());E.push(j);this._sSelectedAppointment=j.getSelected()&&G?j:undefined;}else{this._sSelectedAppointment=undefined;}return E;};x.prototype._isBorderReached=function(i,j){var G=h.fromLocalJSDate(this.getStartDate()),y=new h(G.getYear(),G.getMonth(),G.getDate()+this._getColumns()-1),E=h.fromLocalJSDate(i),J=j===K.ARROW_LEFT&&E.isSame(G),M=j===K.ARROW_RIGHT&&E.isSame(y);return J||M;};x.prototype._focusCellWithKeyboard=function(i,j){var y=this.isAllDayAppointment(i._getStartDateWithTimezoneAdaptation(),i._getEndDateWithTimezoneAdaptation()),E=this._getDateFormatter(),G=new Date(i._getStartDateWithTimezoneAdaptation().getFullYear(),i._getStartDateWithTimezoneAdaptation().getMonth(),i._getStartDateWithTimezoneAdaptation().getDate(),i._getStartDateWithTimezoneAdaptation().getHours()),J=new Date(this.getStartDate().getFullYear(),this.getStartDate().getMonth(),this.getStartDate().getDate(),this.getStartDate().getHours());if(G<J){G=J;}if(this._isBorderReached(G,j)){this.fireEvent("borderReached",{startDate:G,next:j===K.ARROW_RIGHT,fullDay:y});return;}switch(j){case K.ARROW_UP:if(!y){G.setHours(G.getHours()-1);}break;case K.ARROW_DOWN:if(!y){G.setHours(G.getHours()+1);}break;case K.ARROW_LEFT:G.setDate(G.getDate()-1);break;case K.ARROW_RIGHT:G.setDate(G.getDate()+1);break;default:}if(y&&j!==K.ARROW_DOWN){q("[data-sap-start-date='"+E.format(G)+"'].sapMSinglePCBlockersColumn").trigger("focus");}else{q("[data-sap-start-date='"+E.format(G)+"'].sapMSinglePCRow").trigger("focus");}};x.prototype.ontap=function(E){this._fireSelectionEvent(E);};x.prototype.onkeydown=function(E){if(E.which===K.SPACE||E.which===K.ENTER){this._fireSelectionEvent(E);var i=this._findSrcControl(E);if(i&&i.isA("sap.ui.unified.CalendarAppointment")){var j=i.getSelected()?"APPOINTMENT_SELECTED":"APPOINTMENT_UNSELECTED";this._oInvisibleMessage.announce(this._oUnifiedRB.getText(j),w.Polite);}E.preventDefault();}};x.prototype._findSrcControl=function(E){var i=E.target,j=i.parentElement,y;if(!j){return E.srcControl;}else if(j.classList.contains("sapUiCalendarRowApps")){y=j.getAttribute("data-sap-ui-related")||j.id;}else{y=i.getAttribute("data-sap-ui-related")||i.id;}return this.getAppointments().find(function(G){return G.sId===y;});};x.prototype._fireSelectionEvent=function(E){var i=this._findSrcControl(E),G=E.target;if(E.target.classList.contains("sapMSinglePCRow")||E.target.classList.contains("sapMSinglePCBlockersColumn")){this.fireEvent("cellPress",{startDate:this._getDateFormatter().parse(G.getAttribute("data-sap-start-date")),endDate:this._getDateFormatter().parse(G.getAttribute("data-sap-end-date"))});this.fireAppointmentSelect({appointment:undefined,appointments:this._toggleAppointmentSelection(undefined,true)});}else if(i&&i.isA("sap.ui.unified.CalendarAppointment")){if(G.parentElement&&G.parentElement.getAttribute("id")){var j=G.parentElement.getAttribute("id");var y=G.parentElement.getAttribute("data-sap-ui-related");var J=j.replace(y+"-","");i._setAppointmentPartSuffix(J);}this.fireAppointmentSelect({appointment:i,appointments:this._toggleAppointmentSelection(i,!(E.ctrlKey||E.metaKey))});}};x.prototype._getVisibleStartHour=function(){return(this.getFullDay()||!this.getStartHour())?F:this.getStartHour();};x.prototype._getVisibleEndHour=function(){return((this.getFullDay()||!this.getEndHour())?v:this.getEndHour())-1;};x.prototype._isVisibleHour=function(i){var j=this.getStartHour(),E=this.getEndHour();if(!this.getStartHour()){j=F;}if(!this.getEndHour()){E=v;}if(j>E){return j<=i||i<E;}return j<=i&&i<E;};x.prototype._shouldHideRowHeader=function(i){var j=new Date().getHours(),y=k._areCurrentMinutesLessThan(15)&&j===i,E=k._areCurrentMinutesMoreThan(45)&&j===i-1;return y||E;};x.prototype._parseDateStringAndHours=function(i,j){var y=this._getDateFormatter().parse(i);if(j){y.setHours(j);}return y;};x.prototype._getDateFormatter=function(){if(!(this._oDateFormat instanceof D)){this._oDateFormat=D.getDateTimeInstance({pattern:"yyyyMMdd-HHmm"});}return this._oDateFormat;};x.prototype._formatTimeAsString=function(i){var j=this._getHoursPattern()+":mm",y=D.getTimeInstance({pattern:j},new a(this._getCoreLocaleId()));return y.format(i);};x.prototype._addAMPM=function(i){var j=this._getAMPMFormat();return" "+j.format(i);};x.prototype._calculateTopPosition=function(i){var j=i.getHours()-this._getVisibleStartHour(),M=i.getMinutes(),y=this._getRowHeight();return(y*j)+(y/60)*M;};x.prototype._calculateBottomPosition=function(i){var j=this._getVisibleEndHour()+1-i.getHours(),M=i.getMinutes(),y=this._getRowHeight();return(y*j)-(y/60)*M;};x.prototype._updateRowHeaderAndNowMarker=function(){var i=new Date();this._updateNowMarker(i);this._updateRowHeaders(i);setTimeout(this._updateRowHeaderAndNowMarker.bind(this),O);};x.prototype._updateNowMarker=function(i){var $=this.$("nowMarker"),j=this.$("nowMarkerText"),y=this.$("nowMarkerAMPM"),E=!this._isVisibleHour(i.getHours()),M=new Date(i.getTime());M=this._convertToTimezone(M);$.toggleClass("sapMSinglePCNowMarkerHidden",E);$.css("top",this._calculateTopPosition(M)+"rem");j.text(this._formatTimeAsString(i));y.text(this._addAMPM(i));j.append(y);};x.prototype._convertToTimezone=function(i){var j=b.getConfiguration().getTimezone();var N=k._createUniversalUTCDate(i,undefined,true);N=new Date(i.getUTCFullYear(),i.getUTCMonth(),i.getUTCDate(),i.getUTCHours(),i.getUTCMinutes(),i.getUTCSeconds());N.setUTCFullYear(i.getUTCFullYear());N=T.convertToTimezone(N,j);return N;};x.prototype._updateRowHeaders=function(i){var $=this.$(),j=i.getHours(),N=j+1;$.find(".sapMSinglePCRowHeader").removeClass("sapMSinglePCRowHeaderHidden");if(this._shouldHideRowHeader(j)){$.find(".sapMSinglePCRowHeader"+j).addClass("sapMSinglePCRowHeaderHidden");}else if(this._shouldHideRowHeader(N)){$.find(".sapMSinglePCRowHeader"+N).addClass("sapMSinglePCRowHeaderHidden");}};x.prototype._createAppointmentsMap=function(i){var j=this;return i.reduce(function(M,y){var E=y._getStartDateWithTimezoneAdaptation(),G=y._getEndDateWithTimezoneAdaptation(),J,N,Q;if(!E||!G){return M;}if(!j.isAllDayAppointment(E,G)){J=h.fromLocalJSDate(E);N=h.fromLocalJSDate(G);while(J.isSameOrBefore(N)){Q=j._getDateFormatter().format(J.toLocalJSDate());if(!M.appointments[Q]){M.appointments[Q]=[];}M.appointments[Q].push(y);J.setDate(J.getDate()+1);}}else{M.blockers.push(y);}return M;},{appointments:{},blockers:[]});};x.prototype._calculateVisibleAppointments=function(j,y,E){var V={},G,J,M;for(var i=0;i<E;i++){G=new h(y.getFullYear(),y.getMonth(),y.getDate()+i);J=this._getDateFormatter().format(G.toLocalJSDate());M=this._isAppointmentFitInVisibleHours(G);if(j[J]){V[J]=j[J].filter(M,this).sort(this._sortAppointmentsByStartHourCallBack);}}return V;};x.prototype._isAppointmentFitInVisibleHours=function(i){return function(j){var y=j._getStartDateWithTimezoneAdaptation().getTime(),E=j._getEndDateWithTimezoneAdaptation().getTime(),G=(new U(i.getYear(),i.getMonth(),i.getDate(),this._getVisibleStartHour())).getTime(),J=(new U(i.getYear(),i.getMonth(),i.getDate(),this._getVisibleEndHour(),59,59)).getTime();var M=y<G&&E>J,N=y>=G&&y<J,Q=E>G&&E<=J;return M||N||Q;};};x.prototype._calculateAppointmentsLevelsAndWidth=function(V){var i=H-((this.getScaleFactor()-1)*5*60*1000);var j=this;return Object.keys(V).reduce(function(y,E){var M=0,G=new S.list(),J=V[E];J.forEach(function(N){var Q=new S.node(N),W=N._getStartDateWithTimezoneAdaptation().getTime();if(G.getSize()===0){G.add(Q);return;}G.getIterator().forEach(function(X){var Y=true,Z=X.getData(),$=Z._getStartDateWithTimezoneAdaptation().getTime(),a1=Z._getEndDateWithTimezoneAdaptation().getTime(),b1=a1-$;if(b1<i){a1=a1+(i-b1);}if(W>=$&&W<a1){Q.level++;M=Math.max(M,Q.level);}if(X.next&&X.next.level===Q.level){Y=false;}if(W>=a1&&Y){this.interrupt();}});G.insertAfterLevel(Q.level,Q);});y[E]={oAppointmentsList:j._calculateAppointmentsWidth(G),iMaxLevel:M};return y;},{});};x.prototype._calculateAppointmentsWidth=function(i){i.getIterator().forEach(function(j){var y=j.getData(),E=j.level,G=j.level,J=y._getStartDateWithTimezoneAdaptation().getTime(),M=y._getEndDateWithTimezoneAdaptation().getTime(),N=M-J;if(N<H){M=M+(H-N);}new S.iterator(i).forEach(function(Q){var V=Q.getData(),W=Q.level,X=V._getStartDateWithTimezoneAdaptation().getTime(),Y=V._getEndDateWithTimezoneAdaptation().getTime(),Z=Y-X;if(Z<H){Y=Y+(H-Z);}if(G>=W){return;}if(J>=X&&J<Y||M>X&&M<Y||J<=X&&M>=Y){j.width=W-G;this.interrupt();return;}if(E<W){E=W;j.width++;}});});return i;};x.prototype._calculateVisibleBlockers=function(i,j,y){var E=new h(j.getYear(),j.getMonth(),j.getDate()+y-1),G=this._isBlockerVisible(j,E);return i.filter(G).sort(this._sortAppointmentsByStartHourCallBack);};x.prototype._isBlockerVisible=function(V,i){return function(j){var y=h.fromLocalJSDate(j._getStartDateWithTimezoneAdaptation()),E=h.fromLocalJSDate(j._getEndDateWithTimezoneAdaptation());var G=y.isBefore(V)&&E.isAfter(i),J=k._isBetween(y,V,i,true),M=k._isBetween(E,V,i,true);return G||J||M;};};x.prototype._calculateBlockersLevelsAndWidth=function(V){var M=0,i=new S.list();V.forEach(function(j){var y=new S.node(j),E=h.fromLocalJSDate(j._getStartDateWithTimezoneAdaptation()),G=h.fromLocalJSDate(j._getEndDateWithTimezoneAdaptation());y.width=k._daysBetween(G,E);if(i.getSize()===0){i.add(y);return;}i.getIterator().forEach(function(J){var N=true,Q=J.getData(),W=h.fromLocalJSDate(Q._getStartDateWithTimezoneAdaptation()),X=h.fromLocalJSDate(Q._getEndDateWithTimezoneAdaptation());if(E.isSameOrAfter(W)&&E.isSameOrBefore(X)){y.level++;M=Math.max(M,y.level);}if(J.next&&J.next.level===y.level){N=false;}if(E.isSameOrAfter(X)&&N){this.interrupt();}});i.insertAfterLevel(y.level,y);},this);return{oBlockersList:i,iMaxlevel:M};};x.prototype._sortAppointmentsByStartHourCallBack=function(i,j){return i.getStartDate().getTime()-j.getStartDate().getTime()||j.getEndDate().getTime()-i.getEndDate().getTime();};x.prototype._getVisibleAppointments=function(){return this._oVisibleAppointments;};x.prototype._getAppointmentsToRender=function(){return this._oAppointmentsToRender;};x.prototype._getVisibleBlockers=function(){return this._aVisibleBlockers;};x.prototype._getBlockersToRender=function(){return this._oBlockersToRender;};x.prototype._setColumns=function(i){this._iOldColumns=this._iColumns;this._iColumns=i;this.getAggregation("_columnHeaders").setDays(i);this.invalidate();return this;};x.prototype._getColumns=function(){return this._iColumns;};x.prototype._getRowHeight=function(){return this._isCompact()?r*this.getScaleFactor():R*this.getScaleFactor();};x.prototype._getBlockerRowHeight=function(){return this._isCompact()?s:B;};x.prototype._isCompact=function(){var i=this.getDomRef();while(i&&i.classList){if(i.classList.contains("sapUiSizeCompact")){return true;}i=i.parentNode;}return false;};x.prototype._getCoreLocaleId=function(){if(!this._sLocale){this._sLocale=sap.ui.getCore().getConfiguration().getFormatSettings().getFormatLocale().toString();}return this._sLocale;};x.prototype._getCoreLocaleData=function(){var i,j;if(!this._oLocaleData){i=this._getCoreLocaleId();j=new a(i);this._oLocaleData=L.getInstance(j);}return this._oLocaleData;};x.prototype._hasAMPM=function(){var i=this._getCoreLocaleData();return i.getTimePattern("short").search("a")>=0;};x.prototype._getHoursFormat=function(){var i=this._getCoreLocaleId();if(!this._oHoursFormat||this._oHoursFormat.oLocale.toString()!==i){var j=new a(i),y=this._getHoursPattern();this._oHoursFormat=D.getTimeInstance({pattern:y},j);}return this._oHoursFormat;};x.prototype._getHoursPattern=function(){return this._hasAMPM()?"h":"H";};x.prototype._getAMPMFormat=function(){var i=this._getCoreLocaleId(),j=new a(i);if(!this._oAMPMFormat||this._oAMPMFormat.oLocale.toString()!==i){this._oAMPMFormat=D.getTimeInstance({pattern:"a"},j);}return this._oAMPMFormat;};x.prototype._getColumnHeaders=function(){return this.getAggregation("_columnHeaders");};x.prototype._getAppointmentAnnouncementInfo=function(i){var j=this._oUnifiedRB.getText("CALENDAR_START_TIME"),E=this._oUnifiedRB.getText("CALENDAR_END_TIME"),y=this._oFormatStartEndInfoAria.format(i._getStartDateWithTimezoneAdaptation()),G=this._oFormatStartEndInfoAria.format(i._getEndDateWithTimezoneAdaptation()),J=j+": "+y+"; "+E+": "+G;return J+"; "+P.findLegendItemForItem(sap.ui.getCore().byId(this._sLegendId),i);};x.prototype.enhanceAccessibilityState=function(i,j){if(i.getId()===this._getColumnHeaders().getId()){j.labelledby=I.getStaticId("sap.m","PLANNINGCALENDAR_DAYS");}};x.prototype._getCellStartEndInfo=function(i,E){var j=this._oUnifiedRB.getText("CALENDAR_START_TIME"),y=this._oUnifiedRB.getText("CALENDAR_END_TIME"),G=!E;if(G){return j+": "+this._oFormatAriaFullDayCell.format(i)+"; ";}return j+": "+this._oFormatStartEndInfoAria.format(i)+"; "+y+": "+this._oFormatStartEndInfoAria.format(E);};x.prototype.isAllDayAppointment=function(i,j){return k._isMidnight(i)&&k._isMidnight(j);};x.prototype._createBlockersDndPlaceholders=function(j,y){this.destroyAggregation("_blockersPlaceholders");for(var i=0;i<y;i++){var E=new U(j.getFullYear(),j.getMonth(),j.getDate()+i);var G=new A({date:E});this.addAggregation("_blockersPlaceholders",G,true);}};x.prototype._createAppointmentsDndPlaceholders=function(E,G){var J=this._getVisibleStartHour(),M=this._getVisibleEndHour();this._dndPlaceholdersMap={};this.destroyAggregation("_intervalPlaceholders");for(var i=0;i<G;i++){var N=new h(E.getFullYear(),E.getMonth(),E.getDate()+i);if(!this._dndPlaceholdersMap[N]){this._dndPlaceholdersMap[N]=[];}for(var j=J;j<=M;j++){var Q=this._dndPlaceholdersMap[N],Y=N.getYear(),V=N.getMonth(),W=N.getDate(),X=this.getScaleFactor()*2,Z=60/X*60;for(var y=0;y<X;y++){Q.push(this._createAppointmentsDndPlaceHolder(new U(Y,V,W,j,0,Z*y)));}}}};x.prototype._createAppointmentsDndPlaceHolder=function(i){var j=new A({date:i});this.addAggregation("_intervalPlaceholders",j,true);return j;};x.prototype._getSpecialDates=function(){var j=this.getSpecialDates();for(var i=0;i<j.length;i++){var N=j[i].getSecondaryType()===u.CalendarDayType.NonWorking&&j[i].getType()!==u.CalendarDayType.NonWorking;if(N){var y=new l();y.setType(u.CalendarDayType.NonWorking);y.setStartDate(j[i].getStartDate());if(j[i].getEndDate()){y.setEndDate(j[i].getEndDate());}j.push(y);}}return j;};function z(){var $=q("<span></span>").addClass("sapUiCalAppResizeGhost");$.appendTo(document.body);setTimeout(function(){$.remove();},0);return $.get(0);}var A=C.extend("sap.m.SinglePlanningCalendarGrid._internal.IntervalPlaceholder",{metadata:{library:"sap.m",properties:{date:{type:"object",group:"Data"}}},renderer:{apiVersion:2,render:function(i,j){i.openStart("div",j).class("sapMSinglePCPlaceholder").openEnd().close("div");}}});function _(){var i=this.getDomRef(),j=this.$().find(".sapMSinglePCBlockersColumn").toArray();this._aGridCells=Array.prototype.concat(j);for(var y=0;y<=this._getVisibleEndHour();++y){j=this.$().find("div[data-sap-hour='"+y+"']").toArray();this._aGridCells=this._aGridCells.concat(j);}if(!this._oItemNavigation){this._oItemNavigation=new n();this.addDelegate(this._oItemNavigation);}this._oItemNavigation.setRootDomRef(i);this._oItemNavigation.setItemDomRefs(this._aGridCells);this._oItemNavigation.setCycling(false);this._oItemNavigation.setDisabledModifiers({sapnext:["alt","meta"],sapprevious:["alt","meta"],saphome:["alt","meta"],sapend:["meta"]});this._oItemNavigation.setTableMode(true,true).setColumns(this._getColumns());this._oItemNavigation.setPageSize(this._aGridCells.length);}return x;});
