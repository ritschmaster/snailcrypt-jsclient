/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/thirdparty/jquery",'./InputBase','./DatePicker','sap/ui/model/type/Date','sap/ui/unified/DateRange','./library','sap/ui/core/library','sap/ui/core/Control','sap/ui/Device','sap/ui/core/format/DateFormat','sap/ui/core/LocaleData','sap/ui/core/Core','sap/ui/core/format/TimezoneUtil','./TimePickerClocks','./DateTimePickerRenderer','./SegmentedButton','./SegmentedButtonItem','./ResponsivePopover','./Button',"sap/ui/events/KeyCodes","sap/ui/core/IconPool","sap/ui/qunit/utils/waitForThemeApplied"],function(q,I,D,a,b,l,c,C,d,e,L,f,T,g,h,S,k,R,B,K,m,w){"use strict";var P=l.PlacementType,n=l.ButtonType,o="Phone",p=c.CalendarType;var r=D.extend("sap.m.DateTimePicker",{metadata:{library:"sap.m",properties:{minutesStep:{type:"int",group:"Misc",defaultValue:1},secondsStep:{type:"int",group:"Misc",defaultValue:1},showCurrentTimeButton:{type:"boolean",group:"Behavior",defaultValue:false},showTimezone:{type:"boolean",group:"Behavior"},timezone:{type:"string",group:"Data"}},designtime:"sap/m/designtime/DateTimePicker.designtime",dnd:{draggable:false,droppable:true}},constructor:function(i,j,A){var E;if(typeof i!=='string'&&i!==undefined){A=j;j=i;i=j&&j.id;}E=j?Object.keys(j).sort(function(F,G){if(F==="timezone"){return-1;}else if(G==="timezone"){return 1;}return 0;}).reduce(function(F,G){F[G]=j[G];return F;},{}):j;D.call(this,i,E,A);}});var s={Short:"short",Medium:"medium",Long:"long",Full:"full"};var t=C.extend("sap.m.internal.DateTimePickerPopup",{metadata:{library:"sap.m",properties:{forcePhoneView:{type:"boolean",group:"Behavior",defaultValue:false}},aggregations:{_switcher:{type:"sap.ui.core.Control",multiple:false,visibility:"hidden"},calendar:{type:"sap.ui.core.Control",multiple:false},clocks:{type:"sap.ui.core.Control",multiple:false}}},renderer:{apiVersion:2,render:function(i,j){i.openStart("div",j);i.class("sapMDateTimePopupCont").class("sapMTimePickerDropDown");i.openEnd();var A=j.getAggregation("_switcher");if(A){i.openStart("div");i.class("sapMTimePickerSwitch");i.openEnd();i.renderControl(A);i.close("div");}var E=j.getCalendar();if(E){i.renderControl(E);}i.openStart("div");i.class("sapMTimePickerSep");i.openEnd();i.close("div");var F=j.getClocks();if(F){i.renderControl(F);}i.close("div");}},init:function(){},onBeforeRendering:function(){var i=this.getAggregation("_switcher");if(!i){var j=f.getLibraryResourceBundle("sap.m");var A=j.getText("DATETIMEPICKER_DATE");var E=j.getText("DATETIMEPICKER_TIME");i=new S(this.getId()+"-Switch",{selectedKey:"Cal",items:[new k(this.getId()+"-Switch-Cal",{key:"Cal",text:A}),new k(this.getId()+"-Switch-Clk",{key:"Clk",text:E})]});i.attachSelect(this._handleSelect,this);this.setAggregation("_switcher",i,true);}if(d.system.phone||q('html').hasClass("sapUiMedia-Std-Phone")||this.getForcePhoneView()){i.setVisible(true);i.setSelectedKey("Cal");this.getCalendar().addDelegate({onAfterRendering:function(){this._switchVisibility(i.getSelectedKey());}.bind(this)});}else{i.setVisible(false);}},_handleSelect:function(E){var i=E.getParameter("key");this._switchVisibility(i);if(i==="Clk"){this.getClocks()._focusActiveButton();}},_switchVisibility:function(i){var j=this.getCalendar(),A=this.getClocks();if(!j||!A){return;}if(i==="Cal"){j.$().css("display","flex");A.$().css("display","none");j.getFocusDomRef()&&j.getFocusDomRef().focus();}else{j.$().css("display","none");A.$().css("display","");}},switchToTime:function(){var i=this.getAggregation("_switcher");if(i&&i.getVisible()){i.setSelectedKey("Clk");this._switchVisibility("Clk");}},getSpecialDates:function(){return this._oDateTimePicker.getSpecialDates();}});r.prototype.init=function(){D.prototype.init.apply(this,arguments);this._bOnlyCalendar=false;};r.prototype.setValue=function(V){var F;D.prototype.setValue.apply(this,arguments);delete this._prefferedValue;if(!this.getDateValue()){F=this._fallbackParse(V);if(typeof F==="string"){this._bValid=true;this._prefferedValue=F;if(this.getDomRef()&&this._$input.val()!==F){this._$input.val(F);this._curpos=this._$input.cursorPos();}}}return this;};r.prototype.setTimezone=function(i){var j,F,N;if(this.getTimezone()===i){return this;}j=this.getDateValue()||this._parseValue(this.getValue(),false);F=this._formatValue(j,false);this.setProperty("timezone",i);this._oDisplayFormat=null;this._oValueFormat=null;this._oDisplayFormatWithTimezone=null;this._oValueFormatWithTimezone=null;if(this._oTimezonePopup){this._oTimezonePopup.setTitle(i);}N=this._parseValue(F,true);if(N){this.setProperty("dateValue",N);this.setProperty("value",this._formatValue(N,true));}return this;};r.prototype.ontap=function(E){if(E.target.parentElement.classList.contains("sapMDTPTimezoneLabel")){this._togglePopoverOpen(this._getTimezoneNamePopup(),E.target);return;}D.prototype.ontap.apply(this,arguments);};r.prototype.onAfterRendering=function(){if(this._getShowTimezone()){w().then(function(){var i=this.$().find(".sapMDummyContent"),j;if(!i||!i.length){return;}j=i[0].getBoundingClientRect().width;this.$("inner").css("max-width",(j+2)+"px");}.bind(this));}};r.prototype.getIconSrc=function(){return m.getIconURI("date-time");};r.prototype.exit=function(){D.prototype.exit.apply(this,arguments);if(this._oClocks){this._oClocks.destroy();delete this._oClocks;}this._oTimezonePopup=undefined;this._oPopupContent=undefined;d.media.detachHandler(this._handleWindowResize,this);};r.prototype.setDisplayFormat=function(i){this._oDisplayFormatWithTimezone=null;D.prototype.setDisplayFormat.apply(this,arguments);if(this._oClocks){this._oClocks.setValueFormat(y.call(this));this._oClocks.setDisplayFormat(y.call(this));}return this;};r.prototype.setValueFormat=function(V){this._oValueFormatWithTimezone=null;return D.prototype.setValueFormat.apply(this,arguments);};r.prototype.setMinutesStep=function(M){this.setProperty('minutesStep',M,true);if(this._oClocks){this._oClocks.setMinutesStep(M);}return this;};r.prototype._getDefaultValueStyle=function(){return s.Medium;};r.prototype.setMinDate=function(i){D.prototype.setMinDate.call(this,i);if(i){this._oMinDate.setHours(i.getHours(),i.getMinutes(),i.getSeconds());}return this;};r.prototype.setMaxDate=function(i){D.prototype.setMaxDate.call(this,i);if(i){this._oMaxDate.setHours(i.getHours(),i.getMinutes(),i.getSeconds());}return this;};r.prototype.setSecondsStep=function(i){this.setProperty('secondsStep',i,true);if(this._oClocks){this._oClocks.setSecondsStep(i);}return this;};r.prototype.setShowCurrentTimeButton=function(i){var j=this._oClocks;j&&j.setShowCurrentTimeButton(i);return this.setProperty("showCurrentTimeButton",i);};r.prototype._getTimezoneNamePopup=function(){var i;if(this._oTimezonePopup){this._oTimezonePopup.setTitle(this._getTimezone(true));return this._oTimezonePopup;}this._oTimezonePopup=new R({showArrow:false,placement:P.VerticalPreferredBottom,offsetX:0,offsetY:3,horizontalScrolling:false,title:this._getTimezone(true)});this.addDependent(this._oTimezonePopup);if(d.system.phone){i=f.getLibraryResourceBundle("sap.m");this._oTimezonePopup.setEndButton(new B({text:i.getText("SUGGESTIONSPOPOVER_CLOSE_BUTTON"),type:n.Emphasized,press:function(){this._oTimezonePopup.close();}.bind(this)}));}return this._oTimezonePopup;};r.prototype._togglePopoverOpen=function(i,O){if(i.isOpen()){i.close();}else{i.openBy(O||this.getDomRef());}};r.prototype._getFormatter=function(i){var j=this._getTimezoneFormatterCacheName(i);if(!this[j]){this[j]=e.getDateTimeWithTimezoneInstance(this._getTimezoneFormatOptions(i));}return this[j];};r.prototype._getBindingFormatOptions=function(){var i=this.getBinding("value")||this.getBinding("dateValue"),j;if(i){j=i.getType();}if(this._isSupportedBindingType(j)){return q.extend({},j.getFormatOptions());}};r.prototype._getTimezoneFormatOptions=function(i){var F=this._getBindingFormatOptions()||{},j=i?this.getDisplayFormat():this.getValueFormat(),A=this.getBinding("value")||this.getBinding("dateValue"),E=A&&A.getType&&A.getType();if(i||!this._getTimezone()||(E&&!E.isA(["sap.ui.model.odata.type.DateTimeWithTimezone"]))){F.showTimezone=false;}if(F.relative===undefined){F.relative=false;}if(F.calendarType===undefined){F.calendarType=i?this.getDisplayFormatType():p.Gregorian;}if(F.strictParsing===undefined){F.strictParsing=true;}if(j&&!this._isSupportedBindingType(E)){F[this._checkStyle(j)?"style":"pattern"]=j;}return F;};r.prototype._getTimezoneFormatterCacheName=function(i){return i?"_oDisplayFormatWithTimezone":"_oValueFormatWithTimezone";};r.prototype._getShowTimezone=function(){var i=this.getBinding("value")||this.getBinding("dateValue"),j=i&&i.getType();if(this.getShowTimezone()===undefined&&j&&j.isA(["sap.ui.model.odata.type.DateTimeWithTimezone"])){return j.getFormatOptions().showTimezone!==false;}return this.getShowTimezone();};r.prototype._getTimezone=function(U){var i=this.getBinding("value")||this.getBinding("dateValue"),j=i&&i.getType();if(!this.getTimezone()&&j&&j.isA(["sap.ui.model.odata.type.DateTimeWithTimezone"])&&i.aValues[1]){return i.aValues[1];}return this.getTimezone()||(U&&f.getConfiguration().getTimezone());};r.prototype._checkStyle=function(A){if(D.prototype._checkStyle.apply(this,arguments)){return true;}else if(A.indexOf("/")>0){var E=[s.Short,s.Medium,s.Long,s.Long];var F=false;for(var i=0;i<E.length;i++){var G=E[i];for(var j=0;j<E.length;j++){var H=E[j];if(A==G+"/"+H){F=true;break;}}if(F){break;}}return F;}return false;};r.prototype._parseValue=function(V,i,j){var A=this.getBinding("value")||this.getBinding("dateValue"),E=A&&A.getType(),F;if(E&&E.isA(["sap.ui.model.odata.type.DateTimeWithTimezone"])){var G=A.getCurrentValues().slice(0);G[1]=j||this._getTimezone(true);return E.parseValue(V,"string",G)[0];}F=this._getFormatter(i).parse(V,j||this._getTimezone(true));if(!F||!F.length){return null;}return F[0];};r.prototype._formatValue=function(i,V,j){if(!i){return"";}return this._getFormatter(!V).format(i,j||this._getTimezone(true));};r.prototype._fallbackParse=function(V){return this._getFallbackParser().parse(V)?"":null;};r.prototype._getFallbackParser=function(){if(!this._fallbackParser){this._fallbackParser=e.getDateTimeWithTimezoneInstance({showDate:false,showTime:false,showTimezone:true});}return this._fallbackParser;};r.prototype._getPickerParser=function(){if(!this._clocksParser){this._clocksParser=e.getDateTimeWithTimezoneInstance({showTimezone:false});}return this._clocksParser;};r.prototype._getLocaleBasedPattern=function(i){var j=L.getInstance(f.getConfiguration().getFormatSettings().getFormatLocale()),A=i.indexOf("/");if(A>0){return j.getCombinedDateTimePattern(i.substr(0,A),i.substr(A+1));}else{return j.getCombinedDateTimePattern(i,i);}};r.prototype._createPopup=function(){var i,j,A,O,E,F;if(!this._oPopup){A=f.getLibraryResourceBundle("sap.m");O=A.getText("TIMEPICKER_SET");E=A.getText("TIMEPICKER_CANCEL");this._oPopupContent=new t(this.getId()+"-PC");this._oPopupContent._oDateTimePicker=this;this._oOKButton=new B(this.getId()+"-OK",{text:O,type:n.Emphasized,press:_.bind(this)});var H=this._getValueStateHeader();this._oPopup=new R(this.getId()+"-RP",{showCloseButton:false,showHeader:false,placement:P.VerticalPreferedBottom,beginButton:this._oOKButton,content:[H,this._oPopupContent],afterOpen:v.bind(this),afterClose:x.bind(this)});H.setPopup(this._oPopup._oControl);if(d.system.phone){i=this.$("inner").attr("aria-labelledby");j=i?document.getElementById(i).getAttribute("aria-label"):"";this._oPopup.setTitle(j);this._oPopup.setShowHeader(true);this._oPopup.setShowCloseButton(true);}else{this._oPopup._getPopup().setDurations(0,0);this._oPopup.setEndButton(new B(this.getId()+"-Cancel",{text:E,press:u.bind(this)}));}this._oPopup.addStyleClass("sapMDateTimePopup");F=this._oPopup.getAggregation("_popup");if(F.setShowArrow){F.setShowArrow(false);}this.setAggregation("_popup",this._oPopup,true);}};r.prototype._openPopup=function(i){if(!this._oPopup){return;}if(!i){i=this.getDomRef();}this.addStyleClass(I.ICON_PRESSED_CSS_CLASS);var j=this._oPopup.getAggregation("_popup");j.oPopup.setExtraContent([i]);this._oPopup.openBy(i||this);};r.prototype._createPopupContent=function(){var N=!this._oCalendar;D.prototype._createPopupContent.apply(this,arguments);if(N){this._oPopupContent.setCalendar(this._oCalendar);this._oCalendar.attachSelect(z,this);}if(!this._oClocks){this._oClocks=new g(this.getId()+"-Clocks",{minutesStep:this.getMinutesStep(),secondsStep:this.getSecondsStep(),valueFormat:y.call(this),displayFormat:y.call(this),localeId:this.getLocaleId(),showCurrentTimeButton:this.getShowCurrentTimeButton()});this._oPopupContent.setClocks(this._oClocks);}};r.prototype._attachAfterRenderingDelegate=function(){};r.prototype._selectFocusedDateValue=function(i){var j=this._oCalendar;j.removeAllSelectedDates();j.addSelectedDate(i);return this;};r.prototype._fillDateRange=function(){var i=this.getDateValue(),j=true,F;if(i){i=new Date(i.getTime());this._oOKButton.setEnabled(true);}else{j=false;i=this.getInitialFocusedDateValue();if(!i){i=new Date();this._oCalendar.removeAllSelectedDates();}var M=this._oMaxDate.getTime();if(i.getTime()<this._oMinDate.getTime()||i.getTime()>M){i=this._oMinDate;}this._oOKButton.setEnabled(false);}F=this._getPickerParser().format(i,this._getTimezone(true));i=this._getPickerParser().parse(F,T.getLocalTimezone())[0];this._oCalendar.focusDate(i);if(j){if(!this._oDateRange.getStartDate()||this._oDateRange.getStartDate().getTime()!=i.getTime()){this._oDateRange.setStartDate(i);}}this._oClocks._setTimeValues(i);};r.prototype._getSelectedDate=function(){var i=D.prototype._getSelectedDate.apply(this,arguments),j,A;if(i){j=this._oClocks.getTimeValues();A=this._oClocks._getDisplayFormatPattern();if(A.search("h")>=0||A.search("H")>=0){i.setHours(j.getHours());}if(A.search("m")>=0){i.setMinutes(j.getMinutes());}if(A.search("s")>=0){i.setSeconds(j.getSeconds());}if(i.getTime()<this._oMinDate.getTime()){i=new Date(this._oMinDate.getTime());}else if(i.getTime()>this._oMaxDate.getTime()){i=new Date(this._oMaxDate.getTime());}}return i;};r.prototype.getLocaleId=function(){return f.getConfiguration().getFormatSettings().getFormatLocale().toString();};r.prototype.getAccessibilityInfo=function(){var i=D.prototype.getAccessibilityInfo.apply(this,arguments);i.type=f.getLibraryResourceBundle("sap.m").getText("ACC_CTR_TYPE_DATETIMEINPUT");return i;};function _(E){this._handleCalendarSelect();}function u(E){this.onsaphide(E);if(!this.getDateValue()){this._oCalendar.removeAllSelectedDates();}}r.prototype._handleWindowResize=function(i){var j=this.getAggregation("_popup").getContent()[1].getAggregation("_switcher"),A=this.getAggregation("_popup").getContent()[1].getCalendar(),E=this.getAggregation("_popup").getContent()[1].getClocks();if(i.name===o){j.setVisible(true);this.getAggregation("_popup").getContent()[1]._switchVisibility(j.getSelectedKey());}else{j.setVisible(false);E.$().css("display","");A.$().css("display","flex");}};function v(E){this._oCalendar.focus();d.media.attachHandler(this._handleWindowResize,this);this.fireAfterValueHelpOpen();}function x(){this.removeStyleClass(I.ICON_PRESSED_CSS_CLASS);this._oCalendar._closePickers();d.media.detachHandler(this._handleWindowResize,this);this.fireAfterValueHelpClose();}function y(){var i=this.getDisplayFormat();var j;var A=this.getBinding("value");if(A&&A.oType&&(A.oType instanceof a)){i=A.oType.getOutputPattern();}else if(A&&A.oType&&A.oType.oFormat){i=A.oType.oFormat.oFormatOptions.pattern;}else{i=this.getDisplayFormat();}if(!i){i=s.Medium;}var E=i.indexOf("/");if(E>0&&this._checkStyle(i)){i=i.substr(E+1);}if(i==s.Short||i==s.Medium||i==s.Long||i==s.Full){var F=f.getConfiguration().getFormatSettings().getFormatLocale();var G=L.getInstance(F);j=G.getTimePattern(i);}else{j=i;}return j;}function z(E){this._oPopupContent.switchToTime();this._oPopupContent.getClocks()._focusActiveButton();this._oOKButton.setEnabled(true);}return r;});
