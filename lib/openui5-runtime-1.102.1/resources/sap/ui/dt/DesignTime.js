/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/base/ManagedObject","sap/ui/dt/ElementOverlay","sap/ui/dt/AggregationOverlay","sap/ui/dt/OverlayRegistry","sap/ui/dt/SelectionManager","sap/ui/dt/ElementDesignTimeMetadata","sap/ui/dt/AggregationDesignTimeMetadata","sap/ui/dt/ElementUtil","sap/ui/dt/Overlay","sap/ui/dt/OverlayUtil","sap/ui/dt/MetadataPropagationUtil","sap/ui/dt/Util","sap/ui/dt/TaskManager","sap/ui/dt/TaskRunner","sap/base/Log","sap/base/util/isPlainObject","sap/base/util/merge","sap/ui/dt/SelectionMode","sap/base/util/includes","sap/ui/dt/DesignTimeStatus","sap/base/util/restricted/_curry","sap/base/util/restricted/_difference","sap/base/util/isEmptyObject"],function(M,E,A,O,S,a,b,c,d,e,f,U,T,g,L,i,m,h,j,D,_,k,l){"use strict";var n=M.extend("sap.ui.dt.DesignTime",{metadata:{library:"sap.ui.dt",properties:{designTimeMetadata:{type:"object"},enabled:{type:"boolean",defaultValue:true},scope:{type:"string",defaultValue:"default"}},associations:{rootElements:{type:"sap.ui.core.Element",multiple:true}},aggregations:{plugins:{type:"sap.ui.dt.Plugin",multiple:true}},events:{addRootElement:{parameters:{element:{type:"sap.ui.core.Element"}}},addPlugin:{parameters:{plugin:{type:"sap.ui.dt.Plugin"}}},enabledChanged:{parameters:{value:{type:"boolean"}}},elementOverlayCreated:{parameters:{elementOverlay:{type:"sap.ui.dt.ElementOverlay"}}},elementOverlayDestroyed:{parameters:{elementOverlay:{type:"sap.ui.dt.ElementOverlay"}}},elementOverlayAdded:{parameters:{id:{type:"string"},targetIndex:{type:"int"},targetId:{type:"string"},targetAggregation:{type:"string"}}},elementOverlayMoved:{parameters:{id:{type:"string"},targetIndex:{type:"int"},targetId:{type:"string"},targetAggregation:{type:"string"}}},elementOverlayEditableChanged:{parameters:{id:{type:"string"},elementId:{type:"string"},editable:{type:"boolean"}}},elementPropertyChanged:{parameters:{id:{type:"string"},name:{type:"string"},oldValue:{type:"any"},value:{type:"any"}}},syncing:{},synced:{},syncFailed:{}}},constructor:function(){this._sStatus=D.SYNCED;this._mPendingOverlays={};this._oTaskManager=new T({complete:function(q){if(q.getSource().isEmpty()){this._registerElementOverlays();if(this._oTaskManager.isEmpty()&&this._sStatus!==D.SYNCED){this._sStatus=D.SYNCED;setTimeout(function(){if(this._sStatus===D.SYNCED){this.fireSynced();}}.bind(this),0);}}}.bind(this),add:function(q){if(q.getSource().count()===1){this._sStatus=D.SYNCING;this.fireSyncing();}}.bind(this)});this._oTaskRunner=new g({taskManager:this._oTaskManager,taskType:"applyStyles"}).run();this._oSelectionManager=new S();this._aOverlaysCreatedInLastBatch=[];M.apply(this,arguments);this.getRootElements().forEach(this._createOverlaysForRootElement,this);this.attachEvent("addRootElement",function(q){this._createOverlaysForRootElement(q.getParameter("element"));},this);this.getPlugins().forEach(function(P){P.attachEvent("processingStatusChange",this._onProcessingStatusChange,this);},this);this.attachEvent("addPlugin",function(q){var P=q.getParameter("plugin");P.attachEvent("processingStatusChange",this._onProcessingStatusChange,this);},this);this.attachEvent("enabledChanged",function(q){var v=q.getParameter("value");var $=d.getOverlayContainer();$[v?"show":"hide"]();this.getRootElements().forEach(function(r){var R=O.getOverlay(r);R.setVisible(v);if(v){this._oTaskManager.add({type:"applyStyles",callbackFn:R.applyStyles.bind(R,true),overlayId:R.getId()});}}.bind(this));},this);}});n.prototype._onProcessingStatusChange=function(q){if(q.getParameter("processing")){this._oTaskManager.add({type:"pluginInProcess",plugin:q.getSource().getMetadata().getName()});}else{this._oTaskManager.completeBy({type:"pluginInProcess",plugin:q.getSource().getMetadata().getName()});}};n.prototype._onApplyStylesRequired=function(q){var P=q.getParameters();var r=q.getSource();this._oTaskManager.add({type:"applyStyles",callbackFn:r.applyStyles.bind(r,P.bForceScrollbarSync,P.bSkipForceCalculation),overlayId:r.getId()},"overlayId");};n.prototype._removeOverlayFromSyncingBatch=function(q){var I=this._aOverlaysCreatedInLastBatch.indexOf(q);if(I!==-1){this._aOverlaysCreatedInLastBatch.splice(I,1);}};n.prototype._registerElementOverlays=function(){var q=this._aOverlaysCreatedInLastBatch.slice();if(!q.length){return;}var t=this._oTaskManager.add({type:"registerElementOverlays"});var P=this.getPlugins();q.forEach(function(r){O.register(r);r.attachBeforeDestroy(function(s){O.deregister(s.getSource());});});q.forEach(function(r){P.forEach(function(s){try{s.callElementOverlayRegistrationMethods(r);}catch(v){var u=U.propagateError(v,"DesignTime#_registerElementOverlays",U.printf("registerElementOverlay() method of the plugin {0} has failed for overlay with id='{1}' (element id='{2}')",s.getMetadata().getName(),r.getId(),r.getElement().getId()));L.error(U.errorToString(u));}});},this);q.forEach(function(r){try{this.fireElementOverlayCreated({elementOverlay:r});}catch(v){var s=U.propagateError(v,"DesignTime#_registerElementOverlays",U.printf('One of the listeners of elementOverlayCreated event failed while precessing the overlay with id="{0}" for element with id="{1}"',r.getId(),r.getElement().getId()));L.error(U.errorToString(s));}},this);this._aOverlaysCreatedInLastBatch=[];this._oTaskManager.complete(t);};n.prototype.exit=function(){this._bDestroyPending=true;this.getPlugins().forEach(function(P){P.destroy();});this._oSelectionManager.destroy();this._oTaskManager.destroy();this._destroyAllOverlays();this._aOverlaysCreatedInLastBatch=[];delete this._bDestroyPending;};n.prototype.getSelection=function(){return this.getSelectionManager().get();};n.prototype.getSelectionManager=function(){return this._oSelectionManager;};n.prototype.getPlugins=function(){return this.getAggregation("plugins")||[];};n.prototype.getBusyPlugins=function(){return this.getPlugins().filter(function(P){return P.isBusy();});};n.prototype.waitForBusyPlugins=function(){var B=this.getBusyPlugins();return Promise.all(B.map(function(P){return P.waitForBusyAction();}));};n.prototype.addPlugin=function(P){this.addAggregation("plugins",P);this.fireAddPlugin({plugin:P});P.setDesignTime(this);return this;};n.prototype.insertPlugin=function(P,I){this.insertAggregation("plugins",P,I);this.fireAddPlugin({plugin:P});P.setDesignTime(this);return this;};n.prototype.removePlugin=function(P){this.getPlugins().forEach(function(C){if(C===P){P.setDesignTime(null);P.detachEvent("processingStatusChange",this._onProcessingStatusChange,this);}}.bind(this));this.removeAggregation("plugins",P);return this;};n.prototype.removeAllPlugins=function(){this.getPlugins().forEach(function(P){P.setDesignTime(null);P.detachEvent("processingStatusChange",this._onProcessingStatusChange,this);}.bind(this));this.removeAllAggregation("plugins");return this;};n.prototype.getRootElements=function(){return(this.getAssociation("rootElements")||[]).map(function(s){return c.getElementInstance(s);});};n.prototype.getDesignTimeMetadataFor=function(q){var C;if(typeof q==="string"){C=q;L.error("sap.ui.dt.DesignTime#getDesignTimeMetadataFor / Function getDesignTimeMetadataFor() should be called with element instance");}else{C=q.getMetadata().getName();}return(this.getDesignTimeMetadata()||{})[C];};n.prototype.addRootElement=function(r){this.addAssociation("rootElements",r);this.fireAddRootElement({element:r});};n.prototype._createOverlaysForRootElement=function(r){var t=this._oTaskManager.add({type:"createOverlay",element:r,root:true});this.createOverlay({element:c.getElementInstance(r),root:true,visible:this.getEnabled()}).then(function(q){d.getOverlayContainer().append(q.render());this._oTaskManager.add({type:"applyStyles",callbackFn:q.applyStyles.bind(q),overlayId:q.getId()},"overlayId");this._oTaskManager.complete(t);return q;}.bind(this),function(v){var q=U.propagateError(v,"DesignTime#_createOverlaysForRootElement",U.printf("Root element with id = '{0}' initialization is failed",r.getId()));L.error(U.errorToString(q));this._oTaskManager.cancel(t);this.fireSyncFailed({error:q});}.bind(this));};n.prototype.removeRootElement=function(r){this.removeAssociation("rootElements",r);this._destroyOverlaysForElement(c.getElementInstance(r));return this;};n.prototype.removeAllRootElement=function(){this.removeAssociation("rootElements");this._destroyAllOverlays();return this;};n.prototype.getElementOverlays=function(){var q=[];this._iterateRootElements(function(r){q=q.concat(this._getAllElementOverlaysIn(r));},this);return q;};function o(I,q){if(I){q.setIsRoot(true);}}n.prototype.createOverlay=function(v){var P=Object.assign({},i(v)?v:{element:v});var t=this._oTaskManager.add({type:"createOverlay"});if(!P.element||!c.isElementValid(P.element)){this._oTaskManager.cancel(t);return this._rejectCreateOverlay(P.element);}var s=P.element.getId();var q=O.getOverlay(s);if(q){o(P.root,q);this._oTaskManager.complete(t);return Promise.resolve(q);}else if(s in this._mPendingOverlays){this._oTaskManager.complete(t);return this._mPendingOverlays[s];}if(typeof P.root==="undefined"){P.root=true;}this._mPendingOverlays[s]=this._createElementOverlay(P).then(function(q){return this._createChildren(q,P).then(function(){this.attachEventOnce("synced",function(){delete this._mPendingOverlays[s];},this);if(this.bIsDestroyed){q.detachEvent("destroyed",this._onElementOverlayDestroyed,this);q.destroy();this._oTaskManager.cancel(t);return Promise.reject(U.createError("DesignTime#createOverlay","while creating overlay, DesignTime instance has been destroyed"));}else if(q.bIsDestroyed){this._oTaskManager.cancel(t);return Promise.reject(U.createError("DesignTime#createOverlay","while creating children overlays, its parent overlay has been destroyed"));}this._aOverlaysCreatedInLastBatch.push(q);this._oTaskManager.complete(t);return q;}.bind(this));}.bind(this)).catch(function(r){var u=U.propagateError(r,"DesignTime#createOverlay",U.printf("Failed attempt to create overlay for '{0}'",s));delete this._mPendingOverlays[s];this._oTaskManager.cancel(t);return Promise.reject(u);}.bind(this));return this._mPendingOverlays[s];};n.prototype._rejectCreateOverlay=function(q){var r;if(!q){r="Cannot create overlay — no element is specified.";}else if(q.bIsDestroyed){r="Cannot create overlay — the element is already destroyed.";}else if(q instanceof M&&!c.isElementInTemplate(q)){r="Element is in a bound aggregation, but not found in the binding template. Skipping overlay creation for element with id='"+q.getId()+"'. Please report to CA-UI5-FL-RTA component.";}else{r=U.printf("Cannot create overlay without a valid element. Expected a descendant of sap.ui.core.Element or sap.ui.core.Component, but {0} was given",U.getObjectType(q));}return Promise.reject(U.createError("DesignTime#createOverlay",r));};n.prototype._createAggregationOverlay=function(s,q,r,I){return new A({aggregationName:s,element:q,visible:!I,isPartOfTemplate:I,designTimeMetadata:new b({data:r}),init:function(t){var u=t.getSource();u.attachEvent("destroyed",this._onAggregationOverlayDestroyed,this);u.attachEvent("applyStylesRequired",this._onApplyStylesRequired,this);}.bind(this),beforeDestroy:function(t){var u=t.getSource();O.deregister(u);u.detachEvent("applyStylesRequired",this._onApplyStylesRequired,this);}.bind(this)});};n.prototype._createElementOverlay=function(P){var q=P.element;function r(s){return new E(s);}return new Promise(function(R,s){r({element:q,isRoot:P.root,visible:typeof P.visible!=="boolean"||P.visible,isPartOfTemplate:P.isPartOfTemplate,metadataScope:this.getScope(),designTimeMetadata:(this.getDesignTimeMetadataFor(q)instanceof a?this.getDesignTimeMetadataFor(q):_(function(t,u,q,v){v=m({},v,t);this._mMetadataOriginal=v;if(u){v=f.propagateMetadataToElementOverlay(v,u,q);}return v;})(this.getDesignTimeMetadataFor(q),P.parentMetadata,q)),init:function(t){var u=t.getSource();R(t.getSource());u.attachEvent("destroyed",this._onElementOverlayDestroyed,this);u.attachEvent("elementDestroyed",this._onElementDestroyed,this);u.attachEvent("selectionChange",this._onElementOverlaySelectionChange,this);u.attachEvent("elementModified",this._onElementModified,this);u.attachEvent("editableChange",this._onEditableChanged,this);u.attachEvent("applyStylesRequired",this._onApplyStylesRequired,this);}.bind(this),initFailed:function(t,u){var v=u.getSource();var w=U.propagateError(u.getParameter("error"),"DesignTime#_createElementOverlay",U.printf("Can't create overlay properly (id='{0}') for '{1}'",v.getId(),t));v.detachEvent("destroyed",this._onElementOverlayDestroyed,this);v.detachEvent("elementDestroyed",this._onElementDestroyed,this);v.detachEvent("applyStylesRequired",this._onApplyStylesRequired,this);v.destroy();s(w);}.bind(this,q.getId())});}.bind(this));};function p(q,r){var s=q.getElement();return r.reduce(function(t,u){var v=c.getAggregationBindingTemplate(s,u);if(v){t[u]=v;}return t;},{});}n.prototype._createChildren=function(q,P){var r=q.getAggregationNames();var s=P.parentMetadata;var t=p(q,r);var u=Object.keys(t);var v=P.isPartOfTemplate!==undefined;var H=!l(t);var I=H&&!v;var w=I?true:P.isPartOfTemplate;var x=I?false:P.isPartOfTemplate;if(H&&w&&!I){r=k(r,u);}return this._createChildrenOverlays(q,s,u,w,t).then(this._createChildrenOverlays.bind(this,q,s,r,x));};n.prototype._createChildrenOverlays=function(q,P,r,I,s){var t=!l(s);if(t&&!I){return Promise.resolve();}return Promise.all(r.map(function(u){var v=q.getElement();var w=v.getMetadata().getName();var x=f.propagateMetadataToAggregationOverlay(q.getDesignTimeMetadata().getAggregation(u),v,P);var y=this._createAggregationOverlay(u,v,x,t);O.register(y);var C;if(t){C=[s[u]];}else{C=c[y.isAssociation()?"getAssociationInstances":"getAggregation"](v,u);}return Promise.all(C.map(function(z,v){return this.createOverlay({element:v,root:false,parentMetadata:x,isPartOfTemplate:I}).catch(function(B){var F=this._enrichChildCreationError(B,v,z,u);L[F.severity](F.message);return F.errorObject;}.bind(this));}.bind(this,w))).then(function(z){z.map(function(B){if(B instanceof E&&!B.bIsDestroyed&&!B.getParent()){y.addChild(B,true);}},this);return y;}.bind(this));},this)).then(function(u){u.forEach(function(v){if(q.bIsDestroyed){v.destroy();}else if(t){q.addAggregationBindingTemplateOverlay(v);}else{q.addChild(v,true);}});});};n.prototype._enrichChildCreationError=function(q,r,P,s){var t="error";var u=U.errorToString(q);if(q.message.includes("Cannot create overlay without a valid element")){t="warning";q=U.createError("DesignTime#_createChildren",U.printf(["Child element in aggregation '{0}' of {1} must be a descendant of sap.ui.core.Element or ","sap.ui.core.Component, but {2} was give. Consider ignoring the aggregation '{0}' ","in the .designtime configuration of the control."].join(""),s,P,U.getObjectType(r)));u=q.toString();}else if(q.message.startsWith("Element is in a bound aggregation")){t="error";u=q.toString();}return{errorObject:q,severity:t,message:u};};n.prototype._destroyOverlaysForElement=function(q){var r=O.getOverlay(q);if(r){r.destroy();}};n.prototype._destroyAllOverlays=function(){this._iterateRootElements(function(r){this._destroyOverlaysForElement(r);},this);};n.prototype._onElementOverlayDestroyed=function(q){if(this._bDestroyPending){return;}var r=q.getSource();this._oTaskManager.cancelBy({type:"applyStyles",overlayId:r.getId()},"overlayId");var s=r.getAssociation("element");if(s in this._mPendingOverlays){this._removeOverlayFromSyncingBatch(r);delete this._mPendingOverlays[s];return;}if(!O.hasOverlays()){d.destroyMutationObserver();d.removeOverlayContainer();}if(r.isSelected()){this.getSelectionManager().remove(r);}this.fireElementOverlayDestroyed({elementOverlay:r});};n.prototype._onElementDestroyed=function(q){var s=q.getParameter("targetId");this.removeRootElement(s);};n.prototype._onAggregationOverlayDestroyed=function(q){this._oTaskManager.cancelBy({type:"applyStyles",overlayId:q.getSource().getId()},"overlayId");if(!O.hasOverlays()){d.removeOverlayContainer();}};n.prototype._onElementOverlaySelectionChange=function(q){var r=q.getSource();var s=q.getParameter("selected");if(s){if(this.getSelectionManager().getSelectionMode()===h.Multi){this.getSelectionManager().add(r);}else{this.getSelectionManager().set(r);}if(!j(this.getSelectionManager().get(),r)){r.setSelected(false);}}else{this.getSelectionManager().remove(r);}};n.prototype._onElementModified=function(q){var P=m({},q.getParameters());var r=q.getSource();P.type=!P.type?q.getId():P.type;switch(P.type){case"addOrSetAggregation":case"insertAggregation":this._onAddAggregation(P.value,P.target,P.name);break;case"setParent":setTimeout(function(){if(!this.bIsDestroyed){this._checkIfOverlayShouldBeDestroyed(P.target);}}.bind(this),0);break;case"propertyChanged":P.id=q.getSource().getId();delete P.type;delete P.target;if(this.getStatus()===D.SYNCING){this.attachEventOnce("synced",P,function(){if(!r.bIsDestroyed){this.fireElementPropertyChanged(arguments[1]);}},this);}else{this.fireElementPropertyChanged(P);}break;default:break;}};n.prototype._onEditableChanged=function(q){var P=m({},q.getParameters());var r=q.getSource();P.id=r.getId();if(this.getStatus()===D.SYNCING){this.attachEventOnce("synced",P,function(){if(!r.bIsDestroyed){this.fireElementOverlayEditableChanged(arguments[1]);}},this);}else{this.fireElementOverlayEditableChanged(P);}};n.prototype._onAddAggregation=function(q,P,s){if(c.isElementValid(q)){var r=O.getOverlay(P);var t=r&&r.getAggregationOverlay(s);if(!t){var u=function(v){var w=v.getParameter("elementOverlay");if(w.getElement().getId()===P.getId()){var t=w.getAggregationOverlay(s);this.detachElementOverlayCreated(u,this);this._addAggregation(q,t);}};this.attachElementOverlayCreated(u,this);}else{this._addAggregation(q,t);}}};n.prototype._addAggregation=function(q,P){var r=O.getOverlay(q);if(!r&&P&&P.getElement()){var t=this._oTaskManager.add({type:"createChildOverlay",element:q});this.createOverlay({element:q,root:false,parentMetadata:P.getDesignTimeMetadata().getData()}).then(function(r){var I=P.insertChild(null,r);if(I===true){this._oTaskManager.add({type:"applyStyles",callbackFn:r.applyStyles.bind(r),overlayId:r.getId()},"overlayId");var s=P.indexOfAggregation("children",r);this.attachEventOnce("synced",r,function(){if(!r.bIsDestroyed){this.fireElementOverlayAdded({id:r.getId(),targetIndex:s,targetId:P.getId(),targetAggregation:P.getAggregationName()});}},this);}this._oTaskManager.complete(t);}.bind(this)).catch(function(s,u,v){this._oTaskManager.cancel(t);var w=U.propagateError(v,"DesignTime#_onAddAggregation",U.printf("Failed to add new element overlay (elementId='{0}') into aggregation overlay (id='{1}')",s,u));if(!q.bIsDestroyed&&!P.bIsDestroyed){L.error(U.errorToString(w));}}.bind(this,q.getId(),P.getId()));}else{if(r&&!this._isElementInRootElements(r)&&r.isRoot()){r.setIsRoot(false);}if(P){P.insertChild(null,r);}else{L.error("No parentAggregationOverlay exists during addAggregation");return;}r.setDesignTimeMetadata(f.propagateMetadataToElementOverlay(r._mMetadataOriginal,P.getDesignTimeMetadata().getData(),q));this.fireElementOverlayMoved({id:r.getId(),targetIndex:P.indexOfAggregation("children",r),targetId:P.getId(),targetAggregation:P.getAggregationName()});}};n.prototype._checkIfOverlayShouldBeDestroyed=function(q){var r=O.getOverlay(q);if(!q.bIsDestroyed&&r&&(!this._isElementInRootElements(q)||q.sParentAggregationName==="dependents")){r.destroy();}};n.prototype._isElementInRootElements=function(q){var F=false;this._iterateRootElements(function(r){if(c.hasAncestor(q,r)){F=true;return false;}return undefined;});return F;};n.prototype._iterateRootElements=function(s,q){var r=this.getRootElements();r.forEach(function(R){var t=c.getElementInstance(R);s.call(q||this,t);},this);};n.prototype._getAllElementOverlaysIn=function(q){var r=[];var s=O.getOverlay(q);if(s){e.iterateOverlayElementTree(s,function(C){if(C.getDesignTimeMetadata()){r.push(C);}});}return r;};n.prototype.setEnabled=function(v){v=!!v;if(this.getEnabled()!==v){this.setProperty("enabled",v);this.fireEnabledChanged({value:v});}};n.prototype.getStatus=function(){return this._sStatus;};return n;});
