/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/rta/plugin/Plugin","sap/ui/dt/Overlay","sap/ui/dt/OverlayRegistry","sap/ui/dt/util/ZIndexManager","sap/ui/dt/Util","sap/ui/core/Core"],function(P,O,a,Z,D,C){"use strict";var R=P.extend("sap.ui.rta.plugin.Resize",{metadata:{library:"sap.ui.rta",properties:{handle:"object",dragging:"boolean"},associations:{},events:{}}});var H="sapUiRtaResizeHandle";var b="sapUiRtaResizeHandleExtension";var F="sapUiRtaFullScreenDiv";var M=15;var r=C.getConfiguration().getRTL();var d=r?-1:1;var B=r?"right":"left";var k=15*d;function g(o){return o.getDomRef().offsetWidth;}function c(){this._oFullScreenDiv=document.createElement("div");this._oFullScreenDiv.className=F;this._oFullScreenDiv.style["z-index"]=Z.getNextZIndex();var o=O.getOverlayContainer()[0];o.append(this._oFullScreenDiv);}function e(){this._oFullScreenDiv.removeEventListener("mouseup",this._fnOnMouseUp);this._oFullScreenDiv.removeEventListener("mousemove",this._fnOnMouseMove);this._oFullScreenDiv.remove();delete this._oFullScreenDiv;}R.prototype._isEditable=function(o){var A=this.getAction(o);if(A&&A.handler){return Promise.resolve(this.hasStableId(o));}return this._checkChangeHandlerAndStableId(o);};R.prototype._createResizeCommand=function(o,m,f){var v=this.getVariantManagementReference(o);return this.getCommandFactory().getCommandFor(m.selectorElement,"resize",m.changeSpecificData,undefined,v).then(function(h){return f.addCommand(h);});};R.prototype._createCompositeCommand=function(o,E,f){var h;return this.getCommandFactory().getCommandFor(E,"composite").then(function(_){h=_;return f.reduce(function(p,m){return p.then(this._createResizeCommand.bind(this,o,m,h));}.bind(this),Promise.resolve());}.bind(this)).then(function(){return h;});};R.prototype._createCommand=function(o,n){var E=o.getElement();var A=this.getAction(o);var h=A.handler;return Promise.resolve().then(function(){if(h){var p={newWidth:n};return h(E,p).then(function(f){if(f.length>0){return this._createCompositeCommand(o,E,f);}return undefined;}.bind(this)).catch(function(v){throw D.propagateError(v,"Resize#handler","Error occured during handler execution","sap.ui.rta.plugin");});}return this._createCompositeCommand(o,E,[{changeSpecificData:{changeType:A.changeType,content:{resizedElementId:E.getId(),newWidth:n}},selectorElement:E}]);}.bind(this)).then(function(f){if(f&&f.getCommands().length>0){this.fireElementModified({command:f});}}.bind(this));};R.prototype._onHandleMouseDown=function(o,E){this.setBusy(true);if(E.detail===2){this._onDoubleClick(o);this.setBusy(false);return;}c.call(this);var A=this.getAction(o);var h=this.getHandle();var f=o.getElement();var i=o.getDomRef();var j=Math.round(i.getBoundingClientRect()[B]);var l=Math.round(h.offsetWidth/2);var m=E.clientX;var n;var N=g(o);h.style[B]=(m-j)*d-l+"px";this.setDragging(true);o.focus();this._fnOnMouseMove=q.bind(this);this._fnOnMouseUp=s.bind(this);if(A.getHandleExtensionHeight){var p=A.getHandleExtensionHeight(f);n=document.createElement("div");n.className=b;n.style["height"]=p+"px";n.style["pointer-events"]="none";}function q(E){if(n){h.append(n);h.extension=n;}N=(E.clientX-j)*d+l;N=this._limitNewWidth(o,N);h.style[B]=N-h.offsetWidth+"px";}function s(){this._finalizeResize(o,N);e.call(this);this.setDragging(false);this.setBusy(false);}this._oFullScreenDiv.addEventListener("mousemove",this._fnOnMouseMove);this._oFullScreenDiv.addEventListener("mouseup",this._fnOnMouseUp);};R.prototype._onDoubleClick=function(o){var A=this.getAction(o);if(A.getDoubleClickWidth){var n=A.getDoubleClickWidth(o.getElement());this._finalizeResize(o,n);}};R.prototype._finalizeResize=function(o,n){var i=g(o);if(n===i){return Promise.resolve();}var f=function(){o.setSelected(true);o.focus();o.detachEvent("geometryChanged",f,this);o.attachEvent("geometryChanged",this._onOverlayGeometryChanged,this);};o.detachEvent("geometryChanged",this._onOverlayGeometryChanged,this);o.attachEvent("geometryChanged",f,this);o.setSelected(false);return this._createCommand(o,n).catch(function(E){f.call(this);throw D.propagateError(E,"Resize","Error occured during resize command creation","sap.ui.rta.plugin");}.bind(this));};R.prototype._limitNewWidth=function(o,n){var A=this.getAction(o);var E=o.getElement();var s=A.getSizeLimits&&A.getSizeLimits(E);var m=s&&s.minimumWidth||M;var i=s&&s.maximumWidth;if(m&&(n<m)){n=m;}if(i&&(n>i)){n=i;}return n;};R.prototype._createHandle=function(E){var o=this.getHandle();var f=a.getOverlay(E.target.id);if(!this.isEnabled([f])){this._removeHandle(false);return;}if(!o&&!this.getDragging()){var h=f.getDomRef();var n=document.createElement("div");n.className=H;h.append(n);n.style[B]=h.clientWidth-n.clientWidth+"px";n.style["z-index"]=Z.getNextZIndex();n.addEventListener("mousedown",this._onHandleMouseDown.bind(this,f));this.setHandle(n);}};R.prototype._removeHandle=function(i){var h=this.getHandle();if(h&&(i||!this.getDragging())){h.remove();this.setDragging(false);this.setHandle(null);}};R.prototype._onOverlayMouseMove=function(E){var o=a.getOverlay(E.target.id);if(o&&o.isSelectable()){this._createHandle(E);}};R.prototype._onOverlayKeyDown=function(E){var o=a.getOverlay(E.target.id);var n;if(E.key==="Escape"){this._removeHandle(true);if(this._oFullScreenDiv){e.call(this);}E.stopImmediatePropagation();return;}if(!E.shiftKey||E.ctrlKey||E.metaKey||E.altKey){return;}var i=g(o);if(E.key==="ArrowLeft"||E.key==="ArrowRight"){var f=E.key==="ArrowLeft"?k*(-1):k;n=this._limitNewWidth(o,i+f);this._finalizeResize(o,n);}};R.prototype._onOverlayMouseLeave=function(){this._removeHandle(false);};R.prototype._onOverlaySelectionChange=function(E){if(E.getParameter("selected")){this._removeHandle(false);E.target={id:E.getParameter("id")};this._createHandle(E);}else{this._removeHandle();}};R.prototype._onOverlayFocus=function(E){var o=a.getOverlay(E.target.id);if(o.getSelected()&&!this.getHandle()){this._createHandle(E);}};R.prototype._onOverlayGeometryChanged=function(E){var o=a.getOverlay(E.getParameter("id"));if(o.getSelected()&&o.hasFocus()){this._removeHandle();this._createHandle(E);}};R.prototype.registerElementOverlay=function(o){if(this.isEnabled([o])){o.attachBrowserEvent("mousemove",this._onOverlayMouseMove,this);o.attachBrowserEvent("mouseleave",this._onOverlayMouseLeave,this);o.attachBrowserEvent("keydown",this._onOverlayKeyDown,this);o.attachBrowserEvent("focus",this._onOverlayFocus,this);o.attachEvent("selectionChange",this._onOverlaySelectionChange,this);o.attachEvent("geometryChanged",this._onOverlayGeometryChanged,this);}P.prototype.registerElementOverlay.apply(this,arguments);};R.prototype.deregisterElementOverlay=function(o){o.detachBrowserEvent("mousemove",this._onOverlayMouseMove,this);o.detachBrowserEvent("mouseleave",this._onOverlayMouseLeave,this);o.detachBrowserEvent("keydown",this._onOverlayKeyDown,this);o.detachBrowserEvent("focus",this._onOverlayFocus,this);o.detachEvent("selectionChange",this._onOverlaySelectionChange,this);o.detachEvent("geometryChanged",this._onOverlayGeometryChanged,this);P.prototype.deregisterElementOverlay.apply(this,arguments);};R.prototype.getActionName=function(){return"resize";};return R;});
