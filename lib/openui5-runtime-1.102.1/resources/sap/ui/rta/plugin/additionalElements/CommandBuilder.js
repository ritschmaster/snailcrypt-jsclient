/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/Log","sap/ui/dt/ElementUtil","sap/ui/dt/OverlayRegistry","sap/ui/dt/Util","sap/ui/fl/Utils","sap/ui/rta/Utils"],function(L,E,O,D,F,U){"use strict";var C={};function g(A,r){var R;A.reveal.elements.some(function(m){if(m.element.getId()===r.getId()){R=m;return false;}return undefined;});return R;}function c(p){var o=p.compositeCommand;var s=p.selectedElement;var P=p.parents;var S=p.siblingElement;var A=p.actions;var I=p.index;var t=p.targetAggregation;var j=p.plugin;return a(s,A,P,j).then(function(r){o.addCommand(r);return b(s,P,S,I,t,j);}).then(function(m){if(m){o.addCommand(m);}else{L.warning("No move action configured for "+P.parent.getMetadata().getName()+", aggregation: "+s.aggregation,"sap.ui.rta");}return o;});}function a(s,A,p,P){var r=E.getElementInstance(s.elementId);var R=O.getOverlay(r);var m=g(A,r);var o=m.designTimeMetadata;var j=m.action;var v;if(R){v=P.getVariantManagementReference(R);}if(j.changeOnRelevantContainer){return P.getCommandFactory().getCommandFor(r,"reveal",{revealedElementId:r.getId(),directParent:p.parent},o,v);}return P.getCommandFactory().getCommandFor(r,"reveal",{},o,v);}function b(s,p,S,I,t,P){var r=E.getElementInstance(s.elementId);var R=O.getOverlay(r);var j=s.sourceAggregation;var o=R.getParentElementOverlay().getElement()||p.parent;var T=p.parent;var k=U.getIndex(p.parent,S,t);var l=U.getIndex(o,r,j)-1;k=I!==undefined?I:E.adjustIndexForMove(o,T,l,k);if(k!==l||p.parent!==r.getParent()||j!==t){var m=O.getOverlay(r)?O.getOverlay(r).getParentAggregationOverlay():p.relevantContainerOverlay;var n=m.getDesignTimeMetadata();var v=P.getVariantManagementReference(R);return P.getCommandFactory().getCommandFor(p.relevantContainer,"move",{movedElements:[{element:r,sourceIndex:l,targetIndex:k}],source:{parent:o,aggregation:j},target:{parent:T,aggregation:t}},n,v);}return Promise.resolve();}function d(o,r){var A=o.getManifestEntry("/sap.ui5/dependencies/libs");return Object.keys(r).some(function(R){return!A[R];});}function e(p,r,P,o){if(r){var j=F.getAppComponentForControl(p.relevantContainer);var l=d(j,r);if(l){var m=j.getManifest();var R=m["sap.app"].id;return o.getCommandFactory().getCommandFor(p.publicParent,"addLibrary",{reference:R,parameters:{libraries:r},appComponent:j},P);}}return Promise.resolve();}function f(p){var o=p.compositeCommand;var A=p.actions.addViaDelegate.action;var r=A.delegateInfo.requiredLibraries;var P=p.parents.parentOverlay.getAggregationOverlay(p.actions.aggregation);var j=P.getDesignTimeMetadata();return e(p.parents,r,j,p.plugin).then(function(k){if(k){o.addCommand(k);}return i(p,j);}).then(function(k){if(k){o.addCommand(k);}return o;});}function h(m){var u="";if(m){var s=m.getEntry?m.getEntry("sap.app"):m["sap.app"];if(s&&s.dataSources&&s.dataSources.mainService&&s.dataSources.mainService.uri){u=s.dataSources.mainService.uri;}}return u;}function i(p,P){var s=p.selectedElement;var m=p.parents;var S=p.siblingElement;var A=p.actions;var I=p.index;var o=p.plugin;var j=A.addViaDelegate.action;var k=j.changeOnRelevantContainer?m.relevantContainer:m.parent;var l=j.changeOnRelevantContainer?m.relevantContainerOverlay:m.parentOverlay;var v=o.getVariantManagementReference(l);var n=U.getIndex(m.parent,S,A.aggregation,P.getData().getIndex);var q="addDelegateProperty";var M=F.getAppComponentForControl(m.parent).getManifest();var r=h(M);return o.getCommandFactory().getCommandFor(m.parent,q,{newControlId:U.createFieldLabelId(k,s.entityType,s.bindingPath),index:I!==undefined?I:n,bindingString:s.bindingPath,entityType:s.entityType,parentId:m.parent.getId(),propertyName:s.name,oDataServiceVersion:s.oDataServiceVersion,oDataServiceUri:r,modelType:j.delegateInfo.modelType,relevantContainerId:m.relevantContainer.getId()},P,v);}C.createCommands=function(p,s,A,I,S,t,P){S.sort(function(o,j){if(o.label>j.label){return-1;}if(o.label<j.label){return 1;}return 0;});if(S.length>0){return P.getCommandFactory().getCommandFor(p.parent,"composite").then(function(o){var j=Promise.resolve();S.forEach(function(k){var m={compositeCommand:o,selectedElement:k,parents:p,siblingElement:s,actions:A,index:I,targetAggregation:t,plugin:P};switch(k.type){case"invisible":j=j.then(c.bind(this,m));break;case"delegate":j=j.then(f.bind(this,m));break;default:L.error("Can't create command for untreated element.type "+k.type);}},this);return j.then(function(){return o;});}.bind(this)).then(function(o){P.fireElementModified({command:o});}).catch(function(m){throw D.propagateError(m,"AdditionalElementsPlugin#_createCommands","Error occured during _createCommands execution","sap.ui.rta.plugin");});}return Promise.resolve();};return C;});
