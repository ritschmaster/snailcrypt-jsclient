/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/dt/plugin/ControlDragDrop","sap/ui/dt/Util","sap/ui/dt/OverlayRegistry","sap/ui/rta/plugin/RTAElementMover","sap/ui/rta/plugin/Plugin","sap/ui/rta/Utils"],function(C,D,O,R,P,U){"use strict";var a=C.extend("sap.ui.rta.plugin.DragDrop",{metadata:{library:"sap.ui.rta",properties:{commandFactory:{type:"object",multiple:false}},events:{dragStarted:{},elementModified:{command:{type:"sap.ui.rta.command.BaseCommand"}}}}});U.extendWith(a.prototype,P.prototype,function(d,s,p){return p!=="getMetadata";});a.prototype.init=function(){C.prototype.init.apply(this,arguments);this.setElementMover(new R({commandFactory:this.getCommandFactory()}));};a.prototype.setCommandFactory=function(c){this.setProperty("commandFactory",c);this.getElementMover().setCommandFactory(c);};a.prototype._isEditable=function(o,p){return this.getElementMover().isEditable(o,p.onRegistration);};a.prototype.registerElementOverlay=function(){C.prototype.registerElementOverlay.apply(this,arguments);P.prototype.registerElementOverlay.apply(this,arguments);};a.prototype.deregisterElementOverlay=function(){C.prototype.deregisterElementOverlay.apply(this,arguments);P.prototype.removeFromPluginsList.apply(this,arguments);};a.prototype.onDragStart=function(o){this.fireDragStarted();C.prototype.onDragStart.apply(this,arguments);this.getSelectedOverlays().forEach(function(o){o.setSelected(false);});o.$().addClass("sapUiRtaOverlayPlaceholder");};a.prototype.onDragEnd=function(o){this.getElementMover().buildMoveCommand().then(function(c){this.fireElementModified({command:c});o.$().removeClass("sapUiRtaOverlayPlaceholder");o.setSelected(true);o.focus();C.prototype.onDragEnd.apply(this,arguments);this._updateRelevantOverlays();}.bind(this)).catch(function(e){throw D.propagateError(e,"DragDrop#onDragEnd","Error accured during onDragEnd execution","sap.ui.rta.plugin");});};a.prototype.onMovableChange=function(){C.prototype.onMovableChange.apply(this,arguments);};a.prototype._updateRelevantOverlays=function(){var p=this.getElementMover().getSourceAndTargetParentInformation();var s=p.sourceParentInformation.parent;var t=p.targetParentInformation.parent;var S=p.sourceParentInformation.aggregation;var T=p.targetParentInformation.aggregation;var b=s&&s.getAggregation(S);var r=[];if(b&&b.length>0){var o=O.getOverlay(b[0]);r=this._getRelevantOverlays(o,S);}if(t&&(t!==s||((t===s)&&(S!==T)))){var c=t&&t.getAggregation(T);if(c&&c.length>1){var i=p.targetParentInformation.index;var d=c[i+1]||c[i-1];var e=O.getOverlay(d);var f=this._getRelevantOverlays(e,T);r=r.concat(f);}}if(r.length>0){r=r.filter(function(g,I,h){return I===h.indexOf(g);});this.evaluateEditable(r,{onRegistration:false});}};return a;});
