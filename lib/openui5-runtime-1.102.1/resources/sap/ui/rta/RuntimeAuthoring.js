/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/strings/capitalize","sap/base/util/UriParameters","sap/base/Log","sap/m/MessageBox","sap/m/MessageToast","sap/ui/thirdparty/jquery","sap/ui/base/ManagedObject","sap/ui/core/BusyIndicator","sap/ui/dt/DesignTime","sap/ui/dt/DOMUtil","sap/ui/dt/ElementUtil","sap/ui/dt/Overlay","sap/ui/dt/OverlayRegistry","sap/ui/dt/Util","sap/ui/events/KeyCodes","sap/ui/fl/write/api/Version","sap/ui/fl/apply/api/FlexRuntimeInfoAPI","sap/ui/fl/apply/api/SmartVariantManagementApplyAPI","sap/ui/fl/write/api/ControlPersonalizationWriteAPI","sap/ui/fl/write/api/FeaturesAPI","sap/ui/fl/write/api/PersistenceWriteAPI","sap/ui/fl/write/api/ReloadInfoAPI","sap/ui/fl/write/api/VersionsAPI","sap/ui/fl/write/api/TranslationAPI","sap/ui/fl/Layer","sap/ui/fl/LayerUtils","sap/ui/fl/registry/Settings","sap/ui/fl/Utils","sap/ui/model/json/JSONModel","sap/ui/performance/Measurement","sap/ui/rta/appVariant/Feature","sap/ui/rta/command/BaseCommand","sap/ui/rta/command/LREPSerializer","sap/ui/rta/command/Stack","sap/ui/rta/service/index","sap/ui/rta/toolbar/Fiori","sap/ui/rta/toolbar/FioriLike","sap/ui/rta/toolbar/Personalization","sap/ui/rta/toolbar/Standalone","sap/ui/rta/util/changeVisualization/ChangeVisualization","sap/ui/rta/util/PluginManager","sap/ui/rta/util/PopupManager","sap/ui/rta/util/ServiceEventBus","sap/ui/rta/util/validateFlexEnabled","sap/ui/rta/Utils","sap/ui/Device"],function(c,U,L,M,a,q,b,B,D,d,E,O,e,f,K,V,F,S,C,g,P,R,h,T,i,j,k,l,J,m,n,o,p,r,s,t,u,v,w,x,y,z,A,G,H,I){"use strict";var N="STARTING";var Q="STARTED";var W="STOPPED";var X="FAILED";var Y="SERVICE_STARTING";var Z="SERVICE_STARTED";var $="SERVICE_FAILED";var _=b.extend("sap.ui.rta.RuntimeAuthoring",{metadata:{library:"sap.ui.rta",associations:{rootControl:{type:"sap.ui.base.ManagedObject"}},properties:{customFieldUrl:"string",showCreateCustomField:"boolean",showToolbars:{type:"boolean",defaultValue:true},triggeredFromDialog:{type:"boolean",defaultValue:false},showWindowUnloadDialog:{type:"boolean",defaultValue:true},commandStack:{type:"any"},flexSettings:{type:"object",defaultValue:{layer:i.CUSTOMER,developerMode:true}},mode:{type:"string",defaultValue:"adaptation"},metadataScope:{type:"string",defaultValue:"default"}},events:{start:{parameters:{editablePluginsCount:{type:"int"}}},stop:{},failed:{},selectionChange:{parameters:{selection:{type:"sap.ui.dt.Overlay[]"}}},modeChanged:{},undoRedoStackModified:{}}},_sAppTitle:null,_dependents:null,_sStatus:W,_bNavigationModeWarningShown:false,constructor:function(){b.apply(this,arguments);this._dependents={};this._mServices={};this._mCustomServicesDictinary={};this._mUShellServices={};this._pElementModified=Promise.resolve();this.addDependent(new y(),"pluginManager");this.addDependent(new z(),"popupManager");if(this.getShowToolbars()){this.getPopupManager().attachOpen(this.onPopupOpen,this);this.getPopupManager().attachClose(this.onPopupClose,this);this.addDependent(new x(),"changeVisualization");}if(window.parent!==window){this.startService("receiver");}this._loadUShellServicesPromise=l.getUShellServices(["URLParsing","AppLifeCycle","CrossApplicationNavigation"]).then(function(f1){this._mUShellServices=f1;}.bind(this));},_RELOAD:{NOT_NEEDED:"NO_RELOAD",VIA_HASH:"CROSS_APP_NAVIGATION",RELOAD_PAGE:"HARD_RELOAD"}});_.prototype._shouldValidateFlexEnabled=function(){var f1=U.fromQuery(window.location.search).get("sap-ui-rta-skip-flex-validation");return k.getInstance().then(function(g1){return!g1.isCustomerSystem()&&f1!=="true";});};_.prototype.addDependent=function(f1,g1,h1){h1=typeof h1==="undefined"?true:!!h1;if(!(g1 in this._dependents)){if(g1&&h1){this["get"+c(g1,0)]=this.getDependent.bind(this,g1);}this._dependents[g1||f1.getId()]=f1;}else{throw f.createError("RuntimeAuthoring#addDependent",f.printf("Can't add dependency with same key '{0}'",g1),"sap.ui.rta");}};_.prototype.getDependent=function(f1){return this._dependents[f1];};_.prototype.getDependents=function(){return this._dependents;};_.prototype.removeDependent=function(f1){delete this._dependents[f1];};_.prototype.onPopupOpen=function(f1){var g1=f1.getParameters().getSource();if(g1.isA("sap.m.Dialog")&&this.getToolbar().type==="fiori"){this.getToolbar().setColor("contrast");}this.getToolbar().bringToFront();};_.prototype.onPopupClose=function(f1){if(f1.getParameters().isA("sap.m.Dialog")){this.getToolbar().setColor();}};_.prototype.setPlugins=function(f1){if(this._sStatus!==W){throw new Error("Cannot replace plugins: runtime authoring already started");}this.getPluginManager().setPlugins(f1);};_.prototype.getPlugins=function(){return this.getPluginManager&&this.getPluginManager()&&this.getPluginManager().getPlugins();};_.prototype.getDefaultPlugins=function(){return this.getPluginManager().getDefaultPlugins(this.getFlexSettings());};_.prototype.setFlexSettings=function(f1){var g1=U.fromQuery(window.location.search);var h1=g1.get("sap-ui-layer");f1=q.extend({},this.getFlexSettings(),f1);if(h1){f1.layer=h1.toUpperCase();}if(f1.scenario||f1.baseId){var i1=l.buildLrepRootNamespace(f1.baseId,f1.scenario,f1.projectId);f1.rootNamespace=i1;f1.namespace=i1+"changes/";}H.setRtaStyleClassName(f1.layer);this.setProperty("flexSettings",f1);};_.prototype.getLayer=function(){return this.getFlexSettings().layer;};_.prototype.getRootControlInstance=function(){if(!this._oRootControl){this._oRootControl=E.getElementInstance(this.getRootControl());}return this._oRootControl;};_.prototype._getTextResources=function(){return sap.ui.getCore().getLibraryResourceBundle("sap.ui.rta");};_.prototype._setVersionsModel=function(f1){this._oVersionsModel=f1;};_.prototype._initVersioning=function(){return h.initialize({control:this.getRootControlInstance(),layer:this.getLayer()}).then(this._setVersionsModel.bind(this));};_.prototype._onPersonalizationChangeCreation=function(){if(this.getMode()==="navigation"&&!this._bNavigationModeWarningShown){this._showMessageToast("MSG_NAVIGATION_MODE_CHANGES_WARNING",{duration:5000});this._bNavigationModeWarningShown=true;}};function a1(f1,g1){if(f1.isA("sap.ui.core.UIComponent")){f1=f1.getRootControl();}if(f1){f1[g1?"addStyleClass":"removeStyleClass"]("sapUiRtaRoot");}}_.prototype.start=function(){var f1;var g1;if(this._sStatus===W){this._sStatus=N;var h1=this.getRootControlInstance();if(!h1){g1=new Error("Root control not found");L.error(g1);return Promise.reject(g1);}return this._loadUShellServicesPromise.then(this._initVersioning.bind(this)).then(this._determineReload.bind(this)).then(function(i1){if(i1){return Promise.reject("Reload triggered");}this._oSerializer=new p({commandStack:this.getCommandStack(),rootControl:this.getRootControl()});this.getPluginManager().preparePlugins(this.getFlexSettings(),this._handleElementModified.bind(this),this.getCommandStack());var j1=this.getPluginManager().getPluginList();f1=new Promise(function(k1,l1){m.start("rta.dt.startup","Measurement of RTA: DesignTime start up");this._oDesignTime=new D({scope:this.getMetadataScope(),plugins:j1});a1(this.getRootControlInstance(),true);this._oDesignTime.addRootElement(this._oRootControl);q(O.getOverlayContainer()).addClass("sapUiRta");if(this.getLayer()===i.USER){q(O.getOverlayContainer()).addClass("sapUiRtaPersonalize");}else{q("body").addClass("sapUiRtaMode");}this._oDesignTime.getSelectionManager().attachChange(function(m1){this.fireSelectionChange({selection:m1.getParameter("selection")});},this);this._oDesignTime.attachEventOnce("synced",function(){k1();m.end("rta.dt.startup","Measurement of RTA: DesignTime start up");},this);this._oDesignTime.attachEventOnce("syncFailed",function(m1){l1(m1.getParameter("error"));});}.bind(this));this._oldUnloadHandler=window.onbeforeunload;window.onbeforeunload=this._onUnload.bind(this);return undefined;}.bind(this)).then(function(){if(this.getShowToolbars()){return this._getToolbarButtonsVisibility().then(this._createToolsMenu.bind(this));}return undefined;}.bind(this)).then(this._onStackModified.bind(this)).then(function(){O.getOverlayContainer().get(0).style.setProperty("--sap-ui-rta-scrollbar-scrollWidth",d.getScrollbarWidth()+"px");O.getOverlayContainer().get(0).style.setProperty("--sap-ui-rta-scrollbar-scrollWidthPlusTwo",d.getScrollbarWidth()+2+"px");return f1;}).then(function(){this.getPopupManager().setRta(this);if(this.getShowToolbars()){return this.getToolbar().show();}return undefined;}.bind(this)).then(function(){if(I.browser.name==="ff"){q(document).on("contextmenu",b1);}}).then(function(){this.fnKeyDown=this._onKeyDown.bind(this);q(document).on("keydown",this.fnKeyDown);this.fnOnPersonalizationChangeCreation=this._onPersonalizationChangeCreation.bind(this);C.attachChangeCreation(this.getRootControlInstance(),this.fnOnPersonalizationChangeCreation);}.bind(this)).then(this._shouldValidateFlexEnabled).then(function(i1){if(i1){G(this);}this._sStatus=Q;this.fireStart({editablePluginsCount:this.getPluginManager().getEditableOverlaysCount()});}.bind(this)).catch(function(g1){if(g1!=="Reload triggered"){this._sStatus=X;this.fireFailed(g1);}if(g1){this.destroy();return Promise.reject(g1);}return undefined;}.bind(this));}return undefined;};function b1(){return false;}_.prototype._getToolbarButtonsVisibility=function(){return g.isPublishAvailable().then(function(f1){return n.isSaveAsAvailable(this.getRootControlInstance(),this.getLayer(),this._oSerializer).then(function(g1){return{publishAvailable:f1,saveAsAvailable:f1&&g1};});}.bind(this));};_.prototype._isOldVersionDisplayed=function(){return h.isOldVersionDisplayed({control:this.getRootControlInstance(),layer:this.getLayer()});};_.prototype._isDraftAvailable=function(){return h.isDraftAvailable({control:this.getRootControlInstance(),layer:this.getLayer()});};function c1(f1){B.hide();var g1=f1.userMessage||f1.stack||f1.message||f1.status||f1;var h1=sap.ui.getCore().getLibraryResourceBundle("sap.ui.rta");L.error("Failed to transfer changes",g1);var i1=h1.getText("MSG_LREP_TRANSFER_ERROR")+"\n"+h1.getText("MSG_ERROR_REASON",g1);M.error(i1,{styleClass:H.getRtaStyleClassName()});}_.prototype.setCommandStack=function(f1){var g1=this.getProperty("commandStack");if(g1){g1.detachModified(this._onStackModified,this);}if(this._oInternalCommandStack){this._oInternalCommandStack.destroy();delete this._oInternalCommandStack;}var h1=this.setProperty("commandStack",f1);if(f1){f1.attachModified(this._onStackModified,this);}if(this.getPluginManager&&this.getPluginManager()){this.getPluginManager().provideCommandStack("settings",f1);}return h1;};_.prototype.getCommandStack=function(){var f1=this.getProperty("commandStack");if(!f1){f1=new r();this._oInternalCommandStack=f1;this.setCommandStack(f1);}return f1;};_.prototype._onStackModified=function(){var f1=this._oVersionsModel.getProperty("/backendDraft");var g1=this._oVersionsModel.getProperty("/displayedVersion")===V.Number.Draft;var h1=this.getCommandStack();var i1=h1.canUndo();if(!this.getShowToolbars()||!i1||this._bUserDiscardedDraft||g1||!f1){return this._modifyStack();}return H.showMessageBox("warning","MSG_DRAFT_DISCARD_AND_CREATE_NEW_DIALOG",{titleKey:"TIT_DRAFT_DISCARD_DIALOG",actions:[M.Action.OK,M.Action.CANCEL],emphasizedAction:M.Action.OK}).then(function(j1){if(j1===M.Action.OK){this._discardDraftConfirmed();}else{this.undo();}}.bind(this));};_.prototype._discardDraftConfirmed=function(){this._bUserDiscardedDraft=true;this._modifyStack();};_.prototype._modifyStack=function(){if(this.getShowToolbars()){var f1=this.getCommandStack();var g1=f1.canUndo();var h1=f1.canRedo();var i1=this._oToolbarControlsModel.getProperty("/translationVisible")&&T.hasTranslationRelevantDirtyChanges({layer:i.CUSTOMER,selector:this.getRootControlInstance()});this._oVersionsModel.setDirtyChanges(g1);this._oToolbarControlsModel.setProperty("/undoEnabled",g1);this._oToolbarControlsModel.setProperty("/redoEnabled",h1);this._oToolbarControlsModel.setProperty("/publishEnabled",this.bInitialPublishEnabled||g1);this._oToolbarControlsModel.setProperty("/restoreEnabled",this.bInitialResetEnabled||g1);this._oToolbarControlsModel.setProperty("/translationEnabled",this.bPersistedDataTranslatable||i1);}this.fireUndoRedoStackModified();return Promise.resolve();};_.prototype._checkToolbarAndExecuteFunction=function(f1,g1){if(this.getShowToolbars()&&this.getToolbar&&this.getToolbar()){return this.getToolbar()[f1](g1);}return undefined;};_.prototype.getSelection=function(){if(this._oDesignTime){return this._oDesignTime.getSelectionManager().get();}return[];};function d1(){return Promise.resolve(this._oDesignTime&&this._oDesignTime.waitForBusyPlugins()).then(function(){return this._pElementModified;}.bind(this));}_.prototype.stop=function(f1,g1){this._checkToolbarAndExecuteFunction("setBusy",true);return d1.call(this).then(this._handleReloadOnExit.bind(this,g1)).then(function(h1){return((f1)?Promise.resolve():this._serializeToLrep(this)).then(this._checkToolbarAndExecuteFunction.bind(this,"hide",f1)).then(function(){this.fireStop();if(h1.reloadMethod&&(h1.reloadMethod!==this._RELOAD.NOT_NEEDED)){h1.deleteMaxLayer=true;h1.onExit=true;h1.triggerHardReload=(h1.reloadMethod===this._RELOAD.RELOAD_PAGE);return this._handleUrlParameterOnExit(h1);}return undefined;}.bind(this));}.bind(this)).catch(c1).then(function(){this._checkToolbarAndExecuteFunction("setBusy",false);this._sStatus=W;q("body").removeClass("sapUiRtaMode");}.bind(this));};_.prototype.restore=function(){return this._onRestore();};_.prototype.transport=function(){return this._onTransport();};_.prototype.undo=function(){return this._onUndo();};_.prototype.redo=function(){return this._onRedo();};_.prototype.canUndo=function(){return this.getCommandStack().canUndo();};_.prototype.canRedo=function(){return this.getCommandStack().canRedo();};_.prototype._onKeyDown=function(f1){var g1=I.os.macintosh;var h1=O.getOverlayContainer().get(0).contains(document.activeElement);var i1=this.getShowToolbars()&&this.getToolbar().getDomRef().contains(document.activeElement);var j1=false;q(".sapUiDtContextMenu").each(function(n1,o1){if(o1.contains(document.activeElement)){j1=true;}});var k1=document.body===document.activeElement;var l1=q(document.activeElement).parents(".sapUiRtaEditableField").length>0;if((h1||i1||j1||k1)&&!l1){var m1=g1?f1.metaKey:f1.ctrlKey;if(f1.keyCode===K.Z&&f1.shiftKey===false&&f1.altKey===false&&m1===true){this._onUndo().then(f1.stopPropagation.bind(f1));}else if(((g1&&f1.keyCode===K.Z&&f1.shiftKey===true)||(!g1&&f1.keyCode===K.Y&&f1.shiftKey===false))&&f1.altKey===false&&m1===true){this._onRedo().then(f1.stopPropagation.bind(f1));}}};_.prototype._onUnload=function(){var f1=this.getCommandStack();var g1=f1.canUndo()||f1.canRedo();if(g1&&this.getShowWindowUnloadDialog()){return this._getTextResources().getText("MSG_UNSAVED_CHANGES");}window.onbeforeunload=this._oldUnloadHandler;return undefined;};_.prototype._saveOnly=function(f1){var g1=f1.getParameter("callback")||function(){};return d1.call(this).then(this._serializeToLrep.bind(this)).then(g1);};_.prototype._serializeAndSave=function(){if(this.getShowToolbars()){this.bPersistedDataTranslatable=this._oToolbarControlsModel.getProperty("/translationEnabled");}var f1=this._oVersionsModel.getProperty("/versioningEnabled")&&this.getLayer()===i.CUSTOMER;return this._oSerializer.saveCommands(f1,this.getLayer(),true);};_.prototype._serializeToLrep=function(){if(!this._bReloadNeeded){return this._oSerializer.needsReload().then(function(f1){this._bReloadNeeded=f1;return this._serializeAndSave();}.bind(this));}return this._serializeAndSave();};_.prototype._onUndo=function(){this.getPluginManager().handleStopCutPaste();return this.getCommandStack().undo();};_.prototype._onRedo=function(){this.getPluginManager().handleStopCutPaste();return this.getCommandStack().redo();};_.prototype._onActivate=function(f1){var g1=f1.getParameter("versionTitle");if(this._isOldVersionDisplayed()&&this._isDraftAvailable()){return H.showMessageBox("warning","MSG_DRAFT_DISCARD_ON_REACTIVATE_DIALOG",{titleKey:"TIT_DRAFT_DISCARD_ON_REACTIVATE_DIALOG",actions:[M.Action.OK,M.Action.CANCEL],emphasizedAction:M.Action.OK}).then(function(h1){if(h1===M.Action.OK){return this._activate(g1);}}.bind(this));}return this._activate(g1);};_.prototype._activate=function(f1){var g1=this.getLayer();var h1=this.getRootControlInstance();return this._serializeAndSave().then(function(){return h.activate({layer:g1,control:h1,title:f1});}).then(function(){this._showMessageToast("MSG_DRAFT_ACTIVATION_SUCCESS");this.bInitialResetEnabled=true;this._oToolbarControlsModel.setProperty("/restoreEnabled",true);this.getCommandStack().removeAllCommands();}.bind(this)).catch(function(i1){H.showMessageBox("error","MSG_DRAFT_ACTIVATION_FAILED",{error:i1});});};_.prototype._handleDiscard=function(){var f1=this.getLayer();var g1={isDraftAvailable:false,layer:f1};_.enableRestart(f1,this.getRootControlInstance());if(!l.getUshellContainer()){this.getCommandStack().removeAllCommands();return this._triggerHardReload(g1);}var h1=true;this.getCommandStack().removeAllCommands();var i1=this._removeVersionParameterForFLP(g1,l.getParsedURLHash(this._getUShellService("URLParsing")),h1);this._triggerCrossAppNavigation(i1);return this.stop(true,true);};_.prototype._onDiscardDraft=function(){return H.showMessageBox("warning","MSG_DRAFT_DISCARD_DIALOG",{actions:[M.Action.OK,M.Action.CANCEL],emphasizedAction:M.Action.OK}).then(function(f1){if(f1===M.Action.OK){return h.discardDraft({layer:this.getLayer(),control:this.getRootControlInstance(),updateState:true}).then(this._handleDiscard.bind(this));}return undefined;}.bind(this));};_.prototype._onSwitchVersion=function(f1){var g1=f1.getParameter("version");var h1=this._oVersionsModel.getProperty("/displayedVersion");if(g1===h1){return;}if(this.canUndo()){this._sSwitchToVersion=g1;H.showMessageBox("warning","MSG_SWITCH_VERSION_DIALOG",{titleKey:"TIT_SWITCH_VERSION_DIALOG",actions:[M.Action.YES,M.Action.NO,M.Action.CANCEL],emphasizedAction:M.Action.YES}).then(function(i1){if(i1===M.Action.YES){this._serializeToLrep(this).then(this._switchVersion.bind(this,this._sSwitchToVersion));}else if(i1===M.Action.NO){this.getCommandStack().removeAllCommands(true);this._switchVersion(this._sSwitchToVersion);}return undefined;}.bind(this));return;}this._switchVersion(g1);};_.prototype._switchVersion=function(f1){_.enableRestart(this.getLayer(),this.getRootControlInstance());if(!l.getUshellContainer()){if(!R.hasVersionParameterWithValue({value:f1},this._getUShellService("URLParsing"))){var g1={versionSwitch:true,version:f1};return this._triggerHardReload(g1);}return this._reloadPage();}var h1=l.getParsedURLHash(this._getUShellService("URLParsing"));h.loadVersionForApplication({control:this.getRootControlInstance(),layer:this.getLayer(),version:f1});var i1=h1.params[V.UrlParameter];if(i1&&i1[0]===f1&&this._getUShellService("AppLifeCycle")){this._getUShellService("AppLifeCycle").reloadCurrentApp();}else{h1.params[V.UrlParameter]=f1;this._triggerCrossAppNavigation(h1);}return undefined;};_.prototype._setUriParameter=function(f1){document.location.search=f1;};_.prototype._createToolsMenu=function(f1){if(!this.getDependent("toolbar")){var g1=this.getLayer()===i.USER;var h1={rtaInformation:{flexSettings:this.getFlexSettings(),rootControl:this.getRootControlInstance(),commandStack:this.getCommandStack()},textResources:this._getTextResources(),restore:this._onRestore.bind(this),exit:this.stop.bind(this,false,g1),save:this._saveOnly.bind(this)};if(!g1){h1.transport=this._onTransport.bind(this);h1.publishVersion=this._onPublishVersion.bind(this);h1.undo=this._onUndo.bind(this);h1.redo=this._onRedo.bind(this);h1.modeChange=this._onModeChange.bind(this);h1.activate=this._onActivate.bind(this);h1.discardDraft=this._onDiscardDraft.bind(this);h1.switchVersion=this._onSwitchVersion.bind(this);h1.openChangeCategorySelectionPopover=this.getChangeVisualization?this.getChangeVisualization().openChangeCategorySelectionPopover.bind(this.getChangeVisualization()):function(){};}var i1;if(g1){i1=new v(h1);}else if(H.isOriginalFioriToolbarAccessible()){i1=new t(h1);}else if(H.getFiori2Renderer()){i1=new u(h1);}else{i1=new w(h1);}this.addDependent(i1,"toolbar");return Promise.all([i1.onFragmentLoaded(),g.isKeyUserTranslationEnabled(this.getLayer())]).then(function(j1){var k1=j1[1];var l1=f1.saveAsAvailable;var m1=l1&&n.isOverviewExtended();var n1=U.fromURL(window.location.href);var o1;o1=!n1.has("fiori-tools-rta-mode")||n1.get("fiori-tools-rta-mode")==="false";this.bPersistedDataTranslatable=false;this._oToolbarControlsModel=new J({undoEnabled:false,redoEnabled:false,translationVisible:k1,translationEnabled:this.bPersistedDataTranslatable,publishVisible:f1.publishAvailable,publishEnabled:this.bInitialPublishEnabled,restoreEnabled:this.bInitialResetEnabled,appVariantsOverviewVisible:l1&&m1,appVariantsOverviewEnabled:l1&&m1,saveAsVisible:l1,saveAsEnabled:false,manageAppsVisible:l1&&!m1,manageAppsEnabled:l1&&!m1,modeSwitcher:this.getMode(),visualizationButtonVisible:o1});var p1=new Promise(function(r1){if(!k1){r1();return;}T.getSourceLanguages({selector:this.getRootControlInstance(),layer:this.getLayer()}).then(function(s1){this.bPersistedDataTranslatable=s1.length>0;this._oToolbarControlsModel.setProperty("/translationEnabled",this.bPersistedDataTranslatable);}.bind(this)).finally(r1);}.bind(this));var q1=new Promise(function(r1){if(!l1){r1();return;}n.isManifestSupported().then(function(s1){this._oToolbarControlsModel.setProperty("/saveAsEnabled",s1);this._oToolbarControlsModel.setProperty("/appVariantsOverviewEnabled",s1);this._oToolbarControlsModel.setProperty("/manageAppsEnabled",s1);}.bind(this)).finally(r1);}.bind(this));this.getToolbar().setModel(this._oVersionsModel,"versions");this.getToolbar().setModel(this._oToolbarControlsModel,"controls");return Promise.all([p1,q1]);}.bind(this));}return Promise.resolve();};_.prototype.destroy=function(){q.map(this._dependents,function(f1,g1){this.removeDependent(g1);f1.destroy(true);}.bind(this));Object.keys(this._mServices).forEach(function(f1){this.stopService(f1);},this);if(this._oDesignTime){this._oDesignTime.destroy();this._oDesignTime=null;q(document).off("keydown",this.fnKeyDown);if(this.fnOnPersonalizationChangeCreation){C.detachChangeCreation(this.getRootControlInstance(),this.fnOnPersonalizationChangeCreation);}}if(this.getRootControlInstance()){a1(this.getRootControlInstance(),false);}this.setCommandStack(null);if(this._oServiceEventBus){this._oServiceEventBus.destroy();}if(I.browser.name==="ff"){q(document).off("contextmenu",b1);}window.onbeforeunload=this._oldUnloadHandler;b.prototype.destroy.apply(this,arguments);};_.prototype._onPublishVersion=function(){this.getPluginManager().handleStopCutPaste();return h.publish({selector:this.getRootControlInstance(),styleClass:H.getRtaStyleClassName(),layer:this.getLayer(),version:this._oVersionsModel.getProperty("/displayedVersion")}).then(function(f1){if(f1!=="Error"&&f1!=="Cancel"){a.show(f1);}});};_.prototype._onTransport=function(){this.getPluginManager().handleStopCutPaste();B.show(500);return this._serializeToLrep().then(function(){B.hide();var f1=l.isVariantByStartupParameter(this._oRootControl);var g1=S.isApplicationVariant({control:this._oRootControl})&&!f1;return(g1?n.getAppVariantDescriptor(this._oRootControl):Promise.resolve()).then(function(h1){var i1=[];if(h1){i1.push(h1);}return P.publish({selector:this.getRootControlInstance(),styleClass:H.getRtaStyleClassName(),layer:this.getLayer(),appVariantDescriptors:i1}).then(function(j1){if(j1!=="Error"&&j1!=="Cancel"){a.show(j1);if(this.getShowToolbars()){P.getResetAndPublishInfo({selector:this.getRootControlInstance(),layer:this.getLayer()}).then(function(k1){this._oToolbarControlsModel.setProperty("/publishEnabled",k1.isPublishEnabled);this._oToolbarControlsModel.setProperty("/restoreEnabled",k1.isResetEnabled);}.bind(this));}}}.bind(this));}.bind(this));}.bind(this))["catch"](c1);};_.prototype._deleteChanges=function(){var f1=this.getLayer();var g1=l.getAppComponentForControl(this.getRootControlInstance());return P.reset({selector:g1,layer:f1}).then(function(){this.getCommandStack().removeAllCommands(true);R.removeInfoSessionStorage(g1);var h1={isDraftAvailable:R.hasVersionParameterWithValue({value:f1},this._getUShellService("URLParsing")),layer:f1,deleteMaxLayer:false,triggerHardReload:true};return this._handleUrlParameterOnExit(h1);}.bind(this)).catch(function(h1){if(h1!=="cancel"){H.showMessageBox("error","MSG_RESTORE_FAILED",{error:h1});}});};_.prototype._reloadPage=function(){window.location.reload();};_.prototype._showMessageToast=function(f1,g1){var h1=this._getTextResources().getText(f1);a.show(h1,g1||{});};_.needsRestart=function(f1){return!!window.sessionStorage.getItem("sap.ui.rta.restart."+f1);};_.enableRestart=function(f1,g1){var h1=F.getFlexReference({element:g1});var i1=h1||true;window.sessionStorage.setItem("sap.ui.rta.restart."+f1,i1);};_.disableRestart=function(f1){window.sessionStorage.removeItem("sap.ui.rta.restart."+f1);};_.prototype._onRestore=function(){var f1=this.getLayer();var g1=f1===i.USER?"FORM_PERS_RESET_MESSAGE_PERSONALIZATION":"FORM_PERS_RESET_MESSAGE";var h1=f1===i.USER?"BTN_RESTORE":"FORM_PERS_RESET_TITLE";this.getPluginManager().handleStopCutPaste();return H.showMessageBox("warning",g1,{titleKey:h1,actions:[M.Action.OK,M.Action.CANCEL],emphasizedAction:M.Action.OK}).then(function(i1){if(i1===M.Action.OK){_.enableRestart(f1,this.getRootControlInstance());return this._deleteChanges();}return undefined;}.bind(this));};_.prototype._scheduleOnCreated=function(f1,g1){function h1(i1){var j1=i1.getParameter("elementOverlay");if(j1.getElement().getId()===f1){this._oDesignTime.detachEvent("elementOverlayCreated",h1,this);g1(j1);}}this._oDesignTime.attachEvent("elementOverlayCreated",h1,this);};_.prototype._scheduleOnCreatedAndVisible=function(f1,g1){function h1(j1){var k1=j1.getSource();if(k1.getGeometry()&&k1.getGeometry().visible){k1.detachEvent("geometryChanged",h1);g1(k1);}}function i1(j1){if(!j1.getGeometry()||!j1.getGeometry().visible){j1.attachEvent("geometryChanged",h1);}else{g1(j1);}}this._scheduleOnCreated(f1,function(j1){if(j1.isRendered()){i1(j1);}else{j1.attachEventOnce("afterRendering",function(k1){i1(k1.getSource());});}});};_.prototype._scheduleRenameOnCreatedContainer=function(f1,g1){var h1=function(i1){i1.setSelected(true);this.getPluginManager().getPlugin("rename").startEdit(i1);}.bind(this);this._scheduleOnCreatedAndVisible(g1,function(i1){var j1=this.getPluginManager().getPlugin("createContainer").getCreatedContainerId(f1,i1.getElement().getId());var k1=e.getOverlay(j1);if(k1){h1(k1);}else{this._scheduleOnCreatedAndVisible(j1,h1);}}.bind(this));};_.prototype._handleElementModified=function(f1){var g1=f1.getParameter("command");var h1=f1.getParameter("newControlId");var i1=f1.getParameter("action");this._pElementModified=this._pElementModified.then(function(){this.getPluginManager().handleStopCutPaste();if(g1 instanceof o){if(h1){this._scheduleOnCreated(h1,function(j1){var k1=j1.getDesignTimeMetadata();var l1=k1.getData().select;if(typeof l1==="function"){l1(j1.getElement());}});if(i1){this._scheduleRenameOnCreatedContainer(i1,h1);}}return this.getCommandStack().pushAndExecute(g1).catch(function(j1){if(j1&&j1.message&&j1.message.indexOf("The following Change cannot be applied because of a dependency")>-1){H.showMessageBox("error","MSG_DEPENDENCY_ERROR",{error:j1});}L.error("sap.ui.rta: "+j1.message);});}}.bind(this));return this._pElementModified;};_.prototype._buildNavigationArguments=function(f1){return{target:{semanticObject:f1.semanticObject,action:f1.action,context:f1.contextRaw},params:f1.params,appSpecificRoute:f1.appSpecificRoute,writeHistory:false};};_.prototype._triggerCrossAppNavigation=function(f1){if((this.getLayer()!==i.USER)&&this._getUShellService("CrossApplicationNavigation")){this._getUShellService("CrossApplicationNavigation").toExternal(this._buildNavigationArguments(f1));return true;}return false;};_.prototype._removeVersionParameterForFLP=function(f1,g1,h1){var i1=this.getLayer();if(i1===i.USER){return g1;}var j1=l.getParameter(V.UrlParameter,this._getUShellService("URLParsing"));if(j1){delete g1.params[V.UrlParameter];}else if((this._isDraftAvailable()||h1)&&!f1.hasHigherLayerChanges&&this._getUShellService("AppLifeCycle")){this._getUShellService("AppLifeCycle").reloadCurrentApp();}return g1;};_.prototype._removeMaxLayerParameterForFLP=function(f1,g1){if(f1.deleteMaxLayer&&f1.hasHigherLayerChanges){delete g1.params[j.FL_MAX_LAYER_PARAM];}return g1;};_.prototype._handleUrlParameterOnExit=function(f1){if(!l.getUshellContainer()){return this._triggerHardReload(f1);}var g1=l.getParsedURLHash(this._getUShellService("URLParsing"));if(!g1){return undefined;}if(f1.hasHigherLayerChanges||f1.hasVersionUrlParameter){g1=this._removeMaxLayerParameterForFLP(f1,g1);g1=this._removeVersionParameterForFLP(f1,g1,false);this._triggerCrossAppNavigation(g1);}else{this._getUShellService("AppLifeCycle").reloadCurrentApp();}if(f1.triggerHardReload){this._reloadPage();}return undefined;};_.prototype._getReloadMessageOnStart=function(f1){var g1;var h1=f1.layer===i.CUSTOMER;if(f1.hasHigherLayerChanges&&f1.isDraftAvailable){g1=h1?"MSG_VIEWS_OR_PERSONALIZATION_AND_DRAFT_EXISTS":"MSG_HIGHER_LAYER_CHANGES_AND_DRAFT_EXISTS";}else if(f1.hasHigherLayerChanges&&f1.allContexts){g1="MSG_RESTRICTED_CONTEXT_EXIST_AND_PERSONALIZATION";}else if(f1.hasHigherLayerChanges){g1=h1?"MSG_PERSONALIZATION_OR_PUBLIC_VIEWS_EXISTS":"MSG_HIGHER_LAYER_CHANGES_EXIST";}else if(f1.isDraftAvailable){g1="MSG_DRAFT_EXISTS";}else if(f1.allContexts){g1="MSG_RESTRICTED_CONTEXT_EXIST";}return g1;};_.prototype._getReloadMessageOnExit=function(f1){var g1=f1.layer===i.CUSTOMER;if(f1.hasHigherLayerChanges){if(!g1){return"MSG_RELOAD_WITH_ALL_CHANGES";}if(f1.isDraftAvailable){return"MSG_RELOAD_WITH_VIEWS_PERSONALIZATION_AND_WITHOUT_DRAFT";}if(f1.allContexts){return"MSG_RELOAD_WITH_PERSONALIZATION_AND_RESTRICTED_CONTEXT";}return"MSG_RELOAD_WITH_PERSONALIZATION_AND_VIEWS";}if(f1.initialDraftGotActivated){return"MSG_RELOAD_ACTIVATED_DRAFT";}if(f1.isDraftAvailable){return"MSG_RELOAD_WITHOUT_DRAFT";}if(f1.changesNeedReload){return"MSG_RELOAD_NEEDED";}if(f1.allContexts){return"MSG_RELOAD_WITHOUT_ALL_CONTEXT";}return undefined;};_.prototype._handleReloadMessageBoxOnExit=function(f1){var g1=this._getReloadMessageOnExit(f1);if(g1){return H.showMessageBox("information",g1,{titleKey:"HEADER_RELOAD_NEEDED"});}return Promise.resolve();};_.prototype._triggerReloadOnStart=function(f1){if(this._getUShellService("CrossApplicationNavigation")&&this._oVersionsModel.getProperty("/versioningEnabled")){if(f1.isDraftAvailable){h.loadDraftForApplication({control:f1.selector,layer:f1.layer});}else{h.loadVersionForApplication({control:f1.selector,layer:f1.layer,allContexts:f1.allContexts});}}var g1=this._getReloadMessageOnStart(f1);if(!g1){return Promise.resolve();}return(this.getFlexSettings().developerMode?Promise.resolve():H.showMessageBox("information",g1)).then(function(){_.enableRestart(f1.layer,this.getRootControlInstance());if(f1.allContexts&&!f1.hasHigherLayerChanges&&!f1.isDraftAvailable&&this._getUShellService("AppLifeCycle")){this._getUShellService("AppLifeCycle").reloadCurrentApp();}if(l.getUshellContainer()){var h1=R.handleParametersOnStart(f1);return this._triggerCrossAppNavigation(h1);}return this._triggerHardReload(f1);}.bind(this));};_.prototype._determineReload=function(){var f1={hasHigherLayerChanges:false,isDraftAvailable:false,layer:this.getLayer(),selector:this.getRootControlInstance(),ignoreMaxLayerParameter:false,includeCtrlVariants:true,URLParsingService:this._getUShellService("URLParsing")};return R.getReloadReasonsForStart(f1).then(function(f1){var g1=P.getResetAndPublishInfoFromSession(f1.selector);this.bInitialResetEnabled=!!g1.isResetEnabled;this.bInitialPublishEnabled=!!g1.isPublishEnabled;if(f1.hasHigherLayerChanges||f1.isDraftAvailable||f1.allContexts){return this._triggerReloadOnStart(f1);}return undefined;}.bind(this));};_.prototype._triggerHardReload=function(f1){f1.parameters=document.location.search;f1.URLParsingService=this._getUShellService("URLParsing");var g1=R.handleUrlParametersForStandalone(f1);if(document.location.search!==g1){this._setUriParameter(g1);return Promise.resolve();}return this._reloadPage();};_.prototype._handleReloadOnExit=function(f1){if(f1){return Promise.resolve({reloadMethod:this._RELOAD.NOT_NEEDED});}var g1=this._bReloadNeeded?Promise.resolve(this._bReloadNeeded):this._oSerializer.needsReload();return g1.then(function(h1){var i1={layer:this.getLayer(),selector:this.getRootControlInstance(),changesNeedReload:h1,isDraftAvailable:this._oVersionsModel.getProperty("/draftAvailable"),versioningEnabled:this._oVersionsModel.getProperty("/versioningEnabled"),activeVersion:this._oVersionsModel.getProperty("/activeVersion"),URLParsingService:this._getUShellService("URLParsing")};i1=R.getReloadMethod(i1);return this._handleReloadMessageBoxOnExit(i1).then(function(){return i1;});}.bind(this));};_.prototype._onModeChange=function(f1){this.setMode(f1.getParameter("item").getKey());};_.prototype.setMode=function(f1){var g1=this.getMode();if(g1!==f1){var h1=this.getChangeVisualization&&this.getChangeVisualization();if(f1==="visualization"||g1==="visualization"){h1.triggerModeChange(this.getRootControl(),this.getToolbar());}var i1=this.getPluginManager().getPlugin("tabHandling");var j1=this.getPluginManager().getPlugin("selection");if(g1==="navigation"||f1==="navigation"){this._oDesignTime.setEnabled(f1!=="navigation");i1[(f1==="navigation")?"restoreTabIndex":"removeTabIndex"]();}if(g1==="adaptation"){this.getPluginManager().handleStopCutPaste();}i1[(f1==="adaptation")?"restoreOverlayTabIndex":"removeOverlayTabIndex"]();j1.setIsActive(!(f1==="visualization"));O.getOverlayContainer().toggleClass("sapUiRtaVisualizationMode",(f1==="visualization"));if(f1==="visualization"){q(".sapUiDtOverlayMovable").css("cursor","default");}else{q(".sapUiDtOverlayMovable").css("cursor","move");}this._oToolbarControlsModel.setProperty("/modeSwitcher",f1);this.setProperty("mode",f1);this.fireModeChanged({mode:f1});}};_.prototype.setMetadataScope=function(f1){if(this._sStatus!==W){L.error("sap.ui.rta: Failed to set metadata scope on RTA instance after RTA is started");return;}this.setProperty("metadataScope",f1);};function e1(f1){if(s.hasOwnProperty(f1)){return s[f1].replace(/\./g,"/");}return undefined;}_.prototype.startService=function(f1){if(this._sStatus!==Q){return new Promise(function(i1,j1){this.attachEventOnce("start",i1);this.attachEventOnce("failed",j1);}.bind(this)).then(function(){return this.startService(f1);}.bind(this),function(){return Promise.reject(f.createError("RuntimeAuthoring#startService",f.printf("Can't start the service '{0}' while RTA has been failed during a startup",f1),"sap.ui.rta"));});}var g1=e1(f1);var h1;if(!g1){return Promise.reject(f.createError("RuntimeAuthoring#startService",f.printf("Unknown service. Can't find any registered service by name '{0}'",f1),"sap.ui.rta"));}h1=this._mServices[f1];if(h1){switch(h1.status){case Z:{return Promise.resolve(h1.exports);}case Y:{return h1.initPromise;}case $:{return h1.initPromise;}default:{return Promise.reject(f.createError("RuntimeAuthoring#startService",f.printf("Unknown service status. Service name = '{0}'",f1),"sap.ui.rta"));}}}else{this._mServices[f1]=h1={status:Y,location:g1,initPromise:new Promise(function(i1,j1){sap.ui.require([g1],function(k1){h1.factory=k1;if(!this._oServiceEventBus){this._oServiceEventBus=new A();}f.wrapIntoPromise(k1)(this,this._oServiceEventBus.publish.bind(this._oServiceEventBus,f1)).then(function(l1){if(this.bIsDestroyed){throw f.createError("RuntimeAuthoring#startService",f.printf("RuntimeAuthoring instance is destroyed while initialising the service '{0}'",f1),"sap.ui.rta");}if(!q.isPlainObject(l1)){throw f.createError("RuntimeAuthoring#startService",f.printf("Invalid service format. Service should return simple javascript object after initialisation. Service name = '{0}'",f1),"sap.ui.rta");}h1.service=l1;h1.exports={};if(Array.isArray(l1.events)&&l1.events.length>0){q.extend(h1.exports,{attachEvent:this._oServiceEventBus.subscribe.bind(this._oServiceEventBus,f1),detachEvent:this._oServiceEventBus.unsubscribe.bind(this._oServiceEventBus,f1),attachEventOnce:this._oServiceEventBus.subscribeOnce.bind(this._oServiceEventBus,f1)});}var m1=l1.exports||{};q.extend(h1.exports,Object.keys(m1).reduce(function(n1,o1){var p1=m1[o1];n1[o1]=typeof p1==="function"?f.waitForSynced(this._oDesignTime,p1):p1;return n1;}.bind(this),{}));h1.status=Z;i1(Object.freeze(h1.exports));}.bind(this)).catch(j1);}.bind(this),function(k1){h1.status=$;j1(f.propagateError(k1,"RuntimeAuthoring#startService",f.printf("Can't load service '{0}' by its name: {1}",f1,g1),"sap.ui.rta"));});}.bind(this)).catch(function(i1){h1.status=$;return Promise.reject(f.propagateError(i1,"RuntimeAuthoring#startService",f.printf("Error during service '{0}' initialisation.",f1),"sap.ui.rta"));})};return h1.initPromise;}};_.prototype.stopService=function(f1){var g1=this._mServices[f1];if(g1){if(g1.status===Z){if(typeof g1.service.destroy==="function"){g1.service.destroy();}}delete this._mServices[f1];}else{throw f.createError("RuntimeAuthoring#stopService",f.printf("Can't destroy service: unable to find service with name '{0}'",f1),"sap.ui.rta");}};_.prototype.getService=function(f1){return this.startService(f1);};_.prototype._getUShellService=function(f1){return l.getUshellContainer()&&this._mUShellServices[f1];};return _;});
