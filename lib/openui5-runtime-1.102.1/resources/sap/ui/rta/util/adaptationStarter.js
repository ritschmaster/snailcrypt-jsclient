/*
 * ! OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/Log","sap/ui/core/Control","sap/ui/core/UIComponent","sap/ui/fl/write/api/FeaturesAPI","sap/ui/fl/write/api/PersistenceWriteAPI","sap/ui/fl/Layer","sap/ui/fl/Utils","sap/ui/rta/util/showMessageBox","sap/ui/rta/RuntimeAuthoring"],function(L,C,U,F,P,a,b,s,R){"use strict";function c(l){if(a.CUSTOMER===l){return F.isKeyUser().then(function(i){if(!i){var E=Error("Key user rights have not been granted to the current user");E.reason="isKeyUser";throw E;}});}return Promise.resolve();}function d(A){var m=A.getManifest()||{};var f=m["sap.ui5"]&&m["sap.ui5"].flexEnabled;if(f===false){var E=Error("This app is not enabled for key user adaptation");E.reason="flexEnabled";throw E;}}function e(o,l,f,g,h){var r;return Promise.resolve().then(function(){if(!(o.rootControl instanceof C)&&!(o.rootControl instanceof U)){var E=Error("An invalid root control was passed");E.reason="rootControl";throw E;}o.rootControl=b.getAppComponentForControl(o.rootControl);}).then(c.bind(undefined,o.flexSettings.layer)).then(function(){return d(o.rootControl);}).then(function(){r=new R(o);if(f){r.attachEvent("start",f);}if(g){r.attachEvent("failed",g);}var O=h||function(){r.destroy();};r.attachEvent("stop",O);if(l){return l(r);}}).then(function(){return r.start();}).then(function(){if(o.flexSettings.layer==="CUSTOMER"){var p={oComponent:o.rootControl,selector:o.rootControl,invalidateCache:false,includeVariants:true,includeCtrlVariants:true,currentLayer:a.CUSTOMER};P.getChangesWarning(p).then(function(w){if(w.showWarning){var i=sap.ui.getCore().getLibraryResourceBundle("sap.ui.rta");var m=w.warningType==="mixedChangesWarning"?{text:"MSG_ADAPTATION_STARTER_MIXED_CHANGES_WARNING",title:"TIT_ADAPTATION_STARTER_MIXED_CHANGES_TITLE"}:{text:"MSG_ADAPTATION_STARTER_NO_CHANGES_IN_P_WARNING",title:"TIT_ADAPTATION_STARTER_NO_CHANGES_IN_P_TITLE"};s(i.getText(m.text),{title:i.getText(m.title)},"warning");}});}return r;}).catch(function(E){if(E!=="Reload triggered"){L.error("UI Adaptation could not be started",E.message);}throw E;});}return e;});
