/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/core/Fragment","sap/base/util/restricted/_difference","sap/base/util/deepEqual","sap/base/Log","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/Control","sap/ui/dt/OverlayRegistry","sap/ui/dt/ElementUtil","sap/ui/fl/apply/_internal/changes/Utils","sap/ui/fl/write/api/ChangesWriteAPI","sap/ui/fl/write/api/PersistenceWriteAPI","sap/ui/fl/Layer","sap/ui/fl/Utils","sap/ui/model/resource/ResourceModel","sap/ui/model/json/JSONModel","sap/ui/rta/util/changeVisualization/ChangeIndicator","sap/ui/rta/util/changeVisualization/ChangeIndicatorRegistry"],function(F,d,a,L,J,C,O,E,b,c,P,e,f,R,g,h,i){"use strict";var V={add:["createContainer","addDelegateProperty","reveal","addIFrame"],move:["move"],rename:["rename"],combinesplit:["combine","split"],remove:["remove"]};var j="all";var k={all:"sap-icon://show",add:"sap-icon://add",move:"sap-icon://move",rename:"sap-icon://edit",combinesplit:"sap-icon://combine",remove:"sap-icon://less"};function _(){var p=this.getPopover();if(p&&p.isOpen()){p.close();}}var l=C.extend("sap.ui.rta.util.changeVisualization.ChangeVisualization",{metadata:{library:"sap.ui.rta",properties:{rootControlId:{type:"string"},isActive:{type:"boolean",defaultValue:false}},aggregations:{popover:{type:"sap.m.Popover",multiple:false}}},constructor:function(){C.prototype.constructor.apply(this,arguments);this._oChangeIndicatorRegistry=new i({commandCategories:V});this._oTextBundle=sap.ui.getCore().getLibraryResourceBundle("sap.ui.rta");this.setModel(new R({bundle:this._oTextBundle}),"i18n");this._oChangeVisualizationModel=new g({active:this.getIsActive()});this._oChangeVisualizationModel.setDefaultBindingMode("OneWay");this._sSelectedCommandCategory="all";this._bSetModeChanged=false;this._fnOnClickHandler=_.bind(this);}});l.prototype.setRootControlId=function(r){if(this.getRootControlId()&&this.getRootControlId()!==r){this._reset();}this.setProperty("rootControlId",r);};l.prototype._getComponent=function(){return f.getAppComponentForControl(E.getElementInstance(this.getRootControlId()));};l.prototype.setIsActive=function(A){if(A===this.getIsActive()){return;}this.setProperty("isActive",A);if(this._oChangeVisualizationModel){this._updateVisualizationModel({active:A});}};l.prototype.exit=function(){this._oChangeIndicatorRegistry.destroy();this._toggleRootOverlayClickHandler(false);};l.prototype._reset=function(){this._oChangeIndicatorRegistry.reset();};l.prototype._updateVisualizationModelMenuData=function(){var v=this._oChangeVisualizationModel.getData().visualizedChanges;var H=[];var r=this._oChangeIndicatorRegistry.getChanges();r.forEach(function(o){var n=v.find(function(n){return o.change.getId()===n.id;});if(!n&&!o.dependent){H.push(o);}});var m=Object.keys(V).map(function(s){var t=this._getCommandCategoryLabel(s,this._getChangesForCommandCategory(s,v).length);return{key:s,count:this._getChangesForCommandCategory(s,v).length,title:t,icon:k[s]};}.bind(this));m.unshift({key:j,count:this._getChangesForCommandCategory(j,v).length,title:this._getCommandCategoryLabel(j,this._getChangesForCommandCategory(j,v).length),icon:k[j]});this._updateVisualizationModel({commandCategories:m,hiddenChanges:H,popupInfoMessage:this._oTextBundle.getText("MSG_CHANGEVISUALIZATION_HIDDEN_CHANGES_INFO",[H.length])});};l.prototype._getChangesForCommandCategory=function(s,m){return m.filter(function(o){return s===j?o.commandCategory!==undefined:s===o.commandCategory;});};l.prototype._getCommandCategoryLabel=function(s,m){var n="TXT_CHANGEVISUALIZATION_OVERVIEW_"+s.toUpperCase();return this._oTextBundle.getText(n,[m]);};l.prototype._getCommandCategoryButton=function(s){var B="BTN_CHANGEVISUALIZATION_OVERVIEW_"+s.toUpperCase();return this._oTextBundle.getText(B);};l.prototype.openChangeCategorySelectionPopover=function(o){if(!this._oToolbarButton){this._oToolbarButton=sap.ui.getCore().byId(o.getParameter("id"));}var p=this.getPopover();if(!p){F.load({name:"sap.ui.rta.util.changeVisualization.ChangeIndicatorCategorySelection",id:this._getComponent().createId("changeVisualization_changesListPopover"),controller:this}).then(function(p){this._oToolbarButton.addDependent(p);p.setModel(this._oChangeVisualizationModel,"visualizationModel");p.openBy(this._oToolbarButton);this.setPopover(p);}.bind(this));return;}if(p.isOpen()){p.close();}else{p.openBy(this._oToolbarButton);}};l.prototype.onCommandCategorySelection=function(o){var s=o.getSource().getBindingContext("visualizationModel").getObject().key;return this._selectCommandCategory(s);};l.prototype._selectCommandCategory=function(s){this._sSelectedCommandCategory=s;var r=this._oChangeIndicatorRegistry.getChanges();var m=this._getChangesForCommandCategory(s,r);var n=this._getCommandCategoryButton(s);this._updateVisualizationModel({commandCategory:s,commandCategoryText:n});return Promise.all(m.map(function(o){return this._getVisualizationInfo(o).then(function(v){this._oChangeIndicatorRegistry.addVisualizationInfo(o.change.getId(),v);}.bind(this));}.bind(this))).then(function(){this._updateChangeIndicators();this._setFocusedIndicator();}.bind(this));};l.prototype._getVisualizationInfo=function(m){var o=this._getComponent();function n(s){if(!s){return undefined;}return s.map(function(S){var p=typeof S.getId==="function"?S:J.bySelector(S,o);return p&&p.getId();}).filter(Boolean);}return this._getInfoFromChangeHandler(o,m.change).then(function(I){var v=I||{};var A=(n(v.affectedControls||[m.change.getSelector()]));return{affectedElementIds:A,dependentElementIds:n(v.dependentControls)||[],displayElementIds:n(v.displayControls)||A,payload:v.payload};});};l.prototype._getCommandForChange=function(o){var s=o.getDefinition().support.command;if(s){return s;}var m=this._getComponent();var S=J.bySelector(o.getSelector(),m);var n=o.getDependentSelectorList().slice(-1)[0];var p=J.bySelector(n,m);function q(r,A){var t=r.getElement();var s=r.getDesignTimeMetadata().getCommandName(o.getChangeType(),t,A);if(s){return s;}var u=r.getParentElementOverlay();var v=r.getParentAggregationOverlay();if(r.getElement().getId()===S.getId()||!u){return undefined;}return q(u,v&&v.getAggregationName());}return S&&p&&q(O.getOverlay(p));};l.prototype._getInfoFromChangeHandler=function(A,o){var m=J.bySelector(o.getSelector(),A);if(m){var p={modifier:J,appComponent:A,view:f.getViewForControl(m)};var n=b.getControlIfTemplateAffected(o,m,p);return c.getChangeHandler({changeType:o.getChangeType(),element:n.control,modifier:J,layer:o.getLayer()}).then(function(q){if(q&&typeof q.getChangeVisualizationInfo==="function"){return q.getChangeVisualizationInfo(o,A);}return undefined;}).catch(function(v){L.error(v);return undefined;});}return Promise.resolve();};l.prototype._collectChanges=function(){var o=this._getComponent();var p={selector:o,invalidateCache:false,currentLayer:e.CUSTOMER,includeDirtyChanges:true,onlyCurrentVariants:true};return P._getUIChanges(p);};l.prototype._updateChangeRegistry=function(){return this._collectChanges().then(function(m){var r=this._oChangeIndicatorRegistry.getChangeIds();var o=m.filter(function(p){return p.getFileType()==='change';}).reduce(function(p,q){p[q.getId()]=q;return p;},{});var n=Object.keys(o);d(r,n).forEach(function(s){this._oChangeIndicatorRegistry.removeChange(s);}.bind(this));d(n,r).forEach(function(s){var p=o[s];var q=this._getCommandForChange(p);this._oChangeIndicatorRegistry.registerChange(p,q);}.bind(this));}.bind(this));};l.prototype.selectChange=function(o){var s=o.getParameter("changeId");this._selectChange(s);};l.prototype._selectChange=function(s){var D=this._oChangeIndicatorRegistry.getChange(s).visualizationInfo.dependentElementIds;D.forEach(function(m){var o=O.getOverlay(m).getDomRef();o.scrollIntoViewIfNeeded();o.classList.add("sapUiRtaChangeIndicatorDependent");o.addEventListener("animationend",function(){o.classList.remove("sapUiRtaChangeIndicatorDependent");},{once:true});});};l.prototype._updateVisualizationModel=function(D){this._oChangeVisualizationModel.setData(Object.assign({},this._oChangeVisualizationModel.getData(),D));};l.prototype._updateChangeIndicators=function(){var s=this._oChangeIndicatorRegistry.getChangeIndicatorData();var I={};var v=[];Object.keys(s).forEach(function(S){var m=s[S];var o=O.getOverlay(S);if(!o||!o.getDomRef()||!o.isVisible()){return undefined;}var n=o.getDomRef().getClientRects()[0]||{left:0,top:0};var r=this._filterRelevantChanges(m);r.forEach(function(p){v.push(p);});I[S]={posX:parseInt(n.left),posY:parseInt(n.top),changes:r};if(!this._oChangeIndicatorRegistry.hasChangeIndicator(S)){this._createChangeIndicator(o,S);}return undefined;}.bind(this));if(!a(I,this._oChangeVisualizationModel.getData().content)||!a(v,this._oChangeVisualizationModel.getData().visualizedChanges)){this._updateVisualizationModel({content:I,visualizedChanges:v});}};l.prototype._filterRelevantChanges=function(m){if(!Array.isArray(m)){return m;}var r=this._oChangeVisualizationModel.getData();return m.filter(function(o){return(!o.dependent&&(r.commandCategory==='all'||r.commandCategory===o.commandCategory));});};l.prototype._createChangeIndicator=function(o,s){var m=new h({changes:"{changes}",posX:"{posX}",posY:"{posY}",visible:"{= ${/active} && (${changes} || []).length > 0}",overlayId:o.getId(),selectorId:s,selectChange:this.selectChange.bind(this)});m.setModel(this._oChangeVisualizationModel);m.bindElement("/content/"+s);m.setModel(this.getModel("i18n"),"i18n");m.placeAt(sap.ui.getCore().getStaticAreaRef());this._oChangeIndicatorRegistry.registerChangeIndicator(s,m);};l.prototype._setFocusedIndicator=function(){sap.ui.getCore().applyChanges();var v=this._oChangeIndicatorRegistry.getChangeIndicators().filter(function(I){return I.getVisible();}).sort(function(I,o){var D=I.getPosY()-o.getPosY();var m=I.getPosX()-o.getPosX();return D||m;});if(v.length===0){return;}v.forEach(function(I,m){I.getDomRef().tabIndex=m+2;});v[0].focus();};l.prototype._toggleRootOverlayClickHandler=function(m){var r=this.oRootOverlay&&this.oRootOverlay.getDomRef();if(r){if(m){r.addEventListener("click",this._fnOnClickHandler,{capture:true});}else{r.removeEventListener("click",this._fnOnClickHandler,{capture:true});}}};l.prototype.triggerModeChange=function(r,t){this.oMenuButton=t.getControl("toggleChangeVisualizationMenuButton");this.oRootOverlay=O.getOverlay(r);if(this.getIsActive()){this.setIsActive(false);this._toggleRootOverlayClickHandler(false);return;}this._toggleRootOverlayClickHandler(true);if(!this.getRootControlId()){this.setRootControlId(r);}this.setIsActive(true);this._updateChangeRegistry().then(this._selectCommandCategory.bind(this,this._sSelectedCommandCategory)).then(function(){this._updateVisualizationModelMenuData();t.setModel(this._oChangeVisualizationModel,"visualizationModel");}.bind(this));};return l;});
