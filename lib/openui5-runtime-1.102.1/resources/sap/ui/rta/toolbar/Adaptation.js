/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/m/GroupHeaderListItem","sap/ui/core/format/DateFormat","sap/ui/core/Fragment","sap/ui/core/library","sap/ui/fl/write/api/Version","sap/ui/rta/Utils","sap/ui/rta/toolbar/translation/Translation","sap/ui/fl/write/api/FeaturesAPI","sap/ui/rta/appVariant/Feature","sap/ui/rta/toolbar/Base","sap/ui/model/Sorter","sap/ui/Device"],function(G,D,F,c,V,U,T,a,A,B,S,b){"use strict";var M=c.MessageType;var d=B.extend("sap.ui.rta.toolbar.Adaptation",{renderer:"sap.ui.rta.toolbar.AdaptationRenderer",animation:true,metadata:{library:"sap.ui.rta",events:{undo:{},redo:{},exit:{},save:{},restore:{},transport:{},publishVersion:{},modeChange:{},activate:{},discardDraft:{},switchVersion:{},openChangeCategorySelectionPopover:{}}}});d.modes={MOBILE:"sapUiRtaToolbarMobile",TABLET:"sapUiRtaToolbarTablet",DESKTOP:"sapUiRtaToolbarDesktop"};var e="sapUiRtaToolbar";var f="sapUiRtaDraftVersionAccent";var g="sapUiRtaActiveVersionAccent";d.prototype.init=function(){b.media.attachHandler(this._onSizeChanged,this,e);this._pFragmentLoaded=B.prototype.init.apply(this,arguments);};d.prototype.onBeforeRendering=function(){if(!b.media.hasRangeSet(e)){b.media.initRangeSet(e,[900,1200],"px",[d.modes.MOBILE,d.modes.TABLET,d.modes.DESKTOP]);}this._onSizeChanged(b.media.getCurrentRange(e));B.prototype.onBeforeRendering.apply(this,arguments);};d.prototype.onFragmentLoaded=function(){return this._pFragmentLoaded;};d.prototype.exit=function(){b.media.detachHandler(this._onSizeChanged,this,e);B.prototype.exit.apply(this,arguments);};function s(p,I,t,q){var u=this.getControl(p);var v=t?this.getTextResources().getText(t):"";var w=q?this.getTextResources().getText(q):"";u.setText(v||"");u.setTooltip(w||"");u.setIcon(I||"");}d.prototype.formatPublishVersionVisibility=function(p,v,q,t){return p&&v&&q!==V.Number.Draft&&t==="adaptation";};d.prototype.formatDiscardDraftVisible=function(p,v,q){return p===V.Number.Draft&&v&&q==="adaptation";};d.prototype.formatVersionButtonText=function(v,p){var t=sap.ui.getCore().getLibraryResourceBundle("sap.ui.rta");var q="";var u="Active";v=v||[];if(p===undefined||p===V.Number.Original){q=t.getText("TIT_ORIGINAL_APP");u="inactive";if(v.length===0||(v.length===1&&v[0].type==="draft")){u="active";}}else{var w=v.find(function(x){return x.version===p;});if(w){u=w.type;if(p===V.Number.Draft){q=t.getText("TIT_DRAFT");}else{q=w.title||t.getText("TIT_VERSION_1");}}}this.setVersionButtonAccentColor(u);return q;};d.prototype.formatVersionTableVisibility=function(p){return p>0;};d.prototype.formatVersionTitle=function(t,p){var q=sap.ui.getCore().getLibraryResourceBundle("sap.ui.rta");if(p==="draft"){return q.getText("TIT_DRAFT");}return t||q.getText("TIT_VERSION_1");};d.prototype.formatVersionTimeStamp=function(t){if(!t){return"";}return D.getInstance({format:"yMMMdjm"}).format(new Date(t));};d.prototype.formatHighlight=function(t){switch(t){case"draft":return M.Warning;case"active":return M.Success;default:return M.None;}};d.prototype.formatHighlightText=function(t){var p=sap.ui.getCore().getLibraryResourceBundle("sap.ui.rta");switch(t){case"draft":return p.getText("TIT_DRAFT");case"active":return p.getText("LBL_ACTIVE");default:return p.getText("LBL_INACTIVE");}};function h(v){return v.some(function(p){return p.type==="active";});}d.prototype.formatOriginalAppHighlight=function(v){return h(v)?M.None:M.Success;};d.prototype.formatOriginalAppHighlightText=function(v){var t=sap.ui.getCore().getLibraryResourceBundle("sap.ui.rta");return h(v)?t.getText("LBL_INACTIVE"):t.getText("LBL_ACTIVE");};d.prototype.versionSelected=function(E){var v=E.getSource().getBindingContext("versions");var p=V.Number.Original;if(v){p=v.getProperty("version");}this.fireEvent("switchVersion",{version:p});};d.prototype.showVersionHistory=function(E){var v=E.getSource();if(!this.oVersionDialogPromise){this.oVersionDialogPromise=F.load({name:"sap.ui.rta.toolbar.VersionHistory",id:this.getId()+"_fragment--sapUiRta_versionHistoryDialog",controller:{formatVersionTitle:this.formatVersionTitle.bind(this),formatVersionTimeStamp:this.formatVersionTimeStamp.bind(this),formatVersionTableVisibility:this.formatVersionTableVisibility.bind(this),formatHighlight:this.formatHighlight.bind(this),formatHighlightText:this.formatHighlightText.bind(this),formatOriginalAppHighlight:this.formatOriginalAppHighlight.bind(this),formatOriginalAppHighlightText:this.formatOriginalAppHighlightText.bind(this),versionSelected:this.versionSelected.bind(this),getGroupHeaderFactory:this.getGroupHeaderFactory.bind(this)}}).then(function(p){v.addDependent(p);return p;});}return this.oVersionDialogPromise.then(function(p){if(!p.isOpen()){p.openBy(v);if(this.getModel("controls").getProperty("/publishVisible")){var L=this.getControl("versionHistoryDialog--versionList");var q=new S({path:"isPublished",group:true});L.getBinding("items").sort(q);}}else{p.close();}}.bind(this));};d.prototype.getGroupHeaderFactory=function(p){var t=sap.ui.getCore().getLibraryResourceBundle("sap.ui.rta");return new G({title:p.key?t.getText("TIT_VERSION_HISTORY_PUBLISHED"):t.getText("TIT_VERSION_HISTORY_UNPUBLISHED"),upperCase:false,visible:this.getModel("controls").getProperty("/publishVisible")}).addStyleClass("sapUiRtaVersionHistoryGrouping").addStyleClass("sapUiRtaVersionHistory");};d.prototype.showRestore=function(v){return!v;};d.prototype._showButtonIcon=function(p,I,t){s.call(this,p,I,"",t);};d.prototype._showButtonText=function(p,t){s.call(this,p,"",t,"");};d.prototype._switchToIcons=function(){var I=this.getControl("iconBox");var p=this.getControl("iconSpacer");I.setVisible(false);p.setVisible(false);this._showButtonIcon("adaptationSwitcherButton","sap-icon://wrench","BTN_ADAPTATION");this._showButtonIcon("navigationSwitcherButton","sap-icon://explorer","BTN_NAVIGATION");this._showButtonIcon("visualizationSwitcherButton","sap-icon://show","BTN_VISUALIZATION");this._showButtonIcon("exit","sap-icon://decline","BTN_EXIT");};d.prototype._switchToTexts=function(){var I=this.getControl("iconBox");var p=this.getControl("iconSpacer");I.setVisible(true);p.setVisible(true);this._showButtonText("adaptationSwitcherButton","BTN_ADAPTATION");this._showButtonText("navigationSwitcherButton","BTN_NAVIGATION");this._showButtonText("visualizationSwitcherButton","BTN_VISUALIZATION");this._showButtonText("exit","BTN_EXIT");};d.prototype._onSizeChanged=function(p){if(!p){return Promise.resolve();}return this.onFragmentLoaded().then(function(){var q=p.name;this.sMode=q;switch(q){case d.modes.MOBILE:this._switchToIcons();break;case d.modes.TABLET:case d.modes.DESKTOP:this._switchToTexts();break;default:}}.bind(this));};d.prototype.buildControls=function(){return F.load({name:"sap.ui.rta.toolbar.Adaptation",id:this.getId()+"_fragment",controller:{activate:this._openVersionTitleDialog.bind(this),discardDraft:this.eventHandler.bind(this,"DiscardDraft"),formatDiscardDraftVisible:this.formatDiscardDraftVisible.bind(this),formatPublishVersionVisibility:this.formatPublishVersionVisibility.bind(this),modeChange:this.eventHandler.bind(this,"ModeChange"),openDownloadTranslationDialog:o.bind(this),openUploadTranslationDialog:i.bind(this),undo:this.eventHandler.bind(this,"Undo"),redo:this.eventHandler.bind(this,"Redo"),openChangeCategorySelectionPopover:this.eventHandler.bind(this,"OpenChangeCategorySelectionPopover"),manageApps:m.bind(this),appVariantOverview:l.bind(this),saveAs:k.bind(this),formatSaveAsEnabled:j,restore:this.eventHandler.bind(this,"Restore"),publish:this.eventHandler.bind(this,"Transport"),publishVersion:this.eventHandler.bind(this,"PublishVersion"),exit:this.eventHandler.bind(this,"Exit"),formatVersionButtonText:this.formatVersionButtonText.bind(this),showVersionHistory:this.showVersionHistory.bind(this),showRestore:this.showRestore.bind(this)}});};function o(){var p={layer:this.getRtaInformation().flexSettings.layer,selector:this.getRtaInformation().rootControl};this.addExtension("translation",T).openDownloadTranslationDialog(p);}function i(){this.addExtension("translation",T).openUploadTranslationDialog();}function j(p,q){return p&&q!==V.Number.Draft;}function k(){A.onSaveAs(true,true,this.getRtaInformation().flexSettings.layer,null);}function l(E){var I=E.getParameter("item");var t=I.getId().endsWith("keyUser");return A.onGetOverview(t,this.getRtaInformation().flexSettings.layer);}function m(){A.onGetOverview(true,this.getRtaInformation().flexSettings.layer);}function r(){this.getControl("versionTitleInput").setValue("");this.getControl("confirmVersionTitleButton").setEnabled(false);return Promise.resolve(this._oDialog);}function n(){return F.load({name:"sap.ui.rta.toolbar.VersionTitleDialog",id:this.getId()+"_fragment",controller:{onConfirmVersioningDialog:function(){var v=this.getControl("versionTitleInput").getValue();this.fireEvent("activate",{versionTitle:v});this._oDialog.close();}.bind(this),onCancelVersioningDialog:function(){this._oDialog.close();}.bind(this),onVersionTitleLiveChange:function(E){var v=E.getParameter("value");this.getControl("confirmVersionTitleButton").setEnabled(!!v);}.bind(this)}}).then(function(p){this._oDialog=p;p.addStyleClass(U.getRtaStyleClassName());this.addDependent(this._oDialog);}.bind(this));}d.prototype.getControl=function(N){return sap.ui.getCore().byId(this.getId()+"_fragment--sapUiRta_"+N);};d.prototype._openVersionTitleDialog=function(p){var q;if(this._oDialog){q=r.call(this);}else{q=n.call(this);}return q.then(function(){var t=sap.ui.getCore().getLibraryResourceBundle("sap.ui.rta");var u=t.getText("TIT_VERSION_TITLE_DIALOG");if(p!==V.Number.Draft){u=t.getText("TIT_REACTIVATE_VERSION_TITLE_DIALOG");}this._oDialog.setTitle(u);return this._oDialog.open();}.bind(this));};d.prototype.setVersionButtonAccentColor=function(t){var v=this.getControl("versionButton");switch(t){case"draft":v.addStyleClass(f);v.removeStyleClass(g);break;case"active":v.addStyleClass(g);v.removeStyleClass(f);break;default:v.removeStyleClass(g);v.removeStyleClass(f);}};return d;});
