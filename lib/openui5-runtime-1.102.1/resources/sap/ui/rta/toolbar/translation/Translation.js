/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/Log","sap/ui/base/ManagedObject","sap/ui/core/Fragment","sap/ui/rta/Utils","sap/ui/fl/Utils","sap/ui/model/json/JSONModel","sap/m/MessageBox","sap/m/MessageToast","sap/ui/fl/write/api/TranslationAPI","sap/ui/fl/write/api/VersionsAPI","sap/ui/fl/Layer","sap/ui/core/util/File"],function(L,M,F,U,a,J,b,c,T,V,d,f){"use strict";function s(e){var E=e.userMessage||e.stack||e.message||e.status||e;var t=sap.ui.getCore().getLibraryResourceBundle("sap.ui.rta");L.error(E);var m=t.getText("MSG_LREP_TRANSFER_ERROR")+"\n"+t.getText("MSG_ERROR_REASON",E);b.error(m,{styleClass:U.getRtaStyleClassName()});}var g=M.extend("sap.ui.rta.toolbar.translation.Translation",{metadata:{properties:{toolbar:{type:"sap.ui.rta.toolbar.Base"}}},constructor:function(){M.prototype.constructor.apply(this,arguments);this._oTranslationModel=new J(j());}});function h(E){var m=E.getSource().getModel("translation");var S=m.getProperty("/sourceLanguage");var t=m.getProperty("/targetLanguage");var k=S+"_"+t+"_"+"TranslationXLIFF";var p={layer:d.CUSTOMER,sourceLanguage:S,targetLanguage:t,selector:this.getToolbar().getRtaInformation().rootControl};var o=new Promise(function(r){if(m.getProperty("/translationRelevantDirtyChangesExist")){o=this.getToolbar().fireSave({callback:r});}else{r();}}.bind(this));o.then(T.getTexts.bind(undefined,p)).then(function(e){f.save(e,k,"xml","application/xml");this._oDownloadDialog.close();}.bind(this)).catch(function(e){s(e);});}g.prototype._createDownloadTranslationDialog=function(){return F.load({name:"sap.ui.rta.toolbar.translation.DownloadTranslationDialog",id:this.getToolbar().getId()+"_download_translation_fragment",controller:{onDownloadFile:h.bind(this),onCancelDownloadDialog:function(){this._oDownloadDialog.close();}.bind(this)}}).then(function(D){this._oDownloadDialog=D;this._oDownloadDialog.setModel(this._oTranslationModel,"translation");this.getToolbar().addDependent(this._oDownloadDialog);return D;}.bind(this));};g.prototype._createUploadTranslationDialog=function(){var u=this.getToolbar().getId()+"_upload_translation_fragment";return F.load({name:"sap.ui.rta.toolbar.translation.UploadTranslationDialog",id:u,controller:{onCancelUploadDialog:function(){this._oUploadDialog.close();}.bind(this),formatUploadEnabled:function(){var o=sap.ui.getCore().byId(u+"--fileUploader");return o.checkFileReadable();},saveFiles:function(e){this._oTranslationModel.setProperty("/file",e.getParameter("files")[0]);}.bind(this),handleUploadPress:i.bind(this,u)}}).then(function(o){this._oUploadDialog=o;this._oUploadDialog.setModel(this._oTranslationModel,"translation");this.getToolbar().addDependent(this._oUploadDialog);return this._oUploadDialog;}.bind(this));};function i(u){var o=sap.ui.getCore().byId(u+"--fileUploader");o.checkFileReadable().then(function(){if(this._oTranslationModel.getProperty("/file")){var p={layer:d.CUSTOMER,payload:new FormData()};p.payload.append("file",this._oTranslationModel.getProperty("/file"),o.getValue());return T.uploadTranslationTexts(p).then(function(){var t=sap.ui.getCore().getLibraryResourceBundle("sap.ui.rta");var m=t.getText("MSG_UPLOAD_TRANSLATION_SUCCESS");c.show(m,{styleClass:U.getRtaStyleClassName()});this._oUploadDialog.close();}.bind(this)).catch(function(e){s(e);}).finally(o.clear.bind(o));}}.bind(this));}function j(){return Object.assign({},{sourceLanguage:"",sourceLanguages:[],downloadChangedTexts:false,file:undefined});}g.prototype.openDownloadTranslationDialog=function(p){var H=T.hasTranslationRelevantDirtyChanges(p);this._oTranslationModel.setProperty("/translationRelevantDirtyChangesExist",H);return T.getSourceLanguages(p).then(function(S){if(S){this._oTranslationModel.setProperty("/sourceLanguages",S);this._oTranslationModel.setProperty("/sourceLanguage",S[0]||"");}}.bind(this)).then(function(){if(this._oDownloadDialogPromise){this._oTranslationModel.setProperty("/targetLanguage","");}else{this._oDownloadDialogPromise=this._createDownloadTranslationDialog();}return this._oDownloadDialogPromise;}.bind(this)).then(function(D){return D.open();}).catch(function(e){s(e);});};g.prototype.openUploadTranslationDialog=function(){if(!this._oUploadDialogPromise){this._oUploadDialogPromise=this._createUploadTranslationDialog();}return this._oUploadDialogPromise.then(function(u){this.getToolbar().addDependent(u);return u.open();}.bind(this));};return g;});
