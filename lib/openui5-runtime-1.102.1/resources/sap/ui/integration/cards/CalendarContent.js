/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./CalendarContentRenderer","sap/ui/core/ResizeHandler","sap/ui/integration/library","sap/ui/integration/cards/BaseContent","sap/ui/integration/util/BindingHelper","sap/ui/integration/util/BindingResolver","sap/f/CalendarAppointmentInCard","sap/f/CalendarInCard","sap/f/PlanningCalendarInCardLegend","sap/m/library","sap/m/Button","sap/m/FlexBox","sap/ui/core/format/DateFormat","sap/ui/core/Locale","sap/ui/core/LocaleData","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/unified/calendar/CalendarDate","sap/ui/unified/calendar/CalendarUtils","sap/ui/unified/DateTypeRange","sap/ui/core/date/UniversalDate","sap/ui/unified/CalendarLegendItem"],function(C,R,l,B,a,b,c,d,P,L,e,F,D,f,g,h,j,k,m,n,U,o){"use strict";var A=l.CardActionArea;var p=B.extend("sap.ui.integration.cards.CalendarContent",{renderer:C,metadata:{library:"sap.ui.integration",properties:{visibleAppointmentsCount:{type:"int",group:"Data",defaultValue:2},noAppointmentsText:{type:"string",group:"Misc",defaultValue:null}},aggregations:{appointments:{type:"sap.f.CalendarAppointmentInCard",multiple:true,singularName:"appointment"}}}});p.prototype._createCardContent=function(){this._oCalendar=new d(this.getId()+"-navigation",{startDateChange:function(E){var i=E.getSource()._getFocusedDate().toLocalJSDate();this._handleStartDateChange(i);}.bind(this),select:function(E){var s=E.getSource().getSelectedDates()[0].getStartDate();this._setParameters(E,E.getParameter("startDate"));this._refreshVisibleAppointments(s);this.invalidate();this._handleSelect(s);}.bind(this)});this._oLegend=new P(this.getId()+"-legend",{columnWidth:"7.5rem",standardItems:[]});this._oCalendar.setLegend(this._oLegend);this._oContent=new F(this.getId()+"-wrapper",{items:[this._oCalendar,this._oLegend]});this.setAggregation("_content",this._oContent);this._oFormatAria=D.getDateTimeInstance({pattern:"EEEE dd/MM/YYYY 'at' "+_.call(this).getTimePattern("medium")});};p.prototype.init=function(){this._aVisibleAppointments=[];B.prototype.init.apply(this,arguments);this._createCardContent();};p.prototype.exit=function(){if(this._sTwoColumnsResizeListener){R.deregister(this._sTwoColumnsResizeListener);this._sTwoColumnsResizeListener=undefined;}B.prototype.exit.apply(this,arguments);if(this._oAppointmentTemplate){this._oAppointmentTemplate.destroy();this._oAppointmentTemplate=null;}if(this._oSpecialDateTemplate){this._oSpecialDateTemplate.destroy();this._oSpecialDateTemplate=null;}if(this._oCalendarLegendItemTemplate){this._oCalendarLegendItemTemplate.destroy();this._oCalendarLegendItemTemplate=null;}if(this._oAppointmentLegendItemTemplate){this._oAppointmentLegendItemTemplate.destroy();this._oAppointmentLegendItemTemplate=null;}if(this._bDataInitiallyLoaded){this._bDataInitiallyLoaded=null;}};p.prototype.onDataChanged=function(){var s=this._oCalendar.getSelectedDates()[0]&&this._oCalendar.getSelectedDates()[0].getStartDate();if(!s){return;}if(!this._bDataInitiallyLoaded){this._handleSelect(s);this._handleStartDateChange(s);this._bDataInitiallyLoaded=true;}this._setParameters();this._refreshVisibleAppointments(s);this.invalidate();};p.prototype.onBeforeRendering=function(){var i=this._oCalendar.getSelectedDates().length?this._oCalendar.getSelectedDates()[0].getStartDate():this._oCalendar.getStartDate();this._setParameters();this._refreshVisibleAppointments(i);this.getModel("parameters").setProperty("/visibleItems",this._iVisibleItems);this.getModel("parameters").setProperty("/allItems",this._iAllItems);};p.prototype.onAfterRendering=function(){B.prototype.onAfterRendering.call(this,arguments);if(!this._sTwoColumnsResizeListener){this._sTwoColumnsResizeListener=R.register(this,this.resizeHandler);this.resizeHandler({control:this,target:this.getDomRef()});}};p.prototype.resizeHandler=function(E){E.control.toggleStyleClass("sapMPCInCardTwoColumns",E.target.getBoundingClientRect().width>576);};p.prototype.setConfiguration=function(i){B.prototype.setConfiguration.apply(this,arguments);i=this.getParsedConfiguration();this.fireEvent("_actionContentReady");if(!i){return this;}if(i.item){this._addItem(i.item);}if(i.specialDate){this._addSpecialDate(i.specialDate);}if(i.legendItem){this._addLegendItem(i.legendItem);}if(i.date){this._addDate(i.date);}if(i.maxItems){this._addMaxItems(i.maxItems);}if(i.maxLegendItems){this._addMaxLegendItems(i.maxLegendItems);}if(i.noItemsText){this._addNoItemsText(i.noItemsText);}if(i.moreItems&&i.moreItems.actions){this._oActions.attach({area:A.Content,actions:i.moreItems.actions,control:this._getMoreButton()});}return this;};p.prototype._setParameters=function(E,i){var r,s,t,u,v;if(i){r=i;}else if(this._oCalendar.getSelectedDates().length){r=this._oCalendar.getSelectedDates()[0].getStartDate();}else{r=this._oCalendar.getStartDate();}s=new Date(r.getFullYear(),r.getMonth(),r.getDate()).getTime();t=new Date(r.getFullYear(),r.getMonth(),r.getDate()+1).getTime();u=this.getAppointments();if(u){v=u.filter(function(w){var S=w.getStartDate().getTime(),x=w.getEndDate().getTime();if((S>=s&&S<t)||(x>s&&x<=t)||(S<s&&x>t)){return w;}});}else{v=[];}this._iAllItems=v.length;this._iMaxItems=this.getVisibleAppointmentsCount();this._iVisibleItems=Math.min(this._iMaxItems,this._iAllItems);if(this.getModel("parameters")){this.getModel("parameters").setProperty("/visibleItems",this._iVisibleItems);this.getModel("parameters").setProperty("/allItems",this._iAllItems);}};p.prototype._refreshVisibleAppointments=function(s){this._aVisibleAppointments=this._calculateVisibleAppointments(this.getAppointments(),s);};p.prototype._calculateVisibleAppointments=function(i,s){var I=this._isAppointmentInSelectedDate(s);var t=function(u,v){var E=u.getEndDate(),N=new Date();if(s.getDate()===N.getDate()&&s.getMonth()===N.getMonth()&&s.getFullYear()===N.getFullYear()){return this._iAllItems-v<this._iVisibleItems||E.getTime()>N.getTime();}return true;};var r=i.filter(I,this).sort(this._sortByStartHourCB).filter(t,this).slice(0,this._iVisibleItems);return r;};p.prototype._sortByStartHourCB=function(i,r){return i.getStartDate().getTime()-r.getStartDate().getTime()||r.getEndDate().getTime()-i.getEndDate().getTime();};p.prototype._isAppointmentInSelectedDate=function(s){return function(i){var r=i.getStartDate().getTime(),t=i.getEndDate().getTime(),S=s.getTime(),u=U.getInstance(new Date(s.getTime())),v,w,x,E;u.setDate(u.getDate()+1);v=u.getTime();w=r<S&&t>v;x=r>=S&&r<v;E=t>S&&t<=v;return w||x||E;};};p.prototype._getVisibleAppointments=function(){return this._aVisibleAppointments;};p.prototype.formatDate=function(t){var i=D.getDateTimeInstance({pattern:"yyyy-MM-dd'T'HH:mm:ss.SSSXXX"}).parse(t);if(!i){i=D.getInstance({pattern:"yyyy-MM-dd"}).parse(t);}return i;};p.prototype._addItem=function(i){var r={title:i.template.title,text:i.template.text,type:i.template.type},s;if(i.template.startDate){r.startDate=a.formattedProperty(i.template.startDate,this.formatDate);}if(i.template.endDate){r.endDate=a.formattedProperty(i.template.endDate,this.formatDate);}if(i.template.icon&&i.template.icon.src){r.icon=a.formattedProperty(i.template.icon.src,function(v){return this._oIconFormatter.formatSrc(v);}.bind(this));}this._oAppointmentTemplate=new c(r);var t=this.getActions();t.attach({area:A.ContentItem,actions:i.template.actions,control:this,actionControl:this._oAppointmentTemplate,enabledPropertyName:"clickable",enabledPropertyValue:true,disabledPropertyValue:false});s={path:i.path,template:this._oAppointmentTemplate};this._bindAggregationToControl("appointments",this,s);};p.prototype._addSpecialDate=function(s){var S=s.template,i;if(S.startDate){S.startDate=a.formattedProperty(S.startDate,this.formatDate);}if(S.endDate){S.endDate=a.formattedProperty(S.endDate,this.formatDate);}this._oSpecialDateTemplate=new n(S);i={path:s.path,template:this._oSpecialDateTemplate};this._bindAggregationToControl("specialDates",this._oCalendar,i);};p.prototype._addLegendItem=function(i){var r={text:i.template.text,type:i.template.type},s={text:i.template.text,type:i.template.type},t,u;this._oCalendarLegendItemTemplate=new o(r);t={path:i.path,template:this._oCalendarLegendItemTemplate,filters:new h({path:"category",operator:j.Contains,value1:"calendar"})};this._bindAggregationToControl("items",this._oLegend,t);this._oAppointmentLegendItemTemplate=new o(s);u={path:i.path,template:this._oAppointmentLegendItemTemplate,filters:new h({path:"category",operator:j.Contains,value1:"appointment"})};this._bindAggregationToControl("appointmentItems",this._oLegend,u);};p.prototype._addDate=function(t){if(b.isBindingInfo(t)){if(!t){return;}var i=new n();i.bindProperty("startDate",a.formattedProperty(t,this.formatDate));this._oCalendar.addSelectedDate(i);}else{this._oCalendar.addSelectedDate(new n({startDate:this.formatDate(t)}));var r=this.formatDate(t);this._handleSelect(r);this._handleStartDateChange(r);this._bDataInitiallyLoaded=true;}};p.prototype._addMaxItems=function(M){if(b.isBindingInfo(M)){M&&this.bindProperty("visibleAppointmentsCount",M);}else{this.setVisibleAppointmentsCount(M);}};p.prototype._addMaxLegendItems=function(M){if(b.isBindingInfo(M)){M&&this._oLegend.bindProperty("visibleLegendItemsCount",M);}else{this._oLegend.setVisibleLegendItemsCount(M);}};p.prototype._addNoItemsText=function(N){if(b.isBindingInfo(N)){N&&this.bindProperty("noAppointmentsText",N);}else{this.setNoAppointmentsText(N);}};p.prototype._getMoreButton=function(){if(!this._oMoreAppsButton){this._oMoreAppsButton=new e({text:"More"});}return this._oMoreAppsButton;};p.prototype._bNeedForMoreButton=function(){return this._iAllItems>this.getVisibleAppointmentsCount();};p.prototype._getCurrentAppointment=function(){var r=this._getVisibleAppointments(),N=new Date(),s,S,E,i,t=this._oCalendar.getSelectedDates().length?this._oCalendar.getSelectedDates()[0].getStartDate():this._oCalendar.getStartDate();if(t.getDate()===N.getDate()&&t.getMonth()===N.getMonth()&&t.getFullYear()===N.getFullYear()){for(i=r.length-1;i>=0;i--){s=r[i];S=s.getStartDate().getTime();E=s.getEndDate().getTime();if(N.getTime()>S&&N.getTime()<E){return s;}}}};p.prototype._handleStartDateChange=function(i){var r=this.getActions(),s=k.fromLocalJSDate(i),t=m._getFirstDateOfWeek(m._getFirstDateOfMonth(s)),u=new k(i.getFullYear(),i.getMonth()+1,1),v;u.setDate(u.getDate()-1);v=m._getFirstDateOfWeek(u);v.setDate(v.getDate()+6);r.fireAction(this,"MonthChange",{"firstDate":t.toLocalJSDate(),"lastDate":v.toLocalJSDate()});};p.prototype._handleSelect=function(s){var i=this.getActions();i.fireAction(this,"DateChange",{"selectedDate":s});};function _(){if(!this._oLocaleData){var s=q.call(this);var i=new f(s);this._oLocaleData=g.getInstance(i);}return this._oLocaleData;}function q(){if(!this._sLocale){this._sLocale=sap.ui.getCore().getConfiguration().getFormatSettings().getFormatLocale().toString();}return this._sLocale;}return p;});
