/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/integration/library","sap/base/Log","sap/ui/base/ManagedObject","sap/ui/integration/cards/actions/CustomAction","sap/ui/integration/cards/actions/DateChangeAction","sap/ui/integration/cards/actions/MonthChangeAction","sap/ui/integration/cards/actions/SubmitAction","sap/ui/integration/cards/actions/NavigationAction","sap/ui/integration/util/BindingHelper","sap/ui/integration/util/BindingResolver","sap/base/strings/capitalize","sap/ui/integration/cards/actions/ShowCardAction","sap/ui/integration/cards/actions/HideCardAction"],function(l,L,M,C,D,a,S,N,B,b,c,d,H){"use strict";function _(s){if(s&&typeof s==="object"){return s.name;}return s;}var A=l.CardActionArea,f=l.CardActionType;var g=M.extend("sap.ui.integration.cards.actions.CardActions",{metadata:{library:"sap.ui.integration",properties:{card:{type:"object"},bindingPathResolver:{type:"function"}}}});g.prototype.attach=function(o){var e=o.control,s=o.area;o.actionControl=o.actionControl||o.control;o.enabledPropertyValue=o.enabledPropertyValue||true;o.disabledPropertyValue=o.disabledPropertyValue||false;o.eventName=o.eventName||"press";if(!o.actions){this._fireActionReady(e,s);return;}var h=o.actions[0];if(h&&h.type){o.action=h;this._attachAction(o);}else{this._fireActionReady(e,s);}};g.prototype._attachAction=function(o){var e=o.action,s=o.area,h=o.control,i=o.actionControl,E=o.enabledPropertyName,v=o.enabledPropertyValue,j=o.disabledPropertyValue,k=true,m=this._isSingleAction(s),n=true;if(E){k=false;if(e.service&&!m){this._setControlEnabledStateUsingService(e,h,i,E,v,j);}else{this._setControlEnabledState(e,i,E,v,j);}}if(e.service&&m){this._getSingleActionEnabledState(e,h).then(function(p){if(p){this._attachEventListener(o);}this._fireActionReady(h,s);}.bind(this));return;}if(k){n=e.enabled!==false&&e.enabled!=="false";}if(n){this._attachEventListener(o);}this._fireActionReady(h,s);};g.prototype._setControlEnabledStateUsingService=function(o,e,h,p,E,v){var i=M.bindingParser("{path:''}");i.formatter=function(V){var j=this.getBindingContext(),P,m;if(j){P=j.getPath();}m=b.resolveValue(o.parameters,e,P);if(V.__resolved){if(!V.__enabled||V.__enabled==="false"){return v;}return E;}if(!V.__promise){V.__promise=true;e._oServiceManager.getService(_(o.service)).then(function(n){if(n){n.enabled({parameters:m}).then(function(k){V.__resolved=true;V.__enabled=k;e.getModel().checkUpdate(true);}).catch(function(){V.__resolved=true;V.__enabled=false;});}else{V.__resolved=true;V.__enabled=false;}});}return v;};h.bindProperty(p,i);};g.prototype._setControlEnabledState=function(o,e,p,E,v){var h,V;if(typeof o.enabled==="object"){h=B.formattedProperty(o.enabled,function(i){if(!i||i==="false"){return v;}return E;});}if(h){e.bindProperty(p,h);}else{V=(o.enabled===false||o.enabled==="false")?v:E;e.setProperty(p,V);}};g.prototype._getSingleActionEnabledState=function(o,e){var h=e.getBindingContext(),p,P;if(h){P=h.getPath();}p=b.resolveValue(o.parameters,e,P);return new Promise(function(r){e._oServiceManager.getService(_(o.service)).then(function(n){if(n){n.enabled({parameters:p}).then(function(E){r(E);}).catch(function(){r(false);});}else{r(false);}}).catch(function(){r(false);});});};g.prototype._fireActionReady=function(o,s){var h=s===A.Header;var e=h?"_actionHeaderReady":"_actionContentReady";o.fireEvent(e);};g.prototype._resolveBindingPath=function(e){var o=e.getSource().getBindingContext(),p;if(this.getBindingPathResolver()){p=this.getBindingPathResolver()(e);}else if(o){p=o.getPath();}return p;};g.prototype._handleServiceAction=function(E,o,h){var s=E.getSource();var p=this._resolveBindingPath(E);h._oServiceManager.getService(_(o.service)).then(function(e){if(e){e.navigate({parameters:b.resolveValue(o.parameters,s,p)});}}).catch(function(e){L.error("Navigation service unavailable",e);}).finally(function(){this._processAction(s,o,p);}.bind(this));};g.prototype._attachEventListener=function(o){var e=o.action;o.actionControl["attach"+c(o.eventName)](function(E){var s=E.getSource();if(e.service){this._handleServiceAction(E,e,o.control);}else{this._processAction(s,e,this._resolveBindingPath(E));}}.bind(this));};g.prototype._processAction=function(s,o,p){var h=this._getHostInstance(),e=this.getCard();g.fireAction({card:e,host:h,action:o,parameters:b.resolveValue(o.parameters,s,p),source:s});};g.prototype._getHostInstance=function(){var o=this.getCard();if(o){return o.getHostInstance();}return null;};g.prototype.fireAction=function(s,t,p){g.fireAction({card:this.getCard(),host:this._getHostInstance(),action:{type:t},parameters:p,source:s});};g.fireAction=function(m){var h=m.host,o=m.card,e=o.getAggregation("_extension"),p=m.parameters||{},i={type:m.action.type,card:o,actionSource:m.source,parameters:p},j=Object.assign({},i,{manifestParameters:p}),k=o.fireAction(j);if(!k){return false;}if(h){k=h.fireAction(i);}if(!k){return false;}if(e){k=e.fireAction(i);}if(k){var n=g._createHandler(m);if(n){n.execute();n.destroy();}}return k;};g.prototype._isSingleAction=function(s){return[A.Header,A.Content,A.ContentItemDetail,A.ActionsStrip].indexOf(s)>-1;};g._createHandler=function(m){var e=null;switch(m.action.type){case f.Custom:e=C;break;case f.DateChange:e=D;break;case f.HideCard:e=H;break;case f.MonthChange:e=a;break;case f.Navigation:e=N;break;case f.ShowCard:e=d;break;case f.Submit:e=S;break;default:L.error("Unknown action type '"+m.action.type+"'. Expected one of "+Object.values(f).join(", "),null,"sap.ui.integration.widgets.Card");}if(e){return new e({config:m.action,parameters:m.parameters,actionHandler:m.card.getManifestEntry("/sap.card/configuration/actionHandlers/"+m.action.type.toLowerCase()),card:m.card,source:m.source});}return null;};return g;});
