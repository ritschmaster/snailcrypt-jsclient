/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/base/Object","sap/ui/core/Manifest","sap/base/util/deepClone","sap/base/util/deepExtend","sap/base/util/each","sap/base/util/isPlainObject","sap/base/util/isEmptyObject","sap/base/Log","./ParameterMap","sap/ui/integration/util/CardMerger"],function(B,C,d,a,e,b,c,L,P,f){"use strict";var M="/{SECTION}/configuration/parameters",g="/{SECTION}/configuration/filters",h="/{SECTION}",A="/sap.app/dataSources",R=/\{\{(?!parameters.)(?!destinations.)(?!csrfTokens.)([^\}\}]+)\}\}|\{i18n>([^\}]+)\}/g;var k=B.extend("sap.ui.integration.util.Manifest",{constructor:function(s,i,j,l){B.call(this);this._aChanges=l;this._sSection=s;this.PARAMETERS=M.replace("{SECTION}",s);this.FILTERS=g.replace("{SECTION}",s);this.CONFIGURATION=h.replace("{SECTION}",s);if(i){var O={},t;O.process=false;this._oInitialJson=d(i,500);if(j){O.baseUrl=j;this._sBaseUrl=j;}else{L.warning("If no base URL is provided when the manifest is an object static resources cannot be loaded.");}if(this._aChanges){t=this.mergeDeltaChanges(i);}else{t=i;}this._oManifest=new C(t,O);this.oJson=this._oManifest.getRawJson();}}});k.prototype.mergeDeltaChanges=function(i){return f.mergeCardDelta(i,this._aChanges,this._sSection);};k.prototype.getJson=function(){return this._unfreeze(this.oJson);};k.prototype.getInitialJson=function(){return this._oInitialJson;};k.prototype.get=function(s){return this._unfreeze(q(this.oJson,s));};k.prototype.getUrl=function(){return this._oManifest.resolveUri("./","manifest");};k.prototype.getResourceBundle=function(){return this.oResourceBundle;};k.prototype._unfreeze=function(v){if(typeof v==="object"){return JSON.parse(JSON.stringify(v));}return v;};k.prototype.destroy=function(){this.oJson=null;this.oResourceBundle=null;if(this._oManifest){this._oManifest.destroy();}this._bIsDestroyed=true;};k.prototype.isDestroyed=function(){return this._bIsDestroyed;};k.prototype.load=function(s){if(!s||!s.manifestUrl){if(this._sBaseUrl&&this._oManifest){return this.loadI18n().then(function(){this.processManifest();}.bind(this));}else{if(this._oManifest){this.processManifest();}return new Promise(function(i){i();});}}return C.load({manifestUrl:s.manifestUrl,async:true,processJson:function(i){this._oInitialJson=d(i,500);if(this._aChanges){return this.mergeDeltaChanges(i);}return i;}.bind(this)}).then(function(i){this._oManifest=i;this.oJson=this._oManifest.getRawJson();return this.loadI18n().then(function(){this.processManifest();}.bind(this));}.bind(this));};k.prototype.loadI18n=function(){var H=false;C.processObject(this._oManifest.getJson(),function(O,K,v){if(!H&&v.match(R)){H=true;}});if(this.get("/sap.app/i18n")){H=true;}if(!H){return Promise.resolve();}return this._oManifest._loadI18n(true).then(function(i){this.oResourceBundle=i;}.bind(this));};k.prototype.processManifest=function(){var i=0,j=15,u=a({},this._oManifest.getRawJson()),D=this.get(A);p(u,this.oResourceBundle,i,j,this._oCombinedParams,D,this._oCombinedFilters);m(u);this.oJson=u;};function m(O){if(O&&typeof O==='object'&&!Object.isFrozen(O)){Object.freeze(O);for(var K in O){if(O.hasOwnProperty(K)){m(O[K]);}}}}function n(v){return(typeof v==="string")&&v.match(R)&&v.indexOf("{{")===0&&v.indexOf("}}")===v.length-2;}function o(v){return(typeof v==="string")&&(v.indexOf("{{parameters.")>-1||v.indexOf("{{dataSources")>-1||v.indexOf("{{filters.")>-1);}k._processPlaceholder=function(s,i,D,F){var j=P.processPredefinedParameter(s),v,l;if(!c(i)){for(var t in i){v=i[t].value;l="{{parameters."+t;j=r(j,v,l);}}if(D){j=r(j,D,"{{dataSources");}if(F){j=r(j,F,"{{filters");}return j;};function r(s,v,i){if(b(v)||Array.isArray(v)){for(var j in v){s=r(s,v[j],i+"."+j);}}else if(s.includes(i+"}}")){s=s.replace(new RegExp(i+"}}",'g'),v);}return s;}function p(O,i,j,l,s,D,F){if(j===l){return;}if(Array.isArray(O)){O.forEach(function(I,u,v){if(typeof I==="object"){p(I,i,j+1,l,s,D,F);}else if(o(I)){v[u]=k._processPlaceholder(I,s,D,F);}else if(n(I)&&i){v[u]=i.getText(I.substring(2,I.length-2));}},this);}else{for(var t in O){if(typeof O[t]==="object"){p(O[t],i,j+1,l,s,D,F);}else if(o(O[t])){O[t]=k._processPlaceholder(O[t],s,D,F);}else if(n(O[t])&&i){O[t]=i.getText(O[t].substring(2,O[t].length-2));}}}}function q(O,s){if(s==="/"){return O;}if(O&&s&&typeof s==="string"&&s[0]==="/"){var j=s.substring(1).split("/"),t;for(var i=0,l=j.length;i<l;i++){t=j[i];O=O.hasOwnProperty(t)?O[t]:undefined;if(O===null||typeof O!=="object"){if(i+1<l&&O!==undefined){O=undefined;}break;}}return O;}return O&&O[s];}k.prototype.processFilters=function(i){if(!this._oManifest){return;}var j=this.get(this.FILTERS),l={};if(i.size&&!j){L.error("If runtime filters are set, they have to be defined in the manifest configuration as well.");return;}e(j,function(K,s){var v=i.get(K)||s.value;l[K]=v;});this._oCombinedFilters=l;this.processManifest();};k.prototype.processParameters=function(i){if(!this._oManifest){return;}var j=this.get(this.PARAMETERS);if(!c(i)&&!j){L.error("If parameters property is set, parameters should be described in the manifest");return;}this._oCombinedParams=this._syncParameters(i,j);this.processManifest();};k.prototype.getProcessedParameters=function(i){var j=this.get(this.PARAMETERS),l=this._syncParameters(i,j);p(l,this.oResourceBundle,0,15,i);return l;};k.prototype._syncParameters=function(l,s){if(c(l)){return s;}var t=d(s||{},500),u=Object.getOwnPropertyNames(l),v=Object.getOwnPropertyNames(t);for(var i=0;i<v.length;i++){for(var j=0;j<u.length;j++){if(v[i]===u[j]){t[v[i]].value=l[u[j]];}}}return t;};k.prototype.findDataSections=function(s){var i=[],K;if(!s){s=this.get(this.CONFIGURATION);}if(!b(s)){return[];}if(s.data){i.push(s.data);}for(K in s){if(s[K]){i=i.concat(this.findDataSections(s[K]));}}return i;};return k;});
