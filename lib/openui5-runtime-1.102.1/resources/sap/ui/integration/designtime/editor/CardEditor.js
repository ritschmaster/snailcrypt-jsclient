/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/integration/editor/Editor","sap/ui/core/Core","sap/ui/integration/widgets/Card","sap/ui/integration/editor/Merger","sap/ui/model/json/JSONModel","sap/base/util/merge","sap/ui/model/resource/ResourceModel","sap/ui/integration/editor/EditorResourceBundles","sap/base/util/LoaderExtensions","sap/ui/core/theming/Parameters","sap/ui/dom/includeStylesheet"],function(E,C,a,M,J,m,R,b,L,P,i){"use strict";var r=C.getLibraryResourceBundle("sap.ui.integration");var c=E.extend("sap.ui.integration.designtime.editor.CardEditor",{metadata:{library:"sap.ui.integration",properties:{card:{type:"any",defaultValue:null}},aggregations:{_extension:{type:"sap.ui.integration.Extension",multiple:false,visibility:"hidden"}}},renderer:E.getMetadata().getRenderer().render});c.prototype.hasPreview=function(){var p=this.getAggregation("_preview");if(p&&p.getSettings()&&p.getSettings().preview&&p.getSettings().preview.modes==="None"){return false;}return true;};c.prototype._updatePreview=function(){var p=this.getAggregation("_preview");if(p&&p.update&&p._getCurrentMode()!=="None"){p.update();}};c.prototype.setCard=function(v,s){if(v===this.getProperty("card")){return this;}if(this._oEditorCard){this._oEditorCard.destroy();}this.setProperty("card",v,s);if(typeof v==="string"){try{v=JSON.parse(v);}catch(e){var d=C.byId(v);if(!d){var f=document.getElementById(v);if(f&&f.tagName&&f.tagName==="ui-integration-card"){d=f._getControl();}}v=d;}}if(v&&v.isA&&v.isA("sap.ui.integration.widgets.Card")){v={manifest:v.getManifest(),manifestChanges:v.getManifestChanges(),host:v.getHost(),baseUrl:v.getBaseUrl()};}if(typeof v==="object"){this._oEditorCard=new a(v);this._oEditorCard.onBeforeRendering();this._oEditorCard.attachEventOnce("_cardReady",function(){this.setJson(v,s);}.bind(this));}};c.prototype.createManifest=function(I,s){this._isManifestReady=false;if(this._oEditorManifest){this._oEditorManifest.destroy();}this.destroyAggregation("_extension");var d=M.layers[this.getMode()];this._oEditorManifest=this._oEditorCard._oCardManifest;this._registerManifestModulePath();var o=this._oEditorManifest._oInitialJson;this._oInitialManifestModel=new J(o);this.setProperty("json",o,s);var e;if(this._beforeLayerManifestChanges){e=M.mergeDelta(o,[this._beforeLayerManifestChanges]);}else{e=o;}var _=m({},e);this._beforeManifestModel=new J(_);if(d<M.layers["translation"]&&this._currentLayerManifestChanges){e=M.mergeDelta(e,[this._currentLayerManifestChanges]);}this._manifestModel=new J(e);this._isManifestReady=true;this.fireManifestReady();var v=this._oEditorManifest.get("/sap.app/i18n");var f=this.getBaseUrl()+v;if(v&&b.getResourceBundleURL()!==f){b.setResourceBundleURL(f);}this._createContextModel();if(this._oEditorManifest&&this._oEditorManifest.getResourceBundle()){var r=this._oEditorManifest.getResourceBundle();var g=new R({bundle:r});this.setModel(g,"i18n");if(this._oResourceBundle){g.enhance(this._oResourceBundle);}this._oResourceBundle=g.getResourceBundle();}return this._loadExtension().then(function(){this._initInternal();}.bind(this));};c.prototype._initPreview=function(){var s=this._oDesigntimeInstance.getSettings()||{};s.preview=s.preview||{};s.preview.position=this.getPreviewPosition();return new Promise(function(d,e){sap.ui.require(["sap/ui/integration/designtime/editor/CardPreview"],function(f){var p=new f({settings:s,card:this._oEditorCard});this.setAggregation("_preview",p);d();}.bind(this));}.bind(this));};c.prototype._loadExtension=function(){return new Promise(function(d,e){var o=this._oEditorCard.getAggregation("_extension");this.setAggregation("_extension",o);d();}.bind(this));};c.prototype._mergeContextData=function(o){var d={};d["empty"]=c._contextEntries.empty;for(var n in o){d[n]=o[n];}d["card.internal"]=c._contextEntries["card.internal"];return d;};c._contextEntries={empty:{label:r.getText("CARDEDITOR_CONTEXT_EMPTY_VAL"),type:"string",description:r.getText("CARDEDITOR_CONTEXT_EMPTY_DESC"),placeholder:"",value:""},"card.internal":{label:r.getText("CARDEDITOR_CONTEXT_CARD_INTERNAL_VAL"),todayIso:{type:"string",label:r.getText("CARDEDITOR_CONTEXT_CARD_TODAY_VAL"),description:r.getText("CARDEDITOR_CONTEXT_CARD_TODAY_DESC"),tags:[],placeholder:r.getText("CARDEDITOR_CONTEXT_CARD_TODAY_VAL"),customize:["format.dataTime"],value:"{{parameters.TODAY_ISO}}"},nowIso:{type:"string",label:r.getText("CARDEDITOR_CONTEXT_CARD_NOW_VAL"),description:r.getText("CARDEDITOR_CONTEXT_CARD_NOW_DESC"),tags:[],placeholder:r.getText("CARDEDITOR_CONTEXT_CARD_NOW_VAL"),customize:["dateFormatters"],value:"{{parameters.NOW_ISO}}"},currentLanguage:{type:"string",label:r.getText("CARDEDITOR_CONTEXT_CARD_LANG_VAL"),description:r.getText("CARDEDITOR_CONTEXT_CARD_LANG_VAL"),tags:["technical"],customize:["languageFormatters"],placeholder:r.getText("CARDEDITOR_CONTEXT_CARD_LANG_VAL"),value:"{{parameters.LOCALE}}"}}};c._languages={};c._appendThemeVars=function(){var v=["sapUiButtonHoverBackground","sapUiBaseBG","sapUiContentLabelColor","sapUiTileSeparatorColor","sapUiHighlight","sapUiListSelectionBackgroundColor","sapUiNegativeText","sapUiCriticalText","sapUiPositiveText","sapUiChartScrollbarBorderColor"];var p=P.get({name:v,callback:function(_){}});if(p){for(var n in p){document.body.style.setProperty("--"+n,p[n]);}}};c.init=function(){this.init=function(){};c._appendThemeVars();C.attachThemeChanged(function(){c._appendThemeVars();});var s=sap.ui.require.toUrl("sap.ui.integration.editor.css.Editor".replace(/\./g,"/")+".css");i(s);L.loadResource("sap/ui/integration/editor/languages.json",{dataType:"json",failOnError:false,async:true}).then(function(o){c._languages=o;});};c.init();return c;});
