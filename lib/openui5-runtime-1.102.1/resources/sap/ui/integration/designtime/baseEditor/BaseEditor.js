/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/integration/designtime/baseEditor/util/createPromise","sap/ui/integration/designtime/baseEditor/propertyEditor/PropertyEditorFactory","sap/ui/integration/designtime/baseEditor/validator/ValidatorRegistry","sap/ui/integration/designtime/baseEditor/PropertyEditors","sap/ui/integration/designtime/baseEditor/util/binding/resolveBinding","sap/ui/integration/designtime/baseEditor/util/binding/ObjectBinding","sap/ui/integration/designtime/baseEditor/util/hasTag","sap/ui/integration/designtime/baseEditor/util/cleanupDesigntimeMetadata","sap/ui/base/EventProvider","sap/ui/core/Control","sap/ui/model/resource/ResourceModel","sap/base/util/ObjectPath","sap/base/util/each","sap/base/util/deepClone","sap/base/util/deepEqual","sap/base/util/values","sap/base/util/includes","sap/base/util/isPlainObject","sap/base/util/isEmptyObject","sap/base/util/restricted/_intersection","sap/base/util/restricted/_flatten","sap/base/util/restricted/_mergeWith","sap/base/util/restricted/_merge","sap/base/util/restricted/_omit","sap/base/util/restricted/_union","sap/base/util/restricted/_isNil","sap/base/util/restricted/_castArray","sap/ui/model/json/JSONModel","sap/base/i18n/ResourceBundle","sap/base/Log","sap/ui/integration/designtime/baseEditor/util/unset"],function(c,P,V,a,r,O,h,b,E,C,R,d,f,g,i,v,j,k,l,_,m,n,o,p,q,s,t,J,u,L,w){"use strict";var x="customProperty--";var B=C.extend("sap.ui.integration.designtime.baseEditor.BaseEditor",{metadata:{library:"sap.ui.integration",properties:{"json":{type:"object"},"config":{type:"object",defaultValue:{"i18n":["sap/ui/integration/designtime/baseEditor/i18n/i18n.properties"]}},"designtimeMetadata":{type:"object"},"layout":{type:"string",defaultValue:"list"}},defaultAggregation:"content",aggregations:{content:{type:"sap.ui.core.Control",multiple:true}},events:{jsonChange:{parameters:{json:{type:"object"}}},designtimeMetadataChange:{parameters:{designtimeMetadata:{type:"object"}}},configChange:{parameters:{config:{type:"object"}}},propertyEditorsReady:{parameters:{propertyEditors:{type:"array"}}},validationErrorChange:{parameters:{hasError:{type:"boolean"}}}}},constructor:function(){this._oSetConfigPromise=Promise.resolve();this._mObservableConfig={};this._mPropertyEditors={};this._aCancelHandlers=[];this._oDataModel=this._createModel();this._oDesigntimeMetadataModel=this._createModel();this._bInitFinished=false;this._bValidatorsReady=false;this._setReady(false);C.prototype.constructor.apply(this,arguments);this._oDataModel.setData(this._prepareData(this.getJson()));this.attachJsonChange(function(e){var D=e.getParameter("json");this._oDataModel.setData(this._prepareData(D));this._checkReady();},this);},renderer:function(e,D){var F=D.getContent();e.openStart("div",D);e.openEnd();if(F.length){F.forEach(function(G){e.renderControl(G);});}else{D.getPropertyEditorsSync().forEach(function(G){e.renderControl(G);});}e.close("div");}});B.prototype.init=function(){};B.prototype.exit=function(){this._reset();this._oDataModel.destroy();this._oDesigntimeMetadataModel.destroy();};B.prototype._prepareData=function(e){var D=g(e);f(this._mObservableConfig,function(F,G){var H=G.path;if(H[0]==="/"){H=H.substr(1);}if(typeof d.get(H.split("/"),D)==="undefined"&&typeof G.defaultValue!=="undefined"){d.set(H.split("/"),g(G.defaultValue),D);}});return D;};B.prototype.setJson=function(D){var F;if(typeof D==="string"){try{F=JSON.parse(D);}catch(e){L.error("sap.ui.integration.designtime.baseEditor.BaseEditor: invalid JSON string is specified");}}else if(k(D)){F=o({},D);}else{L.error("sap.ui.integration.designtime.baseEditor.BaseEditor: unsupported data type specified in setJson()");}if(F&&JSON.stringify(this.getProperty("json"))!==JSON.stringify(F)){this.setProperty("json",F);this.fireJsonChange({json:F});}};B.prototype.setPreventInitialization=function(e){this._bPreventInitialization=e;};B.prototype.setConfig=function(e,I){this._bIsDefaultConfig=I;e=e||{};this._oSetConfigPromise=this._oSetConfigPromise.then(this._registerPropertyEditorTypes.bind(this,e.propertyEditors)).then(this._setConfig.bind(this,e,I));return this._oSetConfigPromise;};B.prototype._registerPropertyEditorTypes=function(e){P.deregisterAllTypes();return P.registerTypes(e||{});};B.prototype._setConfig=function(e,I,D){this._initValidators(e.validators||{});var T={propertyEditors:{},properties:{}};var N=y(T,e);if(this._oSpecificConfig){N=I?this._oSpecificConfig:A(N,this._oSpecificConfig,D);}N.i18n=q(N.i18n&&t(N.i18n),this.getMetadata().getProperty("config").getDefaultValue().i18n);this.setProperty("config",N,false);this.fireConfigChange({config:g(N)});this.initialize();};B.prototype.addConfig=function(e,I){this._bIsDefaultConfig=I;this._oSetConfigPromise=this._oSetConfigPromise.then(function(){e=y(this.getConfig(),e);return e.propertyEditors;}.bind(this)).then(this._registerPropertyEditorTypes).then(function(D){this._setConfig(e,I,D);}.bind(this));return this._oSetConfigPromise;};function y(T,e){var D=o({},T,e);D.i18n=[].concat(T.i18n||[],e.i18n||[]);return D;}B.prototype._addSpecificConfig=function(S){var e;this._oSetConfigPromise=this._oSetConfigPromise.then(function(){this._oSpecificConfig=S;e=o({},this.getConfig());e.propertyEditors=z(e,S);return e.propertyEditors;}.bind(this)).then(this._registerPropertyEditorTypes).then(function(D){this._setConfig(e,this._bIsDefaultConfig,D);}.bind(this));return this._oSetConfigPromise;};function z(e,S){var D={};var F=e.propertyEditors||{};var G=S.propertyEditors||{};q(Object.keys(F),Object.keys(G)).forEach(function(H){D[H]=G[H]||F[H];});return D;}function A(e,S,D){e.i18n=q(e.i18n,S.i18n);var N=Object.assign({},e,p(S,["properties","i18n","propertyEditors"]),p(e,["properties","i18n","propertyEditors"]));N.properties={};f(e.properties,function(F,G){var H=e.propertyEditors[G.type]&&e.propertyEditors[G.type].split("/").join(".");var I=H&&D[H].configMetadata;if(I&&S.properties[F]){f(G,function(K,T){var M;var Q=I[K]&&I[K].mergeStrategy;if(Q){if(Q==="mostRestrictiveWins"){var U=I[K].mostRestrictiveValue||false;if(T===U){M=U;}else{M=S.properties[F][K];}}else if(Q==="intersection"){M=_(T,S.properties[F][K]);}}else{M=T;}N.properties[F]=N.properties[F]||{};N.properties[F][K]=M;});}});return N;}B.prototype.setDesigntimeMetadata=function(D,I){var N=g(D,15);if(!i(N,this.getDesigntimeMetadata())){this.setProperty("designtimeMetadata",N);this._oDesigntimeMetadataModel.setData(N);if(!I){this.fireDesigntimeMetadataChange({designtimeMetadata:this._formatExportedDesigntimeMetadata(N)});}}};B.prototype._formatExportedDesigntimeMetadata=function(M){var F={};var e=function(D,G){Object.keys(D).forEach(function(K){var H=D[K];if(K==="__value"){F[G.join("/")]=H;}else if(k(H)){e(H,[].concat(G,K));}});};e(M||{},[]);return F;};B.prototype._initValidators=function(e){V.deregisterAllValidators();V.registerValidators(e);V.ready().then(function(){this._bValidatorsReady=true;this._checkReady();}.bind(this));};B.prototype._reset=function(){this._bInitFinished=false;this._setReady(false);this._aCancelHandlers.forEach(function(e){e();});if(this._oI18nModel){this._oI18nModel.destroy();delete this._oI18nModel;}if(this._oConfigObserver){this._oConfigObserver.destroy();}f(this._mPropertyEditors,function(e,D){D.forEach(function(F){this.deregisterPropertyEditor(F,e);},this);}.bind(this));if(this._oRootWrapper){this._oRootWrapper.destroy();}};B.prototype.initialize=function(){if(!this._bPreventInitialization){this._initialize();}};B.prototype._initialize=function(){this._reset();var e=this.getConfig();if(typeof this.getProperty("json")==="undefined"){this.attachEventOnce("jsonChange",this._initialize);return;}if(e){this._oConfigObserver=new O();this._loadI18nBundles(e.i18n).then(function(D){this._oI18nModel=this._createI18nModel(D);this.setModel(this._oI18nModel,"i18n");this._oConfigObserver.addToIgnore(["template","itemLabel"]);this._oConfigObserver.setModel(this._oDataModel);this._oConfigObserver.setModel(this._oDesigntimeMetadataModel,"designtimeMetadata");this._oConfigObserver.setModel(this._oI18nModel,"i18n");var F=this._getContextPath();if(F){this._oConfigObserver.setModel(this._oDataModel,"context");this._oConfigObserver.setBindingContext(this._oDataModel.getContext(F),"context");}var G=r(e.properties,{"i18n":this._oI18nModel});this._mObservableConfig=Object.assign(this._mObservableConfig,this._prepareConfig(G));this._oConfigObserver.setObject(this._mObservableConfig);this._oConfigObserver.attachChange(this._onConfigChange,this);var H=this.getContent();if(H.length===0||H.length===1&&H[0]===this._oRootWrapper){this.removeAllContent();this._createEditors(this._oConfigObserver.getObject());}this._bInitFinished=true;this._checkReady();}.bind(this));}};B.prototype._onConfigChange=function(e){var D=e.getParameter("changes").reduce(function(G,H){var K=g(H);K.path=K.path.split("/");K.propertyKey=K.path.shift();if(!G[K.propertyKey]){G[K.propertyKey]=[];}G[K.propertyKey].push(K);return G;},{});var F=Object.keys(D).reduce(function(G,H){var K=(this.getPropertyEditorsByNameSync(H)||[]).map(function(N){return{editor:N,propertyName:H};});G=G.concat(K);return G;}.bind(this),[]);var I=F.filter(function(G){return!this._oRootWrapper||!j(this._oRootWrapper._aEditorWrappers,G.editor);}.bind(this));I.forEach(function(G){var H=G.propertyName;var K=e.getSource().getObject();var N=p(g(K[H]),"value");var Q=false;var S=D[H]||[];S.forEach(function(T){if(T.path[0]==="value"){G.editor.setValue(T.value);}else{d.set(T.path,T.value,N);Q=true;}});if(Q){G.editor.setConfig(N);}});if(I.length<F.length){var M=g(this._oRootWrapper.getConfig()).map(function(G){var H=D[G.__propertyName]||[];H.forEach(function(K){d.set(K.path,K.value,G);});return G;});this._oRootWrapper.setConfig(M);}};B.prototype._createModel=function(){var M=new J();M.setDefaultBindingMode("OneWay");return M;};B.prototype.getI18nProperty=function(N,e){if(this.getModel("i18n")){return this.getModel("i18n").getResourceBundle().getText(N,e);}return N;};B.prototype._loadI18nBundles=function(e){return this._createPromise(function(D,F){Promise.all(e.map(function(I){return new Promise(function(D,G){u.create({url:sap.ui.require.toUrl(I),async:true}).then(D,G);});})).then(D,F);});};B.prototype._createI18nModel=function(e){var D=e.slice();var I=new R({bundle:D.shift()});I.setDefaultBindingMode("OneWay");D.forEach(function(F){I.enhance(F);});return I;};B.prototype._prepareConfig=function(e){var D={};f(e,function(K,F){D[K]=Object.assign({},this._preparePropertyConfig(F),{__propertyName:K});}.bind(this));return D;};B.prototype._preparePropertyConfig=function(e){var D=this._getContextPath();if(D&&!D.endsWith("/")){D=D+"/";}var F=e.path;if(!F.startsWith("/")&&D){F=D+F;}return Object.assign({},e,{path:F,value:"{"+F+"}",designtime:"{designtimeMetadata>"+F+"}"});};B.prototype._createEditors=function(e){var D=d.get(["layout",this.getLayout()],this.getConfig());if(k(D)||Array.isArray(D)){D=r(D,{"i18n":this._oI18nModel});}this._oRootWrapper=new a({config:v(e),layout:this.getLayout(),layoutConfig:D});this.addContent(this._oRootWrapper);return(Promise.all(v(this._mPropertyEditors).reduce(function(F,G){return F.concat(G);},[]).map(function(F){return F.ready();})).then(this._checkReady.bind(this)));};B.prototype._getRegistrationKey=function(e,K){if(typeof K!=="string"){if(e.isA("sap.ui.integration.designtime.baseEditor.PropertyEditor")&&!e.getConfig()&&!e.getBindingInfo("config")&&e.getPropertyName()){K=e.getPropertyName();}else{K=x+e.getId();}}return K;};B.prototype._addCustomProperty=function(K,e){var D=Object.assign({},this._mObservableConfig);D[K]=this._preparePropertyConfig(e);this._mObservableConfig=D;this._oConfigObserver.setObject(D);};B.prototype._removeCustomProperty=function(K){var e=p(this._mObservableConfig,K);this._mObservableConfig=e;this._oConfigObserver.setObject(e);};B.prototype.registerPropertyEditor=function(e,K){K=this._getRegistrationKey(e,K);var D=Array.isArray(this._mPropertyEditors[K])?this._mPropertyEditors[K]:[];this._mPropertyEditors[K]=D.concat(e);if(K.startsWith(x)){this._addCustomProperty(K,e.getConfig());}var F=d.get([K],this._oConfigObserver.getObject()).value;e.setValue(F);e.attachValueChange(this._onValueChange,this);e.attachDesigntimeMetadataChange(this._onDesigntimeMetadataChange,this);e.attachReady(this._checkReady,this);e.attachValidationErrorChange(function(){this.fireValidationErrorChange({hasError:this.hasError()});}.bind(this));};B.prototype.deregisterPropertyEditor=function(e,K){K=this._getRegistrationKey(e,K);var D=this._mPropertyEditors[K];if(K.startsWith(x)){this._removeCustomProperty(K);}e.detachValueChange(this._onValueChange,this);e.detachDesigntimeMetadataChange(this._onDesigntimeMetadataChange,this);if(Array.isArray(D)){this._mPropertyEditors[K]=D.filter(function(I){return e!==I;});if(this._mPropertyEditors[K].length===0){delete this._mPropertyEditors[K];}}};B.prototype._setReady=function(e){var D=this._bIsReady;this._bIsReady=e;if(D!==true&&e===true){this.firePropertyEditorsReady({propertyEditors:this.getPropertyEditorsSync()});}};B.prototype._checkReady=function(){var e=this.getContent().filter(function(F){return(F.isA("sap.ui.integration.designtime.baseEditor.PropertyEditors")||F.isA("sap.ui.integration.designtime.baseEditor.propertyEditor.BasePropertyEditor"));});e.forEach(function(F){if(!E.hasListener(F,"ready",this._checkReady,this)){F.attachReady(this._checkReady,this);}},this);var D=[].concat(e,this.getPropertyEditorsSync());var I=(this._bInitFinished&&this._bValidatorsReady&&D.every(function(F){return F.isReady();}));this._setReady(I);};B.prototype.isReady=function(){return this._bIsReady;};B.prototype.ready=function(){return new Promise(function(e){if(this.isReady()){e();}else{this.attachEventOnce("propertyEditorsReady",e);}}.bind(this));};B.prototype.hasError=function(){return m(Object.values(this._mPropertyEditors||{})).some(function(e){return e.hasError();});};B.prototype._createPromise=function(e){var D=c(e);this._aCancelHandlers.push(D.cancel);var F=function(G,H){this._aCancelHandlers=this._aCancelHandlers.filter(function(e){return e!==G;});return H;}.bind(this,D.cancel);return D.promise.then(F,F);};B.prototype.getPropertyConfigByName=function(e){return p(d.get([e],this._oConfigObserver.getObject()),"value");};B.prototype.getPropertyEditorsByName=function(e){return new Promise(function(D){if(!this._mPropertyEditors||Object.keys(this._mPropertyEditors).length===0){this.attachEventOnce("propertyEditorsReady",D);}else{D();}}.bind(this)).then(function(){return this.getPropertyEditorsByNameSync(e);}.bind(this));};B.prototype.getPropertyEditorsByNameSync=function(e){var D=this._mPropertyEditors[e];return Array.isArray(D)&&D.slice()||null;};B.prototype.getPropertyEditorsByTag=function(T){return new Promise(function(e){if(!this._mPropertyEditors||Object.keys(this._mPropertyEditors).length===0){this.attachEventOnce("propertyEditorsReady",e);}else{e();}}.bind(this)).then(function(){return this.getPropertyEditorsByTagSync(T);}.bind(this));};B.prototype.getConfigsByTag=function(T){var e=this.getConfig().properties;return Object.keys(e).filter(function(D){return h(e[D],T);}).map(function(D){return e[D];});};B.prototype.getPropertyEditorsByTagSync=function(T){return this.getPropertyEditorsSync().filter(function(e){return h(e.getConfig(),T);});};B.prototype.getPropertyEditorsSync=function(){return v(this._mPropertyEditors).reduce(function(e,D){return e.concat(D);},[]).sort(function(e,D){return parseInt(e.getId().match(/\d+$/))-parseInt(D.getId().match(/\d+$/));});};B.prototype.getJson=function(){return o({},this.getProperty("json"));};B.prototype.getDesigntimeMetadata=function(){return o({},this.getProperty("designtimeMetadata"));};B.prototype._getContextPath=function(){var e=this.getConfig();var D=e&&e.context||null;if(D&&D[0]!=="/"){D="/"+D;}return D;};B.prototype._onValueChange=function(e){var D=e.getSource();var F=e.getParameter("path");var G=this.getJson()||{};var H=e.getParameter("value");if(F[0]==="/"){F=F.substr(1);}else{throw new Error("BaseEditor._onValueChange: unknown relative path - '"+F+"'");}var I=F.split("/");d.set(I,H,G);if(typeof H==="undefined"||i(H,D.getRuntimeConfig().defaultValue)||Array.isArray(H)&&H.length===0||k(H)&&l(H)){w(G,I);}this.setJson(G);};B.prototype._onDesigntimeMetadataChange=function(e){var D=e.getParameter("path");var F=this.getDesigntimeMetadata()||{};var G=e.getParameter("value");if(D[0]==="/"){D=D.substr(1);}else{throw new Error("BaseEditor._onDesigntimeMetadataChange: unknown relative path - '"+D+"'");}var H=D.split("/");d.set(H,G,F);b(F);this.setDesigntimeMetadata(F);};return B;});
