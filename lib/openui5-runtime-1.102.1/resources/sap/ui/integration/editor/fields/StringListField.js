/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/integration/editor/fields/BaseField","sap/m/Input","sap/m/MultiComboBox","sap/m/MultiInput","sap/base/util/restricted/_debounce","sap/base/util/restricted/_isEqual","sap/base/util/ObjectPath","sap/base/util/includes","sap/base/util/merge","sap/ui/core/SeparatorItem","sap/ui/model/Sorter","sap/m/Token","sap/m/Tokenizer","sap/base/util/deepClone","sap/ui/model/json/JSONModel","sap/ui/integration/util/BindingResolver"],function(B,I,M,b,_,c,O,i,m,S,d,T,e,f,J,g){"use strict";var h=B.extend("sap.ui.integration.editor.fields.StringListField",{metadata:{library:"sap.ui.integration"},renderer:B.getMetadata().getRenderer()});h.prototype.initVisualization=function(C){var t=this,o;var v=C.visualization;if(!v){if(C.values){o=this.formatListItem(C.values.item);v={type:M,settings:{selectedKeys:{path:'currentSettings>value'},busy:{path:'currentSettings>_loading'},editable:C.editable,visible:C.visible,showSecondaryValues:true,width:"100%",items:{path:"",template:o,sorter:[new d({path:'Selected',descending:false,group:true})],groupHeaderFactory:t.getGroupHeader}}};if(this.isFilterBackend()){v.settings.selectedKeys={parts:['currentSettings>value','currentSettings>suggestValue'],formatter:function(V,a){if(a){t.setSuggestValue();}return V;}};}}else{v={type:I,settings:{value:{path:'currentSettings>value',formatter:function(a){a=a||[];return a.join(",");}},change:function(E){var a=E.getSource();a.getBinding("value").setRawValue(a.getValue().split(","));},editable:C.editable,visible:C.visible,placeholder:C.placeholder}};}}else if(C.values&&this.isFilterBackend()&&v.type==="MultiInput"){o=this.formatListItem(C.values.item);var s={busy:{path:'currentSettings>_loading'},placeholder:C.placeholder,editable:C.editable,visible:C.visible,showSuggestion:true,autocomplete:false,showValueHelp:false,filterSuggests:false,width:"100%",suggestionItems:{path:"",template:o,sorter:[new d({path:'Selected',descending:false,group:true})],groupHeaderFactory:t.getGroupHeader}};if(v.settings){s=m(s,v.settings);}v={type:b,settings:s};}this._visualization=v;this.attachAfterInit(this._afterInit);};h.prototype._afterInit=function(){var C=this.getAggregation("_field");var o=this.getModel();if(C instanceof M){if(this.isFilterBackend()){this.onInputForMultiComboBox=_(this.onInputForMultiComboBox,500);C.oninput=this.onInputForMultiComboBox;C.attachSelectionChange(this.onSelectionChangeForFilterBackend);C.attachSelectionFinish(this.onSelectionFinishForFilterBackend);o.attachPropertyChange(this.onPropertyChangeForFilterBackend,this);}else{C.attachSelectionChange(this.onSelectionChange);o.attachPropertyChange(this.onPropertyChange,this);}}else if(C instanceof b){this.initTokens();this.onInputForMultiInput=_(this.onInputForMultiInput,500);C.oninput=this.onInputForMultiInput;o.attachPropertyChange(this.onPropertyChangeForFilterBackend,this);o.attachPropertyChange(this.initTokens,this);C.attachTokenChange(this.onTokenChange);}};h.prototype.initTokens=function(){var C=this.getAggregation("_field");var o=this.getConfiguration();var t=[];if(Array.isArray(o.valueTokens)&&o.valueTokens.length>0){o.valueTokens.forEach(function(v){var a=new T(v);t.push(a);});}else if(Array.isArray(o.value)&&o.value.length>0&&Array.isArray(o.valueItems)&&o.valueItems.length>0){o.valueTokens=[];o.valueItems.forEach(function(v){var a=new J();a.setData(v);var k=g.resolveValue(o.values.item.key,a);if(i(o.value,k)){var s=g.resolveValue(o.values.item.text,a);var j={key:k,text:s};var l=new T(j);t.push(l);o.valueTokens.push(j);}});}C.setTokens(t);};h.prototype.getKeyFromItem=function(o){var C=this.getConfiguration();var a=new J();a.setData(o);return g.resolveValue(C.values.item.key,a);};h.prototype.onPropertyChangeForFilterBackend=function(E){var C=this.getConfiguration();if(!C.valueItems){C.valueItems=[];}var p=C.values.data.path||"/";var v=this.getModel();var D=v.getData();if(p!=="/"){if(p.startsWith("/")){p=p.substring(1);}if(p.endsWith("/")){p=p.substring(0,p.length-1);}var P=p.split("/");var r=O.get(P,D);r=this.mergeSelectedItems(C,r);O.set(P,r,D);}else{D=this.mergeSelectedItems(C,D);}v.setData(D);this.setSuggestValue();};h.prototype.onPropertyChange=function(E){var C=this.getAggregation("_field");var s=C.getSelectedItems().map(function(j){return j.getKey();});var a=this.getBindingContext("currentSettings").sPath;var o=this.getModel("currentSettings");o.setProperty(a+"/value",s);};h.prototype.mergeSelectedItems=function(C,D){var t=this;var r=t.getResourceBundle();if(Array.isArray(D)){var s=C.valueItems.map(function(l){return this.getKeyFromItem(l);}.bind(this));var o=D.filter(function(l){var p=this.getKeyFromItem(l);return!i(s,p);}.bind(this));var a=o.filter(function(l){return l.Selected===r.getText("EDITOR_ITEM_SELECTED");});C.valueItems=C.valueItems.concat(a);var n=o.filter(function(l){return l.Selected!==r.getText("EDITOR_ITEM_SELECTED");});D=C.valueItems.concat(n);var j=this.getAggregation("_field");if(j.isOpen&&j.isOpen()){s=C.valueItems.map(function(l){return this.getKeyFromItem(l);}.bind(this));var k=j.getSelectedKeys();if(!c(s,k)){j.setSelectedKeys(s);}}}else{D=C.valueItems;}return D;};h.prototype.setSuggestValue=function(){var C=this.getAggregation("_field");var s=this.getBindingContext("currentSettings").sPath;var o=this.getModel("currentSettings");var a=o.getProperty(s+"/suggestValue");if(a&&a!==""){C.setValue(a.replaceAll("\'\'","'"));}};h.prototype.getSuggestValue=function(){var s=this.getBindingContext("currentSettings").sPath;var o=this.getModel("currentSettings");return o.getProperty(s+"/suggestValue");};h.prototype.getGroupHeader=function(G){return new S({text:G.key});};h.prototype.onSelectionChangeForFilterBackend=function(E){var F=E.getSource().getParent();var C=F.getConfiguration();var r=F.getResourceBundle();var l=E.getParameter("changedItem");var s=l.getKey();var a=E.getParameter("selected");var D=this.getModel().getData();var p=C.values.data.path||"/";var P,o;if(p!=="/"){if(p.startsWith("/")){p=p.substring(1);}if(p.endsWith("/")){p=p.substring(0,p.length-1);}P=p.split("/");o=O.get(P,D);}else{o=D;}if(o){if(!C.valueItems){C.valueItems=[];}var n=[];o.forEach(function(j){var N=f(j,500);var k=F.getKeyFromItem(N);if(k===s){if(a){N.Selected=r.getText("EDITOR_ITEM_SELECTED");C.valueItems=C.valueItems.concat([N]);}else{N.Selected=r.getText("EDITOR_ITEM_UNSELECTED");C.valueItems=C.valueItems.filter(function(q){var k=F.getKeyFromItem(q);return k!==s;});}}n.push(N);});if(P!==undefined){O.set(P,n,D);this.getModel().checkUpdate(true);}else{this.getModel().setData(n);}}};h.prototype.onTokenChange=function(E){var F=this.getParent();var C=F.getConfiguration();var r=F.getResourceBundle();var s=F.getModel("currentSettings");var a=F.getBindingContext("currentSettings").sPath;var v=s.getProperty(a+"/value");var t=E.getParameter("token");if(t){var j=t.getKey();if(!C.valueTokens){C.valueTokens=[];}if(!v){v=[];}var k=E.getParameter("type");switch(k){case e.TokenChangeType.Removed:v=v.filter(function(n){return n!==j;});C.value=v;C.valueTokens=C.valueTokens.filter(function(n){return n.key!==j;});break;case e.TokenChangeType.Added:if(!i(v,j)){v=v.concat([j]);C.value=v;}var l=C.valueTokens.map(function(V){return V.key;});if(!i(l,j)){C.valueTokens=C.valueTokens.concat([{"key":j,"text":t.getText()}]);}break;case e.TokenChangeType.RemovedAll:C.value=[];C.valueItems=[];C.valueTokens=[];break;default:break;}var D=F.getModel().getData();var R;var p=C.values.data.path||"/";var P;if(p!=="/"){if(p.startsWith("/")){p=p.substring(1);}if(p.endsWith("/")){p=p.substring(0,p.length-1);}P=p.split("/");R=f(O.get(P,D),10);}else{R=f(D,10);}if(Array.isArray(R)){C.valueItems=[];R.forEach(function(o){var j=F.getKeyFromItem(o);if(i(C.value,j)){o.Selected=r.getText("EDITOR_ITEM_SELECTED");C.valueItems.push(o);}else{o.Selected=r.getText("EDITOR_ITEM_UNSELECTED");}});if(p!=="/"){O.set(P,R,D);}else{D=R;}F.getModel().setData(D);F.getModel().checkUpdate(true);}s.setProperty(a+"/value",C.value);s.setProperty(a+"/valueItems",C.valueItems);s.setProperty(a+"/valueTokens",C.valueTokens);}};h.prototype.onSelectionChange=function(E){var F=E.oSource.getParent();var C=F.getConfiguration();var r=F.getResourceBundle();var l=E.getParameter("changedItem");var s=l.getKey();var a=E.getParameter("selected");var D=this.getModel().getData();var p=C.values.data.path||"/";if(p!=="/"){if(p.startsWith("/")){p=p.substring(1);}if(p.endsWith("/")){p=p.substring(0,p.length-1);}var P=p.split("/");var R=O.get(P,D);if(Array.isArray(R)){for(var n in R){var j=F.getKeyFromItem(R[n]);if(j===s){if(a){R[n].Selected=r.getText("EDITOR_ITEM_SELECTED");}else{R[n].Selected=r.getText("EDITOR_ITEM_UNSELECTED");}}}O.set(P,R,D);}}else if(Array.isArray(D)){for(var n in D){var j=F.getKeyFromItem(D[n]);if(j===s){if(a){D[n].Selected=r.getText("EDITOR_ITEM_SELECTED");}else{D[n].Selected=r.getText("EDITOR_ITEM_UNSELECTED");}}}}this.getModel().setData(D);this.getModel().checkUpdate(true);};h.prototype.onSelectionFinishForFilterBackend=function(E){var F=this.getParent();var C=F.getConfiguration();var s=E.getParameter("selectedItems").map(function(k){return k.getKey();});var D=this.getModel().getData();var p=C.values.data.path||"/";if(p!=="/"){if(p.startsWith("/")){p=p.substring(1);}if(p.endsWith("/")){p=p.substring(0,p.length-1);}var P=p.split("/");D=O.get(P,D);}if(D){C.valueItems=D.filter(function(k){var l=F.getKeyFromItem(k);return i(s,l);});}var a=this.getBindingContext("currentSettings").sPath;var o=this.getModel("currentSettings");o.setProperty(a+"/value",s);var j=F.getSuggestValue();if(j&&j!==""){o.setProperty(a+"/suggestValue","");}};h.prototype.onInputForMultiComboBox=function(E){var t=E.target.value;var s=this.getBindingContext("currentSettings").sPath;var o=this.getModel("currentSettings");o.setProperty(s+"/suggestValue",t.replaceAll("'","\'\'"));o.setProperty(s+"/_loading",true);E.srcControl.open();E.srcControl._getSuggestionsPopover()._sTypedInValue=t;};h.prototype.onInputForMultiInput=function(E){var C=E.srcControl;b.prototype.oninput.apply(C,arguments);var t=E.target.value;if(t===""){return;}var s=this.getBindingContext("currentSettings").sPath;var o=this.getModel("currentSettings");var a=o.getProperty(s+"/suggestValue");if(a!==t.replaceAll("'","\'\'")){o.setProperty(s+"/suggestValue",t.replaceAll("'","\'\'"));o.setProperty(s+"/_loading",true);}};return h;});
