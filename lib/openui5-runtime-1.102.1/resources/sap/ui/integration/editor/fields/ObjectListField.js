/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/integration/editor/fields/ObjectField","sap/ui/model/json/JSONModel","sap/ui/table/Table","sap/m/CheckBox","sap/base/util/deepEqual","sap/base/util/deepClone","sap/ui/integration/util/Utils"],function(O,J,T,C,d,a,U){"use strict";var b=O.extend("sap.ui.integration.editor.fields.ObjectListField",{metadata:{library:"sap.ui.integration"},renderer:O.getMetadata().getRenderer()});b.prototype.initVisualization=function(c){var t=this;t._newObjectTemplate={"_dt":{"_selected":true,"_uuid":""}};var v=c.visualization;if(!v){if(c.value&&!c.properties&&(!c.values||(c.values&&!c.values.metadata))){t.parseValueProperties();}if(c.values||c.properties){v=t.createTableVisualization(c);}else{v=t.createTextAreaVisualization(c);}c.withLabel=true;}this._visualization=v;this.attachAfterInit(this._afterInit);};b.prototype._afterInit=function(){var t=this;var c=t.getAggregation("_field");if(c instanceof T){c.addStyleClass("sapUiIntegrationEditorItemObjectListFieldTable");var o=t.getConfiguration();if(!o.values){var v=a(o.value,500)||[];v.forEach(function(i){i._dt=i._dt||{};i._dt._selected=true;i._dt._uuid=i._dt._uuid||U.generateUuidV4();});t.setModel(new J({value:v,_allSelected:true}));t.bindObject({path:"/value"});}}};b.prototype.parseValueProperties=function(){var t=this;var c=t.getConfiguration();if(Array.isArray(c.value)&&c.value.length>0&&!c.properties){var p={};c.value.forEach(function(o){for(var n in o){if(!p[n]&&n!=="_dt"){var s=typeof o[n];var P=s==="string"?{}:{"type":s};p[n]=P;}}});if(!d(p,{})){c.properties=p;c._propertiesParsedFromValue=true;}}};b.prototype.buildSelectionColumnLables=function(){var t=this;var c=t.getConfiguration();var r=t.getResourceBundle();return new C({selected:"{/_allSelected}",visible:typeof c.values!=="undefined",tooltip:{path:'/_allSelected',formatter:function(A){if(!A){return r.getText("EDITOR_FIELD_OBJECT_LIST_TABLE_COLUMN_SELECTION_TOOLTIP_ADDALL");}else{return r.getText("EDITOR_FIELD_OBJECT_LIST_TABLE_COLUMN_SELECTION_TOOLTIP_REMOVEALL");}}},select:t.onSelectionColumnClick.bind(t)});};b.prototype.onSelectionColumnClick=function(e){var t=this;var i=e.getParameter("selected");var o=t.getAggregation("_field");var r=o.getBinding("rows").getContexts();r.forEach(function(R){var I=R.getObject();I._dt=I._dt||{};I._dt._selected=i;});var m=o.getModel();var p=o.getBinding("rows").getPath();var D=m.getProperty(p);var v;D.forEach(function(c){if(c._dt&&c._dt._selected){var f=a(c,500);v=v||[];v.push(f);}});m.checkUpdate(true);t.setValue(v);};b.prototype.updateSelectionColumn=function(){var t=this;var o=t.getAggregation("_field");var r=o.getBinding("rows").getContexts();var A=true;if(r.length===0){A=false;}else{for(var i=0;i<r.length;i++){var c=r[i].getObject();if(!c._dt||c._dt._selected!==true){A=false;break;}}}o.getModel().setProperty("/_allSelected",A);};b.prototype.onAdd=function(e){var t=this;var c=t.getAggregation("_field");var n=t._oObjectDetailsPopover.getModel().getProperty("/value");var p=c.getBinding("rows").getPath();var m=c.getModel();var D=m.getProperty(p);D.push(n);m.setProperty("/_hasTableAllSelected",false);m.setProperty("/_hasTableSelected",false);m.checkUpdate();t.refreshValue();t._oObjectDetailsPopover.close();};b.prototype.refreshValue=function(){var t=this;var o=t.getAggregation("_field");var m=o.getModel();var p=o.getBinding("rows").getPath();var D=m.getProperty(p);var v=[];D.forEach(function(i){if(i._dt._selected){var c=a(i);v.push(c);}});t.setValue(v);};b.prototype.onSelectionChange=function(e){var t=this;var s=e.getParameter("selected");var v=this._getCurrentProperty("value");var o=t.getAggregation("_field");var m=o.getModel();if(s||v.length>1){t.refreshValue();t.updateSelectionColumn();}else{m.setProperty("/_allSelected",false);t.setValue(undefined);}};b.prototype.mergeValueWithRequestResult=function(t){var c=this;var o=c.getConfiguration();var e=c.getAggregation("_field");var m=e.getModel();if(o.value&&Array.isArray(o.value)&&o.value.length>0){var v=a(o.value,500),p=e.getBinding("rows").getPath();if(Array.isArray(t)&&t.length>0){var u=[];v.forEach(function(f){var s;if(!f._dt){s=U.generateUuidV4();}else{s=f._dt._uuid||U.generateUuidV4();delete f._dt._uuid;}u.push(s);});var n=[];for(var i=0;i<t.length;i++){var r=t[i];var I=false;for(var j=0;j<v.length;j++){if(d(r,v[j])){I=true;break;}}if(!I){r._dt._uuid=U.generateUuidV4();n.push(r);}}for(var k=0;k<v.length;k++){var V=v[k];V._dt=V._dt||{};V._dt._selected=true;V._dt._uuid=u[k];}if(n.length>0){m.setProperty("/_allSelected",false);v=v.concat(n);}else{m.setProperty("/_allSelected",true);}}else{v.forEach(function(f){f._dt=f._dt||{};f._dt._selected=true;f._dt._uuid=f._dt._uuid||U.generateUuidV4();});m.setProperty("/_allSelected",true);}m.setProperty(p,v);}else{if(Array.isArray(t)&&t.length>0){t.forEach(function(R){R._dt._uuid=U.generateUuidV4();});}m.setProperty("/_allSelected",false);}m.checkUpdate();};b.prototype.onChangeOfTextArea=function(E){var t=this;var r=t.getResourceBundle();var o=E.getSource();var v=o.getValue();if(!v||v===""){t.saveValue(undefined,o);}else{try{var V=JSON.parse(v);if(!(V instanceof Array)){o.setValueState("Error");o.setValueStateText(r.getText("EDITOR_VAL_NOT_AN_ARRAY_OF_JSONOBJECTS"));return;}t.saveValue(V,o);}catch(e){o.setValueState("Error");o.setValueStateText(r.getText("EDITOR_VAL_NOT_A_JSONOBJECT"));}}};b.prototype.saveValue=function(v,t,i){var c=this;var V;if(!i){c.setValue(v);}else{V=t.getModel();V.setProperty("/value",v);}t.setValueState("None");t.setValueStateText("");};b.prototype.cleanDT=function(v){if(v){v.forEach(function(i){if(i&&i._dt&&i._dt._selected){delete i._dt._selected;}if(i&&i._dt&&d(i._dt,{})){delete i._dt;}});}};return b;});
