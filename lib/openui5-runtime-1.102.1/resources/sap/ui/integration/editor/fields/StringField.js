/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/integration/editor/fields/BaseField","sap/m/Input","sap/m/Text","sap/m/Title","sap/m/Select","sap/m/ComboBox","sap/m/Popover","sap/m/Button","sap/m/OverflowToolbar","sap/m/ToolbarSpacer","sap/ui/core/ListItem","sap/m/List","sap/m/CustomListItem","sap/m/VBox","sap/base/util/each","sap/base/util/restricted/_debounce","sap/ui/core/Core","sap/ui/model/json/JSONModel","sap/ui/integration/editor/EditorResourceBundles","sap/base/util/deepClone","sap/ui/model/Sorter",'sap/m/GroupHeaderListItem',"sap/base/util/includes","sap/ui/core/CustomData"],function(B,I,T,a,S,C,P,b,O,c,L,d,e,V,f,_,g,J,E,h,j,G,k,l){"use strict";var R=/parameters\.([^\}\}]+)/g;var s=["TODAY_ISO","NOW_ISO","LOCALE"];var m=B.extend("sap.ui.integration.editor.fields.StringField",{metadata:{library:"sap.ui.integration"},renderer:B.getMetadata().getRenderer()});m.prototype.initVisualization=function(o){var v=o.visualization;if(!v){var r=o.value?o.value.match(R):undefined;var p,n,q;if(r&&r.length>0){r=r.filter(function(i){var u=i.substring(11);return!k(s,u);});}if(r&&r.length>0){p=r.map(function(i){if(this.isOrigLangField){return"items>"+i.substring(11)+"/_language/value";}return"items>"+i.substring(11)+"/value";}.bind(this));p.unshift("currentSettings>value");n={parts:p,formatter:function(u){var A=Array.prototype.slice.call(arguments,1);for(var i=0;i<A.length;i++){if(A[i]){u=u.replaceAll("{{"+r[i]+"}}",A[i]);}}return u;}};q=function(i){var u=i.getSource().getValue();var w=this.getBindingContext("currentSettings").sPath;this._settingsModel.setProperty(w+"/value",u);var x=this._settingsModel.getBindings();var y=w.substring(w.lastIndexOf("/")+1);f(x,function(z,A){if(A.sPath==="/form/items/"+y+"/value"){A.checkUpdate(true);}});}.bind(this);}if(this.getMode()==="translation"){if(o.editable){v={type:I,settings:{value:{path:'currentSettings>value'},tooltip:{path:'currentSettings>value'},editable:o.editable,visible:o.visible,placeholder:o.placeholder}};}else{v={type:T,settings:{text:{path:'currentSettings>value'},tooltip:{path:'currentSettings>value'},visible:o.visible,wrapping:false}};}}else if(o.enum){var t=new L({key:{path:"currentSettings>"},text:{path:"currentSettings>"}});v={type:S,settings:{selectedKey:{path:'currentSettings>value'},forceSelection:false,editable:o.editable,visible:o.visible,showSecondaryValues:false,width:"100%",items:{path:"currentSettings>enum",template:t}}};}else if(o.values){var t=this.formatListItem(o.values.item);if(!o.values.item.key){o.values.item.key=o.values.item.text;}v={type:C,settings:{busy:{path:'currentSettings>_loading'},selectedKey:{path:'currentSettings>value'},editable:o.editable,visible:o.visible,showSecondaryValues:true,width:"100%",items:{path:"",template:t}}};if(this.isFilterBackend()){v.settings.selectedKey={parts:['currentSettings>value','currentSettings>suggestValue'],formatter:function(i,u){if((!i||i==="")&&u){return u.replaceAll('\'\'',"'");}else{return i;}}};}}else if(this.getMode()!=="translation"&&o.translatable){v={type:I,settings:{value:{path:'currentSettings>value'},tooltip:{path:'currentSettings>value'},editable:o.editable,visible:o.visible,placeholder:o.placeholder,valueHelpIconSrc:"sap-icon://translate",showValueHelp:true,valueHelpRequest:this.openTranslationListPopup,change:function(i){var u=i.getSource();var w=u.getValue();var x=g.getConfiguration().getLanguage().replaceAll('_','-');u.getParent().setTranslationValueInTexts(x,o.manifestpath,w);}}};if(p){delete v.settings.tooltip;v.settings.value=n;v.settings.change=q;v.settings.showValueHelp=false;delete v.settings.valueHelpRequest;}}else{v={type:I,settings:{value:{path:'currentSettings>value'},tooltip:{path:'currentSettings>value'},editable:o.editable,visible:o.visible,placeholder:o.placeholder}};if(p){delete v.settings.tooltip;v.settings.value=n;v.settings.change=q;}}}else if(v.type==="TextArea"){v.type="sap/m/TextArea";}this._visualization=v;this.attachAfterInit(this._afterInit);};m.prototype._afterInit=function(){var o=this.getAggregation("_field");if(o instanceof C){if(this.isFilterBackend()){this.onInput=_(this.onInput,500);o.oninput=this.onInput.bind(this);o.attachSelectionChange(this.onSelectionChange.bind(this));}}};m.prototype.onSelectionChange=function(o){var i=o.getParameter("selectedItem")||{};var K=i.getKey();var n=this.getBindingContext("currentSettings").sPath;this._settingsModel.setProperty(n+"/value",K);};m.prototype.onInput=function(o){var t=o.target.value;var i=this.getBindingContext("currentSettings").sPath;this._settingsModel.setProperty(i+"/suggestValue",t.replaceAll("'","\'\'"));this._settingsModel.setProperty(i+"/_loading",true);this._settingsModel.setProperty(i+"/value","");var n=this._settingsModel.getBindings();var p=i.substring(i.lastIndexOf("/")+1);f(n,function(r,u){if(u.sPath==="/form/items/"+p+"/value"){u.checkUpdate(true);}});var q=o.srcControl;q.open();q.setValue(t);q.setSelection(null);};m.prototype.getOriginTranslatedValues=function(o){var i=[];var n=E.getInstance();var K;if(o._translatedDefaultPlaceholder&&o._translatedDefaultPlaceholder.startsWith("{i18n>")&&o._translatedDefaultPlaceholder.endsWith("}")){K=o._translatedDefaultPlaceholder.substring(6,o._translatedDefaultPlaceholder.length-1);}else if(o._translatedDefaultPlaceholder&&o._translatedDefaultPlaceholder.startsWith("{{")&&o._translatedDefaultPlaceholder.endsWith("}}")){K=o._translatedDefaultPlaceholder.substring(2,o._translatedDefaultPlaceholder.length-2);}for(var p in n){var r=n[p];var t="";var q="";if(K&&r){var u=r.resourceBundle&&r.resourceBundle.getText(K,[],true);if(u!==undefined){t=u;q=u;}else{t=o._translatedValue||"";q=o._translatedValue||"";}}else{t=o._translatedDefaultPlaceholder||"";q=o._translatedDefaultPlaceholder||"";}var v={"key":p,"desription":r.language,"value":t,"originValue":q,"editable":true};i.push(v);}return i;};m.prototype.getTranslationValueInTexts=function(i,M){var t="/texts/"+i;var p=this._settingsModel.getProperty(t)||{};return p[M];};m.prototype.setTranslationValueInTexts=function(i,M,v){var t="/texts";var D=this._settingsModel.getData();if(!D){return;}if(!D.hasOwnProperty("texts")){var o={};o[i]={};o[i][M]=v;this._settingsModel.setProperty(t,o);}else{t="/texts/"+i;var n;if(!D.texts.hasOwnProperty(i)){n={};}else{n=D.texts[i];}n[M]=v;this._settingsModel.setProperty(t,n);}};m.prototype.openTranslationListPopup=function(o){var t=this;var i=o.getSource();var F=i.getParent();var n=F.getConfiguration();if(!t._aOriginTranslatedValues){t._aOriginTranslatedValues=F.getOriginTranslatedValues(n);}var p=h(t._aOriginTranslatedValues,500);var r=F.getResourceBundle();p.forEach(function(w){var x=F.getTranslationValueInTexts(w.key,n.manifestpath);if(x){w.value=x;if(!k(t._aUpdatedLanguages,w.key)){w.originValue=w.value;}}else if(n._beforeLayerChange){w.value=n._beforeLayerChange;if(!k(t._aUpdatedLanguages,w.key)){w.originValue=w.value;}}w.status=r.getText("EDITOR_FIELD_TRANSLATION_LIST_POPOVER_LISTITEM_GROUP_NOTUPDATED");if(w.key===r.sLocale.replaceAll('_','-')){w.editable=false;}});var q={"currentLanguage":{},"isUpdated":false,"translatedLanguages":[]};var M;if(p){p.forEach(function(w){if(k(t._aUpdatedLanguages,w.key)){w.value=F.getTranslationValueInTexts(w.key,n.manifestpath);w.status=r.getText("EDITOR_FIELD_TRANSLATION_LIST_POPOVER_LISTITEM_GROUP_UPDATED");}if(w.key===r.sLocale.replaceAll('_','-')){w.value=i.getValue();q.currentLanguage=w;}else{q.translatedLanguages.push(w);}});}if(!t._oTranslationPopover){var u=new d({items:{path:"languages>/translatedLanguages",template:new e({content:[new V({items:[new T({text:"{languages>desription}"}),new I({value:"{languages>value}",editable:"{languages>editable}"})]})],customData:[new l({key:"{languages>key}",value:"{languages>desription}"})]}),sorter:[new j({path:'status',descending:true,group:true})],groupHeaderFactory:F.getGroupHeader}});var v=F._previewPosition==="right"?"Right":"Left";t._oTranslationPopover=new P({placement:v,contentWidth:"300px",contentHeight:"345px",customHeader:new V({items:[new a({text:r.getText("EDITOR_FIELD_TRANSLATION_LIST_POPOVER_TITLE")}).addStyleClass("sapMPopoverTitle"),new a({text:r.getText("EDITOR_FIELD_TRANSLATION_LIST_POPOVER_CURRENTLANGUAGE")}).addStyleClass("sapMHeaderTitle"),new V({items:[new T({text:"{languages>/currentLanguage/desription}"}),new I({value:"{languages>/currentLanguage/value}",editable:false})]}).addStyleClass("sapMCurrentLanguageVBox"),new a({text:r.getText("EDITOR_FIELD_TRANSLATION_LIST_POPOVER_OTHERLANGUAGES")}).addStyleClass("sapMHeaderTitle")]}),content:u,footer:new O({content:[new c(),new b({type:"Emphasized",text:r.getText("EDITOR_FIELD_TRANSLATION_LIST_POPOVER_BUTTON_SAVE"),enabled:"{languages>/isUpdated}",press:function(){var w=t._oTranslationPopover.getModel("languages").getData();var U=[];w.translatedLanguages.forEach(function(x){if(x.value!==x.originValue){F.setTranslationValueInTexts(x.key,n.manifestpath,x.value);U.push(x.key);}});if(w.currentLanguage.value!=w.currentLanguage.originValue){F.setTranslationValueInTexts(w.currentLanguage.key,n.manifestpath,w.currentLanguage.value);U.push(w.currentLanguage.key);}if(U.length>0){t._aUpdatedLanguages=U;}t._oTranslationPopover.close();}}),new b({text:r.getText("EDITOR_FIELD_TRANSLATION_LIST_POPOVER_BUTTON_CANCEL"),press:function(){t._oTranslationPopover.close();}})]})}).addStyleClass("sapUiIntegrationFieldTranslation");M=new J(q);M.attachPropertyChange(function(o){var D=M.getData();var U=r.getText("EDITOR_FIELD_TRANSLATION_LIST_POPOVER_LISTITEM_GROUP_UPDATED");var N=r.getText("EDITOR_FIELD_TRANSLATION_LIST_POPOVER_LISTITEM_GROUP_NOTUPDATED");var w=false;D.translatedLanguages.forEach(function(x){if(x.value!==x.originValue){x.status=U;w=true;}else{x.status=N;}});D.isUpdated=w;M.setData(D);M.checkUpdate(true);});t._oTranslationPopover.setModel(M,"languages");}else{M=t._oTranslationPopover.getModel("languages");M.setData(q);M.checkUpdate(true);}t._oTranslationPopover.openBy(i._oValueHelpIcon);};m.prototype.getGroupHeader=function(o){return new G({title:o.key,upperCase:false});};return m;});
