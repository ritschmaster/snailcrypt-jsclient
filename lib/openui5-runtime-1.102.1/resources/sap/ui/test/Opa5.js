/*!
* OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
*/
sap.ui.define(['sap/ui/test/Opa','sap/ui/test/OpaPlugin','sap/ui/test/PageObjectFactory','sap/ui/base/Object','sap/ui/test/launchers/iFrameLauncher','sap/ui/test/launchers/componentLauncher','sap/ui/core/routing/HashChanger','sap/ui/test/matchers/Matcher','sap/ui/test/matchers/AggregationFilled','sap/ui/test/matchers/PropertyStrictEquals','sap/ui/test/pipelines/ActionPipeline','sap/ui/test/_ParameterValidator','sap/ui/test/_OpaLogger','sap/ui/thirdparty/URI','sap/ui/base/EventProvider','sap/ui/qunit/QUnitUtils','sap/ui/test/autowaiter/_autoWaiter','sap/ui/dom/includeStylesheet','sap/ui/thirdparty/jquery','sap/ui/test/_OpaUriParameterParser','sap/ui/test/_ValidationParameters','sap/base/util/extend','sap/base/util/isPlainObject'],function(O,a,P,U,f,c,H,M,A,b,d,_,e,g,E,Q,h,j,$,k,l,m,n){"use strict";var L=e.getLogger("sap.ui.test.Opa5"),o=new d(),F="OpaFrame",v=new _({errorPrefix:"sap.ui.test.Opa5#waitFor"}),C=Object.keys(l.OPA5_WAITFOR_CONFIG),p=Object.keys(l.OPA_WAITFOR),q=[],r=new E();var s=U.extend("sap.ui.test.Opa5",$.extend({},O.prototype,{constructor:function(){O.apply(this,arguments);}}));s._appUriParams=k._getAppParams();s._allUriParams=new g().search(true);s._oPlugin=new a();function S(){var i={};var B=["source","timeout","autoWait","width","height"];if(arguments.length===1&&$.isPlainObject(arguments[0])){i=arguments[0];}else{var V=arguments;B.forEach(function(K,N){i[K]=V[N];});}if(i.source&&typeof i.source!=="string"){i.source=i.source.toString();}var D=new g(i.source?i.source:'');D.search($.extend(D.search(true),O.config.appParams));var G=w();G.success=function(){u({source:D.toString(),width:i.width||O.config.frameWidth,height:i.height||O.config.frameHeight});};this.waitFor(G);var I=w();I.check=f.hasLaunched;I.timeout=i.timeout||80;I.errorMessage="unable to load the IFrame with the url: "+i.source;this.waitFor(I);var J=w();J.success=function(){this._loadExtensions(f.getWindow());}.bind(this);this.waitFor(J);var W=w();W.autoWait=i.autoWait||false;W.timeout=i.timeout||80;return this.waitFor(W);}s.prototype.iStartMyUIComponent=function N(i){var B=this;var D=false;i=i||{};var G=w();G.success=function(){var R=new g();R.search($.extend(R.search(true),O.config.appParams));window.history.replaceState({},"",R.toString());};this.waitFor(G);var I=w();I.success=function(){var R=sap.ui.require.toUrl("sap/ui/test/OpaCss")+".css";j(R);H.getInstance().setHash(i.hash||"");c.start(i.componentConfig).then(function(){D=true;});};this.waitFor(I);var J=w();J.errorMessage="Unable to load the component with the name: "+i.name;J.check=function(){return D;};if(i.timeout){J.timeout=i.timeout;}B.waitFor(J);var K=w();K.success=function(){this._loadExtensions(window);}.bind(this);this.waitFor(K);var W=w();W.autoWait=i.autoWait||false;W.timeout=i.timeout||80;return this.waitFor(W);};s.prototype.iTeardownMyUIComponent=function T(){var i=w();i.success=function(){c.teardown();};var B=w();B.success=function(){var D=new g();D.search(s._allUriParams);window.history.replaceState({},"",D.toString());};return $.when(this.waitFor(i),this.waitFor(B));};s.prototype.iTeardownMyApp=function(){var i=this;var B=w();B.success=function(){i._unloadExtensions(s.getWindow());};var D=w();D.success=function(){if(f.hasLaunched()){this.iTeardownMyAppFrame();}else if(c.hasLaunched()){this.iTeardownMyUIComponent();}else{var G="A teardown was called but there was nothing to tear down use iStartMyComponent or iStartMyAppInAFrame";L.error(G,"Opa");throw new Error(G);}}.bind(this);return $.when(this.waitFor(B),this.waitFor(D));};s.iStartMyAppInAFrame=S;s.prototype.iStartMyAppInAFrame=S;function t(){var W=w();W.success=function(){f.teardown();};return this.waitFor(W);}s.iTeardownMyAppFrame=t;s.prototype.iTeardownMyAppFrame=t;s.prototype.hasAppStartedInAFrame=function(){return f.hasLaunched();};s.prototype.hasUIComponentStarted=function(){return c.hasLaunched();};s.prototype.hasAppStarted=function(){return f.hasLaunched()||c.hasLaunched();};s.prototype.waitFor=function(i){var B=x(i);var D=y(i,B);if(D){D.success=function(N){var W=Array.isArray(N)?N[0]:N;var X=z(i,B,W);return s.prototype.waitFor.call(this,X);};return s.prototype.waitFor.call(this,D);}var G=i.actions,I=O._createFilteredConfig(C),J;i=$.extend({},I,i);i.actions=G;v.validate({validationInfo:l.OPA5_WAITFOR,inputToValidate:i});var K=i.check,N=null,R=i.success,T,V;J=O._createFilteredOptions(p,i);J.check=function(){var W=!!i.actions||i.autoWait;var X=s._getAutoWaiter();X.extendConfig(i.autoWait);if(W&&X.hasToWait()){return false;}var Y=s.getPlugin();var Z=$.extend({},i,{interactable:W||i.interactable});T=Y._getFilteredControls(Z,N);if(f.hasLaunched()&&Array.isArray(T)){var a1=[];T.forEach(function(b1){a1.push(b1);});T=a1;}if(T===a.FILTER_FOUND_NO_CONTROLS){L.debug("Matchers found no controls so check function will be skipped");return false;}if(K){return this._executeCheck(K,T);}return true;};J.success=function(){var W=O._getWaitForCounter();if(G&&(T||!V)){o.process({actions:G,control:T});}if(!R){return;}var X=[];if(T){X.push(T);}if(W.get()===0){L.timestamp("opa.waitFor.success");L.debug("Execute success handler");R.apply(this,X);return;}var Y=w();if($.isPlainObject(i.autoWait)){Y.autoWait=$.extend({},i.autoWait);}else{Y.autoWait=i.autoWait;}Y.success=function(){R.apply(this,X);};this.waitFor(Y);};return O.prototype.waitFor.call(this,J);};s.getPlugin=function(){return f.getPlugin()||s._oPlugin;};s.getJQuery=function(){return f.getJQuery()||$;};s.getWindow=function(){return f.getWindow()||window;};s.getUtils=function(){return f.getUtils()||Q;};s.getHashChanger=function(){return f.getHashChanger()||H.getInstance();};s._getAutoWaiter=function(){return f._getAutoWaiter()||h;};s.extendConfig=function(i){O.extendConfig(i);O.extendConfig({appParams:s._appUriParams});s._getAutoWaiter().extendConfig(i.autoWait);};s.resetConfig=function(){O.resetConfig();O.extendConfig({viewNamespace:"",arrangements:new s(),actions:new s(),assertions:new s(),visible:true,enabled:undefined,editable:undefined,autoWait:false,_stackDropCount:1});O.extendConfig({appParams:s._appUriParams});};s.getTestLibConfig=function(T){return O.config.testLibs&&O.config.testLibs[T]?O.config.testLibs[T]:{};};s.emptyQueue=O.emptyQueue;s.stopQueue=O.stopQueue;s.getContext=O.getContext;s.matchers={};s.matchers.Matcher=M;s.matchers.AggregationFilled=A;s.matchers.PropertyStrictEquals=b;s.createPageObjects=function(i){return P.create(i,s);};s.prototype._executeCheck=function(i,B){var D=[];B&&D.push(B);L.debug("Executing OPA check function on controls "+B);L.debug("Check function is:\n"+i);var R=i.apply(this,D);L.debug("Result of check function is: "+R||"not defined or null");return R;};s.prototype.iWaitForPromise=function(i){var B=w();return O.prototype._schedulePromiseOnFlow.call(this,i,B);};s.resetConfig();function u(i){var I=sap.ui.require.toUrl("sap/ui/test/OpaCss")+".css";j(I);var B=$.extend({},i,{frameId:F,opaLogLevel:O.config.logLevel,disableHistoryOverride:O.config.disableHistoryOverride});return f.launch(B);}function w(){return{viewName:null,controlType:null,id:null,searchOpenDialogs:false,autoWait:false};}$(function(){if($("#"+F).length){u();}$("body").addClass("sapUiBody");$("html").height("100%");});s._getEventProvider=function(){return r;};s.prototype._loadExtensions=function(i){var B=O.config.extensions?O.config.extensions:[];var D=$.when.apply($,$.map(B,function(G){var I=$.Deferred();i.sap.ui.require([G],function(J){var K=new J();K.name=K.getMetadata?K.getMetadata().getName():G;this._executeExtensionOnAfterInit(K,i).done(function(){s._getEventProvider().fireEvent('onExtensionAfterInit',{extension:K,appWindow:i});this._addExtension(K);I.resolve();}.bind(this)).fail(function(N){L.error(new Error("Error during extension init: "+N),"Opa");I.resolve();});}.bind(this));return I.promise();}.bind(this)));return this.iWaitForPromise(D);};s.prototype._unloadExtensions=function(i){var B=this;var D=$.when.apply($,$.map(this._getExtensions(),function(G){var I=$.Deferred();s._getEventProvider().fireEvent('onExtensionBeforeExit',{extension:G});B._executeExtensionOnBeforeExit(G,i).done(function(){I.resolve();}).fail(function(J){L.error(new Error("Error during extension init: "+J),"Opa");I.resolve();});return I.promise();}));this.iWaitForPromise(D);};s.prototype._addExtension=function(i){q.push(i);};s.prototype._getExtensions=function(){return q;};s.prototype._executeExtensionOnAfterInit=function(i,B){var D=$.Deferred();var G=i.onAfterInit;if(G){G.bind(B)().done(function(){D.resolve();}).fail(function(I){D.reject(new Error("Error while waiting for extension: "+i.name+" to init, details: "+I));});}else{D.resolve();}return D.promise();};s.prototype._executeExtensionOnBeforeExit=function(i,B){var D=$.Deferred();var G=i.onBeforeExit;if(G){G.bind(B)().done(function(){D.resolve();}).fail(function(I){D.reject(new Error("Error while waiting for extension: "+i.name+" to exit, details: "+I));});}else{D.resolve();}return D.promise();};function x(i){var B;["ancestor","descendant","sibling"].forEach(function(D){if(i[D]&&n(i[D])){B=[D];}else if(i.matchers&&i.matchers[D]&&n(i.matchers[D])){B=["matchers",D];}});return B;}function y(i,B){if(B){var R=i;B.forEach(function(D){if(R[D]!==undefined){R=R[D];}});return R;}}function z(B,D,G){if(D){var R=m({},B);var I=R;var i=0;while(i<D.length-1){I=R[D[i++]];}I[D[i]]=G;return R;}}return s;});
