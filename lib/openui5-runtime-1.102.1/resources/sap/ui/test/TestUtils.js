/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/Log","sap/base/util/merge","sap/base/util/UriParameters","sap/ui/thirdparty/jquery","sap/ui/core/Core"],function(L,m,U,q){"use strict";var r=/\/\$batch($|\?)/,a=/(?:^|\r\n)Content-Id\s*:\s*(\S+)/i,b=/^(.*)?:\s*(.*)$/,j="application/json;charset=UTF-8;IEEE754Compatible=true",M={},s="\r\nContent-Type: application/http\r\n"+"Content-Transfer-Encoding: binary\r\n",c=/^Content-Type:\s*multipart\/mixed;\s*boundary=/i,u=U.fromQuery(window.location.search),A=u.get("autoRespondAfter"),R=u.get("realOData"),d=/^(\S+) (\S+)$/,e=/^(GET|DELETE|MERGE|PATCH|POST) (\S+) HTTP\/1\.1$/,D={},f=/^(OData-Version|DataServiceVersion)$/,g=R==="true"||R==="direct",h=0,o=u.get("optimisticBatch"),O=o===null?undefined:o==="true",S=u.get("supportAssistant")==="true",T;if(g){document.title=document.title+" (real OData)";}function k(i,E,P){var l=QUnit.objectType(i),n=QUnit.objectType(E),N;if(l==="string"&&n==="regexp"){if(!E.test(i)){throw new Error(P+": actual value "+i+" does not match expected regular expression "+E);}return;}if(l!==n){throw new Error(P+": actual type "+l+" does not match expected type "+n);}if(l==="array"){if(i.length<E.length){throw new Error(P+": array length: "+i.length+" < "+E.length);}}if(l==="array"||l==="object"){for(N in E){k(i[N],E[N],P==="/"?P+N:P+"/"+N);}}else if(i!==E){throw new Error(P+": actual value "+i+" does not match expected value "+E);}}function p(i,E,l,n){try{k(i,E,"/");QUnit.assert.pushResult({result:n,actual:i,expected:E,message:l});}catch(t){QUnit.assert.pushResult({result:!n,actual:i,expected:E,message:(l||"")+" failed because of "+t.message});}}T={awaitRendering:function(){if(sap.ui.getCore().getUIDirty()){return new Promise(function(i){function l(){if(sap.ui.getCore().getUIDirty()){setTimeout(l,1);}else{i();}}l();});}},checkError:function(i,E,C,l){i.strictEqual(E.constructor,C);i.strictEqual(E.message,l);i.strictEqual(E.name,C.name);},deepContains:function(i,E,l){p(i,E,l,true);},notDeepContains:function(i,E,l){p(i,E,l,false);},useFakeServer:function(i,B,F,l,n,t){var v,w;function x(Z,$){var _=P(Z,$.requestBody),a1=K($);h+=1;$.respond(200,q.extend({},a1,{"Content-Type":"multipart/mixed;boundary="+_.boundary}),H(_,a1));}function y(Z){var $={buildResponse:Z.buildResponse,code:Z.code||200,headers:Z.headers||{},ifMatch:Z.ifMatch};if(Z.source){$.message=W(B+Z.source);$.headers["Content-Type"]=$.headers["Content-Type"]||C(Z.source);}else if(typeof Z.message==="object"){$.headers["Content-Type"]=j;$.message=JSON.stringify(Z.message);}else{$.message=Z.message;}return $;}function z(){var Z,$,_={};for($ in F){Z=F[$];if(!$.includes(" ")){$="GET "+$;}if(Array.isArray(Z)){_[$]=Z.map(y);}else{_[$]=[y(Z)];}}return _;}function C(Z){if(/\.xml$/.test(Z)){return"application/xml";}if(/\.json$/.test(Z)){return j;}return"application/x-octet-stream";}function E(Z,$,_){L.error($.requestLine||$.method+" "+$.url,_,"sap.ui.test.TestUtils");return{code:Z,headers:{"Content-Type":"text/plain"},message:_};}function G(Z){return Z.slice(0,Z.indexOf("\r\n"));}function H(Z,$){var _=[""];Z.parts.every(function(a1){_.push(a1.boundary?"\r\nContent-Type: multipart/mixed;boundary="+a1.boundary+"\r\n\r\n"+H(a1,$):I(a1,$));return!a1.code||a1.code<400||$.DataServiceVersion==="2.0";});_.push("--\r\n");return _.join("--"+Z.boundary);}function I(Z,$){var _=q.extend({},$,Z.headers);return s+(Z.contentId?"Content-ID: "+Z.contentId+"\r\n":"")+"\r\nHTTP/1.1 "+Z.code+" \r\n"+Object.keys(_).map(function(a1){return a1+": "+_[a1];}).join("\r\n")+"\r\n\r\n"+(Z.message||"")+"\r\n";}function J(Z,$){var _,a1,b1=Z+" "+$;if(w[b1]){return{responses:w[b1]};}if(!v){return undefined;}_=[];a1=v.filter(function(c1){var d1=b1.match(c1.regExp);if(d1){_.push(d1);}return d1;});if(a1.length>1){L.warning("Multiple matches found for "+b1,undefined,"sap.ui.test.TestUtils");return undefined;}return a1.length?{responses:a1[0].response,match:_[0]}:undefined;}function K(Z){var $,_={};for($ in Z.requestHeaders){if(f.test($)){_[$]=Z.requestHeaders[$];}}return _;}function N(Z,$){var _,a1=J(Z.method,Z.url),b1,c1=a1&&a1.responses;c1=(c1||[]).filter(function(b1){if(typeof b1.ifMatch==="function"){return b1.ifMatch(Z);}return!b1.ifMatch||b1.ifMatch.test(Z.requestBody);});if(c1.length){b1=c1[0];if(typeof b1.buildResponse==="function"){b1=m({},b1);b1.buildResponse(a1.match,b1);}if(a1.responses.length>1){_=a1.responses.indexOf(b1);}}else if(!t){switch(Z.method){case"HEAD":b1={code:200};break;case"DELETE":case"MERGE":case"PATCH":b1={code:204};break;case"POST":b1={code:200,headers:{"Content-Type":j},message:Z.requestBody};break;}}if(b1){L.info(Z.method+" "+Z.url+(_!==undefined?", alternative (ifMatch) #"+_:""),'{"If-Match":'+JSON.stringify(Z.requestHeaders["If-Match"])+'}',"sap.ui.test.TestUtils");}else{b1=E(404,Z,"No mock data found");}b1.headers=q.extend({},K(Z),b1.headers);if($&&b1.code<300){b1.contentId=$;}return b1;}function P(Z,$){var _;$=$.replace(/^\s+/,"");_=G($);return{boundary:G($).slice(2),parts:$.split(_).slice(1,-1).map(function(a1){var b1,c1,d1,e1,f1,g1;a1=a1.slice(2);c1=G(a1);if(c.test(c1)){e1=P(Z,a1.slice(c1.length+4));b1=e1.parts.filter(function(h1){return h1.code>=300;});return b1.length?b1[0]:e1;}g1=a1.indexOf("\r\n\r\n")+4;f1=Q(Z,a1.slice(g1));d1=a.exec(a1.slice(0,g1));return N(f1,d1&&d1[1]);})};}function Q(Z,$){var _=$.indexOf("\r\n\r\n"),a1,b1,c1={requestHeaders:{}};c1.requestBody=$.slice(_+4,$.length-2);$=$.slice(0,_);a1=$.split("\r\n");c1.requestLine=a1.shift();b1=e.exec(c1.requestLine);if(b1){c1.method=b1[1];c1.url=Z+b1[2];a1.forEach(function(d1){var b1=b.exec(d1);if(b1){c1.requestHeaders[b1[1]]=b1[2];}});}return c1;}function V(Z){var $=Z.url;if(r.test($)){x($.slice(0,$.indexOf("/$batch")+1),Z);}else{X(Z);}}function W(Z){var $=M[Z];if(!$){q.ajax({async:false,url:Z,dataType:"text",success:function(_){$=_;}});if(!$){throw new Error(Z+": resource not found");}M[Z]=$;}return $;}function X(Z){var $=N(Z);h+=1;Z.respond($.code,$.headers,$.message);}function Y(){var Z,$;w=z();if(l){v=l.map(function(_){return{regExp:_.regExp,response:Array.isArray(_.response)?_.response.map(y):[y(_.response)]};});}$=sinon.fakeServer.create();i.add($);$.autoRespond=true;if(A){$.autoRespondAfter=parseInt(A);}$.respondWith("GET",/./,X);$.respondWith("DELETE",/./,X);$.respondWith("HEAD",/./,X);$.respondWith("PATCH",/./,X);$.respondWith("MERGE",/./,X);$.respondWith("POST",/./,V);Z=$.restore;$.restore=function(){sinon.FakeXMLHttpRequest.filters=[];Z.apply(this,arguments);};sinon.xhr.supportsCORS=q.support.cors;sinon.FakeXMLHttpRequest.useFilters=true;sinon.FakeXMLHttpRequest.addFilter(function(_,a1){var b1=J(_,a1)||(n?a1.startsWith(n)||r.test(a1):_==="DELETE"||_==="HEAD"||_==="MERGE"||_==="PATCH"||_==="POST");return!b1;});return $;}B=sap.ui.require.toUrl(B).replace(/(^|\/)resources\/(~[-a-zA-Z0-9_.]*~\/)?/,"$1test-resources/")+"/";return Y();},withNormalizedMessages:function(C){var l=sinon.sandbox.create();try{var n=sap.ui.getCore(),G=n.getLibraryResourceBundle;l.stub(n,"getLibraryResourceBundle").returns({getText:function(K,t){var v=K,w=G.call(n).getText(K),i;for(i=0;i<10;i+=1){if(w.indexOf("{"+i+"}")>=0){v+=" "+(i>=t.length?"{"+i+"}":t[i]);}}return v;}});C.apply(this);}finally{l.verifyAndRestore();}},isOptimisticBatch:function(){return O;},isRealOData:function(){if(R==="proxy"){throw new Error("realOData=proxy is no longer supported");}return g;},isSupportAssistant:function(){return S;},getRealOData:function(){return R?"&realOData="+R:"";},getRequestCount:function(){return h;},proxy:function(i){L.warning("#proxy is no longer supported",null,"sap.ui.test.TestUtils");return i;},resetRequestCount:function(){h=0;},retrieveData:function(K){var v=D[K];delete D[K];return v;},setData:function(K,v){D[K]=v;},setupODataV4Server:function(i,F,l,n,t){var v={};if(this.isRealOData()){return;}if(!n){n="/";}else if(n.slice(-1)!=="/"){n+="/";}Object.keys(F).forEach(function(w){var x=d.exec(w),y,z;if(x){y=x[1]||"GET";z=x[2];}else{y="GET";z=w;}if(!z.startsWith("/")){z=n+z;}v[y+" "+z]=F[w];});T.useFakeServer(i,l||"sap/ui/core/qunit/odata/v4/data",v,t,n!=="/"?n:undefined);}};return T;},true);
