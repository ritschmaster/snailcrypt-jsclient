/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./WaiterBase","sap/ui/thirdparty/jquery"],function(W,q){"use strict";var S={PENDING:"PENDING",LOADED:"LOADED",ERROR:"ERROR"};var R=W.extend("sap.ui.test.autowaiter._ResourceWaiter",{constructor:function(){W.apply(this,arguments);this._aResources=[];var o=new window.MutationObserver(function(m){m.forEach(function(a){if(a.type==="attributes"&&a.target.tagName==="IMG"){this._trackImage(a.target);}else if(a.type==="childList"){a.addedNodes.forEach(function(n){if(n.tagName==="IMG"){this._trackImage(n);}var c=n.querySelectorAll&&n.querySelectorAll("img")||[];c.forEach(function(b){this._trackImage(b);}.bind(this));}.bind(this));if(a.nextSibling&&a.nextSibling.tagName==="IMG"){this._trackImage(a.nextSibling);}if(a.previousSibling&&a.previousSibling.tagName==="IMG"){this._trackImage(a.previousSibling);}}}.bind(this));}.bind(this));this._onElementAvailable("body",function(e){o.observe(e,{attributes:true,attributeFilter:["src"],childList:true,subtree:true});});},hasPending:function(){this._aResources.forEach(function(r){if(r.state===S.PENDING&&r.element.complete){r.state=S.LOADED;this._oLogger.trace("Image with src '"+r.element.src+"' completed");}}.bind(this));var p=this._aResources.filter(function(r){if(!q(r.element).length){this._oLogger.trace("Image with src '"+r.src+"' was removed");return false;}return r.state===S.PENDING;}.bind(this));var h=p.length>0;if(h){this._oHasPendingLogger.debug("There are "+p.length+" images still loading");p.forEach(function(r){this._oHasPendingLogger.debug("Pending image: "+r.src);}.bind(this));}return h;},_trackImage:function(e){var t=this._aResources.filter(function(r){return r.element===e;})[0];if(t){t.src=e.src;t.state=S.PENDING;this._oLogger.trace("Image with src '"+e.src+"' is updated and pending again");}else{var n={src:e.src,state:S.PENDING,element:e};this._aResources.push(n);this._oLogger.trace("Image with src '"+e.src+"' is pending");e.addEventListener("load",function(){n.state=S.LOADED;this._oLogger.trace("Image with src '"+e.src+"' loaded successfully");}.bind(this));e.addEventListener("error",function(){n.state=S.ERROR;this._oLogger.trace("Image with src '"+e.src+"' failed to load");}.bind(this));}},_onElementAvailable:function(s,o){var e=q(s);if(e.length){o(e[0]);}else{setTimeout(function(){this._onElementAvailable(s,o);}.bind(this),100);}}});return new R();});
