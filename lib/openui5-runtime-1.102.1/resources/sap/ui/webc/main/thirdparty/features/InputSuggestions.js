sap.ui.define(["sap/ui/webc/common/thirdparty/base/FeaturesRegistry","sap/ui/webc/common/thirdparty/base/i18nBundle","sap/base/security/encodeXML","sap/ui/webc/common/thirdparty/base/util/generateHighlightedMarkup","../List","../ResponsivePopover","../SuggestionItem","../SuggestionGroupItem","../Button","../Icon","../Popover","../GroupHeaderListItem","../SuggestionListItem","../generated/i18n/i18n-defaults"],function(e,t,s,n,i,o,r,u,h,c,l,a,d,m){"use strict";function I(e){return e&&typeof e==="object"&&"default"in e?e["default"]:e}var g=I(s);var p=I(n);class f{constructor(e,t,s,n){this.component=e;this.slotName=t;this.handleFocus=n;this.highlight=s;this.fnOnSuggestionItemPress=this.onItemPress.bind(this);this.fnOnSuggestionItemFocus=this.onItemFocused.bind(this);this.fnOnSuggestionItemMouseOver=this.onItemMouseOver.bind(this);this.fnOnSuggestionItemMouseOut=this.onItemMouseOut.bind(this);this._getSuggestionPopover();this.selectedItemIndex=null;this.accInfo={}}defaultSlotProperties(e){const t=this._getComponent().suggestionItems;const s=this.highlight&&!!e;const n=[];t.map((t,i)=>{const o=s?this.getHighlightedText(t,e):this.getRowText(t);const r=s?this.getHighlightedDesc(t,e):this.getRowDesc(t);return n.push({text:o,description:r,image:t.image||undefined,icon:t.icon||undefined,type:t.type||undefined,additionalText:t.additionalText||undefined,additionalTextState:t.additionalTextState,groupItem:t.groupItem,key:i})});return n}onUp(e){e.preventDefault();this._handleItemNavigation(false);return true}onDown(e){e.preventDefault();this._handleItemNavigation(true);return true}onSpace(e){if(this._isItemOnTarget()){e.preventDefault();this.onItemSelected(null,true);return true}return false}onEnter(e){if(this._isGroupOrInactiveItem){e.preventDefault();return false}if(this._isItemOnTarget()){this.onItemSelected(null,true);return true}return false}onPageUp(e){e.preventDefault();const t=this.selectedItemIndex-10>-1;if(this._hasValueState&&!t){this._focusValueState();return true}this._moveItemSelection(this.selectedItemIndex,t?this.selectedItemIndex-=10:this.selectedItemIndex=0);return true}onPageDown(e){e.preventDefault();const t=this._getItems();const s=t.length-1;const n=this.selectedItemIndex+10<=s;if(this._hasValueState&&!t){this._focusValueState();return true}this._moveItemSelection(this.selectedItemIndex,n?this.selectedItemIndex+=10:this.selectedItemIndex=s);return true}onHome(e){e.preventDefault();if(this._hasValueState){this._focusValueState();return true}this._moveItemSelection(this.selectedItemIndex,this.selectedItemIndex=0);return true}onEnd(e){e.preventDefault();const t=this._getItems().length-1;if(this._hasValueState&&!t){this._focusValueState();return true}this._moveItemSelection(this.selectedItemIndex,this.selectedItemIndex=t);return true}onTab(e){if(this._isItemOnTarget()){this.onItemSelected(null,true);return true}return false}toggle(e,{preventFocusRestore:t}){const s=e!==undefined?e:!this.isOpened();if(s){this.open()}else{this.close(t)}}async _isScrollable(){const e=await this._getScrollContainer();return e.offsetHeight<e.scrollHeight}async open(){this._getComponent().open=true;this._beforeOpen();this.responsivePopover.showAt(this._getComponent())}async close(e=false){const t=this._getItems()&&this._getItems()[this.selectedItemIndex];this._getComponent().open=false;this.responsivePopover=await this._getSuggestionPopover();this.responsivePopover.close(false,false,e);if(t&&t.focused){t.focused=false}}updateSelectedItemPosition(e){this.selectedItemIndex=e}onItemFocused(){this._getComponent().onItemFocused()}onItemMouseOver(e){this._getComponent().onItemMouseOver(e)}onItemMouseOut(e){this._getComponent().onItemMouseOut(e)}onItemSelected(e,t){const s=this._getItems();const n=e||s[this.selectedItemIndex];this.selectedItemIndex=s.indexOf(n);this.accInfo={currentPos:this.selectedItemIndex+1,listSize:s.length,itemText:n.textContent};if(n.type==="Inactive"||n.group){return}this._getComponent().onItemSelected(this._getRealItems()[this.selectedItemIndex],t);n.selected=false;n.focused=false;this._getComponent().open=false}onItemPreviewed(e){this._getComponent().onItemPreviewed(e)}onItemPress(e){this.onItemSelected(e.detail.selectedItems[0],false)}_beforeOpen(){this._attachItemsListeners();this._attachPopupListeners()}async _attachItemsListeners(){const e=await this._getList();e.removeEventListener("ui5-selection-change",this.fnOnSuggestionItemPress);e.addEventListener("ui5-selection-change",this.fnOnSuggestionItemPress);e.removeEventListener("ui5-item-focused",this.fnOnSuggestionItemFocus);e.addEventListener("ui5-item-focused",this.fnOnSuggestionItemFocus);e.removeEventListener("mouseover",this.fnOnSuggestionItemMouseOver);e.addEventListener("mouseover",this.fnOnSuggestionItemMouseOver);e.removeEventListener("mouseout",this.fnOnSuggestionItemMouseOut);e.addEventListener("mouseout",this.fnOnSuggestionItemMouseOut)}_attachPopupListeners(){if(!this.handleFocus){return}if(!this.attachedAfterOpened){this._getSuggestionPopover.addEventListener("ui5-after-open",this._onOpen.bind(this));this.attachedAfterOpened=true}if(!this.attachedAfterClose){this._getSuggestionPopover.addEventListener("ui5-after-close",this._onClose.bind(this));this.attachedAfterClose=true}}_onOpen(){this._applyFocus();this._getComponent().onOpen()}_onClose(){this._getComponent().onClose()}_applyFocus(){if(this.selectedItemIndex){this._getItems()[this.selectedItemIndex].focus()}}_isItemOnTarget(){return this.isOpened()&&this.selectedItemIndex!==null&&this.selectedItemIndex!==-1&&!this._isGroupOrInactiveItem}get _isGroupOrInactiveItem(){const e=this._getItems();if(!e||!e[this.selectedItemIndex]){return false}return e[this.selectedItemIndex].group||e[this.selectedItemIndex].type==="Inactive"}isOpened(){return!!(this.responsivePopover&&this.responsivePopover.opened)}_handleItemNavigation(e){if(!this._getItems().length){return}if(e){this._selectNextItem()}else{this._selectPreviousItem()}}_selectNextItem(){const e=this._getItems().length;const t=this.selectedItemIndex;if(this._hasValueState&&t===null&&!this.component._isValueStateFocused){this._focusValueState();return}if(t===null&&!this._hasValueState||this.component._isValueStateFocused){this._clearValueStateFocus();--this.selectedItemIndex}if(t!==null&&t+1>e-1){return}this._moveItemSelection(t,++this.selectedItemIndex)}_selectPreviousItem(){const e=this._getItems();const t=this.selectedItemIndex;if(this._hasValueState&&t===0&&!this.component._isValueStateFocused){this.component.hasSuggestionItemSelected=false;this.component._isValueStateFocused=true;this.selectedItemIndex=null;e[0].focused=false;e[0].selected=false;return}if(this.component._isValueStateFocused){this.component.focused=true;this.component._isValueStateFocused=false;this.selectedItemIndex=null;return}if(t===-1||t===null){return}if(t-1<0){e[t].selected=false;e[t].focused=false;this.component.focused=true;this.component.hasSuggestionItemSelected=false;this.selectedItemIndex-=1;return}this._moveItemSelection(t,--this.selectedItemIndex)}_moveItemSelection(e,t){const s=this._getItems();const n=s[t];const i=s[e];if(!n){return}this.component.focused=false;this._clearValueStateFocus();this.accInfo={currentPos:t+1,listSize:s.length,itemText:n.textContent};if(i){i.selected=false;i.focused=false}if(n){n.focused=true;if(n.type==="Active"){n.selected=true}if(this.handleFocus){n.focus()}}this.component.hasSuggestionItemSelected=true;this.onItemPreviewed(n);if(!this._isItemIntoView(n)){this._scrollItemIntoView(n)}}_deselectItems(){const e=this._getItems();e.forEach(e=>{e.selected=false;e.focused=false})}_clearItemFocus(){const e=this._getItems().find(e=>e.focused);if(e){e.focused=false}}_isItemIntoView(e){const t=e.getDomRef().getBoundingClientRect();const s=this._getComponent().getDomRef().getBoundingClientRect();const n=window.innerHeight||document.documentElement.clientHeight;return t.top+f.SCROLL_STEP<=n&&t.top>=s.top}async _scrollItemIntoView(e){const t=e.getDomRef().offsetTop;const s=await this._getScrollContainer();s.scrollTop=t}async _getScrollContainer(){if(!this._scrollContainer){await this._getSuggestionPopover();this._scrollContainer=this.responsivePopover.shadowRoot.querySelector(".ui5-popup-content")}return this._scrollContainer}_getItems(){return!!this.responsivePopover&&[...this.responsivePopover.querySelector("[ui5-list]").children]}_getComponent(){return this.component}async _getList(){this.responsivePopover=await this._getSuggestionPopover();return this.responsivePopover.querySelector("[ui5-list]")}async _getListWidth(){const e=await this._getList();return e.offsetWidth}_getRealItems(){return this._getComponent().getSlottedNodes(this.slotName)}async _getSuggestionPopover(){if(this.responsivePopover){return this.responsivePopover}const e=await this._getComponent().getStaticAreaItemDomRef();this.responsivePopover=e.querySelector("[ui5-responsive-popover]");return this.responsivePopover}get itemSelectionAnnounce(){const e=f.i18nBundle.getText(m.LIST_ITEM_POSITION,this.accInfo.currentPos,this.accInfo.listSize),t=f.i18nBundle.getText(m.LIST_ITEM_SELECTED);return`${e} ${this.accInfo.itemText} ${t}`}getRowText(e){return this.sanitizeText(e.text||e.textContent)}getRowDesc(e){if(e.description){return this.sanitizeText(e.description)}}getHighlightedText(e,t){const s=e.text||e.textContent;return this.hightlightInput(s,t)}getHighlightedDesc(e,t){const s=e.description||"";return this.hightlightInput(s,t)}hightlightInput(e,t){return p(e,t)}sanitizeText(e){return g(e)}get _hasValueState(){return this.component.hasValueStateMessage}_focusValueState(){const e=this._getItems();this.component._isValueStateFocused=true;this.component.focused=false;this.component.hasSuggestionItemSelected=false;this.selectedItemIndex=null;e&&this._scrollItemIntoView(e[0]);this._deselectItems()}_clearValueStateFocus(){this.component._isValueStateFocused=false}static get dependencies(){return[r,u,o,i,d,a,h,c,l]}static async init(){f.i18nBundle=await t.getI18nBundle("@ui5/webcomponents")}}f.SCROLL_STEP=60;e.registerFeature("InputSuggestions",f);return f});