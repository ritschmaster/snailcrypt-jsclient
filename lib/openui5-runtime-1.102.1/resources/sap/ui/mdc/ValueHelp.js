/*
 * ! OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['sap/ui/mdc/Element','sap/ui/mdc/mixin/PromiseMixin','sap/ui/mdc/condition/Condition','sap/ui/mdc/condition/FilterOperatorUtil','sap/ui/mdc/condition/FilterConverter','sap/ui/mdc/enum/SelectType','sap/ui/mdc/enum/OutParameterMode','sap/ui/mdc/enum/ConditionValidated','sap/ui/model/Context','sap/ui/model/FormatException','sap/ui/model/ParseException','sap/ui/model/base/ManagedObjectModel','sap/ui/base/ManagedObjectObserver','sap/base/util/merge','sap/base/util/deepEqual','sap/ui/mdc/enum/PropagationReason'],function(E,P,C,F,a,S,O,b,c,d,e,M,f,m,g,h){"use strict";var V=E.extend("sap.ui.mdc.ValueHelp",{metadata:{library:"sap.ui.mdc",properties:{conditions:{type:"object[]",defaultValue:[],byValue:true},delegate:{type:"object",group:"Data",defaultValue:{name:"sap/ui/mdc/ValueHelpDelegate"}},filterValue:{type:"string",defaultValue:""},validateInput:{type:"boolean",defaultValue:true},_config:{type:"object",defaultValue:{},visibility:"hidden"},_valid:{type:"boolean",group:"Appearance",defaultValue:true,visibility:"hidden"}},aggregations:{dialog:{type:"sap.ui.mdc.valuehelp.IDialogContainer",multiple:false},typeahead:{type:"sap.ui.mdc.valuehelp.ITypeaheadContainer",multiple:false}},events:{select:{parameters:{conditions:{type:"object[]"},add:{type:"boolean"},close:{type:"boolean"}}},disconnect:{},closed:{},navigated:{parameters:{leaveFocus:{type:"boolean"},condition:{type:"object"},itemId:{type:"string"}}},switchToValueHelp:{}},defaultProperty:"filterValue"}});V.prototype.init=function(){E.prototype.init.apply(this,arguments);this._oObserver=new f(t.bind(this));this._oObserver.observe(this,{aggregations:["typeahead","dialog"]});this.setBindingContext(null);this._oConditions={};};V.prototype.exit=function(){if(this._oManagedObjectModel){this._oManagedObjectModel.destroy();delete this._oManagedObjectModel;}};V.prototype.invalidate=function(i){return;};V.prototype.connect=function(i,j){if(this._oControl&&this._oControl!==i){this.close();this.setFilterValue("");this.setConditions([]);this.fireDisconnect();}this._oControl=i;this.setProperty("_config",j,true);u.call(this);return this;};V.prototype.getControl=function(){return this._oControl;};V.prototype.getDomRef=function(){var T=this.getTypeahead();var D=this.getDialog();if(T&&(T.isOpen()||T.isOpening())){return T.getDomRef();}else if(D&&(D.isOpen()||D.isOpening())){return D.getDomRef();}};V.prototype.getAriaAttributes=function(i){var T=this.getTypeahead();var D=this.getDialog();if(!D&&T&&T.getUseAsValueHelp()){D=T;}var j=T&&T.isOpen();var w=D&&D.isOpen();var x=T&&T.getAriaAttributes(i);var y=D&&D.getAriaAttributes(i);var z;var H;var R;var A;if(j){z=x.contentId;}else if(w){z=y.contentId;}H=(T&&x.ariaHasPopup)||(D&&y.ariaHasPopup);R=(T&&x.role)||(D&&y.role);A=(T&&x.roleDescription)||(D&&y.roleDescription);return{contentId:z,ariaHasPopup:H,role:R,roleDescription:A,valueHelpEnabled:!!D||!!T&&!!T.getUseAsValueHelp()};};V.prototype._retrieveDelegateContent=function(i,j){var w;if(!j){var x=i.getSelectedContent();j=x&&x.getId();}w=this._retrievePromise("delegateContent");var I=this.isOpen();if(!w||(w&&I)||(w&&w.aggregation!==i.sParentAggregationName)){var y=function(){return this._getControlDelegatePromise().then(function(D){return D.retrieveContent(this.getPayload(),i,j);}.bind(this));}.bind(this);var z=w&&w.isPending();w=this._addPromise("delegateContent",z?w.getInternalPromise().then(y):y);w.aggregation=i.sParentAggregationName;}return w.getInternalPromise();};V.prototype._getControlDelegatePromise=function(i){return this._retrievePromise("delegate",this.initControlDelegate.bind(this));};V.prototype.open=function(T){var i=T?this.getTypeahead():v.call(this);var j=T?this.getDialog():this.getTypeahead();if(j&&i!==j&&(j.isOpen()||j.isOpening())){j.close();}if(i&&!i.isOpen()&&!i.isOpening()){i.open(this._retrieveDelegateContent(i));}};function _(i){var j=i.getSource();this._retrieveDelegateContent(j,i.getParameter("contentId"));}function k(i){this.fireSwitchToValueHelp();}V.prototype.close=function(){var T=this.getTypeahead();var D=this.getDialog();if(T&&T.isOpen()){T.close();}if(D&&D.isOpen()){D.close();}};V.prototype.toggleOpen=function(T){var i=this.getTypeahead();var D=this.getDialog();if(!T&&!D&&i&&i.getUseAsValueHelp()){D=i;}var j=i&&i.isOpen();var w=D&&D.isOpen();if((T&&j)||(!T&&w)){this.close();}else if((T&&i)||(!T&&D)){this.open(T);}};V.prototype.isOpen=function(){var T=this.getTypeahead();var D=this.getDialog();return!!((T&&T.isOpen())||(D&&D.isOpen()));};V.prototype.skipOpening=function(){var T=this.getTypeahead();var D=this.getDialog();if(T&&T.isOpening()){T.close();}if(D&&D.isOpening()){D.close();}};V.prototype.initBeforeOpen=function(T){};V.prototype.isTypeaheadSupported=function(){var T=this.getTypeahead();if(T){return this._retrieveDelegateContent(T).then(function(){return!!T&&T.isTypeaheadSupported();});}else{return Promise.resolve(false);}};V.prototype.shouldOpenOnClick=function(){var i=v.call(this);if(i){return i.shouldOpenOnClick();}return false;};V.prototype.isFocusInHelp=function(){var D=v.call(this);return D&&D.isFocusInHelp();};V.prototype.removeFocus=function(){var T=this.getTypeahead();if(T){T.removeFocus();}};V.prototype.navigate=function(i){var T=this.getTypeahead();if(T){var j=function(){if(T.shouldOpenOnNavigate()&&!T.isOpening()&&!T.isOpen()){return T.open(true).then(function(){T.navigate(i);});}return T.navigate(i);};var N=this._retrievePromise("navigate");var w=N&&!N.isSettled()&&N.getInternalPromise();this._addPromise("navigate",w?w.then(j):this._retrieveDelegateContent(T).then(j));}};V.prototype.getTextForKey=function(K,i,B,j,w){return this.getItemForValue({parsedValue:K,value:K,context:i,bindingContext:B,conditionModel:j,conditionModelName:w,checkKey:true,exception:d,caseSensitive:true});};V.prototype.getKeyForText=function(T,i){return this.getItemForValue({value:T,context:i,checkDescription:true,exception:e,caseSensitive:true});};V.prototype.getItemForValue=function(i){var T=this.getTypeahead();if(T){var j=["getItemForValue",i.parsedValue||i.value,JSON.stringify(i.context),i.oBindingContext&&i.oBindingContext.getPath()];var w=j.join("_");return this._retrievePromise(w,function(){return this._retrieveDelegateContent(T).then(function(){i.caseSensitive=i.hasOwnProperty("caseSensitive")?i.caseSensitive:false;var x=T.getItemForValue(i);return x;});}.bind(this));}else{return Promise.reject("No Typeahead");}};V.prototype.isValidationSupported=function(){var T=this.getTypeahead();return T&&T.isValidationSupported();};V.prototype.onControlChange=function(){if(this.bIsDestroyed){return;}l.call(this,h.ControlChange);u.call(this);};V.prototype.getIcon=function(){var T=this.getTypeahead();var D=this.getDialog();if(D){return D.getValueHelpIcon();}else if(T){return T.getValueHelpIcon();}};V.prototype.getMaxConditions=function(){var i=this.getProperty("_config");return(i&&i.maxConditions)||-1;};V.prototype.getDisplay=function(){};V.prototype.getDataType=function(){};V.prototype.valueHelpEnabled=function(){var T=this.getTypeahead();var D=this.getDialog();if(D){return true;}else{return T&&T.getUseAsValueHelp();}};function l(R,i){var D=this.bDelegateInitialized&&this.getControlDelegate();if(D){D.onConditionPropagation(this._oPayload,this,R,i||this.getProperty("_config"));}}function n(i){var j=i.getParameter("condition");this.fireNavigated({condition:j,itemId:i.getParameter("itemId"),leaveFocus:i.getParameter("leaveFocus")});}function o(w){var T=w.getParameter("type");var x=w.getParameter("conditions")||[];var N;var y=this.getMaxConditions()===1;if(y){N=T===S.Remove?[]:x.slice(0,1);}if(T===S.Set){N=[].concat(y?x.slice(0,1):x);}if(T===S.Add){if(y){N=x.slice(0,1);}else{N=this.getConditions();for(var i=0;i<x.length;i++){N.push(x[i]);}}}if(T===S.Remove){if(y){N=[];}else{N=this.getConditions();for(var j=0;j<x.length;j++){var I=F.indexOfCondition(x[j],N);if(I>=0){N.splice(I,1);}}}}if(N){this.setProperty("conditions",N,true);}}function p(i){if(this.getProperty("_valid")){var j=this.getMaxConditions()===1;var w=i.getParameter("close");var x=typeof w!=='undefined'?w:j;var y=this.getConditions();var A=!j&&!i.getSource().isMultiSelect();if(x){this.close();}y=C._removeEmptyConditions(y);y=C._removeInitialFlags(y);F.updateConditionsValues(y);this.fireSelect({conditions:y,add:A,close:x});l.call(this,h.Select);}}function q(i){this.close();}function r(i){}function s(i){this._removePromise("delegateContent");this._removePromise("navigate");this.fireClosed();}function t(i){if(["typeahead","dialog"].indexOf(i.name)!==-1){var j=i.child;var A=i.mutation==="insert";var w=A?j.attachEvent.bind(j):j.detachEvent.bind(j);w("select",o,this);w("requestDelegateContent",_,this);w("confirm",p,this);w("cancel",q,this);w("opened",r,this);w("closed",s,this);if(j.attachRequestSwitchToDialog){w("requestSwitchToDialog",k,this);}if(j.attachNavigated){w("navigated",n,this);}if(A){if(!this._oManagedObjectModel){this._oManagedObjectModel=new M(this);}j.setModel(this._oManagedObjectModel,"$valueHelp");}}}function u(){var B=this._oControl?this._oControl.getBindingContext():null;this.setBindingContext(B);}function v(){var i=this.getDialog();if(!i){var T=this.getTypeahead();if(T&&T.getUseAsValueHelp()){i=T;}}return i;}P.call(V.prototype);return V;});
