/*
 * ! OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['sap/ui/mdc/field/FieldValueHelpTableWrapperBase','sap/ui/model/ChangeReason','sap/base/strings/capitalize',"sap/ui/table/library",'sap/ui/thirdparty/jquery'],function(F,C,c,l,q){"use strict";var V=l.VisibleRowCountMode;var S=l.SelectionMode;var a=l.SelectionBehavior;var b=F.extend("sap.ui.mdc.field.FieldValueHelpUITableWrapper",{metadata:{library:"sap.ui.mdc",aggregations:{table:{type:"sap.ui.table.Table",multiple:false}},defaultAggregation:"table"}});b.prototype.fieldHelpOpen=function(s){F.prototype.fieldHelpOpen.apply(this,arguments);var t=this._getWrappedTable();if(t&&s){var f=this._getTableItems(true);var o=f&&f[0];this._handleScrolling(o);}return this;};b.prototype.getListBinding=function(){var t=this._getWrappedTable();return t&&t.getBinding("rows");};b.prototype.isSuspended=function(){var L=this.getListBinding();if(!L){return true;}return L.isSuspended();};var _=function(t){t=t||this._getWrappedTable();var s=t.getPlugins().find(function(p){return p.isA("sap.ui.table.plugins.SelectionPlugin");});return s||t;};var d=function(B){if(B){this._handleModelContextChange();return true;}};b.prototype._handleTableChanged=function(m,t){if(m==="insert"){this._adjustTable(true);var h=d.call(this,this.getListBinding());this._oObserver.observe(t,{aggregations:["plugins"],bindings:[!h&&"rows"]});var s=_.call(this,t);if(s&&s!==t){s.attachEvent("selectionChange",this._handleSelectionChange,this);}}else{this._oObserver.unobserve(t);}F.prototype._handleTableChanged.call(this,m,t);};b.prototype._observeChanges=function(o,n){if(o.name==="rows"&&o.mutation==="ready"){d.call(this,o.bindingInfo.binding);}if(!n&&o.name==="plugins"&&o.child.isA("sap.ui.table.plugins.SelectionPlugin")){var p=(o.mutation==="insert"?o.child.attachEvent:o.child.detachEvent).bind(o.child);p("selectionChange",this._handleSelectionChange,this);}F.prototype._observeChanges.apply(this,arguments);};b.prototype._handleEvents=function(A){var t=this._getWrappedTable();if(t){var E=(A?t.attachEvent:t.detachEvent).bind(t);E("cellClick",this._handleItemPress,this);E("rowSelectionChange",this._handleSelectionChange,this);E("rowsUpdated",this._handleUpdateFinished,this);E("busyStateChanged",this._handleBusyStateChanged,this);var r=this.getListBinding();if(r){var f=(A?r.attachEvent:r.detachEvent).bind(r);f("change",this._handleUpdateFinished,this);}}};b.prototype._adjustTable=function(s){F.prototype._adjustTable.apply(this,arguments);var t=this._getWrappedTable();var p=this.getParent();if(t){var r=t.getRowMode();if(!r){t.setVisibleRowCountMode(s?V.Fixed:V.Auto);t.setMinAutoRowCount(3);}else if(r.isA("sap.ui.table.rowmodes.AutoRowMode")){r.setMinRowCount(3);}if(p){var o=_.call(this);var f=function(m,B){t.setSelectionBehavior(B);o.setSelectionMode(m);};var g=this._getMaxConditions()===1;var h=g?S.Single:S.MultiToggle;var i=g?a.RowOnly:a.Row;f(h,i);}}};b.prototype._handleSelectionChange=function(E){var u=E.getParameter("userInteraction");if(u||(this._bSuggestion&&this._getMaxConditions()!==1)){this._fireSelectionChange.call(this,false);}};b.prototype._handleUpdateFinished=function(E){if(!this.getParent()){return;}this._updateSelectedItems();if(this._bNavigate){this._bNavigate=false;this.navigate(this._iStep);}if(!E||E.getParameter("reason")!==c(C.Filter)){this.fireDataUpdate({contentChange:false});}};function e(t){var s=_.call(this,t);var f=s.getSelectedIndices();return f.reduce(function(p,i){var o=t.getContextByIndex(i);return o?p.concat(o):p;},[]);}b.prototype._getTableItems=function(s,n){var r=[];var t=this._getWrappedTable();if(t){if(!n){if(s){r=e.call(this,t);}else{var B=t.getBinding();r=B&&B.getAllCurrentContexts()||[];}}else{r=t.getRows().filter(function(R){var o=R.getBindingContext();return o&&o.getObject();});if(s){r=r.filter(function(R){return e.call(this,t).indexOf(R.getBindingContext())>=0;});}}}return r;};b.prototype._modifyTableSelection=function(i,I,s,f,g){f=typeof f!=='undefined'?f:i.indexOf(I);if(f>=0){var o=_.call(this);var h=o.getSelectedIndices().indexOf(f)>=0;if(s&&!h){return this._getMaxConditions()===1?o.setSelectedIndex(f):o.addSelectionInterval(f,f);}else if(!s&&h){return o.removeSelectionInterval(f,f);}}};b.prototype._handleTableEvent=function(E){if(!this._bSuggestion){return;}var i=q(E.target).control(0);switch(E.type){case"sapprevious":if(i.isA("sap.ui.table.Row")){if(this._getTableItems(false,true).indexOf(i)===0){this.fireNavigate({key:undefined,description:undefined,leave:true});E.preventDefault();E.stopPropagation();E.stopImmediatePropagation(true);}}break;case"sapnext":if(i.isA("sap.ui.table.Column")&&this._getMaxConditions()===1){i=this._getTableItems(false,true)[0];if(i){var v=this._getDataFromItem(i);if(v){this.fireNavigate({key:v.key,description:v.description,inParameters:v.inParameters,outParameters:v.outParameters,itemId:i.getId()});E.preventDefault();E.stopPropagation();E.stopImmediatePropagation(true);}}}break;default:break;}};b.prototype._handleScrolling=function(i){var t=this._getWrappedTable();var I=!isNaN(i)&&i;var f=t.getFirstVisibleRow();if(!I&&i){var o=i.isA("sap.ui.table.Row")&&i.getBindingContext();if(!o&&i.isA("sap.ui.model.Context")){o=i;}I=this._getTableItems().indexOf(o);}if(typeof I==="undefined"||I<0){I=f-1;}if(I>=0&&I!=f){t.setFirstVisibleRow(I);return Promise.resolve();}};b.prototype._handleItemPress=function(E){};return b;});
