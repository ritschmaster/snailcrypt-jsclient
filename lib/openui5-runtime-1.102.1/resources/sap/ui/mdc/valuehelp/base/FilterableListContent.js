/*
 * ! OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['sap/ui/mdc/util/loadModules','sap/ui/mdc/valuehelp/base/ListContent','sap/ui/mdc/condition/Condition','sap/ui/mdc/enum/ConditionValidated','sap/ui/mdc/util/Common','sap/ui/mdc/enum/PersistenceMode','sap/ui/mdc/p13n/Engine','sap/base/util/merge'],function(l,L,C,a,b,P,E,m){"use strict";var F=L.extend("sap.ui.mdc.valuehelp.base.FilterableListContent",{metadata:{library:"sap.ui.mdc",properties:{filterFields:{type:"string",defaultValue:""},keyPath:{type:"string",defaultValue:""},descriptionPath:{type:"string",defaultValue:""},group:{type:"string",defaultValue:""}},aggregations:{collectiveSearchItems:{type:"sap.ui.core.Item",multiple:true,singularName:"collectiveSearchItem"},filterBar:{type:"sap.ui.mdc.filterbar.vh.FilterBar",multiple:false},_defaultFilterBar:{type:"sap.ui.mdc.filterbar.vh.FilterBar",multiple:false,visibility:"hidden"}},associations:{filters:{type:"sap.ui.mdc.IFilter",multiple:true}},events:{}}});F.prototype.init=function(){L.prototype.init.apply(this,arguments);this._oResourceBundle=sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc");this._oObserver.observe(this,{properties:["filterFields"],aggregations:["_defaultFilterBar","filterBar"]});E.getInstance().defaultProviderRegistry.attach(this,P.Transient);};F.prototype._handleFilterValueUpdate=function(o){c.call(this,this._getPriorityFilterBar(),o.current);if(this.isContainerOpen()){this.applyFilters(o.current);}};F.prototype._reduceIFilterConditions=function(o){var d=this._getValueHelpDelegate();var p=this._getValueHelpDelegatePayload();return d?d.reduceIFilterConditions(p,this,o):o;};F.prototype.applyFilters=function(s){this.applyFilterConditions();};F.prototype._prettyPrintFilters=function(f){var r;if(!f){return"";}if(Array.isArray(f)){r="";f.forEach(function(f,i,d){r+=this._prettyPrintFilters(f);if(d.length-1!=i){r+=" or ";}},this);return"("+r+")";}else if(f._bMultiFilter){r="";var A=f.bAnd;f.aFilters.forEach(function(f,i,d){r+=this._prettyPrintFilters(f);if(d.length-1!=i){r+=A?" and ":" or ";}},this);return"("+r+")";}else{r=f.sPath+" "+f.sOperator+" '"+f.oValue1+"'";if(f.sOperator==="BT"){r+="...'"+f.oValue2+"'";}return r;}};F.prototype._getItemFromContext=function(B,o){var k=(o&&o.keyPath)||this.getKeyPath();var d=(o&&o.descriptionPath)||this.getDescriptionPath();var K;var D;if(!k){throw new Error("KeyPath missing");}if(B){K=k?B.getProperty(k):undefined;D=d?B.getProperty(d):undefined;}if(K===null||K===undefined){return false;}var p=this._createConditionPayload([K,D],B);return{key:K,description:D,payload:p};};F.prototype._createConditionPayload=function(v,d){var o;var D=this._getValueHelpDelegate();if(D){var e=this._getValueHelpDelegatePayload();o={};o=D.createConditionPayload(e,this,v,d);}return o;};F.prototype._isItemSelected=function(i,d){var D=this._isValueHelpDelegateInitialized()&&this._getValueHelpDelegate();return D?D.isFilterableListItemSelected(this._getValueHelpDelegatePayload(),this,i,d):false;};F.prototype._createDefaultFilterBar=function(){return l(["sap/ui/mdc/filterbar/vh/FilterBar"]).then(function(M){var d=M[0];var f=new d(this.getId()+"-FB",{liveMode:false,showGoButton:false});_.call(this,f);this.setAggregation("_defaultFilterBar",f,true);return f;}.bind(this));};F.prototype._handleSearch=function(e){};function _(f){var e=f.getBasicSearchField();var s=this.getFilterFields();if(!e&&s){if(!this._oSearchField){return l(["sap/ui/mdc/FilterField"]).then(function(M){if(!f.bIsDestroyed){var d=M[0];this._oSearchField=new d(this.getId()+"-search",{conditions:"{$filters>/conditions/"+s+"}",placeholder:"{$i18n>filterbar.SEARCH}",label:"{$i18n>filterbar.SEARCH}",maxConditions:1,width:"50%"});this._oSearchField._bCreatedByValueHelp=true;_.call(this,f);}}.bind(this));}f.setBasicSearchField(this._oSearchField);}else if(e){if(s){e.setConditions([]);}else if(e._bCreatedByValueHelp){f.setBasicSearchField();}}}F.prototype.onShow=function(){L.prototype.onShow.apply(this,arguments);var o=this.getListBinding();var d=this._getListBindingInfo();var B=o&&o.isSuspended();var e=!o&&d&&d.suspended;this._applyInitialConditions(this._getPriorityFilterBar());if((B||e)&&!this.isTypeahead()){return;}this.applyFilters(this.getFilterValue());};F.prototype.onHide=function(){L.prototype.onHide.apply(this,arguments);};F.prototype._getPriorityFilterBar=function(){return this.getFilterBar()||this.getAggregation("_defaultFilterBar");};F.prototype._observeChanges=function(o){if(o.object==this){var f;if(["_defaultFilterBar","filterBar"].indexOf(o.name)!==-1){f=o.child;var d;if(o.mutation==="insert"){_.call(this,f);this._assignCollectiveSearchSelect();if(o.name!=="_defaultFilterBar"||!this.getFilterBar()){f.attachSearch(this._handleSearch,this);}if(o.name==="filterBar"){d=this.getAggregation("_defaultFilterBar");if(d){d.detachSearch(this._handleSearch,this);}}}else{var e=f.getBasicSearchField();if(e&&e._bCreatedByValueHelp){f.setBasicSearchField();}f.detachSearch(this._handleSearch,this);if(o.name==="filterBar"){d=this.getAggregation("_defaultFilterBar");if(d){d.attachSearch(this._handleSearch,this);}else{this._createDefaultFilterBar();}}}c.call(this,this._getPriorityFilterBar(),this.getFilterValue());}else if(o.name==="filterFields"){f=this._getPriorityFilterBar();if(f){_.call(this,f);}}}L.prototype._observeChanges.apply(this,arguments);};F.prototype.getCollectiveSearchKey=function(){return this._oCollectiveSearchSelect&&this._oCollectiveSearchSelect.getSelectedItemKey();};F.prototype.getListBinding=function(){throw new Error("FilterableListContent: Every filterable listcontent must implement this method.");};F.prototype._getListBindingInfo=function(){throw new Error("FilterableListContent: Every filterable listcontent must implement this method.");};F.prototype._getTypesForConditions=function(o){var d=this._getValueHelpDelegate();var D=this._getValueHelpDelegatePayload();return d?d.getTypesForConditions(D,this,o):{};};function c(f,s){var d=this.getFilterFields();if(f&&d){var o=f.getInternalConditions();if(!o[d]||o[d].length!==1||o[d][0].values[0]!==s){var e=C.createCondition("Contains",[s],undefined,undefined,a.NotValidated);o[d]=[e];f.setInternalConditions(o);}}}F.prototype.getFormattedTitle=function(i){var t=L.prototype.getFormattedTitle.apply(this,arguments);if(!t){t=this._oResourceBundle.getText(i?"valuehelp.SELECTFROMLIST":"valuehelp.SELECTFROMLISTNONUMBER",i);}return t;};F.prototype.getFormattedShortTitle=function(){var s=this.getShortTitle();if(!s){s=this._oResourceBundle.getText("valuehelp.SELECTFROMLIST.Shorttitle");}return s;};F.prototype.isSearchSupported=function(){var f=this.getFilterFields();var s=!!f;if(f==="$search"){var o=this.getListBinding();var d=this._getValueHelpDelegate();var D=this._getValueHelpDelegatePayload();s=d&&d.isSearchSupported(D,this,o);}return s;};F.prototype.setCollectiveSearchSelect=function(d){this._oCollectiveSearchSelect=d;this._assignCollectiveSearchSelect();};F.prototype._assignCollectiveSearchSelect=function(){var f=this._getPriorityFilterBar();if(f.setCollectiveSearch&&this._oCollectiveSearchSelect){f.setCollectiveSearch(this._oCollectiveSearchSelect);}};F.prototype.onBeforeShow=function(){var d=this._getValueHelpDelegate();return Promise.resolve(d&&d.getInitialFilterConditions(this._getValueHelpDelegatePayload(),this,this._getControl())).then(function(o){this._oInitialFilterConditions=o;}.bind(this));};F.prototype._applyInitialConditions=function(f){if(f){var s=this.getFilterFields();var n=m({},this._oInitialFilterConditions);if(!n[s]){var o=f.getInternalConditions();if(o[s]){n[s]=o[s];}}f.setInternalConditions(n);}};F.prototype._fireSelect=function(o){var d=this._getValueHelpDelegate();var D=this._getValueHelpDelegatePayload();var M=d&&d.modifySelectionBehaviour?d.modifySelectionBehaviour(D,this,o):o;if(M){this.fireSelect(M);}};F.prototype.exit=function(){E.getInstance().defaultProviderRegistry.detach(this);b.cleanup(this,["_oCollectiveSearchSelect","_oInitialFilterConditions"]);if(this._oSearchField&&!this._oSearchField.getParent()){this._oSearchField.destroy();delete this._oSearchField;}L.prototype.exit.apply(this,arguments);};F.prototype.getCount=function(d,g){var D=this._isValueHelpDelegateInitialized()&&this._getValueHelpDelegate();var o=D&&this._getValueHelpDelegatePayload();return D&&D.getCount?D.getCount(o,this,d,g):L.prototype.getCount.apply(this,arguments);};return F;});
