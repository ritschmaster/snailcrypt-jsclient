/*
 * ! OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['sap/ui/mdc/valuehelp/base/Container','sap/ui/mdc/valuehelp/base/DialogTab','sap/ui/mdc/util/loadModules','sap/ui/Device','sap/m/VBox','sap/m/FlexItemData','sap/ui/model/resource/ResourceModel','sap/ui/mdc/util/Common','sap/ui/mdc/enum/SelectType','sap/base/strings/formatMessage'],function(C,D,l,a,V,F,R,b,S,f){"use strict";var M,c,B,d,I,e;var P,H,T,g;var h=C.extend("sap.ui.mdc.valuehelp.Dialog",{metadata:{library:"sap.ui.mdc",interfaces:["sap.ui.mdc.valuehelp.IDialogContainer"],properties:{_selectedContentKey:{type:"string",visibility:"hidden"},_quickSelectEnabled:{type:"boolean",visibility:"hidden",defaultValue:false},_selectableContents:{type:"object[]",visibility:"hidden",defaultValue:[]},groupConfig:{type:"object",defaultValue:{}}},defaultAggregation:"content"}});function _(){if(a.system.desktop){return"700px";}if(a.system.tablet){return a.orientation.landscape?"600px":"600px";}}function j(){if(a.system.desktop){return"1080px";}if(a.system.tablet){return a.orientation.landscape?"920px":"600px";}}function k(n){var i=this.getContent();return i.filter(function(o){return!!o.getVisible()&&o.getGroup&&o.getGroup()===n;}).length>1;}h.prototype._handleContentSelectionChange=function(n){this.fireRequestDelegateContent({container:this.getId(),contentId:n});this._getRetrieveDelegateContentPromise().then(function(){var s=this.getProperty("_selectedContentKey");var i=this.getContent();var o=s&&i&&i.find(function(p){return p.getId()===s;});if(o){o.onHide();}this._renderSelectedContent(n);}.bind(this));};h.prototype._onTabBarSelect=function(E){var n=E&&E.getParameter("key");this._handleContentSelectionChange(n);};h.prototype.invalidate=function(o){if(o){var i=this.getContent();var n=i.indexOf(o);if(this._oIconTabBar&&n!==-1&&!this._bIsBeingDestroyed){var p=this._oIconTabBar.getItems();if(p[n]){p[n].invalidate(o);}}else{C.prototype.invalidate.apply(this,arguments);}}};h.prototype._getUIAreaForContent=function(){var o=this.getAggregation("_container");if(o){return o.getUIArea();}return C.prototype._getUIAreaForContent.apply(this,arguments);};h.prototype._handleConfirmed=function(E){this.fireConfirm({close:true});};h.prototype._handleClosed=function(E){var o=this.getSelectedContent();if(o){o.onHide();}this.setProperty("_selectedContentKey",this._sInitialContentKey);C.prototype._handleClosed.apply(this,arguments);};h.prototype._getContainer=function(){if(!this.getModel("$i18n")){this.setModel(new R({bundleName:"sap/ui/mdc/messagebundle",async:false}),"$i18n");}var o=this.getAggregation("_container");if(!o){return this._retrievePromise("dialog",function(){return l(["sap/m/Dialog","sap/m/Button","sap/ui/model/base/ManagedObjectModel","sap/m/library"]).then(function(i){M=i[0];B=i[1];d=i[2];c=i[3];var n=c.ButtonType;if(!this._oResourceBundle){this._oResourceBundle=sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc");}this.oButtonOK=new B(this.getId()+"-ok",{text:this._oResourceBundle.getText("valuehelp.OK"),enabled:"{$valueHelp>/_valid}",type:n.Emphasized,press:this._handleConfirmed.bind(this),visible:{parts:['$valueHelp>/_config/maxConditions','$help>/_quickSelectEnabled'],formatter:function(q,Q){return q!==1||!Q;}}});this.oButtonCancel=new B(this.getId()+"-cancel",{text:this._oResourceBundle.getText("valuehelp.CANCEL"),press:this._handleCanceled.bind(this)});this._oManagedObjectModel=new d(this);var o=new M(this.getId()+"-dialog",{contentHeight:_(),contentWidth:j(),horizontalScrolling:false,verticalScrolling:false,title:{parts:['$help>/title','$help>/_selectableContents'],formatter:function(t,q){if(q&&q.length==1){var r=q[0];var s=r.getFormattedShortTitle()?r.getFormattedShortTitle():r.getTitle();if(s){t=this._oResourceBundle.getText("valuehelp.DIALOGSHORTTITLECOLONTITLE",[s,t]);}}return t;}.bind(this)},stretch:a.system.phone,resizable:true,draggable:true,afterOpen:this._handleOpened.bind(this),afterClose:this._handleClosed.bind(this),buttons:[this.oButtonOK,this.oButtonCancel]});o.setModel(this._oManagedObjectModel,"$help");this.setAggregation("_container",o,true);o.isPopupAdaptationAllowed=function(){return false;};o.addStyleClass("sapMdcValueHelp");o.addStyleClass("sapMdcValueHelpTitle");o.addStyleClass("sapMdcValueHelpTitleShadow");var v=new V(this.getId()+"-Content",{fitContainer:true});v.addStyleClass("sapMdcValueHelpPanel");o.addContent(v);var p=[];p.push(this._getIconTabBar(o));if(m(this.getMaxConditions(),this.getContent())){p.push(this._getTokenizerPanel());}return Promise.all(p).then(function(q){q.forEach(function(r){v.addItem(r);});return o;});}.bind(this));}.bind(this));}return o;};h.prototype._handleSelect=function(E){C.prototype._handleSelect.apply(this,arguments);if(this.getProperty("_quickSelectEnabled")&&this._isSingleSelect()){this.fireConfirm({close:true});}};h.prototype._observeChanges=function(o){if(o.name==="content"){var i=this.getContent();this.setProperty("_quickSelectEnabled",i&&i.every(function(p){return p.isQuickSelectSupported();}));this._updateInitialContentKey();if(o.mutation==="insert"&&!this.getProperty("_selectedContentKey")){this.setProperty("_selectedContentKey",this._sInitialContentKey);}this.setProperty("_selectableContents",this._getSelectableContents());if(m(this.getMaxConditions(),this.getContent())){var n=this.getAggregation("_container");if(n&&n.getContent()[0].getItems().length===1){Promise.all([this._getTokenizerPanel()]).then(function(p){p.forEach(function(q){n.getContent()[0].addItem(q);});});}}}C.prototype._observeChanges.apply(this,arguments);};h.prototype._updateInitialContentKey=function(){var o=this.getContent().find(function(i){return!!i.getVisible();});this._sInitialContentKey=o&&o.getId();};h.prototype.getSelectedContent=function(){var s=this.getProperty("_selectedContentKey");return this.getContent().find(function(o){return o.getId()===s;});};h.prototype._getSelectableContents=function(){var s=this.getSelectedContent();var o=s&&s.getGroup&&s.getGroup();var i=s?o:"";var v=[i];return this.getContent().filter(function(n){if(!n.getVisible()){return false;}var G=n.getGroup&&n.getGroup();var p=G&&k.call(this,G);if(p&&(n!==s)){if(v.indexOf(G)>=0){return false;}else{v.push(G);}}return true;}.bind(this));};h.prototype._updateGroupSelectModel=function(){if(this._oGroupSelectModel){var s=this.getSelectedContent();var o=s&&s.getGroup&&s.getGroup();var r=o?this.getContent().filter(function(q){return!!q.getVisible()&&q.getGroup&&q.getGroup()===o;}):[];this._oGroupSelectModel.setData(r.reduce(function(q,t){q.entries.push({key:t.getId(),text:t.getFormattedTitle()});return q;},{entries:[]}));if(this._oGroupSelect){var i=this._oGroupSelect.getSelectedItemKey();var n=r.map(function(q){return q.getId();});var p=this.getProperty("_selectedContentKey");if(n.indexOf(i)==-1||(i!==p)){this._oGroupSelect.setSelectedItemKey(r[0].getId());}}}};h.prototype._retrieveGroupSelect=function(){return this._retrievePromise("collectiveSearchSelect",function(){return l(["sap/ui/mdc/filterbar/vh/CollectiveSearchSelect","sap/ui/core/Item","sap/ui/model/json/JSONModel"]).then(function(i){var n=i[0];var o=i[1];var J=i[2];if(!this._oGroupSelectModel){this._oGroupSelectModel=new J();}if(!this._oGroupSelect){var p=new o(this.getId()+"-collSearchItem",{key:"{$select>key}",text:"{$select>text}",enabled:true});this._oGroupSelect=new n(this.getId()+"--Select",{title:"{$i18n>COL_SEARCH_SEL_TITLE}",items:{path:"$select>/entries",template:p},select:function(E){this._handleContentSelectionChange(E.getParameter("key"));}.bind(this),selectedItemKey:this.getSelectedContent().getId()});this._oGroupSelect.setModel(this._oGroupSelectModel,"$select");}return this._oGroupSelect;}.bind(this));}.bind(this));};h.prototype._getIconTabBar=function(o){if(!this._oIconTabBar){return l(["sap/m/IconTabBar","sap/m/IconTabFilter"]).then(function(i){I=i[0];e=i[1];var n=c.IconTabHeaderMode;this._oIconTabBar=new I(this.getId()+"-ITB",{expandable:false,upperCase:false,stretchContentHeight:true,headerMode:n.Inline,select:this._onTabBarSelect.bind(this),layoutData:new F({growFactor:1}),selectedKey:"{path: '$help>/_selectedContentKey', mode: 'OneWay'}",visible:{parts:['$help>/_selectableContents'],formatter:function(q){if(q&&q.length==1){this.addStyleClass("sapMdcNoHeader");o.removeStyleClass("sapMdcValueHelpTitleShadow");}else{this.removeStyleClass("sapMdcNoHeader");o.addStyleClass("sapMdcValueHelpTitleShadow");}return true;}}});this._oIconTabBar.addStyleClass("sapUiNoContentPadding");var p=new e(this.getId()+"-ITF",{key:{path:"$help>id"},content:new D(this.getId()+"-DT",{content:{path:"$help>displayContent"}}),text:{parts:['$help>','$valueHelp>/conditions'],formatter:function(q,r){var t="none";if(q){var G=q.getGroup&&q.getGroup();var s=q.getCount(r,G);t=G?this._getFormattedContentGroupLabel(G,s):q.getFormattedTitle(s);}return t;}.bind(this)}});this._oIconTabBar.bindAggregation("items",{path:"/_selectableContents",model:"$help",templateShareable:false,template:p});return this._oIconTabBar;}.bind(this));}return this._oIconTabBar;};h.prototype._getFormattedContentGroupLabel=function(G,i){var o=this.getGroupConfig();var n=o&&o[G];var t=n&&(i?n.label:n.nnLabel);t=t&&f(t,i?i:"");t=t||this._oResourceBundle.getText(i?"valuehelp.SELECTFROMLIST":"valuehelp.SELECTFROMLISTNONUMBER",i);return t;};h.prototype._getTokenizerPanel=function(o){if(!this.oTokenizerPanel){return l(['sap/m/Panel','sap/m/HBox','sap/m/VBox','sap/m/Tokenizer','sap/m/Token','sap/ui/model/Filter','sap/ui/mdc/field/ConditionType']).then(function(n){P=n[0];H=n[1];V=n[2];T=n[3];g=n[4];var p=n[5];var q=n[6];var r=c.BackgroundDesign;var s=c.ButtonType;this.oTokenizerPanel=new P(this.getId()+"-TokenPanel",{backgroundDesign:r.Transparent,expanded:true,visible:{parts:['$valueHelp>/_config/maxConditions','$help>/content'],formatter:m},headerText:{parts:['$i18n>valuehelp.TOKENIZERTITLE','$valueHelp>/conditions'],formatter:function(A,E){var G=0;for(var i=0;i<E.length;i++){var J=E[i];if(J.isEmpty!==true){G++;}}if(G===0){A=this._oResourceBundle.getText("valuehelp.TOKENIZERTITLENONUMBER");}return f(A,G);}.bind(this)}});this.oTokenizerPanel.addStyleClass("sapMdcTokenizerPanel");var t=new H(this.getId()+"-TokenBox",{fitContainer:true,width:"100%"});var u=new p({path:'isEmpty',operator:'NE',value1:true});var v=this.getModel("$valueHelp");var w=v?v.getProperty("/_config"):{};var x=this.getParent();var y={maxConditions:-1,valueType:w.dataType,operators:w.operators,display:w.display,fieldHelpID:x&&x.getId()};var z=new g(this.getId()+"-Token",{text:{path:'$valueHelp>',type:new q(y)}});this.oTokenizer=new T(this.getId()+"-Tokenizer",{width:"100%",tokenDelete:function(E){if(E.getParameter("tokens")){var A=E.getParameter("tokens");var G=this.getModel("$valueHelp").getObject("/conditions");var J=[];A.forEach(function(K,i){var L=K.getBindingContext("$valueHelp").sPath;var N=parseInt(L.slice(L.lastIndexOf("/")+1));J.push(G[N]);});this.fireSelect({type:S.Remove,conditions:J});}}.bind(this),tokens:{path:'/conditions',model:"$valueHelp",templateShareable:false,template:z,filters:u},layoutData:new F({growFactor:1,maxWidth:"calc(100% - 2rem)"})});this.oTokenizer.addAriaDescribedBy(this.oTokenizer.getTokensInfoId());this.oTokenizer.addStyleClass("sapMdcTokenizer");this.oRemoveAllBtn=new B(this.getId()+"-TokenRemoveAll",{press:function(E){this.fireSelect({type:S.Set,conditions:[]});}.bind(this),type:s.Transparent,icon:"sap-icon://decline",tooltip:"{$i18n>valuehelp.REMOVEALLTOKEN}",layoutData:new F({growFactor:0,baseSize:"2rem"})});this.oRemoveAllBtn.addStyleClass("sapUiTinyMarginBegin");t.addItem(this.oTokenizer);t.addItem(this.oRemoveAllBtn);this.oTokenizerPanel.addContent(t);return this.oTokenizerPanel;}.bind(this));}return this.oTokenizerPanel;};function m(i,n){var v=i!==1;if(v&&n&&n.every(function(o){return!o.getRequiresTokenizer();})){v=false;}return v;}h.prototype._open=function(o){if(o){this._updateInitialContentKey();if(m(this.getMaxConditions(),this.getContent())&&o.getContent()[0].getItems().length===1){Promise.all([this._getTokenizerPanel()]).then(function(i){i.forEach(function(n){o.getContent()[0].addItem(n);});this._renderSelectedContent(this._sInitialContentKey,function(){o.open();});});}else{this._renderSelectedContent(this._sInitialContentKey,function(){o.open();});}}};h.prototype._renderSelectedContent=function(n,i){var N=this.getContent().find(function(p){return p.getId()===n;});if(!N){throw new Error("sap.ui.mdc.ValueHelp: No content found.");}var o=[N.getContent(),N.onBeforeShow()];var s=N.getGroup&&N.getGroup();var G;if(s&&k.call(this,s)){G=this._retrieveGroupSelect();o.push(G);}return Promise.all(o).then(function(p){this.setProperty("_selectedContentKey",n);this.setProperty("_selectableContents",this._getSelectableContents());this._oManagedObjectModel.checkUpdate(true,true);if(G){this._updateGroupSelectModel();}if(N.setCollectiveSearchSelect){N.setCollectiveSearchSelect(G?this._oGroupSelect:undefined);}if(i){i();}return this._retrievePromise("open").then(function(){N.onShow();return N;});}.bind(this));};h.prototype._close=function(){var o=this.getAggregation("_container");if(o){o.close();}};h.prototype.getValueHelpIcon=function(){return"sap-icon://value-help";};h.prototype.getAriaAttributes=function(i){return{contentId:null,ariaHasPopup:"dialog",role:null,roleDescription:null};};h.prototype.isMultiSelect=function(){return this.getMaxConditions()!==1;};h.prototype.exit=function(){b.cleanup(this,["_oManagedObjectModel","_oResourceBundle","oButtonOK","oButtonCancel","oTokenizerPanel","oTokenizer","_oIconTabBar","_oGroupSelect","_oGroupSelectModel","_sInitialContentKey"]);};return h;});
