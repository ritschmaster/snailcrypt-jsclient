/*
 * ! OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['sap/ui/mdc/valuehelp/base/FilterableListContent','sap/ui/mdc/condition/Condition','sap/ui/mdc/condition/FilterConverter','sap/ui/mdc/enum/ConditionValidated','sap/ui/mdc/util/loadModules','sap/m/library','sap/ui/model/FilterType','sap/ui/model/Filter','sap/ui/model/FilterOperator','sap/ui/model/FilterProcessor','sap/ui/mdc/util/Common','sap/base/strings/formatMessage','sap/base/util/merge','sap/ui/mdc/enum/SelectType','sap/base/Log','sap/ui/thirdparty/jquery'],function(F,C,a,b,l,c,d,e,f,g,h,i,m,S,L,q){"use strict";var j=c.ListMode;var k=c.Sticky;var M=F.extend("sap.ui.mdc.valuehelp.content.MTable",{metadata:{library:"sap.ui.mdc",interfaces:["sap.ui.mdc.valuehelp.ITypeaheadContent","sap.ui.mdc.valuehelp.IDialogContent"],properties:{},aggregations:{table:{type:"sap.m.Table",multiple:false}},events:{contentUpdated:{}},defaultAggregation:"table"}});M.prototype.init=function(){F.prototype.init.apply(this,arguments);this._oObserver.observe(this,{aggregations:["table"]});this._addPromise("listBinding");this._oResourceBundle=sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc");this._oMResourceBundle=sap.ui.getCore().getLibraryResourceBundle("sap.m");};M.prototype.getValueHelpIcon=function(){if(this.getUseAsValueHelp()){return"sap-icon://slim-arrow-down";}else{return null;}};function _(){if(this._oTable){var I=this._oTable.getItems();var t=this.getConditions();var H=this._isSingleSelect()&&!F.prototype._isSingleSelect.apply(this);for(var u in I){var v=I[u];var w=H?false:this._isItemSelected(v,t);v.setSelected(w);}}}M.prototype.applyFilters=function(t){var u=this.getListBinding();var v=this._isValueHelpDelegateInitialized();if((!u||!v)){Promise.all([this._retrievePromise("listBinding"),this._awaitValueHelpDelegate()]).then(function(){if(!this.bIsDestroyed){this.applyFilters(t);}}.bind(this));return;}if(!v||(!this.isTypeahead()&&!this.isContainerOpen()&&u.isSuspended())){return;}var D=this._getValueHelpDelegate();var w=this._getValueHelpDelegatePayload();var x=this.getFilterFields();var y=this._getPriorityFilterBar();var z=y?y.getInternalConditions():this._oInitialFilterConditions||{};if(!y&&t&&x&&x!=="$search"){var A=C.createCondition("Contains",[t],undefined,undefined,b.NotValidated);z[x]=[A];}var B=z&&this._getTypesForConditions(z);var E=z&&a.createFilters(z,B,undefined,this.getCaseSensitive());var G=E&&[E];var H=this.isTypeahead()?t:y&&y.getSearch();var U=true;var I;try{I=u.getFilterInfo();}catch(J){L.info("ValueHelp-Filter: getFilterInfo threw error");}if(!G){G=[];}if(G.length===0&&!I){U=false;}if(x==="$search"&&D&&D.isSearchSupported(w,this,u)){if(!u.isSuspended()&&U){u.suspend();}H=D.adjustSearch(w,this.isTypeahead(),H);D.executeSearch(w,u,H);L.info("ValueHelp-Search: "+H);}if(U){u.filter(G,d.Application);L.info("ValueHelp-Filter: "+this._prettyPrintFilters.call(this,G));}if(u.isSuspended()){u.resume();}};M.prototype._handleSelectionChange=function(E){var t=E.getSource().getBindingInfo("items").model;var I=this.isTypeahead();if(!I||!this._isSingleSelect()){var P=E.getParameters();var u=P.listItems||P.listItem&&[P.listItem];var v=u.map(function(w){var x=w.getBindingContext(t);var V=this._getItemFromContext(x);return V&&this._createCondition(V.key,V.description,V.payload);}.bind(this));this._fireSelect({type:P.selected?S.Add:S.Remove,conditions:v});if(I){this.fireConfirm();}}};M.prototype._handleItemPress=function(E){var t=E.getSource().getBindingInfo("items").model;var I=E.getParameter("listItem");var u=I.getBindingContext(t);var v=this._getItemFromContext(u);var w=this._isSingleSelect();var x=w?true:!I.getSelected();var y=S.Set;if(!w){I.setSelected(x);y=x?S.Add:S.Remove;}var z=this._createCondition(v.key,v.description,v.payload);this._fireSelect({type:y,conditions:[z]});if(this.isTypeahead()){this.fireConfirm({close:true});}};M.prototype._handleUpdateFinished=function(){_.apply(this);this.fireContentUpdated();};M.prototype._getTable=function(){return this._oTable;};M.prototype.onShow=function(){var t=this._getTable();if(t){if(!t.hasStyleClass("sapMComboBoxList")){t.addStyleClass("sapMComboBoxList");}var u=this.isTypeahead()?j.SingleSelectMaster:j.SingleSelectLeft;if(!F.prototype._isSingleSelect.apply(this)&&t.getMode()!==u){u=j.MultiSelect;}if(t.getMode()===j.None){t.setMode(u);}if(t.getMode()!==u){throw new Error("Table selection mode needs to be "+u);}}F.prototype.onShow.apply(this,arguments);};M.prototype.onHide=function(){F.prototype.onHide.apply(this,arguments);var t=this.getTable();if(t){this.removeFocus();if(t.hasStyleClass("sapMComboBoxList")){t.removeStyleClass("sapMComboBoxList");}}};M.prototype._handleConditionsUpdate=function(t){_.call(this);};M.prototype.getContent=function(){if(!this.isTypeahead()){return this._retrievePromise("wrappedContent",function(){return l(["sap/ui/layout/FixFlex","sap/m/VBox","sap/m/Panel","sap/m/ScrollContainer","sap/ui/model/resource/ResourceModel"]).then(function(t){var u=t[0];var V=t[1];var P=t[2];var v=t[3];var R=t[4];if(!this._oContentLayout){this._oFilterBarVBox=new V(this.getId()+"-FilterBarBox");this._oFilterBarVBox.addStyleClass("sapMdcValueHelpPanelFilterbar");this._oFilterBarVBox._oWrapper=this;this._oFilterBarVBox.getItems=function(){return[this._oWrapper._getPriorityFilterBar.call(this._oWrapper)];};this.setModel(new R({bundleName:"sap/ui/mdc/messagebundle",async:false}),"$i18n");var w=function(T){var I=0;if(I===0){T=this.getModel("$i18n").getResourceBundle().getText("valuehelp.TABLETITLENONUMBER");}return i(T,I);};this._oTablePanel=new P(this.getId()+"-TablePanel",{expanded:true,height:"100%",headerText:{parts:['$i18n>valuehelp.TABLETITLE'],formatter:w}});this._oTablePanel.addStyleClass("sapMdcTablePanel");this._oContentLayout=new u(this.getId()+"-FF",{minFlexSize:200,fixContent:this._oFilterBarVBox,flexContent:this._oTablePanel});this._oScrollContainer=new v(this.getId()+"-SC",{height:"100%",width:"100%",vertical:true});this._oScrollContainer._oWrapper=this;this._oScrollContainer.getContent=function(){var y=[];var T=this._oWrapper&&this._oWrapper._oTable;if(T){y.push(T);}return y;};this._oTablePanel.addContent(this._oScrollContainer);}this.setAggregation("displayContent",this._oContentLayout);var x=this._getPriorityFilterBar();if(!x){return this._createDefaultFilterBar().then(function(){return this._oContentLayout;}.bind(this));}return this._oContentLayout;}.bind(this));}.bind(this));}return this._oTable;};M.prototype.getItemForValue=function(t){if(!t.checkKey&&t.parsedValue&&!t.checkDescription){return null;}if(t.checkKey&&!this.getKeyPath()){throw new Error("MTable: KeyPath missing! "+this.getId());}if(t.checkDescription&&!this.getDescriptionPath()){throw new Error("MTable: DescriptionPath missing! "+this.getId());}t.caseSensitive=t.caseSensitive||this.getCaseSensitive();var P=p.call(this);var D=this._getValueHelpDelegate();var u=this._getValueHelpDelegatePayload();var v=D&&D.getInitialFilterConditions(u,this,t.control);return Promise.all([P,v]).then(function(R){var w=R[0];var I=R[1];var x;if(!w){var T=this.getTable();x=n.call(this,t,T.getItems(),I);}if(!x){x=this._loadItemForValue(t,I);}return x;}.bind(this));};function n(t,I,u){if(I.length===0){return;}var B=this._getListBindingInfo();var v=B.model;var w=function(D,P){var A=D.isA("sap.ui.model.Context")?D:D.getBindingContext(v);return A.getProperty(P);};var x;var O;var y=o.call(this,t,u);var z=g.apply(I,y,w);if(z.length===1){var A=z[0].getBindingContext(v);var V=this._getItemFromContext(A,{inParameters:x,outParameters:O});return{key:V.key,description:V.description,payload:V.payload};}else if(z.length>1){if(!t.caseSensitive){var N=m({},t);N.caseSensitive=true;return n.call(this,N,I,u);}throw r.call(this,t.exception,true,t.parsedValue||t.value);}}function o(t,I){var u=t.caseSensitive;var K=this.getKeyPath();var D=this.getDescriptionPath();var v=[];if(t.checkKey&&t.hasOwnProperty("parsedValue")){v.push(new e({path:K,operator:f.EQ,value1:t.parsedValue,caseSensitive:u}));}if(t.checkDescription&&t.value){v.push(new e({path:D,operator:f.EQ,value1:t.value,caseSensitive:u}));}var w=v.length>1?new e({filters:v,and:false}):v[0];if(I){var x=this._getTypesForConditions(I);var y=a.createFilters(I,x,undefined,this.getCaseSensitive());if(y){w=new e({filters:[w,y],and:true});}}return w;}function p(){return this._retrievePromise("listBinding").then(function(t){var D=this._getValueHelpDelegate();var u=this._getValueHelpDelegatePayload();var v=this._getListBindingInfo();if(t&&D){return D.checkListBindingPending(u,t,v);}else{return true;}}.bind(this));}M.prototype.getListBinding=function(){var t=this._getTable();return t&&t.getBinding("items");};M.prototype._getListBindingInfo=function(){var t=this._getTable();return t&&t.getBindingInfo("items");};M.prototype._loadItemForValue=function(t,I){if(!t.checkKey&&t.parsedValue&&!t.checkDescription){return null;}var K=this.getKeyPath();var D=this.getDescriptionPath();var u=this.getUseFirstMatch();var T=this._getTable();var v=T&&T.getBinding("items");var B=v&&v.getContext();var w=v&&v.getModel();var P=v&&v.getPath();var x=this._getValueHelpDelegate();var y=this._getValueHelpDelegatePayload();var z=["loadItemForValue",P,K,t.parsedValue||t.value].join("_");return this._retrievePromise(z,function(){var A=o.call(this,t,I);var E=w.bindList(P,B);return x.executeFilter(y,E,A,2).then(function(G){var H=G.getContexts();setTimeout(function(){E.destroy();},0);if(H.length&&(H.length<2||u)){return this._getItemFromContext(H[0],{keyPath:K,descriptionPath:D,inParameters:undefined});}else if(t.checkKey&&t.parsedValue===""&&H.length===0){return null;}else{var J=r.call(this,t.exception,H.length>1,t.value);throw J;}}.bind(this));}.bind(this));};function r(E,N,v){var t;if(N){t=this._oResourceBundle.getText("valuehelp.VALUE_NOT_UNIQUE",[v]);}else{t=this._oResourceBundle.getText("valuehelp.VALUE_NOT_EXIST",[v]);}var u=new E(t);u._bNotUnique=N;return u;}M.prototype.isValidationSupported=function(t){return true;};M.prototype.navigate=function(t){var u=this.getListBinding();if(!u||!u.getLength()){return p.call(this).then(function(P){if(!P&&u.getLength()!==0){return this.navigate(t);}return false;}.bind(this));}var T=this._getTable();T.addStyleClass("sapMListFocus");var I=this._oTable.getItems();var v=T.getSelectedItem();var w=I.length;var x=0;var y=false;if(v){x=I.indexOf(v);x=x+t;}else if(t>=0){x=t-1;}else{x=w+t;}if(this._getMaxConditions()!==1){if(this.getParent().isOpen()){T.focus();return;}}var z;if(x<0){x=0;z=true;y=true;}else if(x>=w-1){x=w-1;z=false;}else{z=t>=0;}while(I[x]&&I[x].isA("sap.m.GroupHeaderListItem")){if(z){x++;}else{x--;}}if(x<0||x>w-1){z=!z;y=x<0;x=x<0?0:w-1;while(I[x]&&I[x].isA("sap.m.GroupHeaderListItem")){if(z){x++;}else{x--;}}}var A=I[x];if(A){var B;if(A!==v){A.setSelected(true);var D=this._getListBindingInfo();var E=D.model;var G=A.getBindingContext(E);var V=this._getItemFromContext(G);B=V&&this._createCondition(V.key,V.description,V.payload);this.setProperty("conditions",[B],true);if(this._bVisible){this._handleScrolling(A);}this.fireNavigated({condition:B,itemId:A.getId(),leaveFocus:false});}else if(y){this.fireNavigated({condition:undefined,itemId:undefined,leaveFocus:y});}}};M.prototype._handleScrolling=function(I){var t=this.getScrollDelegate();if(t){var T=this._getTable();var u=!isNaN(I)?I:T.indexOfItem(I);T.scrollToIndex(u).catch(function(E){});return true;}return false;};M.prototype.getScrollDelegate=function(){if(this._oScrollContainer){return this._oScrollContainer.getScrollDelegate();}return F.prototype.getScrollDelegate.apply(this,arguments);};M.prototype.removeFocus=function(){var t=this.getTable();if(t){t.removeStyleClass("sapMListFocus");}};M.prototype.getAriaAttributes=function(t){var T=this.getTable();return{contentId:T&&T.getId(),ariaHasPopup:"listbox",roleDescription:null};};M.prototype.getContainerConfig=function(){return{'sap.ui.mdc.valuehelp.Popover':{getContentHeight:function(){var t=this._getTable();var D=t&&t.getDomRef();return D&&Math.round(D.getBoundingClientRect().height);}.bind(this),getFooter:function(){return this._retrievePromise("footer",function(){return this._retrievePromise("listBinding").then(function(t){var B=this._getListBindingInfo();if(B&&B.length){return l(["sap/m/Button","sap/m/Toolbar","sap/m/ToolbarSpacer"]).then(function(u){var v=u[0];var T=u[1];var w=u[2];var x=new v(this.getId()+"-showAllItems",{text:this._oMResourceBundle.getText("INPUT_SUGGESTIONS_SHOW_ALL"),press:function(){this.fireRequestSwitchToDialog();}.bind(this)});var y=[new w(this.getId()+"-Spacer")].concat(x);var z=new T(this.getId()+"-TB",{content:y});return z;}.bind(this));}}.bind(this));}.bind(this));}.bind(this)}};};function s(){if(this._oTable&&this.getParent()){var t=this._oTable.getSticky();if(!t||t.length===0){this._oTable.setSticky([k.ColumnHeaders]);}}}M.prototype.setParent=function(P){F.prototype.setParent.apply(this,arguments);s.call(this);};M.prototype._handleSearch=function(E){return this.applyFilters(this.getFilterValue());};M.prototype._observeChanges=function(t){if(t.name==="config"){s.call(this);}if(t.name==="items"&&t.mutation==="ready"){this._resolvePromise("listBinding",t.bindingInfo.binding);}if(t.name==="table"){var T=t.child;if(t.mutation==="remove"){this._oObserver.unobserve(T);T.removeDelegate(this._oTableDelegate);this._oTable.detachItemPress(this._handleItemPress,this);this._oTable.detachSelectionChange(this._handleSelectionChange,this);this._oTable.detachUpdateFinished(this._handleUpdateFinished,this);this._oTable=null;this._removePromise("footer");this._addPromise("listBinding");}else{this._oTable=T;s.call(this);this._oTable.attachItemPress(this._handleItemPress,this);this._oTable.attachSelectionChange(this._handleSelectionChange,this);this._oTable.attachUpdateFinished(this._handleUpdateFinished,this);this._oTableDelegate=this._oTableDelegate||{onsapprevious:this._handleTableEvent,onsapnext:this._handleTableEvent,cellClick:this._handleTableEvent};T.addDelegate(this._oTableDelegate,true,this);var u=T.getBinding("items");if(u){this._resolvePromise("listBinding",u);}else{this._oObserver.observe(t.child,{bindings:["items"]});}}}F.prototype._observeChanges.apply(this,arguments);};M.prototype._handleTableEvent=function(E){if(!this.isTypeahead()){return;}var t=this._getTable();var I=q(E.target).control(0);switch(E.type){case"sapprevious":if(I.isA("sap.m.ListItemBase")){if(t.indexOfItem(I)===0){this.fireNavigated({condition:undefined,itemId:undefined,leaveFocus:true});E.preventDefault();E.stopPropagation();E.stopImmediatePropagation(true);}}break;default:break;}};M.prototype.isQuickSelectSupported=function(){return true;};M.prototype.shouldOpenOnNavigate=function(){return true;};M.prototype._isSingleSelect=function(){var t=this._getTable();if(t){if(t.getMode()===j.MultiSelect){return false;}else{return true;}}else{return F.prototype._isSingleSelect.apply(this,arguments);}};M.prototype.exit=function(){h.cleanup(this,["_sTableWidth","_oTable","_oScrollContainer","_oContentLayout","_oTablePanel","_oFilterBarVBox","_oMResourceBundle","_oResourceBundle"]);F.prototype.exit.apply(this,arguments);};return M;});
