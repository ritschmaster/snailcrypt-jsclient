/*
 * ! OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['sap/ui/mdc/valuehelp/base/FilterableListContent','sap/ui/mdc/util/loadModules','sap/base/util/deepEqual','sap/ui/mdc/enum/SelectType','sap/ui/mdc/library','sap/m/library',"sap/ui/table/library","sap/ui/thirdparty/jquery",'sap/ui/mdc/condition/FilterConverter','sap/base/util/restricted/_throttle'],function(F,l,d,S,a,L,u,q,b,t){"use strict";var c=L.ListMode;var e=L.Sticky;var M=a.SelectionMode;var U=u.VisibleRowCountMode;var f=u.SelectionMode;var g=u.SelectionBehavior;var _=function(T){var i,v=i=T&&T.getType();if(!v){i="Table";}else if(typeof v==="object"){if(v.isA("sap.ui.mdc.table.ResponsiveTableType")){i="ResponsiveTable";}else{i="Table";}}return i;};var h=function(){var T=this._getTable();var I=T&&T._oTable;var v=T.getRowBinding();var w=function(){return this._oUITableSelectionPlugin||I;}.bind(this);var x=function(C,i){var z=i?S.Add:S.Remove;if(!i&&this._isSingleSelect()){z=S.Add;}this._fireSelect({type:z,conditions:C});};var y={"ResponsiveTable":{getListBindingInfo:function(){return I&&I.getBindingInfo("items");},getItems:function(){return I.getItems();},getSelectedItems:function(){return I.getSelectedItems();},modifySelection:function(i,z){if(i.getSelected()!==z){i.setSelected(z);}},handleItemPress:function(E){var i=E.getParameter("listItem");if(!this.isTypeahead()||!this._isSingleSelect()){i.setSelected(!i.getSelected());}var z=this._getListBindingInfo().model;var A=i.getBindingContext(z);var V=this._getItemFromContext(A);var C=V&&this._createCondition(V.key,V.description,V.payload);x.call(this,[C],i.getSelected());},handleSelectionChange:function(E){if(!this.isTypeahead()||!this._isSingleSelect()){var P=E.getParameters();var i=P.listItems||P.listItem&&[P.listItem];var z=this._getListBindingInfo().model;var C=i.map(function(A){var B=A.getBindingContext(z);var V=this._getItemFromContext(B);return V&&this._createCondition(V.key,V.description,V.payload);}.bind(this));x.call(this,C,P.selected);}},adjustTable:function(){var i=I.getSticky();if(!i||i.length===0){I.setSticky([e.ColumnHeaders]);}if(this._isSingleSelect()){I.setMode(c.SingleSelectLeft);}else{I.setMode(c.MultiSelect);}},handleScrolling:function(i){var z=this.getScrollDelegate();if(z){I.scrollToIndex(i).catch(function(E){});return true;}},handleListBinding:function(){}},"Table":{getListBindingInfo:function(){return I&&I.getBindingInfo("rows");},getItems:function(){return I.getRows().filter(function(R){var i=R.getBindingContext();return i&&i.getObject();});},getSelectedItems:function(){var i=w().getSelectedIndices();var z=i.reduce(function(R,C){var A=I.getContextByIndex(C);return A?R.concat(A):R;},[]);return y["Table"].getItems().filter(function(R){return z.indexOf(R.getBindingContext())>=0;});},modifySelection:function(i,z){var C=i.getBindingContext();var A=y["Table"].getContexts().indexOf(C);var B=w().getSelectedIndices().indexOf(A)>=0;if(z&&!B){return this._isSingleSelect()?w().setSelectedIndex(A):w().addSelectionInterval(A,A);}else if(!z&&B){return w().removeSelectionInterval(A,A);}},handleItemPress:function(E){},handleSelectionChange:function(E){if(this._bScrolling||this._bBusy){return;}var R=E.getParameter("rowIndices");var C=y["Table"].getContexts().filter(function(i,J){return R.indexOf(J)>=0;});var z=y["Table"].getItems().filter(function(i,J){return C.indexOf(i.getBindingContext())>=0;});var A=[],B=[];var D=y["Table"].getSelectedItems();var G=this.getConditions();z.forEach(function(J,i){var K=this._isItemSelected(J,G);var N=D.indexOf(J)!==-1;if(K!==N){var O=D.indexOf(J)!==-1?A:B;var V=this._getItemFromContext(J.getBindingContext());var P=V&&this._createCondition(V.key,V.description,V.payload);O.push(P);}}.bind(this));var H=this._isSingleSelect();if(A.length){x.call(this,A,true);if(H){return;}}if(B.length){x.call(this,B,false);}},adjustTable:function(){var R=I.getRowMode();if(!R){I.setVisibleRowCountMode(U.Auto);I.setMinAutoRowCount(3);}else if(R.isA("sap.ui.table.rowmodes.AutoRowMode")){R.setMinRowCount(3);}var i=this._isSingleSelect()?f.Single:f.MultiToggle;I.setSelectionBehavior(g.Row);w().setSelectionMode(i);},handleScrolling:function(i){var z=I.getFirstVisibleRow();if(typeof i==="undefined"||i<0){i=z-1;}if(i>=0&&i!=z){I.setFirstVisibleRow(i);return Promise.resolve();}return false;},getContexts:function(){return v&&v.getAllCurrentContexts();},handleListBinding:function(){v.attachEvent("change",this._handleUpdateFinished.bind(this));}}};return y[this._sTableType];};function j(){if(this._oTableHelper&&!this._bSelectionIsUpdating){this._bSelectionIsUpdating=true;var i=this._oTableHelper.getItems();var C=this.getConditions();var v=[];for(var I in i){var w=i[I];var x=this._isItemSelected(w,C);v.push(this._oTableHelper.modifySelection.call(this,w,x));}Promise.all(v).then(function(){this._bSelectionIsUpdating=false;}.bind(this));}}var k=t(j,100,{leading:true});var m=F.extend("sap.ui.mdc.valuehelp.content.MDCTable",{metadata:{library:"sap.ui.mdc",interfaces:["sap.ui.mdc.valuehelp.IDialogContent"],properties:{},aggregations:{table:{type:"sap.ui.mdc.Table",multiple:false}},events:{},defaultAggregation:"table"}});m.prototype.init=function(){F.prototype.init.apply(this,arguments);this._oObserver.observe(this,{aggregations:["table"]});this._addPromise("listBinding");};var n=function(){var i=this._getTable().getRowBinding();if(i){this._oTableHelper=h.call(this);this._oTableHelper.handleListBinding.call(this);s.call(this);this._resolvePromise("listBinding",i);}};var o=function(){if(this._oTable&&!this._oTable.getHeader()){this._oTable.setHeader(this._oResourceBundle.getText("valuehelp.TABLETITLENONUMBER"));}};m.prototype._handleConditionsUpdate=function(){k.call(this);};m.prototype._handleUpdateFinished=function(E){this._bScrolling=false;this._bSearchTriggered=false;k.call(this);};m.prototype._handleFirstVisibleRowChanged=function(E){this._bScrolling=true;k.call(this);};m.prototype._handleBusyStateChanged=function(E){this._bBusy=E.getParameter("busy");};var p=function(i,v){if(!i){return;}if(v==="remove"){if(this._sTableType==="Table"){i.detachEvent("cellClick",this._handleItemPress,this);i.detachEvent("rowSelectionChange",this._handleSelectionChange,this);i.detachEvent("rowsUpdated",this._handleUpdateFinished,this);i.detachEvent("firstVisibleRowChanged",this._handleFirstVisibleRowChanged,this);i.detachEvent("busyStateChanged",this._handleBusyStateChanged,this);if(this._oUITableSelectionPlugin){this._oUITableSelectionPlugin.detachEvent("selectionChange",this._handleSelectionChange,this);}this._oUITableSelectionPlugin=undefined;}else if(this._sTableType==="ResponsiveTable"){i.detachEvent("itemPress",this._handleItemPress,this);i.detachEvent("selectionChange",this._handleSelectionChange,this);i.detachEvent("updateFinished",this._handleUpdateFinished,this);}this._oObserver.unobserve(i);}else{if(this._sTableType==="Table"){this._oObserver.observe(i,{bindings:["rows"],aggregations:["plugins"]});i.attachEvent("cellClick",this._handleItemPress,this);i.attachEvent("rowSelectionChange",this._handleSelectionChange,this);i.attachEvent("rowsUpdated",this._handleUpdateFinished,this);i.attachEvent("firstVisibleRowChanged",this._handleFirstVisibleRowChanged,this);i.attachEvent("busyStateChanged",this._handleBusyStateChanged,this);this._oUITableSelectionPlugin=i.getPlugins().find(function(P){return P.isA("sap.ui.table.plugins.SelectionPlugin");});if(this._oUITableSelectionPlugin){this._oUITableSelectionPlugin.attachEvent("selectionChange",this._handleSelectionChange,this);}}else if(this._sTableType==="ResponsiveTable"){this._oObserver.observe(i,{bindings:["items"]});i.attachEvent("itemPress",this._handleItemPress,this);i.attachEvent("selectionChange",this._handleSelectionChange,this);i.attachEvent("updateFinished",this._handleUpdateFinished,this);}}};m.prototype._handleSearch=function(E){var i=this.getFilterFields();var v=E.getSource();var C=v.getInternalConditions();var w=i&&C[i]&&C[i][0];var x=w&&w.values[0];this.setFilterValue(x);};m.prototype._observeChanges=function(C){if(["_defaultFilterBar","filterBar"].indexOf(C.name)!==-1){r.call(this);}if(C.name==="table"){var T=C.child;if(C.mutation==="remove"){this._oObserver.unobserve(T);this._oTable=null;this._oTableHelper=null;this._addPromise("listBinding");}else{this._oTable=T;this._oObserver.observe(T,{aggregations:["_content"]});this._sTableType=_(T);T.addDelegate({onmouseover:function(E){var i=q(E.target).control(0);if(i&&i.isA("sap.m.ColumnListItem")){i.setType("Active");}}});p.call(this,this._oTable._oTable,"insert");n.call(this);o.call(this);r.call(this);}return;}if(C.name==="_content"){p.call(this,C.child,C.mutation);return;}if(["rows","items"].indexOf(C.name)!==-1&&C.mutation==="ready"){n.call(this);return;}if(C.name==="config"){s.call(this);}if(C.name==="plugins"){this._oUITableSelectionPlugin=C.mutation==="remove"||!C.child.isA("sap.ui.table.plugins.SelectionPlugin")?undefined:C.child;if(this._oUITableSelectionPlugin){this._oUITableSelectionPlugin.attachEvent("selectionChange",this._handleSelectionChange,this);}}F.prototype._observeChanges.apply(this,arguments);};m.prototype._getTable=function(){return this._oTable;};function r(){var i=this._getPriorityFilterBar();if(this._oTable&&i&&this._oTable.getFilter()!==i.getId()){this._oTable.setFilter(i);}}function s(){if(this._oTableHelper){this._oTableHelper.adjustTable.call(this);}}m.prototype.getContent=function(){return this._retrievePromise("wrappedContent",function(){return l(["sap/ui/layout/FixFlex","sap/m/VBox","sap/m/ScrollContainer"]).then(function(i){var v=i[0];var V=i[1];var w=i[2];if(!this._oContentLayout){this._oFilterBarVBox=new V(this.getId()+"-FilterBarBox",{visible:"{$this>/_filterBarVisible}"});this._oFilterBarVBox.addStyleClass("sapMdcValueHelpPanelFilterbar");this._oFilterBarVBox._oWrapper=this;this._oFilterBarVBox.getItems=function(){var x=this._oWrapper._getPriorityFilterBar.call(this._oWrapper);var I=x?[x]:[];return I;};this._oTableBox=new V(this.getId()+"-TB",{height:"100%"});this._oTableBox.addStyleClass("sapMdcValueHelpPanelTableBox");this._oTableBox._oWrapper=this;this._oTableBox.getItems=function(){var T=this._oWrapper._sTableType==="ResponsiveTable"?this._oWrapper._oScrollContainer:this._oWrapper._oTable;var I=T?[T]:[];return I;};this._oContentLayout=new v(this.getId()+"-FF",{minFlexSize:200,fixContent:this._oFilterBarVBox,flexContent:this._oTableBox});this._oScrollContainer=new w(this.getId()+"-SC",{height:"calc(100% - 0.5rem)",width:"100%",vertical:true});this._oScrollContainer._oWrapper=this;this._oScrollContainer.getContent=function(){var C=[];var T=this._oWrapper&&this._oWrapper._oTable;if(T){C.push(T);}return C;};}this.setAggregation("displayContent",this._oContentLayout);if(!this._getPriorityFilterBar()){return this._createDefaultFilterBar().then(function(){this._oFilterBarVBox.invalidate();return this._oContentLayout;}.bind(this));}return this._oContentLayout;}.bind(this));}.bind(this));};m.prototype.getListBinding=function(){var T=this.getTable();return T&&T.getRowBinding();};m.prototype._getListBindingInfo=function(){return this._oTableHelper&&this._oTableHelper.getListBindingInfo();};m.prototype.onShow=function(){if(this._oTable){var i=F.prototype._isSingleSelect.apply(this)?M.Single:M.Multi;if(this._oTable.getSelectionMode()===M.None){this._oTable.setSelectionMode(i);}if(this._oTable.getSelectionMode()!==i){throw new Error("Table selectionMode needs to be "+i);}}F.prototype.onShow.apply(this,arguments);};m.prototype.onHide=function(){this._bSearchTriggered=false;F.prototype.onHide.apply(this,arguments);};m.prototype._createFiltersFromBarConditions=function(C){var i=this._getTypesForConditions(C);var v=C&&i&&b.createFilters(C,i,undefined,this.getCaseSensitive());return v&&[].concat(v);};m.prototype.applyFilters=function(i){var T=this.getTable();var v=this._getPriorityFilterBar();if(T&&v){var w=this.getListBinding();var x=w&&w.isSuspended();if(w&&!x&&!this._bSearchTriggered){var y=v.getSearch()||"";var B=w.mParameters.$search||"";var z=this._createFiltersFromBarConditions(v.getConditions());var A=w.aApplicationFilters.reduce(function(R,G){return R.concat(G._bMultiFilter?G.aFilters:G);},[]);var C=!d(z,A);var D=y!==B;var E=T._oTable&&T._oTable.getShowOverlay&&T._oTable.getShowOverlay();if(C||D||E){this._handleScrolling();v.triggerSearch();this._bSearchTriggered=true;}}if(x){w.resume();}if(!w&&T.getAutoBindOnInit()){this._retrievePromise("listBinding").then(function(){this.applyFilters(i);}.bind(this));}}};m.prototype._handleScrolling=function(i){return this._oTableHelper&&this._oTableHelper.handleScrolling.call(this,i);};m.prototype.getScrollDelegate=function(){if(!this.isTypeahead()&&this._oScrollContainer){return this._oScrollContainer.getScrollDelegate();}return F.prototype.getScrollDelegate.apply(this,arguments);};m.prototype._handleItemPress=function(E){this._oTableHelper.handleItemPress.call(this,E);};m.prototype._handleSelectionChange=function(E){if(!this._bSelectionIsUpdating){this._oTableHelper.handleSelectionChange.call(this,E);}};m.prototype.isQuickSelectSupported=function(){return true;};m.prototype.setParent=function(P){F.prototype.setParent.apply(this,arguments);s.call(this);};m.prototype._isSingleSelect=function(){if(this._oTable){if(this._oTable.getSelectionMode()===M.Multi){return false;}else{return true;}}else{return F.prototype._isSingleSelect.apply(this,arguments);}};return m;});
