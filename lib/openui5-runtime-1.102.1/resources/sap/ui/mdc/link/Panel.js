/*
 * ! OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/core/Control","./PanelRenderer","sap/ui/layout/VerticalLayout","sap/base/Log","sap/ui/layout/HorizontalLayout","sap/m/HBox","sap/m/VBox","sap/m/ImageContent","sap/m/Link","sap/m/Label","sap/m/Text","sap/m/Button","sap/m/FlexItemData","sap/ui/model/json/JSONModel","sap/ui/model/BindingMode","sap/ui/base/ManagedObjectObserver","sap/ui/mdc/p13n/subcontroller/LinkPanelController","sap/ui/mdc/p13n/Engine","sap/ui/mdc/mixin/AdaptationMixin","sap/ui/mdc/link/PanelItem"],function(C,P,V,L,H,a,b,I,c,d,T,B,F,J,e,M,f,E,A,g){"use strict";var h=C.extend("sap.ui.mdc.link.Panel",{metadata:{library:"sap.ui.mdc",designtime:"sap/ui/mdc/designtime/link/Panel.designtime",defaultAggregation:"items",properties:{enablePersonalization:{type:"boolean",defaultValue:true,invalidate:true},metadataHelperPath:{type:"string"},beforeNavigationCallback:{type:"function"}},aggregations:{items:{type:"sap.ui.mdc.link.PanelItem",multiple:true,singularName:"item"},additionalContent:{type:"sap.ui.core.Control",multiple:true},_content:{type:"sap.ui.layout.VerticalLayout",visibility:"hidden",multiple:false}},events:{beforeSelectionDialogOpen:{},afterSelectionDialogClose:{}}},renderer:P});h.prototype.init=function(){C.prototype.init.call(this);E.getInstance().registerAdaptation(this,{controller:{LinkItems:f}});A.call(h.prototype);E.getInstance().defaultProviderRegistry.attach(this,"Global");sap.ui.require([this.getMetadataHelperPath()||"sap/ui/mdc/Link"],function(i){this._oMetadataHelper=i;}.bind(this));var m=new J({countAdditionalContent:0,countItemsWithIcon:0,countItemsWithoutIcon:0,showResetEnabled:false,runtimeItems:[],contentTitle:""});m.setDefaultBindingMode(e.TwoWay);m.setSizeLimit(1000);this.setModel(m,"$sapuimdclinkPanel");this._oObserver=new M(_.bind(this));this._oObserver.observe(this,{properties:["enablePersonalization"],aggregations:["items","additionalContent"]});};var r=sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc");h.prototype.applySettings=function(){this._createContent();C.prototype.applySettings.apply(this,arguments);};h.prototype.exit=function(o){if(this._oObserver){this._oObserver.disconnect();this._oObserver=null;}if(this._oMetadataHelper){this._oMetadataHelper=null;}};h.prototype._createContent=function(){var v=new V({content:[this._createAdditionalContentArea(),this._createSeparator(),this._createLinkArea(),this._createFooterArea()]});this.setAggregation("_content",v);};h.prototype._createAdditionalContentArea=function(){var o=new b({fitContainer:false,items:this.getAdditionalContent()});return o;};h.prototype._createSeparator=function(){var s=new b({fitContainer:false,visible:{parts:[{path:"$sapuimdclinkPanel>/countAdditionalContent"},{path:"$sapuimdcLink>/metadata"}],formatter:function(i,m){return i>0&&m.length>0;}}});s.addStyleClass("mdcbaseinfoPanelSeparator");s.setModel(this._getInternalModel(),"$sapuimdclinkPanel");s.setModel(this.getModel("$sapuimdcLink"),"$sapuimdcLink");return s;};h.prototype._createLinkArea=function(){var l=new b({fitContainer:false,items:{path:"$sapuimdclinkPanel>/runtimeItems",templateShareable:false,factory:this._fnLinkItemFactory.bind(this)}});l.addStyleClass("mdcbaseinfoPanelSectionLinks");l.setModel(this._getInternalModel(),"$sapuimdclinkPanel");return l;};h.prototype._fnLinkItemFactory=function(i,o){var j=new I({src:"{$sapuimdclinkPanel>icon}",visible:{path:"$sapuimdclinkPanel>icon",formatter:function(s){return!!s;}}});var l=new c({text:"{$sapuimdclinkPanel>text}",href:"{$sapuimdclinkPanel>href}",target:"{$sapuimdclinkPanel>target}",visible:{path:"$sapuimdclinkPanel>href",formatter:function(s){return!!s;}},press:this.onPressLink.bind(this),wrapping:true});var k=new d({text:"{$sapuimdclinkPanel>text}",visible:{path:"$sapuimdclinkPanel>href",formatter:function(s){return!s;}},wrapping:true});var t=new T({text:"{$sapuimdclinkPanel>description}",visible:{path:"$sapuimdclinkPanel>description",formatter:function(D){return!!D;}},wrapping:true});var v=new b({items:[l,k,t]});var m=new a({layoutData:new F({styleClass:o.getProperty("description")?"mdcbaseinfoPanelItemsGroup":"mdcbaseinfoPanelItemsWithoutGroup"}),items:[j,v]});var p=new H({visible:"{$sapuimdclinkPanel>visible}",content:[m]});p.addStyleClass("mdcbaseinfoPanelListItem");return p;};h.prototype._createFooterArea=function(){var R=new B(this.getId()+"--idSectionPersonalizationButton",{type:"Transparent",text:r.getText("info.POPOVER_DEFINE_LINKS"),press:this.onPressLinkPersonalization.bind(this)});var o=new a({visible:{path:"$sapuimdcLink>/metadata",formatter:function(m){return m.length>0;}},justifyContent:"End",items:[R]});o.addStyleClass("mdcbaseinfoPanelPersonalizationButton");return o;};h.prototype.onPressLink=function(o){if(this.getBeforeNavigationCallback()&&o.getSource()&&o.getSource().getTarget()!=="_blank"){var s=o.getSource().getHref();o.preventDefault();this.getBeforeNavigationCallback()(o).then(function(n){if(n){h.navigate(s);}});}};h.oNavigationPromise=undefined;h.navigate=function(s){if(s.indexOf("#")===0&&sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getServiceAsync){if(!h.oNavigationPromise){h.oNavigationPromise=sap.ushell.Container.getServiceAsync("CrossApplicationNavigation").then(function(o){o.toExternal({target:{shellHash:s.substring(1)}});h.oNavigationPromise=undefined;});}}else{window.location.href=s;}};h.prototype.onPressLinkPersonalization=function(){sap.ui.require([this.getMetadataHelperPath()||"sap/ui/mdc/Link"],function(i){var m=this._getInternalModel();var j=i.retrieveBaseline(this);var k=j;var u=function(s){var S=s._oListControl.getItems().filter(function(o){return o.getSelected();});S=S.map(function(o){var n=s._getP13nModel().getProperty(o.getBindingContext(s.P13N_MODEL).sPath);return{id:n.name,description:n.description,href:n.href,target:n.target,text:n.text,visible:n.visible};});var l=h._showResetButtonEnabled(k,S);this._getInternalModel().setProperty("/showResetEnabled",l);};var p=this.getParent();p.setModal(true);E.getInstance().uimanager.show(this,"LinkItems").then(function(D){var R=D.getCustomHeader().getContentRight()[0];var s=D.getContent()[0];R.setModel(m,"$sapuimdclinkPanel");R.bindProperty("enabled",{path:'$sapuimdclinkPanel>/showResetEnabled'});u.call(this,s);s.attachChange(function(o){u.call(this,s);}.bind(this));D.attachAfterClose(function(){p.setModal(false);});}.bind(this));}.bind(this));};h._showResetButtonEnabled=function(m,s){var S=false;var i=h._getVisibleItems(s);var j=h._getVisibleItems(m);if(s.length!==m.length){S=true;}else if(j.length&&i.length){var k=h._allItemsIncludedInArray(j,i);var l=h._allItemsIncludedInArray(i,j);S=!k||!l;}return S;};h._allItemsIncludedInArray=function(m,i){var j=true;m.forEach(function(o){var k=h._getItemsById(o.id,i);if(k.length===0){j=false;}});return j;};h._getItemsById=function(i,m){return m.filter(function(o){return o.id===i;});};h._getItemById=function(i,j){return h._getItemsById(i,j)[0];};h._getVisibleItems=function(m){return m.filter(function(i){return i.id!==undefined&&i.visible;});};h.prototype._getInternalModel=function(){return this.getModel("$sapuimdclinkPanel");};h.prototype._propagateDefaultIcon=function(s){if(!s){return;}var m=this._getInternalModel();m.getProperty("/runtimeItems").forEach(function(o,i){if(o.icon){return;}m.setProperty("/runtimeItems/"+i+"/icon","sap-icon://chain-link");});};function _(o){var m=this._getInternalModel();if(o.object.isA("sap.ui.mdc.link.Panel")){switch(o.name){case"additionalContent":var i=o.child?[o.child]:o.children;i.forEach(function(l){switch(o.mutation){case"insert":this.getAggregation("_content").getContent()[0].addItem(l);break;case"remove":break;default:L.error("Mutation '"+o.mutation+"' is not supported yet.");}}.bind(this));m.setProperty("/countAdditionalContent",i.length);break;case"items":var j=o.child?[o.child]:o.children;j.forEach(function(p){var R=m.getProperty("/runtimeItems/");switch(o.mutation){case"insert":m.setProperty("/countItemsWithIcon",p.getIcon()?m.getProperty("/countItemsWithIcon")+1:m.getProperty("/countItemsWithIcon"));m.setProperty("/countItemsWithoutIcon",p.getIcon()?m.getProperty("/countItemsWithoutIcon"):m.getProperty("/countItemsWithoutIcon")+1);R.splice(this.indexOfItem(p),0,p.getJson());m.setProperty("/runtimeItems",R);this._propagateDefaultIcon(m.getProperty("/countItemsWithIcon")>0&&m.getProperty("/countItemsWithoutIcon")>0);this._oObserver.observe(p,{properties:["visible"]});break;case"remove":m.setProperty("/countItemsWithIcon",p.getIcon()?m.getProperty("/countItemsWithIcon")-1:m.getProperty("/countItemsWithIcon"));m.setProperty("/countItemsWithoutIcon",p.getIcon()?m.getProperty("/countItemsWithoutIcon"):m.getProperty("/countItemsWithoutIcon")-1);var l=R.find(function(n){return n.id===p.getId();});R.splice(R.indexOf(l),1);m.setProperty("/runtimeItems",R);this._propagateDefaultIcon(m.getProperty("/countItemsWithIcon")>0&&m.getProperty("/countItemsWithoutIcon")>0);this._oObserver.unobserve(p);p.destroy();this.invalidate();break;default:L.error("Mutation '"+o.mutation+"' is not supported yet.");}},this);break;case"enablePersonalization":this._getPersonalizationButton().setVisible(o.current);break;default:L.error("The property or aggregation '"+o.name+"' has not been registered.");}}else if(o.object.isA("sap.ui.mdc.link.PanelItem")){switch(o.name){case"visible":var p=o.object;var k=this.indexOfItem(p);if(p.getVisibleChangedByUser()){m.setProperty("/runtimeItems/"+k+"/visible",p.getVisible());}else{m.setProperty("/baselineItems/"+k+"/visible",p.getVisible());m.setProperty("/runtimeItems/"+k+"/visible",p.getVisible());}break;default:L.error("The '"+o.name+"' of PanelItem is not supported yet.");}}this._updateContentTitle();}h.prototype.getContentTitle=function(){var m=this._getInternalModel();return m.getProperty("/contentTitle");};h.prototype.getCurrentState=function(){var i=[],s;this.getItems().forEach(function(o,j){s=o&&o.getId();if(o.getVisible()){i.push({name:s});}});return{items:i};};h.prototype.initPropertyHelper=function(){var i=this._oMetadataHelper.retrieveAllMetadata(this);return Promise.resolve({getProperties:function(){var j=[];i.forEach(function(o){j.push({name:o.id,getName:function(){return o.id;},getLabel:function(){return o.text;},text:o.text,href:o.href,description:o.description,target:o.target,visible:o.visible});});return j;}});};h.prototype._updateContentTitle=function(){var m=this._getInternalModel();var i=this.getAdditionalContent();var o=this._getPersonalizationButton().getId();if(i.length>0){o=i[0];}else{var j=this.getItems();if(j.length>0){o=j[0];}}m.setProperty("/contentTitle",o);};h.prototype._getPersonalizationButton=function(){return this.getAggregation("_content").getContent()[3].getItems()[0];};return h;});
