/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['sap/m/DynamicDateOption','sap/m/DynamicDateValueHelpUIType','sap/m/Input','sap/ui/mdc/condition/Operator',"sap/ui/mdc/enum/BaseType",'sap/ui/mdc/enum/FieldDisplay','sap/ui/mdc/util/DateUtil','sap/ui/mdc/util/loadModules','sap/ui/model/json/JSONModel','sap/ui/model/FormatException','sap/ui/model/ParseException','sap/ui/model/ValidateException','sap/ui/core/library'],function(D,a,I,O,B,F,b,l,J,c,P,V,d){"use strict";var e=d.ValueState;var f;var g;var h=D.extend("sap.ui.mdc.condition.OperatorDynamicDateOption",{metadata:{library:"sap.ui.mdc",properties:{operator:{type:"object"},type:{type:"object"},baseType:{type:"sap.ui.mdc.enum.BaseType"}}}});h.prototype.exit=function(){D.prototype.exit.apply(this,arguments);if(this._oModel){this._oModel.destroy();this._oModel=undefined;this._mChangeHandler=undefined;}if(this._aUITypes){for(var i=0;i<this._aUITypes.length;i++){this._aUITypes[i].destroy();}this._aUITypes=undefined;}};h.prototype.applySettings=function(){D.prototype.applySettings.apply(this,arguments);var m=[];var s=this.getBaseType();if(s===B.DateTime){if(!g){m.push("sap/m/DateTimePicker");}}else if(!f){m.push("sap/m/DatePicker");}if(m.length>0){return l(m).then(function(m){if(s===B.DateTime){g=m[0];}else{f=m[0];}});}};h.prototype.validateProperty=function(p,v){if(p==="operator"&&v&&(typeof v!=="object"||!v.isA||!v.isA("sap.ui.mdc.condition.Operator"))){throw new Error("\""+v+"\" is of type "+typeof v+", expected "+"sap.ui.mdc.condition.Operator for property \""+p+"\" of "+this);}else if(p==="type"&&v&&(typeof v!=="object"||!v.isA||!v.isA("sap.ui.model.Type"))){throw new Error("\""+v+"\" is of type "+typeof v+", expected "+"sap.ui.model.Type for property \""+p+"\" of "+this);}return D.prototype.validateProperty.apply(this,arguments);};h.prototype.isRange=function(){var o=this.getOperator();return o.isA("sap.ui.mdc.condition.RangeOperator");};h.prototype.getText=function(C){var o=this.getOperator();return o.longText;};h.prototype.getValueHelpUITypes=function(C){if(!this._aUITypes){var o=this.getOperator();var t=this.getType();var s=this.getBaseType();this._aUITypes=[];for(var i=0;i<o.valueTypes.length;i++){var T=o.valueTypes[i];if(T===O.ValueType.Self){var j;if(s===B.DateTime){j="datetime";}else{j="date";}this._aUITypes.push(new a({type:j}));}else if(!T||T===O.ValueType.Static){continue;}else{t=o._createLocalType(T,t);if(t.isA("sap.ui.model.type.Integer")||t.isA("sap.ui.model.odata.type.Int")){this._aUITypes.push(new a({type:"int"}));}else{this._aUITypes.push(new a({type:"custom"}));}}}}return this._aUITypes;};h.prototype.createValueHelpUI=function(C,j){var v=C.getValue();var o=this.getOperator();var t=this.getType();var k=this.getKey();var s=C.getId();if(!v||v.operator!==k){v={operator:k,values:[]};if(o.valueDefaults){v.values=o.valueDefaults;}}_.call(this,C);if(!C.aControlsByParameters){C.aControlsByParameters={};}C.aControlsByParameters[k]=[];var m=function(E){j(this);}.bind(this);for(var i=0;i<o.valueTypes.length;i++){var T=o.valueTypes[i];var n=this.getBaseType();var p;if(!T){continue;}if(!C.aControlsByParameters[k][i]){if(o.createControl){if(!this._oModel){m=function(E){var z=E.getParameter("path");var A=z.split("/");var s=A[0]||A[1];if(this._mChangeHandler&&this._mChangeHandler[s]){this._mChangeHandler[s](this);}}.bind(this);this._oModel=new J();this._oModel.attachPropertyChange({},m,this);this._mChangeHandler={};}var M=this._oModel.getData();M[s]={value0:v&&v.values[0],value1:v&&v.values[1]};this._mChangeHandler[s]=j;if(T!==O.ValueType.Self){t=o._createLocalType(T,t);}var q=o.createControl(t,"internal>/"+s+"/value"+i,i,s+"-"+i);q.setModel(this._oModel,"internal");C.aControlsByParameters[k].push(q);}else if(T===O.ValueType.Self){if(v&&v.values[i]){p=b.typeToUniversalDate(v.values[i],t,n);p=b.utcToLocal(p);}var r=t.getFormatOptions();var u;if(n===B.DateTime){u=g;}else{u=f;}var w=new u(s+"-"+i,{dateValue:p,displayFormat:r.style||r.pattern,displayFormatType:r.calendarType,change:m});C.aControlsByParameters[k].push(w);}else if(typeof T==="object"){t=o._createLocalType(o.valueTypes[i],t);var x=t.formatValue(v&&v.values[i],"string");var y=new I(s+"-"+i,{value:x,change:m});C.aControlsByParameters[k].push(y);}}}return C.aControlsByParameters[k];};h.prototype.validateValueHelpUI=function(C){var k=this.getKey();var o=this.getOperator();var t=this.getType();var j;var v=true;var s=e.None;var m;var i=0;try{j=this.getValueHelpOutput(C);for(i=0;i<j.values.length;i++){var n=j.values[i];if(n===undefined||n===null){v=false;}}o.validate(j.values,t);}catch(E){v=false;s=e.Error;m=E.message;if(E&&!(E instanceof P)&&!(E instanceof V)){throw E;}}if(!o.createControl){for(i=0;i<C.aControlsByParameters[k].length;i++){var p=C.aControlsByParameters[k][i];if(p.setValueState){p.setValueState(s);p.setValueStateText(m);}}}return v;};h.prototype.getValueHelpOutput=function(C){var k=this.getKey();var r={operator:k,values:[]};var o=this.getOperator();var t=this.getType();var s=this.getBaseType();var j=C.getId();for(var i=0;i<o.valueTypes.length;i++){if(!o.valueTypes[i]){continue;}var m=C.aControlsByParameters[k][i];if(m){var v;if(o.createControl){v=this._oModel?this._oModel.getProperty("/"+j+"/value"+i):null;}else if(o.valueTypes[i]===O.ValueType.Self){if(!m.isValidValue()){throw new P();}v=m.getDateValue();if(v){v=b.localToUtc(v);v=b.universalDateToType(v,t,s);}}else{v=m.getValue();t=o._createLocalType(o.valueTypes[i],t);v=t.parseValue(v,"string");}r.values.push(v);}}return r;};h.prototype.getGroupHeader=function(){var o=this.getOperator();if(o.group&&o.group.text){return o.group.text;}return D.prototype.getGroupHeader.apply(this,arguments);};h.prototype.getGroup=function(){var o=this.getOperator();if(o.group){return o.group.id;}return D.prototype.getGroup.apply(this,arguments);};h.prototype.toDates=function(v){var o=this.getOperator();var t=this.getType();var s=this.getBaseType();var r;var i=0;if(o.isA("sap.ui.mdc.condition.RangeOperator")){r=o._getRange(v&&v.values,t,s);for(i=0;i<r.length;i++){r[i]=b.typeToUniversalDate(r[i],t,s);r[i]=b.utcToLocal(r[i]);}}else if(o.valueTypes[0]===O.ValueType.Self){r=v.values;for(i=0;i<r.length;i++){if(r[i]){r[i]=b.typeToUniversalDate(r[i],t,s);r[i]=b.utcToLocal(r[i]);}}if(r.length===1){r.push(r[0]);}}else if([O.ValueType.Self,O.ValueType.Static].indexOf(o.valueTypes[0])===-1){throw new Error("Cannot convert to date, use RangeOperator");}return r;};h.prototype.format=function(v){var o=this.getOperator();var t=this.getType();return o.format(v,t,F.Value);};h.prototype.parse=function(v){var o=this.getOperator();var t=this.getType();if(v&&o.parse(v)){var r={};r.operator=this.getKey();r.values=o.parse(v,t,F.Value);return r;}};h.prototype.enhanceFormattedValue=function(s,A){return false;};function _(C){var k=this.getKey();if(C&&C.aControlsByParameters&&C.aControlsByParameters[k]){for(var i=0;i<C.aControlsByParameters[k].length;i++){var u=C.aControlsByParameters[k][i];if(!u.bIsDestroyed){u.destroy();}}delete C.aControlsByParameters[k];}}return h;});
