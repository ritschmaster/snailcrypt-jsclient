/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/core/Core","sap/ui/mdc/Control","./chart/ChartSettings","sap/ui/mdc/util/loadModules","./ChartRenderer","sap/ui/mdc/library","sap/m/Text","sap/m/VBox","sap/base/Log","./chart/ChartToolbar","./chart/PropertyHelper","sap/ui/mdc/mixin/FilterIntegrationMixin","sap/ui/model/base/ManagedObjectModel","sap/ui/mdc/p13n/subcontroller/ChartItemController","sap/ui/mdc/p13n/subcontroller/FilterController","sap/ui/mdc/p13n/subcontroller/SortController","sap/ui/mdc/p13n/subcontroller/ChartTypeController","sap/ui/base/ManagedObjectObserver","sap/ui/mdc/chart/DrillBreadcrumbs","sap/ui/mdc/actiontoolbar/ActionToolbarAction","sap/ui/thirdparty/jquery"],function(C,a,b,l,c,M,T,V,L,d,P,F,f,g,h,S,i,j,B,A,q){"use strict";var D;var k=a.extend("sap.ui.mdc.Chart",{metadata:{library:"sap.ui.mdc",designtime:"sap/ui/mdc/designtime/chart/Chart.designtime",interfaces:["sap.ui.mdc.IFilterSource","sap.ui.mdc.IxState"],defaultAggregation:"items",properties:{width:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:"100%",invalidate:true},height:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:"100%",invalidate:true},delegate:{type:"object",group:"Data",defaultValue:{name:"sap/ui/mdc/ChartDelegate"}},header:{type:"string",group:"Misc",defaultValue:null},noDataText:{type:"string",defaultValue:"No data"},p13nMode:{type:"sap.ui.mdc.ChartP13nMode[]",defaultValue:[]},legendVisible:{type:"boolean",group:"Misc",defaultValue:true},ignoreToolbarActions:{type:"sap.ui.mdc.ChartToolbarActionType[]",defaultValue:[]},minWidth:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:"240px",invalidate:true},minHeight:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:"400px",invalidate:true},sortConditions:{type:"object"},filterConditions:{type:"object",defaultValue:{}},showChartTooltip:{type:"boolean",group:"Misc",defaultValue:true},autoBindOnInit:{type:"boolean",group:"Misc",defaultValue:true},chartType:{type:"string",group:"Misc",defaultValue:"column"},showSelectionDetails:{type:"boolean",group:"Misc",defaultValue:true},propertyInfo:{type:"object",defaultValue:[]}},aggregations:{items:{type:"sap.ui.mdc.chart.Item",multiple:true},actions:{type:"sap.ui.core.Control",multiple:true,forwarding:{getter:"_getToolbar",aggregation:"actions"}},_toolbar:{type:"sap.ui.mdc.chart.ChartToolbar",multiple:false,visibility:"hidden"},_breadcrumbs:{type:"sap.m.Breadcrumbs",multiple:false,visibility:"hidden"},_innerChart:{type:"sap.ui.core.Control",multiple:false,visibility:"hidden"},selectionDetailsActions:{type:"sap.ui.mdc.chart.SelectionDetailsActions",multiple:false},variant:{type:"sap.ui.fl.variants.VariantManagement",multiple:false}},associations:{filter:{type:"sap.ui.mdc.IFilter",multiple:false}},events:{selectionDetailsActionPressed:{parameters:{action:{type:"sap.ui.core.Item"},itemContexts:{type:"sap.ui.model.Context"},level:{type:"sap.m.SelectionDetailsActionLevel"}}},innerChartLoadedData:{parameters:{innerChart:{type:"sap.ui.core.Control"}}}}},renderer:c});F.call(k.prototype);k.prototype.init=function(){this._oManagedObjectModel=new f(this);this.setModel(this._oManagedObjectModel,"$mdcChart");this._bNewP13n=true;a.prototype.init.apply(this,arguments);this._setupPropertyInfoStore("propertyInfo");this._setPropertyHelperClass(P);};k.prototype.setP13nMode=function(m){var s=null;if(m&&m.length>=1){s=[];var K=m.reduce(function(e,n,I){e[n]=true;return e;},{});if(K.Item){s.push("Item");}if(K.Sort){s.push("Sort");}if(K.Filter){s.push("Filter");}if(K.Type){this._typeBtnActive=true;s.push("Type");}else{this._typeBtnActive=false;}}else{s=m;}this.setProperty("p13nMode",s,true);this._updateAdaptation(this.getP13nMode());return this;};k.prototype._updateAdaptation=function(m){var r={controller:{}};var R={Item:g,Sort:S,Filter:h,Type:i};if(m&&m.length>0){m.forEach(function(s){var K=s;var o=R[s];if(o){r.controller[K]=o;}});this.getEngine().registerAdaptation(this,r);}};k.prototype.isFilteringEnabled=function(){return this.getP13nMode().indexOf("Filter")>-1;};k.prototype.setFilterConditions=function(m){this.setProperty("filterConditions",m,true);var p=this.getInbuiltFilter();if(p){p.setFilterConditions(m);}return this;};k.prototype.getConditions=function(){return this.getInbuiltFilter()?this.getInbuiltFilter().getConditions():[];};k.prototype._registerInnerFilter=function(o){o.attachSearch(function(){this._rebind();},this);};k.prototype.applySettings=function(s,o){this._setPropertyHelperClass(P);a.prototype.applySettings.apply(this,arguments);this.initializedPromise=new Promise(function(r,e){this._fnResolveInitialized=r;this._fnRejectInitialized=e;}.bind(this));this.innerChartBoundPromise=new Promise(function(r,e){this._fnResolveInnerChartBound=r;this._fnRejectInnerChartBound=e;}.bind(this));var p=this._loadDelegate().then(function(e){return e;}).then(function(e){return this.initControlDelegate(e);}.bind(this)).catch(function(e){this._fnRejectInitialized(e);}.bind(this));var I=[p];if(this.isFilteringEnabled()){I.push(this.retrieveInbuiltFilter());}Promise.all(I).then(function(){this._initInnerControls();}.bind(this));};k.prototype._initInnerControls=function(){this.getControlDelegate().initializeInnerChart(this).then(function(I){this.setBusyIndicatorDelay(0);this.getControlDelegate().createInitialChartContent(this);this._renderOverlay(true);if(this.getAutoBindOnInit()){this.setBusy(true);this._createContentfromPropertyInfos(I);}this.setAggregation("_innerChart",I);this._bInnerChartReady=true;this._fnResolveInitialized();this.invalidate();}.bind(this)).catch(function(e){this._fnRejectInitialized(e);}.bind(this));this._getToolbar().createToolbarContent(this);};k.prototype._createContentfromPropertyInfos=function(I){this.getControlDelegate().checkAndUpdateMDCItems(this).then(function(){this.getControlDelegate().createInnerChartContent(this,this._innerChartDataLoadComplete.bind(this)).then(function(){this._createBreadcrumbs();this._oObserver=new j(this._propagateItemChangeToInnerChart.bind(this));this._oObserver.observe(this,{aggregations:["items"]});this._propagatePropertiesToInnerChart();this._fnResolveInnerChartBound();}.bind(this));}.bind(this));};k.prototype.setHeight=function(H){try{this.getControlDelegate().adjustChartHeight(this);}catch(e){}this.setProperty("height",H);return this;};k.prototype._createBreadcrumbs=function(){this._oBreadcrumbs=new B(this.getId()+"--breadcrumbs");this._oBreadcrumbs.updateDrillBreadcrumbs(this,this.getControlDelegate().getDrillableItems(this));this.setAggregation("_breadcrumbs",this._oBreadcrumbs);this._oBreadcrumbs.addEventDelegate({onAfterRendering:function(){this.getControlDelegate().adjustChartHeight(this);}.bind(this)});};k.prototype._loadDelegate=function(){return new Promise(function(r){var n=[this.getDelegate().name];function o(e){r(e);}sap.ui.require(n,o);}.bind(this));};k.prototype.isFilteringEnabled=function(){return this.getP13nMode().indexOf("Filter")>-1;};k.prototype.getAdaptationUI=function(){return this.getControlDelegate().getAdaptionUI(this);};k.prototype._propagateItemChangeToInnerChart=function(o){if(this._bIsDestroyed){return;}this.setBusy(true);switch(o.mutation){case"insert":var I;if(o.child&&o.child.getType()){I=this.getItems().filter(function(e){return e.getType()===o.child.getType();}).indexOf(o.child);}else{I=this.getItems().indexOf(o.child);}this.getControlDelegate().insertItemToInnerChart(this,o.child,I);break;case"remove":this.getControlDelegate().removeItemFromInnerChart(this,o.child);break;default:L.error("Unknown mutation on MDC Chart Item Aggregation. This will not sync to inner chart!");break;}this._rebind();this._oBreadcrumbs.updateDrillBreadcrumbs(this,this.getControlDelegate().getDrillableItems(this));};k.prototype._rebind=function(){if(!this._bInnerChartReady){this.initialized().then(function(){this._rebind();}.bind(this));return;}this.setBusy(true);if(!this.getControlDelegate().getInnerChartBound(this)){this._createContentfromPropertyInfos();return;}var o=this.getControlDelegate()._getBindingInfo(this);this.getControlDelegate().updateBindingInfo(this,o);this.getControlDelegate().rebind(this,o);};k.prototype._getToolbar=function(){if(this.getAggregation("_toolbar")){return this.getAggregation("_toolbar");}else{var t=new d(this.getId()+"--toolbar",{design:"Transparent"});this.setAggregation("_toolbar",t);return t;}};k.prototype._updateToolbar=function(){if(this.getAggregation("_toolbar")){this.getAggregation("_toolbar").updateToolbar(this);}else{L.warning("Trying to uipdate Chart Toolbar, but toolbar is not yet initialized. This will not work!");}};k.prototype._getInnerChart=function(){if(this._bInnerChartReady){return this.getControlDelegate().getInnerChart(this);}else{L.error("Trying to acces inner chart while inner chart is not yet initialized!");}};k.prototype._addItems=function(){};k.prototype.getCollectionModel=function(){var o=this.getBindingInfo("data");return o?this.getModel(o.model):null;};k.prototype.initialized=function(){return this.initializedPromise;};k.prototype.innerChartBound=function(){return this.innerChartBoundPromise;};k.prototype.zoomIn=function(v){if(!v){v=10;}this.getControlDelegate().zoomIn(this,v);};k.prototype.zoomOut=function(v){if(v){v=10;}this.getControlDelegate().zoomOut(this,v);};k.prototype.getZoomState=function(){return this.getControlDelegate().getZoomState(this);};k.prototype.getSelectionHandler=function(){return this.getControlDelegate().getInnerChartSelectionHandler(this);};k.prototype.getChartTypeLayoutConfig=function(){return this.getControlDelegate().getChartTypeLayoutConfig();};k.prototype.getAllowedRolesForKinds=function(){return this.getControlDelegate().getAllowedRolesForKinds();};k.prototype.setLegendVisible=function(v){this.setProperty("legendVisible",v);try{this.getControlDelegate().setLegendVisible(this,v);}catch(e){L.info("Trying to set legend visiblity for Chart before delegate was initialized");}return this;};k.prototype.setShowChartTooltip=function(v){this.setProperty("showChartTooltip",v);try{this.getControlDelegate().setChartTooltipVisibility(this,v);}catch(e){L.info("Trying to set tooltip visibility before delegate was initialized");}return this;};k.prototype.destroy=function(){this._bIsDestroyed=true;a.prototype.destroy.apply(this,arguments);};k.prototype._showDrillDown=function(o){if(!this.oDrillPopover){if(D){this.oDrillPopover=D.createDrillDownPopover(this);this.oDrillPopover.attachAfterClose(function(){delete this.oDrillPopover;}.bind(this));return D.showDrillDownPopover(this,o);}return new Promise(function(r,e){sap.ui.require(["sap/ui/mdc/chart/DrillStackHandler"],function(m){D=m;this.oDrillPopover=D.createDrillDownPopover(this);this.oDrillPopover.attachAfterClose(function(){delete this.oDrillPopover;}.bind(this));D.showDrillDownPopover(this,o).then(function(n){r(n);});}.bind(this));}.bind(this));}};k.prototype._propagatePropertiesToInnerChart=function(){this.setLegendVisible(this.getLegendVisible());this.setShowChartTooltip(this.getShowChartTooltip());this.setChartType(this.getChartType());};k.prototype.getChartTypeInfo=function(){var I;try{I=this.getControlDelegate().getChartTypeInfo(this);}catch(e){if(!I){I={icon:"sap-icon://vertical-bar-chart",text:"Selected Chart Type: Bar Chart"};}}return I;};k.prototype.getAvailableChartTypes=function(){return this.getControlDelegate().getAvailableChartTypes(this);};k.prototype.setChartType=function(s){this.setProperty("chartType",s);try{this.getControlDelegate().setChartType(this,s);}catch(e){L.info("Trying to set chart type for Chart before delegate was initialized");}return this;};k.prototype.getManagedObjectModel=function(){return this._oManagedObjectModel;};k.prototype._innerChartDataLoadComplete=function(m){this.setBusy(false);this._renderOverlay(false);this.getControlDelegate().requestToolbarUpdate(this);this.fireEvent("innerChartLoadedData ",{innerChart:this.getControlDelegate().getInnerChart(this)});};k.prototype.getCurrentState=function(){var s={};var p=this.getP13nMode();if(p){if(p.indexOf("Item")>-1){s.items=this._getVisibleProperties();}if(p.indexOf("Sort")>-1){s.sorters=this._getSortedProperties();}if(p.indexOf("Filter")>-1){s.filter=this.getFilterConditions();}if(p.indexOf("Type")>-1){s.chartType=this.getChartType();}}return s;};k.prototype._getVisibleProperties=function(){var p=[];this.getItems().forEach(function(I){p.push({name:I.getName(),role:I.getRole()});});return p;};k.prototype._getSortedProperties=function(){return this.getSortConditions()?this.getSortConditions().sorters:[];};k.prototype._getPropertyData=function(){if(!this.aFetchedProperties){this.aFetchedProperties=this.getControlDelegate().fetchProperties(this);}else{return this.aFetchedProperties;}};k.prototype._getTypeBtnActive=function(){return!!this._typeBtnActive;};k.prototype.setNoDataText=function(t){this.setProperty("noDataText",t);try{this.getControlDelegate().setNoDataText(this,t);}catch(e){}return this;};k.prototype._onFiltersChanged=function(e){if(this._bInnerChartReady&&this.getControlDelegate()&&this.getControlDelegate().getInnerChartBound(this)&&e.getParameter("conditionsBased")){this._renderOverlay(true);}};k.prototype.setVariant=function(o){this.setAggregation("variant",o);if(this.getAggregation("_toolbar")){this.getAggregation("_toolbar").addVariantManagement(o);}return this;};k.prototype._renderOverlay=function(s){if(this.getControlDelegate().getInnerChart(this)){var $=this.getControlDelegate().getInnerChart(this).$(),e=$.find(".sapUiMdcChartOverlay");if(s&&e.length===0){e=q("<div>").addClass("sapUiOverlay sapUiMdcChartOverlay").css("z-index","1");$.append(e);}else if(!s){e.remove();}}};k.prototype.addAction=function(o){if(o.getMetadata().getName()!=="sap.ui.mdc.actiontoolbar.ActionToolbarAction"){o=new A(o.getId()+"-action",{action:o});}return a.prototype.addAggregation.apply(this,["actions",o]);};return k;});
