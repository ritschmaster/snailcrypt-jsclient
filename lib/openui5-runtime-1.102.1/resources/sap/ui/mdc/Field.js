/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['sap/ui/base/ManagedObjectObserver','sap/ui/mdc/field/FieldBase','sap/ui/mdc/field/FieldBaseRenderer','sap/ui/mdc/enum/FieldDisplay','sap/ui/mdc/condition/Condition','sap/ui/mdc/condition/FilterOperatorUtil','sap/ui/mdc/enum/BaseType','sap/ui/mdc/enum/ConditionValidated','sap/base/util/deepEqual','sap/base/util/merge','sap/ui/model/BindingMode','sap/ui/model/Context'],function(M,F,a,b,C,c,B,d,e,m,f,g){"use strict";var h=F.extend("sap.ui.mdc.Field",{metadata:{library:"sap.ui.mdc",designtime:"sap/ui/mdc/designtime/field/Field.designtime",properties:{value:{type:"any",defaultValue:null},additionalValue:{type:"any",defaultValue:null}},events:{change:{parameters:{value:{type:"string"},valid:{type:"boolean"},promise:{type:"Promise"}}}},defaultProperty:"value"},renderer:a});h.prototype.init=function(){this._vValue=null;this._vAdditionalValue=null;F.prototype.init.apply(this,arguments);this.setMaxConditions(1);this._oObserver.observe(this,{properties:["value","additionalValue"]});};h.prototype.exit=function(){F.prototype.exit.apply(this,arguments);if(this._iConditionUpdateTimer){clearTimeout(this._iConditionUpdateTimer);delete this._iConditionUpdateTimer;delete this._bPendingConditionUpdate;}this._oBindingContext=undefined;};h.prototype.bindProperty=function(N,s){if(N==="value"&&!s.formatter){s.targetType="raw";var D=this._oContentFactory.getDataType();if(s.type&&(!D||D.getMetadata().getName()!==s.type.getMetadata().getName()||!e(D.getFormatOptions(),s.type.getFormatOptions())||!e(D.getConstraints(),s.type.getConstraints())||D._bCreatedByOperator!==s.type._bCreatedByOperator)){this._oContentFactory.setDataType(s.type);if(s.type.isA("sap.ui.model.CompositeType")&&s.parts){var t=[];for(var i=0;i<s.parts.length;i++){t.push(s.parts[i].type);}this._oContentFactory.setCompositeTypes(t);}this._oContentFactory.updateConditionType();this.invalidate();}}F.prototype.bindProperty.apply(this,arguments);};h.prototype._handleModelContextChange=function(E){F.prototype._handleModelContextChange.apply(this,arguments);var i=this.getBinding("value");if(i){var s=i.isA("sap.ui.model.CompositeBinding")?i.getBindings()[0].getContext():i.getContext();if(g.hasChanged(this._oBindingContext,s)){this._oBindingContext=s;this._oContentFactory.updateConditionType();if(this._bParseError||this.getFieldHelp()){if(this._oManagedObjectModel){this._oManagedObjectModel.checkUpdate(true,true);}this._bParseError=false;}}if(!this._oContentFactory.getDataType()){this._oContentFactory.setDataType(i.getType());this.invalidate();}}};h.prototype._initDataType=function(){F.prototype._initDataType.apply(this,arguments);var i=this.getBinding("value");if(i){this._oContentFactory.setDataType(i.getType());}};h.prototype.setProperty=function(P,v,s){if(P==="value"&&this._bParseError&&e(this.getValue(),this.validateProperty(P,v))){if(this._oManagedObjectModel){this._oManagedObjectModel.checkUpdate(true,true);}this._bParseError=false;}return F.prototype.setProperty.apply(this,arguments);};h.prototype.setMaxConditions=function(i){if(i!==1){throw new Error("Only one condition allowed for Field "+this);}return this.setProperty("maxConditions",i,true);};h.prototype._observeChanges=function(i){F.prototype._observeChanges.apply(this,arguments);if(i.name==="value"){var v=n.call(this,i.current,i.old);if(this._vAdditionalValue!==null&&r.call(this)&&!o.call(this,v,this._vValue,true)){this._vAdditionalValue=this.getAdditionalValue();}this._vValue=v;p.call(this,i.current);k.call(this);}if(i.name==="additionalValue"){this._vAdditionalValue=i.current;k.call(this);}if(i.name==="conditions"){if(this._getContent().length<=1){q.call(this,i.current);}}};function _(){return this._vValue;}function j(){return this._vAdditionalValue;}function k(){if(!this.bDelegateInitialized){this.awaitControlDelegate().then(function(){if(!this.bIsDestroyed){k.call(this);}}.bind(this));return;}if(this.getDisplay()===b.Value){l.call(this,_.call(this),j.call(this));}else if(!this._iConditionUpdateTimer){this._iConditionUpdateTimer=setTimeout(function(){l.call(this,_.call(this),j.call(this));this._iConditionUpdateTimer=undefined;this._bPendingConditionUpdate=false;}.bind(this),0);this._bPendingConditionUpdate=true;}}function l(v,A){var i=this.getConditions();if(this._checkValueInitial(v)&&!A){if(i.length>0){this.setConditions([]);}}else{var O=i[0]&&i[0].values[0];var s=i[0]&&i[0].values[1]?i[0].values[1]:null;if(!i[0]||i[0].operator!=="EQ"||!o.call(this,O,v)||s!==A){var t=C.createItemCondition(v,A);t.validated=d.Validated;this.setConditions([t]);}}}function n(v,O){var D=this._oContentFactory.getDataType()?this._oContentFactory.getDataType().getMetadata().getName():this.getDataType();if(v&&O&&(D==="sap.ui.model.odata.type.Unit"||D==="sap.ui.model.odata.type.Currency")&&!v[2]&&O[2]!==undefined){v=m([],v);v[2]=O[2];if(this._bPendingChange){var i=this.getConditions()[0];if(i){if(v[0]===O[0]&&v[0]!==i.values[0][0]){v[0]=i.values[0][0];}if(v[1]===O[1]&&v[1]!==i.values[0][1]){v[1]=i.values[0][1];}}}}return v;}function o(v,V,u){var E=v===V;var D=this._oContentFactory.getDataType()?this._oContentFactory.getDataType().getMetadata().getName():this.getDataType();if(!E&&this.getTypeUtil().getBaseType(D)===B.Unit&&Array.isArray(v)&&Array.isArray(V)){var N=v[0];var U=v[1];var i=v.length>=3?v[2]:null;var s=V[0];var t=V[1];var w=V.length>=3?V[2]:null;if(N===s&&U===t&&(((this._bUnitSet||u)&&(!i||!w))||e(i,w))){E=true;}if((i||w)&&!u){this._bUnitSet=true;}}return E;}function p(v){if(!this._bTypeInitialized){if(!this.bDelegateInitialized){this.awaitControlDelegate().then(function(){if(!this.bIsDestroyed){p.call(this,v);}}.bind(this));return;}var i=this.getBinding("value");var D=i?i.getType():this._oContentFactory.getDataType();this._oTypeInitialization=this.getControlDelegate().initializeTypeFromBinding(this.getPayload(),D,v);this._bTypeInitialized=this._oTypeInitialization.bTypeInitialized;if(this._bTypeInitialized&&this._oContentFactory.getUnitOriginalType()){this.getControlDelegate().initializeInternalUnitType(this.getPayload(),this._oContentFactory.getDataType(),this._oTypeInitialization);this.getControlDelegate().initializeInternalUnitType(this.getPayload(),this._oContentFactory.getUnitType(),this._oTypeInitialization);}}}h.prototype._fireChange=function(i,v,w,P){var V;if(i){if(v){V=this._getResultForPromise(i);}else{V=w;}}if(this._getContent().length>1){if(i){q.call(this,this.getConditions());}else if(P){P=P.then(function(R){q.call(this,this.getConditions());return R;}.bind(this));}}this.fireChange({value:V,valid:v,promise:P});};h.prototype._getResultForPromise=function(i){var v;if(i.length===0&&this._oContentFactory.getDataType()){v=this._oContentFactory.getDataType().parseValue("","string",[]);}else if(i.length===1){v=i[0].values[0];}return v;};function q(i){if(!this.bDelegateInitialized){this.awaitControlDelegate().then(function(){if(!this.bIsDestroyed){q.call(this,i);}}.bind(this));return;}var v=null;var A=null;var O=this.getValue();var s=this.getAdditionalValue();if(i.length===0&&O===null&&s===null){return;}v=this._getResultForPromise(i);if(i.length===0&&!s){A=s;}else if(i.length===1&&i[0].values.length>1){A=i[0].values[1];}this._vValue=v;this._vAdditionalValue=A;if(!o.call(this,v,O,true)){this.setProperty("value",v,true);}if(A!==s&&!r.call(this)){this.setProperty("additionalValue",A,true);}}h.prototype._getOperators=function(){return["EQ"];};function r(){var i=this.getBinding("additionalValue");if(i&&i.getBindingMode()===f.OneWay){return true;}return false;}h.prototype._checkCreateInternalContent=function(){if(!this.bIsDestroyed&&this._oContentFactory.getDataType()&&!this._isPropertyInitial("editMode")&&!this._isPropertyInitial("multipleLines")){F.prototype._checkCreateInternalContent.apply(this,arguments);}};return h;});
