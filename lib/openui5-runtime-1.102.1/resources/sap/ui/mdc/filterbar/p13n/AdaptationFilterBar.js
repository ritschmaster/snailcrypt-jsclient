/*
 * ! OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/mdc/filterbar/p13n/GroupContainer","sap/ui/mdc/filterbar/p13n/FilterColumnLayout","sap/ui/mdc/filterbar/p13n/FilterGroupLayout","sap/ui/mdc/filterbar/p13n/TableContainer","sap/ui/mdc/filterbar/FilterBarBase","sap/ui/mdc/filterbar/FilterBarBaseRenderer","sap/base/util/merge","sap/base/util/UriParameters","sap/ui/core/Core","sap/ui/mdc/enum/PersistenceMode"],function(G,F,a,T,b,c,m,S,C,P){"use strict";var A=b.extend("sap.ui.mdc.filterbar.p13n.AdaptationFilterBar",{metadata:{library:"sap.ui.mdc",associations:{adaptationControl:{type:"sap.ui.mdc.Control",multiple:false}},events:{change:{}}},renderer:c});A.prototype.init=function(){b.prototype.init.apply(this,arguments);this.addStyleClass("sapUIAdaptationFilterBar");this._bPersistValues=true;this.getEngine().defaultProviderRegistry.attach(this,P.Transient);this._fnResolveAdaptationControlPromise=null;this._oAdaptationControlPromise=new Promise(function(r,d){this._fnResolveAdaptationControlPromise=r;}.bind(this));};A.prototype.applySettings=function(){b.prototype._applySettings.apply(this,arguments);this._waitForAdaptControlAndPropertyHelper().then(function(){this._initControlDelegate();}.bind(this));};A.prototype._getPropertyByName=function(n){var p=this.getPropertyHelper();if(p){var o=p.getProperties().find(function(d){return d.path===n;});if(!o){o=p.getPropertyMap()[n]||null;}return o;}};A.prototype._waitForAdaptControlAndPropertyHelper=function(){return this._oAdaptationControlPromise.then(function(){return this._getAdaptationControlInstance().awaitPropertyHelper().then(function(p){this._oPropertyHelper=p;}.bind(this));}.bind(this));};A.prototype._initControlDelegate=function(){return this.initControlDelegate().then(function(){if(!this._bIsBeingDestroyed){this._applyInitialFilterConditions();}}.bind(this));};A.prototype.getControlDelegate=function(){return this._getAdaptationControlInstance().getControlDelegate();};A.prototype.initControlDelegate=function(){return this._oAdaptationControlPromise.then(function(){return this._getAdaptationControlInstance().initControlDelegate();}.bind(this));};A.prototype.initPropertyHelper=function(){return this._oAdaptationControlPromise.then(function(){return this._getAdaptationControlInstance().initPropertyHelper();}.bind(this));};A.prototype.getTypeUtil=function(){if(!this._getAdaptationControlInstance()){throw new Error("No adaptation control assigned yet.");}return this._getAdaptationControlInstance().getTypeUtil();};A.prototype.setMessageStrip=function(s){this._oFilterBarLayout.setMessageStrip(s);};A.prototype.setLiveMode=function(l,s){b.prototype.setLiveMode.apply(this,arguments);this._oConditionModel.attachPropertyChange(function(e){var k=e.getParameter("path").substring(12);if(this.oAdaptationData){var i=this.oAdaptationData.items;var I=i.find(function(o){return o.name==k;});if(I){I.active=this._getConditionModel().getConditions(k).length>0?true:false;}}}.bind(this));return this;};A.prototype._retrieveMetadata=function(){return this._oAdaptationControlPromise.then(function(){return this._getAdaptationControlInstance().awaitPropertyHelper().then(function(p){this._oMetadataAppliedPromise=Promise.resolve();if(!this._getAdaptationControlInstance().isPropertyHelperFinal()){return this.finalizePropertyHelper();}return b.prototype._retrieveMetadata.apply(this,arguments);}.bind(this));}.bind(this));};A.prototype.createConditionChanges=function(){return Promise.all([this._oAdaptationControlPromise,this._getAdaptationControlInstance().awaitControlDelegate()]).then(function(){var d=this._getModelConditions(this._getConditionModel(),false,true);if(this._bPersistValues){return this.getEngine().createChanges({control:this._getAdaptationControlInstance(),key:"Filter",state:d,suppressAppliance:true});}else{this._getAdaptationControlInstance()._setXConditions(d,true);return Promise.resolve(null);}}.bind(this));};A.prototype.setP13nData=function(p){this.oAdaptationData=p;this._oFilterBarLayout.update(p);};A.prototype.getP13nData=function(){return this.oAdaptationData;};A.prototype._handleFilterItemSubmit=function(){return;};A.prototype._getWaitForChangesPromise=function(){return this.getEngine().waitForChanges(this._getAdaptationControlInstance());};A.prototype.applyConditionsAfterChangesApplied=function(o){b.prototype.applyConditionsAfterChangesApplied.apply(this,arguments);if(o===this._getAdaptationControlInstance()){this.triggerSearch();}};A.prototype.createFilterFields=function(){return this.initialized().then(function(){var d=this._bPersistValues?this._getAdaptationControlInstance().getFilterConditions():this._getAdaptationControlInstance()._getXConditions();this.setFilterConditions(d);this._setXConditions(d,true);if(this._bFilterFieldsCreated){this._oFilterBarLayout.setP13nData(this.oAdaptationData);return this;}var o=this._getAdaptationControlInstance();var D=o.getControlDelegate();var f=this._checkAdvancedParent(o)?D:D.getFilterDelegate();this._mOriginalsForClone={};var e=[];this.oAdaptationData.items.forEach(function(i,I){var g;g=this._checkExisting(i,f);g.then(function(h){var j;if(this._checkAdvancedParent(o)){if(h._bTemporaryOriginal){delete g._bTemporaryOriginal;this._mOriginalsForClone[h.getFieldPath()]=h;}j=h.clone();}else{j=h;}i.filterfield=j;}.bind(this));e.push(g);}.bind(this));return Promise.all(e).then(function(){this.oAdaptationData.items.forEach(function(i){this.addAggregation("filterItems",i.filterfield);delete i.filterfield;}.bind(this));this._oFilterBarLayout.setP13nData(this.oAdaptationData);this._bFilterFieldsCreated=true;return this;}.bind(this));}.bind(this));};A.prototype._checkExisting=function(i,f){var o;var d=this._getAdaptationControlInstance();var e=this._checkAdvancedParent(d)?d.getFilterItems():[];var E=e.reduce(function(M,g){M[g.getFieldPath()]=g;return M;},{});if(E[i.name]){o=Promise.resolve(E[i.name]);}else{o=f.addItem(i.name,this._getAdaptationControlInstance());o=o.then(function(g){if(!g){throw new Error("No FilterField could be created for property: '"+i.name+"'.");}g._bTemporaryOriginal=true;return g;});}return o;};A.prototype.executeRemoves=function(){var e=this._oFilterBarLayout.getInner().getSelectedFields();var o=[];Object.keys(this._mOriginalsForClone).forEach(function(k){var d=this._getAdaptationControlInstance().getControlDelegate();if(e.indexOf(k)<0){var r=d.removeItem.call(d,k,this._getAdaptationControlInstance()).then(function(f){if(f&&this._mOriginalsForClone[k]){this._mOriginalsForClone[k].destroy();delete this._mOriginalsForClone[k];}}.bind(this));o.push(r);}}.bind(this));return Promise.all(o);};A.prototype._checkAdvancedParent=function(o){if(!o.isA("sap.ui.mdc.IFilterSource")&&!o.isA("sap.ui.mdc.IFilter")){throw new Error("The 'adaptationControl' needs to implement the IFilterSource or IFilter interface");}return o.isA("sap.ui.mdc.IFilter");};A.prototype.setAdaptationControl=function(o,s){if(this._fnResolveAdaptationControlPromise){this._fnResolveAdaptationControlPromise();this._fnResolveAdaptationControlPromise=null;}this.setAssociation("adaptationControl",o,s);var u=new S(window.location.search).getAll("sap-ui-xx-filterQueryPanel")[0]==="true";this._cLayoutItem=u||this._checkAdvancedParent(o)?a:F;this._oFilterBarLayout=this._checkAdvancedParent(o)?new G():new T();this._oFilterBarLayout.getInner().setParent(this);this.setAggregation("layout",this._oFilterBarLayout,true);if(this._oFilterBarLayout.getInner().attachChange){this._oFilterBarLayout.getInner().attachChange(function(e){if(e.getParameter("reason")==="Remove"){var i=e.getParameter("item");var d=this._bPersistValues?m({},this._getAdaptationControlInstance().getFilterConditions()):this._getAdaptationControlInstance()._getXConditions();d[i.name]=[];this._setXConditions(d,true);}this.fireChange();}.bind(this));}return this;};A.prototype._getAdaptationControlInstance=function(){var s=this.getAdaptationControl();return s&&C.byId(s);};A.prototype.exit=function(){this.getEngine().defaultProviderRegistry.detach(this);b.prototype.exit.apply(this,arguments);for(var k in this._mOriginalsForClone){this._mOriginalsForClone[k].destroy();}this._mOriginalsForClone=null;this.oAdaptationData=null;this._fnResolveAdaptationControlPromise=null;this._oAdaptationControlPromise=null;};return A;});
