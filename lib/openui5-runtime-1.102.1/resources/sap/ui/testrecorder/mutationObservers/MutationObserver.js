/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/base/ManagedObject","sap/ui/testrecorder/Constants","sap/base/util/restricted/_debounce"],function($,M,c,_){"use strict";var a=M.extend("sap.ui.testrecorder.mutationObservers.MutationObserver",{metadata:{library:"sap.ui.testrecorder"},constructor:function(C){M.call(this);this._fnObservationCb=C;this._observer=new window.MutationObserver(this._onObservation.bind(this));},start:function(t){this._oTarget=t||document.body;this._observer.observe(this._oTarget,this._getOptions());},stop:function(){this._observer.disconnect();},_getOptions:function(){return{};},_onObservation:function(m){return _(function(){this._isValidMutation(m).then(function(i){if(i){this._fnObservationCb();}}.bind(this)).catch(function(e){throw new Error("Erro in mutation observer: "+e);});}.bind(this),100)();},_isValidMutation:function(m){return Promise.all(m.map(function(o){return new Promise(function(r,b){if(this._isRecorderElement(o)){r(false);}else{this._hasHiddenElements(o).then(function(h){r(!h);}).catch(b);}}.bind(this));}.bind(this))).then(function(r){return r.every(Boolean);});},_isRecorderElement:function(m){return[c.HIGHLIGHTER_ID,c.CONTEXTMENU_ID].filter(function(i){return m.target.id===i||(m.addedNodes.length&&m.addedNodes[0].id===i)||(m.removedNodes.length&&m.removedNodes[0].id===i);}).length;},_hasHiddenElements:function(m){return new Promise(function(r){if(!m.addedNodes.length){r(false);}Promise.all(Array.prototype.map.call(m.addedNodes,function(n){return new Promise(function(r){this._waitForElement(n)().then(function(){r(this._isHidden(n));}.bind(this)).catch(function(){r(true);});}.bind(this));}.bind(this))).then(function(R){r(R.some(Boolean));});}.bind(this));},_waitForElement:function(n){return function(C){C=C||5;return new Promise(function(r,b){if(n instanceof HTMLElement){r();}else if(!C){b();}else{setTimeout(this._waitForElement(C-1),100);}});};},_isHidden:function(n){var b=$(n);return b.is(":hidden")||b.css("visibility")==="hidden";}});return a;});
