/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/thirdparty/jquery","./View","./XMLViewRenderer","./ViewType","sap/base/util/merge","sap/ui/base/ManagedObject","sap/ui/core/XMLTemplateProcessor","sap/ui/core/Control","sap/ui/core/RenderManager","sap/ui/core/cache/CacheManager","sap/ui/model/resource/ResourceModel","sap/ui/util/XMLHelper","sap/ui/Global","sap/ui/VersionInfo","sap/base/strings/hash","sap/base/Log","sap/base/util/LoaderExtensions","sap/ui/performance/trace/Interaction","sap/ui/core/Core"],function(q,V,X,a,m,M,b,C,R,c,d,f,G,g,h,L,j,I){"use strict";var k=R.RenderPrefixes,x="XMLViewCacheError",n={};var l=C.extend("sap.ui.core.mvc.XMLAfterRenderingNotifier",{metadata:{library:"sap.ui.core"},renderer:{apiVersion:2,render:function(o,e){o.text("");}}});var p=V.extend("sap.ui.core.mvc.XMLView",{metadata:{library:"sap.ui.core",specialSettings:{containingView:{type:'sap.ui.core.mvc.XMLView',visibility:'hidden'},xmlNode:{type:'Element',visibility:'hidden'},cache:'Object',processingMode:{type:"sap.ui.core.mvc.XMLProcessingMode",visibility:"hidden"}},designtime:"sap/ui/core/designtime/mvc/XMLView.designtime"},renderer:X});sap.ui.xmlview=function(i,e){return sap.ui.view(i,e,a.XML);};p.create=function(o){var P=m({},o);P.viewContent=P.definition;P.async=true;P.type=a.XML;return V.create(P);};p._sType=a.XML;p.asyncSupport=true;p._bUseCache=sap.ui.getCore().getConfiguration().getViewCache()&&c._isSupportedEnvironment();function v(e){if(e.parseError.errorCode!==0){var P=e.parseError;throw new Error("The following problem occurred: XML parse Error for "+P.url+" code: "+P.errorCode+" reason: "+P.reason+" src: "+P.srcText+" line: "+P.line+" linepos: "+P.linepos+" filepos: "+P.filepos);}}function r(o,S){if(!S){throw new Error("mSettings must be given");}else if(S.viewName&&S.viewContent){throw new Error("View name and view content are given. There is no point in doing this, so please decide.");}else if((S.viewName||S.viewContent)&&S.xmlNode){throw new Error("View name/content AND an XML node are given. There is no point in doing this, so please decide.");}else if(!(S.viewName||S.viewContent)&&!S.xmlNode){throw new Error("Neither view name/content nor an XML node is given. One of them is required.");}else if(S.cache&&!(S.cache.keys&&S.cache.keys.length)){throw new Error("No cache keys provided. At least one is required.");}}function s(o,S){o.mProperties["viewContent"]=S.viewContent;var e=f.parse(S.viewContent);v(e);return e.documentElement;}function t(o,S){if((o._resourceBundleName||o._resourceBundleUrl)&&(!S.models||!S.models[o._resourceBundleAlias])){var e=new d({bundleName:o._resourceBundleName,bundleUrl:o._resourceBundleUrl,bundleLocale:o._resourceBundleLocale,async:S.async});var i=e.getResourceBundle();if(i instanceof Promise){return i.then(function(){o.setModel(e,o._resourceBundleAlias);});}o.setModel(e,o._resourceBundleAlias);}}function u(o){o.oAfterRenderingNotifier=new l();o.oAfterRenderingNotifier.addDelegate({onAfterRendering:function(){o.onAfterRenderingBeforeChildren();}});}function w(S){var e=sap.ui.require("sap/ui/core/Component"),o;if(e){while(S){var i=e.getOwnerComponentFor(S);if(i){S=o=i;}else{if(S instanceof e){o=S;}S=S.getParent&&S.getParent();}}}return o;}function y(o,e){var i=w(o),J=i?JSON.stringify(i.getManifest()):null,K=[];K=K.concat(B(o,i),E(),D(o),e.keys);return A(o,K).then(function(N){return{key:N+"("+h(J||"")+")",componentManifest:J,additionalData:e.additionalData};});}function z(K){return K;}function A(o,i){return Promise.all(i).then(function(K){K=K.filter(function(J){return J!==n;});if(K.every(z)){return K.join('_');}else{var e=new Error("Provided cache keys may not be empty or undefined.");e.name=x;return Promise.reject(e);}});}function B(o,e){var i=e&&e.getMetadata().getName();return[i||window.location.host+window.location.pathname,o.getId(),sap.ui.getCore().getConfiguration().getLanguageTag()].concat(e&&e.getActiveTerminologies()||[]);}function D(e){var P=e.getPreprocessors(),i=e.getPreprocessorInfo(false),J=[];function K(o){J.push(o.preprocessor.then(function(N){if(N.getCacheKey){return N.getCacheKey(i);}else{return n;}}));}for(var T in P){P[T].forEach(K);}return J;}function E(){return g.load().then(function(i){var T="";if(!i.libraries){T=G.buildinfo.buildtime;}else{i.libraries.forEach(function(o){T+=o.buildTimestamp;});}return T;}).catch(function(e){L.warning("version info could not be retrieved","sap.ui.core.mvc.XMLView");L.debug(e);return"";});}function F(e,i){var K=e.key;delete e.key;var o=e.additionalData;e.xml=f.serialize(i);if(o&&o.setAdditionalCacheData&&o.getAdditionalCacheData){e.additionalData=o.getAdditionalCacheData();}return c.set(K,e);}function H(e){return c.get(e.key).then(function(i){if(i&&i.componentManifest==e.componentManifest){i.xml=f.parse(i.xml,"application/xml").documentElement;if(i.additionalData){var o=e.additionalData;if(o&&o.setAdditionalCacheData&&o.getAdditionalCacheData){o.setAdditionalCacheData(i.additionalData);}else{L.error("Deprecated: Don't use an object reference for caching additional Data! Use a CacheDataProvider instead!");m(e.additionalData,i.additionalData);}}return i;}});}p.prototype.initViewSettings=function(S){var e=this,_;function i(Q){e._xContent=Q;if(V._supportInfo){V._supportInfo({context:e._xContent,env:{caller:"view",viewinfo:m({},e),settings:m({},S||{}),type:"xmlview"}});}if(!e.isSubView()){b.parseViewAttributes(Q,e);}else{delete S.controller;}var T=t(e,S);if(T instanceof Promise){return T.then(function(){u(e);});}u(e);}function o(Q,T){if(e.hasPreprocessor("viewxml")){return b.enrichTemplateIdsPromise(Q,e,T).then(function(){return e.runPreprocessor("viewxml",Q,!T);});}return Q;}function J(Q){var T=I.notifyAsyncStep("VIEW PREPROCESSING");return e.runPreprocessor("xml",Q).then(function(Q){return o(Q,true);}).finally(T);}function K(P){return j.loadResource(P,{async:true}).then(function(Q){return Q.documentElement;});}function N(P,Q){return K(P).then(J).then(function(T){if(Q){F(Q,T);}return T;});}function O(P,Q){return y(e,Q).then(function(T){return H(T).then(function(U){if(!U){return N(P,T);}else{return U.xml;}});}).catch(function(T){if(T.name===x){L.error(T.message,T.name,"sap.ui.core.mvc.XMLView");L.error("Processing the View without caching.","sap.ui.core.mvc.XMLView");return N(P);}else{return Promise.reject(T);}});}this._oContainingView=S.containingView||this;this._sProcessingMode=S.processingMode;if(this.oAsyncState){this.oAsyncState.suppressPreserve=true;}r(this,S);if(S.viewName){var P=S.viewName.replace(/\./g,"/")+".view.xml";if(S.async){if(S.cache&&p._bUseCache){return O(P,S.cache).then(i);}else{return K(P).then(J).then(i);}}else{_=j.loadResource(P).documentElement;}}else if(S.viewContent){if(S.viewContent.nodeType===window.Node.DOCUMENT_NODE){_=S.viewContent.documentElement;}else{_=s(this,S);}}else if(S.xmlNode){_=S.xmlNode;}if(S.async){return J(_).then(i);}else{_=this.runPreprocessor("xml",_,true);_=o(_,false);if(_&&typeof _.getResult==='function'){if(_.isRejected()){throw _.getResult();}_=_.getResult();}i(_);}};p.prototype.onBeforeRendering=function(){var o=this.getDomRef();if(o&&!R.isPreservedContent(o)){R.preserveContent(o,true);}V.prototype.onBeforeRendering.apply(this,arguments);};p.prototype.exit=function(){if(this.oAfterRenderingNotifier){this.oAfterRenderingNotifier.destroy();}V.prototype.exit.apply(this,arguments);};p.prototype.onControllerConnected=function(o,S){var e=this;function i(K){return M.runWithPreprocessors(K,{settings:e._fnSettingsPreprocessor});}if(!this.oAsyncState){this._aParsedContent=i(b.parseTemplate.bind(null,this._xContent,this,S));}else{var J=I.notifyAsyncStep("VIEW PROCESSING");return b.parseTemplatePromise(this._xContent,this,true,{fnRunWithPreprocessor:i}).then(function(P){e._aParsedContent=P;delete e.oAsyncState.suppressPreserve;}).finally(J);}};p.prototype.getControllerName=function(){return this._controllerName;};p.prototype.isSubView=function(){return this._oContainingView!=this;};p.prototype.onAfterRenderingBeforeChildren=function(){if(this._$oldContent.length!==0){var e=this.getAggregation("content");if(e){for(var i=0;i<e.length;i++){var N=document.getElementById(k.Temporary+e[i].getId())||e[i].getDomRef()||document.getElementById(k.Invisible+e[i].getId());if(N){q(document.getElementById(k.Dummy+e[i].getId())).replaceWith(N);}}}q(document.getElementById(k.Temporary+this.getId())).replaceWith(this._$oldContent);}this._$oldContent=undefined;};p.prototype._onChildRerenderedEmpty=function(o,e){q(e).replaceWith('<div id="'+k.Dummy+o.getId()+'" class="sapUiHidden"></div>');return true;};p.registerPreprocessor=function(T,P,e,S,o,i){var O=this.getMetadata().getClass()._sType;if(typeof e==="string"){if(e!==O){throw new TypeError("View types other than "+O+" are not supported by XMLView.registerPreprocessor,"+" check View.registerPreprocessor instead");}}else{i=o;o=S;S=e;}T=T.toUpperCase();if(p.PreprocessorType[T]){V.registerPreprocessor(p.PreprocessorType[T],P,O,S,o,i);}else{L.error("Preprocessor could not be registered due to unknown sType \""+T+"\"",this.getMetadata().getName());}};p.PreprocessorType={XML:"xml",VIEWXML:"viewxml",CONTROLS:"controls"};p.registerPreprocessor("xml","sap.ui.core.util.XMLPreprocessor",true,true);return p;});
