/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['jquery.sap.global','sap/ui/core/support/Plugin','sap/ui/core/support/controls/InteractionSlider','sap/ui/core/support/controls/InteractionTree','sap/ui/core/support/controls/TimelineOverview','sap/m/MessageToast','sap/ui/thirdparty/jszip','sap/ui/core/util/File',"sap/ui/performance/trace/Interaction","sap/ui/performance/Measurement"],function(q,P,I,a,T,M,J,F,b,c){"use strict";var d=P.extend("sap.ui.core.support.plugins.Interaction",{constructor:function(s){P.apply(this,["sapUiSupportInteraction","Interaction",s]);this._oStub=s;if(this.runsAsToolPlugin()){this._aEventIds=[this.getId()+"SetMeasurements",this.getId()+"SetActive",this.getId()+"Export",this.getId()+"Import",this.getId()+"SetQueryString"];var p=function(i,w){return("000"+String(i)).slice(-w);};this._fnFormatTime=function(n){var N=new Date(n),m=Math.floor((n-Math.floor(n))*1000);return p(N.getHours(),2)+":"+p(N.getMinutes(),2)+":"+p(N.getSeconds(),2)+"."+p(N.getMilliseconds(),3)+p(m,3);};this._oInteractionSlider=new I();this._oInteractionTree=new a({});this._oTimelineOverview=new T();}else{this._aEventIds=[this.getId()+"Refresh",this.getId()+"Clear",this.getId()+"Start",this.getId()+"Stop",this.getId()+"Activate",this.getId()+"Export",this.getId()+"Import",this.getId()+"SetQueryString"];}}});d.prototype.init=function(s){P.prototype.init.apply(this,arguments);if(this.runsAsToolPlugin()){g.call(this,s);}else{h.call(this,s);}};d.prototype.exit=function(s){P.prototype.exit.apply(this,arguments);};function g(s){var r=sap.ui.getCore().createRenderManager();r.openStart("div").class("sapUiSupportToolbar").openEnd();r.openStart("button",this.getId()+"-record").class("sapUiSupportIntToggleRecordingBtn").openEnd().close("button");r.openStart("label").class("sapUiSupportIntODataLbl").openEnd();r.voidStart("input",this.getId()+"-odata").attr("type","checkbox").voidEnd();r.text("Enable OData Statistics");r.close("label");r.openStart("div").class("sapUiSupportIntFupInputMask").openEnd();r.voidStart("input",this.getId()+"-fileImport").attr("tabindex","-1").attr("size","1").attr("accept","application/zip").attr("type","file").voidEnd();r.close("div");r.openStart("button",this.getId()+"-import").class("sapUiSupportIntImportExportBtn").class("sapUiSupportIntImportBtn").class("sapUiSupportRoundedButton").openEnd().text("Import").close("button");r.openStart("button",this.getId()+"-export").class("sapUiSupportIntImportExportBtn").class("sapUiSupportIntExportBtn").class("sapUiSupportRoundedButton").class("sapUiSupportIntHidden").openEnd().text("Export").close("button");r.openStart("span",this.getId()+"-info").class("sapUiSupportIntRecordingInfo").openEnd().close("span");r.close("div");r.openStart("div").class("sapUiSupportInteractionCntnt").openEnd();r.close("div");r.openStart("div").class("sapUiPerformanceStatsDiv").class("sapUiSupportIntHidden").openEnd();r.openStart("div").class("sapUiPerformanceTimeline").openEnd().close("div");r.openStart("div").class("sapUiPerformanceTop").openEnd();r.close("div");r.openStart("div").class("sapUiPerformanceBottom").openEnd();r.close("div");r.close("div");r.flush(this.dom());r.destroy();r=sap.ui.getCore().createRenderManager();this._oTimelineOverview.render(r);r.flush(this.dom('.sapUiPerformanceStatsDiv .sapUiPerformanceTimeline'));r.destroy();r=sap.ui.getCore().createRenderManager();this._oInteractionSlider.render(r);r.flush(this.dom('.sapUiPerformanceStatsDiv .sapUiPerformanceTop'));r.destroy();this._oInteractionSlider._registerEventListeners();this.$().find(".sapUiPerformanceTop").on("InteractionSliderChange",{},function(e,f,i){this._oInteractionTree.setRange(f,i);}.bind(this));this.dom("export").addEventListener("click",function(e){this.onsapUiSupportInteractionExport();}.bind(this));this.dom("fileImport").addEventListener("change",function(e){this.onsapUiSupportInteractionImport();}.bind(this));this.dom("odata").checked=this._bODATA_Stats_On;this.dom("odata").addEventListener("click",function(e){q.sap.statistics(!q.sap.statistics());});this.dom('record').dataset.state=(!this._bFesrActive)?'Start recording':'Stop recording';this.dom('record').addEventListener("click",function(e){var R=this.dom('record');if(R.dataset.state==='Stop recording'){this._oStub.sendEvent(this.getId()+"Refresh");this._oStub.sendEvent(this.getId()+"Activate",{"active":false});R.dataset.state='Start recording';this._showPerfData();}else if(this.dom('record').dataset.state==='Start recording'){this._hidePerfData();this._oStub.sendEvent(this.getId()+"Clear");this._oStub.sendEvent(this.getId()+"Activate",{"active":true});R.dataset.state='Stop recording';}}.bind(this));}function h(s){var _=/sap-ui-xx-fesr=(true|x|X)/.test(window.location.search);var e=q.sap.statistics()||/sap-statistics=(true|x|X)/.test(window.location.search);this._oStub.sendEvent(this.getId()+"SetQueryString",{"queryString":{bFesrActive:_,bODATA_Stats_On:e}});k.call(this);}function k(s,e){var A=b.getActive()||this._bFesrActive;var m=[];if(A||e){m=e||b.getAll(true);var f=window.performance.timing.fetchStart;for(var i=0;i<m.length;i++){var l=m[i];for(var j=0;j<l.requests.length;j++){var r=l.requests[j];l.requests[j]={connectEnd:r.connectEnd,connectStart:r.connectStart,domainLookupEnd:r.domainLookupEnd,domainLookupStart:r.domainLookupStart,duration:r.duration,entryType:r.entryType,fetchStart:r.fetchStart,initiatorType:r.initiatorType,name:r.name,redirectEnd:r.redirectEnd,redirectStart:r.redirectStart,requestStart:r.requestStart,responseEnd:r.responseEnd,responseStart:r.responseStart,secureConnectionStart:r.secureConnectionStart,startTime:r.startTime,workerStart:r.workerStart,fetchStartOffset:f};}}}this._oStub.sendEvent(this.getId()+"SetMeasurements",{"measurements":m});this._oStub.sendEvent(this.getId()+"SetActive",{"active":A});}d.prototype.onsapUiSupportInteractionSetQueryString=function(e){var p=e.getParameter("queryString");this._bFesrActive=p.bFesrActive;this._bODATA_Stats_On=p.bODATA_Stats_On;this.dom("odata").checked=this._bODATA_Stats_On;this.dom('record').dataset.state=(!this._bFesrActive)?'Start recording':'Stop recording';};d.prototype.onsapUiSupportInteractionSetMeasurements=function(e){this._setMeasurementsData(e.getParameter("measurements"));};d.prototype.onsapUiSupportInteractionSetActive=function(e){};d.prototype.onsapUiSupportInteractionRefresh=function(e){k.call(this);};d.prototype.onsapUiSupportInteractionClear=function(e){b.clear();this._oStub.sendEvent(this.getId()+"SetMeasurements",{"measurements":[]});};d.prototype.onsapUiSupportInteractionStart=function(e){c.start(this.getId()+"-perf","Measurement by support tool");};d.prototype.onsapUiSupportInteractionEnd=function(e){d.end(true);};d.prototype.onsapUiSupportInteractionActivate=function(e){var A=e.getParameter("active");if(b.getActive()!=A){b.setActive(A);}};d.prototype.onsapUiSupportInteractionExport=function(e){var m=this.measurements||[];if(m.length>0){var z=new J();z.file("InteractionsSteps.json",JSON.stringify(m).replace(/,"isExpanded":true/g,''));var C=z.generate({type:"blob"});this._openGeneratedFile(C);}};d.prototype.onsapUiSupportInteractionImport=function(E){var i=this.dom("fileImport").files;if(i.length===0){M.show('Select a file for import first!',{autoClose:true,duration:3000});return;}if(!window.FileReader){M.show('Use a modern browser which supports FileReader!',{autoClose:true,duration:3000});return;}var r=new window.FileReader(),f=i[0],t=this;r.onload=(function(j){return function(e){var z=new J(e.target.result);var l=z.files["InteractionsSteps.json"]&&z.files["InteractionsSteps.json"].asText();if(l){t._setMeasurementsData(JSON.parse(l.replace(/,"isExpanded":true/g,'')));}else{M.show('Imported data does not contain interaction measures',{autoClose:true,duration:3000});}};})(f);r.readAsArrayBuffer(f);};d.prototype._openGeneratedFile=function(C){F.save(C,"InteractionSteps","zip","application/zip");};d.prototype._setMeasurementsData=function(m){var r=0,e=100,f=function(D){var l=function(R,u){var v=0;if(R.length===0){return v;}for(var i=R.length-1;i>=0;i--){if(R[i].startTime<u.startTime){v=i+1;break;}}return v;},n=function(O,u){return O.filter(function(v){return v.timing.startTime===u;});},o=function(u,v){var w=0;if(u.length===0){return w;}for(var i=u.length-1;i>=0;i--){if(u[i].start<(v.fetchStartOffset+v.startTime)){w=i;break;}}return w;},p=0;D.forEach(function(u,v,w){var x=u.requests;for(var i=x.length-1;i>=0;i--){var y=x[i];if(v>0&&u.start-e>(y.fetchStartOffset+y.startTime)){var z=o(w,y);var A=w[z].requests;p=l(A,y);A.splice(p,0,y);x.splice(i,1);var O=n(u.sapStatistics,y.startTime);if(O.length>0){w[z].sapStatistics=w[z].sapStatistics.concat(O);}}}});};f(m);this.measurements=m;for(var i=0;i<m.length;i++){r+=m[i].requests.length;}if(m.length>0){this._showPerfData();this.dom('info').textContent="Total "+r+" Requests in "+m.length+" Interactions";}else{this._hidePerfData();this.dom('info').textContent="";}var t=this.dom('.sapUiPerformanceStatsDiv .sapUiPerformanceTimeline');var j=sap.ui.getCore().createRenderManager();this._oTimelineOverview.setInteractions(m);this._oTimelineOverview.render(j);j.flush(t);j.destroy();this._oInteractionSlider._initSlider();this._oInteractionSlider.setDuration(m);var s=this.dom('.sapUiPerformanceStatsDiv .sapUiPerformanceBottom');this._oInteractionTree.setInteractions(m);this._oInteractionTree.renderAt(s);};d.prototype._showPerfData=function(){this.dom(".sapUiPerformanceStatsDiv").classList.remove("sapUiSupportIntHidden");this.dom("export").classList.remove("sapUiSupportIntHidden");};d.prototype._hidePerfData=function(){this.dom(".sapUiPerformanceStatsDiv").classList.add("sapUiSupportIntHidden");this.dom("export").classList.add("sapUiSupportIntHidden");};return d;});
