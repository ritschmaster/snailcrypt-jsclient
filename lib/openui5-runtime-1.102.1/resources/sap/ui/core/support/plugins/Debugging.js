/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['sap/ui/core/support/Plugin',"sap/base/security/encodeXML","sap/base/util/each","sap/ui/events/KeyCodes","sap/ui/thirdparty/jquery","sap/ui/dom/jquery/cursorPos","sap/ui/dom/jquery/selectText"],function(P,e,a,K,q){"use strict";var D=P.extend("sap.ui.core.support.plugins.Debugging",{constructor:function(s){P.apply(this,["sapUiSupportDebugging","Debugging",s]);this._oStub=s;this._aEventIds=[this.getId()+"ReceiveClasses",this.getId()+"ReceiveClassMethods",this.getId()+"SaveUrlIfNew",this.getId()+"AppendUserUrls"];this._breakpointId="sapUiSupportBreakpoint";this._localStorageId="sapUiSupportLocalStorage";this._techInfoId="sapUiSupportTechInfo";this._aClasses=[];this._mAddedClasses={};this._sSelectedClass="";this._mRebootUrls={};}});D.prototype.isToolPlugin=function(){return true;};D.prototype.isAppPlugin=function(){return false;};D.prototype.init=function(s){P.prototype.init.apply(this,arguments);this.renderContainer();this._populateRebootUrls();this._oStub.sendEvent(this._breakpointId+"RequestClasses",{callback:this.getId()+"ReceiveClasses"});};D.prototype.exit=function(s){P.prototype.exit.apply(this,arguments);};D.prototype.renderContainer=function(){var r=sap.ui.getCore().createRenderManager();r.openStart("div",this.getId()+"-RebootContainer").class("sapUiSupportContainer").openEnd();r.openStart("div").class("sapUISupportLabel").class("sapUISupportLabelBold").openEnd().text("Note: Designed to work with apps loaded with the standard UI5 loading bootstrap script tag:").close("div");r.openStart("div").class("sapUISupportLabel").class("sapUISupportLabelBold").openEnd().text("<"+"script id=\"sap-ui-bootstrap\" src=\"somepath/resources/sap-ui-core.js\" ...");r.voidStart("br").voidEnd();r.voidStart("br").voidEnd();r.close("div");r.openStart("div").class("sapUISupportLabel").openEnd().text("Boot application with different UI5 version on next reload:").close("div");r.openStart("select",this.getId()+"-RebootSelect").class("sapUiSupportSelect").openEnd();r.openStart("option").attr("value","none").openEnd().text("Disabled (no custom reboot URL").close("option");r.openStart("option",this.getId()+"-RebootOther").attr("value","other").openEnd().text("Other (enter URL to sap-ui-core.js below)...:").close("option");r.close("select");r.voidStart("input",this.getId()+"-RebootInput").attr("type","text").attr("disabled","disabled").voidEnd();r.openStart("button",this.getId()+"-Reboot").class("sapUiSupportRoundedButton").openEnd().text("Activate Reboot URL").close("button");r.close("div");r.openStart("div",this.getId()+"-ClassContainer").class("sapUiSupportContainer").openEnd().close("div");r.openStart("div",this.getId()+"-MethodContainer").class("sapUiSupportContainer").openEnd().close("div");r.flush(this.dom());r.destroy();this.dom("Reboot").addEventListener("click",this._onUseOtherUI5Version.bind(this));this.dom("RebootSelect").addEventListener("change",this._onUI5VersionDropdownChanged.bind(this));};D.prototype.renderClasses=function(){var t=this;var c=this._aClasses;var r=sap.ui.getCore().createRenderManager();r.openStart("div").class("sapUISupportLabel").openEnd().text("Select Class:").close("div");r.openStart("select",this.getId()+"-ClassSelect").class("sapUiSupportAutocomplete").class("sapUiSupportSelect").openEnd();r.openStart("option").openEnd().close("option");a(c,function(i,v){if(typeof(t._mAddedClasses[v])==='undefined'){r.openStart("option").openEnd();r.text(v);r.close("option");}});r.close("select");r.voidStart("input",this.getId()+"-ClassInput").class("sapUiSupportAutocomplete").attr("type","text").voidEnd();r.openStart("button",this.getId()+"-AddClass").class("sapUiSupportRoundedButton").openEnd().text("Add class").close("button");r.voidStart("hr").class("no-border").voidEnd();r.openStart("ul",this.getId()+"-ClassList").class("sapUiSupportList").openEnd();a(c,function(i,v){if(typeof(t._mAddedClasses[v])==='undefined'){return;}var b=t._mAddedClasses[v].bpCount;var d="";if(b){d=b.active+" / "+b.all;}r.openStart("li").attr("data-class-name",v);if(t._sSelectedClass===v){r.class("selected");}r.openEnd();r.openStart("div").openEnd().openStart("span").class("className").openEnd().text(v).close("span").openStart("span").class("breakpoints").openEnd().text(d).close("span").close("div").voidStart("img").class("remove-class").attr("src","../../debug/images/delete.gif").attr("alt","X").voidEnd();r.close("li");});r.close("ul");r.flush(this.dom("ClassContainer"));r.destroy();this.dom("ClassInput").addEventListener("keyup",this._autoComplete.bind(this));this.dom("ClassInput").addEventListener("blur",this._updateSelectOptions.bind(this));this.dom("ClassSelect").addEventListener("change",this._selectOptionsChanged.bind(this));this.dom("AddClass").addEventListener("click",this._onAddClassClicked.bind(this));this.dom("ClassList").addEventListener("click",this._onSelectOrRemoveClass.bind(this));};D.prototype.renderMethods=function(m){var r=sap.ui.getCore().createRenderManager();if(typeof(m)==='undefined'){r.openStart("p").openEnd().text("Select a class in the list on the left side to add breakpoint.").close("p");r.flush(this.dom("MethodContainer"));r.destroy();return;}r.openStart("div").class("sapUISupportLabel").openEnd().text("Select Method").close("div");r.openStart("select",this.getId()+"-MethodSelect").class("sapUiSupportAutocomplete").class("sapUiSupportSelect").openEnd().openStart("option").openEnd().close("option");a(m,function(i,v){if(!v.active){r.openStart("option").attr("data-method-type",v.type).openEnd();r.text(v.name);r.close("option");}});r.close("select");r.voidStart("input",this.getId()+"-MethodInput").class("sapUiSupportAutocomplete").attr("type","text").voidEnd();r.openStart("button",this.getId()+"-AddBreakpoint").class("sapUiSupportRoundedButton").openEnd().text("Add breakpoint").close("button");r.voidStart("hr").class("no-border").voidEnd();r.openStart("ul",this.getId()+"-BreakpointList").class("sapUiSupportList").class("sapUiSupportBreakpointList").openEnd();a(m,function(i,v){if(!v.active){return;}r.openStart("li").attr("data-method-name",v.name).attr("data-method-type",v.type).openEnd().openStart("span").openEnd().text(v.name).close("span").voidStart("img").class("remove-breakpoint").attr("src","../../debug/images/delete.gif").attr("alt","Remove").voidEnd().close("li");});r.close('ul');r.flush(this.dom("MethodContainer"));r.destroy();this.dom("MethodInput").addEventListener("keyup",this._autoComplete.bind(this));this.dom("MethodInput").addEventListener("blur",this._updateSelectOptions.bind(this));this.dom("MethodSelect").addEventListener("change",this._selectOptionsChanged.bind(this));this.dom("AddBreakpoint").addEventListener("click",this._onAddBreakpointClicked.bind(this));this.dom("BreakpointList").addEventListener("click",this._onRemoveBreakpoint.bind(this));};D.prototype.onsapUiSupportDebuggingReceiveClasses=function(E){this._aClasses=JSON.parse(E.getParameter("classes"));this.renderClasses();this.renderMethods();this.dom("ClassInput").focus();};D.prototype.onsapUiSupportDebuggingReceiveClassMethods=function(E){var m=JSON.parse(E.getParameter("methods"));this.renderMethods(m);var c=E.getParameter("className");var b=JSON.parse(E.getParameter("breakpointCount"));this._mAddedClasses[c]={bpCount:b};var B=this.dom('li[data-class-name="'+c+'"] span.breakpoints');B.textContent=b.active+" / "+b.all;this.dom("MethodInput").focus();};D.prototype._autoComplete=function(E){var I=E.target;if(E.keyCode==K.ENTER){this._updateSelectOptions(E);if(I.id===this.getId()+"-ClassInput"){this._onAddClassClicked();}else{this._onAddBreakpointClicked();}return;}if(E.keyCode>=K.ARROW_LEFT&&E.keyCode<=K.ARROW_DOWN){return;}var s=I.value,S=I.previousElementSibling;if(s==""){return;}var o=Array.from(S.querySelectorAll("option")).map(function(b){return b.value;});var O;for(var i=0;i<o.length;i++){O=o[i];if(O.toUpperCase().indexOf(s.toUpperCase())==0){var $=q(I),c=$.cursorPos();if(E.keyCode==K.BACKSPACE){c--;}I.value=O;$.selectText(c,O.length);break;}}return;};D.prototype._onAddClassClicked=function(){var c=this.dom("ClassInput").value;this._mAddedClasses[c]={};this.renderClasses();this.dom("ClassInput").focus();};D.prototype._onRemoveClass=function(E){var l=E.target.closest("li[data-class-name]");var c=l.dataset.className;delete this._mAddedClasses[c];var w=false;if(this._sSelectedClass===c){this._sSelectedClass="";w=true;}this._oStub.sendEvent(this._breakpointId+"RemoveAllClassBreakpoints",{className:c});this.renderClasses();if(w){this.renderMethods();}this.dom("ClassInput").focus();};D.prototype._onAddBreakpointClicked=function(){this.changeBreakpoint(this.dom("ClassList").querySelector("li.selected").dataset.className,this.dom("MethodInput").value,this.dom("MethodSelect").querySelector("option:checked").dataset.methodType,true);};D.prototype._onRemoveBreakpoint=function(E){if(E.target.nodeName==="IMG"&&E.target.classList.contains("remove-breakpoint")){var l=E.target.closest("li");this.changeBreakpoint(this.dom("ClassList").querySelector("li.selected").dataset.className,l.dataset.methodName,l.dataset.methodType,false);}};D.prototype._updateSelectOptions=function(E){var s=E.srcElement||E.target;if(s.tagName=="INPUT"){var v=s.value;s=s.previousSibling;var o=s.options;for(var i=0;i<o.length;i++){var t=o[i].value||o[i].text;if(t.toUpperCase()==v.toUpperCase()){s.selectedIndex=i;break;}}}var b=s.selectedIndex;var c=s.options[b].value||s.options[b].text;if(s.nextSibling&&s.nextSibling.tagName=="INPUT"){s.nextSibling.value=c;}};D.prototype._selectOptionsChanged=function(E){var s=E.srcElement||E.target;var i=s.nextSibling;i.value=s.options[s.selectedIndex].value;};D.prototype._onSelectOrRemoveClass=function(E){if(E.target.nodeName==="IMG"&&E.target.classList.contains("remove-class")){this._onRemoveClass(E);}else{this._onSelectClass(E);}};D.prototype._onSelectClass=function(E){var l=E.target.closest("li[data-class-name]");if(l==null||l.classList.contains("selected")){return;}l.parentElement.querySelectorAll("li.selected").forEach(function(n){n.classList.remove("selected");});l.classList.add("selected");var c=this._sSelectedClass=l.dataset.className;this._oStub.sendEvent(this._breakpointId+"RequestClassMethods",{className:c,callback:this.getId()+"ReceiveClassMethods"});};D.prototype._isClassSelected=function(){var s=false;a(this._mClasses,function(i,v){if(v.selected===true){s=true;}});return s;};D.prototype.changeBreakpoint=function(c,m,t,b){this._oStub.sendEvent(this._breakpointId+"ChangeClassBreakpoint",{className:c,methodName:m,active:b,type:parseInt(t),callback:this.getId()+"ReceiveClassMethods"});};D.prototype._populateRebootUrls=function(){this._mRebootUrls={"https://openui5.hana.ondemand.com/resources/sap-ui-core.js":"Public OpenUI5 server","https://openui5beta.hana.ondemand.com/resources/sap-ui-core.js":"Public OpenUI5 PREVIEW server","https://sapui5.hana.ondemand.com/resources/sap-ui-core.js":"Public SAPUI5 server","http://localhost:8080/testsuite/resources/sap-ui-core.js":"Localhost (port 8080), /testsuite ('grunt serve' URL)","http://localhost:8080/sapui5/resources/sap-ui-core.js":"Localhost (port 8080), /sapui5 (maven URL)"};this._testAndAddUrls(this._mRebootUrls);var t=this;window.setTimeout(function(){t._oStub.sendEvent(t._localStorageId+"GetItem",{id:"sap-ui-reboot-URLs",callback:t.getId()+"AppendUserUrls"});},0);};D.prototype._testAndAddUrls=function(u){var o=this.dom("RebootOther");function c(U){return function(){var h="<option value='"+e(U)+"'>"+u[U]+"</option>";o.insertAdjacentHTML("beforebegin",h);};}for(var U in u){q.ajax({type:"HEAD",url:U,success:c(U)});}};D.prototype.onsapUiSupportDebuggingAppendUserUrls=function(E){var u=E.getParameter("value"),U={},b=u.split(" ");for(var i=0;i<b.length;i++){var s=b[i];if(s&&!this._mRebootUrls[s]){U[s]=e(s)+" (user-defined URL)";}}this._testAndAddUrls(U);};D.prototype._onUI5VersionDropdownChanged=function(){var r=this.dom("RebootSelect").value,i=this.dom("RebootInput");if(r==="other"){i.disabled=false;}else{i.disabled=true;if(r==="none"){i.value="";}else{i.value=r;}}};D.prototype._onUseOtherUI5Version=function(){var r=this.dom("RebootSelect").value;if(r==="other"){r=this.dom("RebootInput").value;}if(!r||r==="none"){this._oStub.sendEvent(this._techInfoId+"SetReboot",{rebootUrl:null});alert("Reboot URL cleared. App will start normally.");}else{this._oStub.sendEvent(this._techInfoId+"SetReboot",{rebootUrl:r});if(!this._mRebootUrls[r]){this._oStub.sendEvent(this._localStorageId+"GetItem",{id:"sap-ui-reboot-URLs",passThroughData:r,callback:this.getId()+"SaveUrlIfNew"});}}};D.prototype.onsapUiSupportDebuggingSaveUrlIfNew=function(E){var u=E.getParameter("value"),n=E.getParameter("passThroughData"),U=u.split(" ");if(U.indexOf(n)===-1){U.push(n.replace(/ /g,"%20"));this._oStub.sendEvent(this._localStorageId+"SetItem",{id:"sap-ui-reboot-URLs",value:U.join(" ")});}};return D;});
