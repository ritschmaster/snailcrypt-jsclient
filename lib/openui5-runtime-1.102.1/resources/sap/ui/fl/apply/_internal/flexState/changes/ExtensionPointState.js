/*
 * ! OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_omit","sap/base/util/merge","sap/base/Log","sap/ui/fl/apply/_internal/changes/Utils","sap/ui/fl/write/api/ChangesWriteAPI","sap/ui/fl/ChangePersistenceFactory"],function(_,m,L,C,a,b){"use strict";var E={};function i(p,o){if(o.getSelector().name!==p.extensionPointName){return false;}return C.filterChangeByView(p,o);}function c(o,e){if(e.fragmentId){var d=o.getExtensionPointInfo&&o.getExtensionPointInfo();if(d){return e.fragmentId!==d.fragmentId;}return true;}return false;}function r(o,e,O){var s=o.getSelector();if(e.closestAggregationBindingCarrier&&e.closestAggregationBinding){s=m(s,{id:e.closestAggregationBindingCarrier,idIsLocal:false});var d=o.getDefinition();var f={id:e.targetControl.getId(),idIsLocal:false};if(!d.dependentSelector){d.dependentSelector={};}if(O){o.originalSelectorToBeAdjusted=f;}else{d.dependentSelector.originalSelector=f;}d.content.boundAggregation=e.closestAggregationBinding;}else{s=m(s,{id:e.targetControl.getId(),idIsLocal:false});}o.setSelector(s);}E.getChangesForExtensionPoint=function(o,p){if(!p.extensionPointName){L.error("Missing name from extension point info!");return Promise.resolve([]);}return o.getChangesForComponent().then(function(d){return d.filter(i.bind(undefined,p));});};E.enhanceExtensionPointChanges=function(p,e){p.extensionPointName=e.name;var o=b.getChangePersistenceForControl(e.targetControl);return E.getChangesForExtensionPoint(o,p).then(function(d){var P=[];d.forEach(function(f){if(f.isInInitialState()&&!(f.getExtensionPointInfo&&f.getExtensionPointInfo())){f.setExtensionPointInfo(e);r(f,e,false);if(o.isChangeMapCreated()){o.addChangeAndUpdateDependencies(p.appComponent,f);}}else if(c(f,e)){var g=f.getDefinition();var h=_(g,["dependentSelector","fileName","selector","content"]);Object.keys(g.content).forEach(function(k){h[k]=g.content[k];});h.support.sourceChangeFileName=g.fileName||"";P.push(a.create({changeSpecificData:h,selector:{view:e.view,name:e.name}}).then(function(R){r(R,e,true);R.setExtensionPointInfo(e);R.setModuleName(g.moduleName);R.getDefinition().creation=g.creation;o.addChangeAndUpdateDependencies(p.appComponent,R,f);}));}});return Promise.all(P).then(function(){return d;});});};return E;});
