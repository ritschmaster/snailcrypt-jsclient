/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/Utils","sap/base/Log","sap/ui/core/CustomData"],function(F,L){"use strict";var a={};a.sync={};a.appliedChangesCustomDataKey="sap.ui.fl.appliedChanges";a.failedChangesCustomDataKeyJs="sap.ui.fl.failedChanges.js";a.failedChangesCustomDataKeyXml="sap.ui.fl.failedChanges.xml";a.notApplicableChangesCustomDataKey="sap.ui.fl.notApplicableChanges";a.sync.getAppliedCustomDataValue=function(C,o){var m=b(C,a._getCustomDataKey(o,a.appliedChangesCustomDataKey));return m.customDataValue;};a.getAppliedCustomDataValue=function(C,o,m){return c(C,m,a._getCustomDataKey(o,a.appliedChangesCustomDataKey)).then(function(d){return d.customDataValue;});};a.sync.getParsedRevertDataFromCustomData=function(C,o){var s=a.sync.getAppliedCustomDataValue(C,o);try{return s&&JSON.parse(s);}catch(e){L.error("Could not parse revert data from custom data",s);return undefined;}};a.getParsedRevertDataFromCustomData=function(C,o,m){return a.getAppliedCustomDataValue(C,o,m).then(function(s){return s&&JSON.parse(s);});};a.sync.hasChangeApplyFinishedCustomData=function(C,o){var d=F.getAggregation(C,"customData")||[];var e=[a._getCustomDataKey(o,a.appliedChangesCustomDataKey),a._getCustomDataKey(o,a.failedChangesCustomDataKeyJs),a._getCustomDataKey(o,a.notApplicableChangesCustomDataKey)];return d.some(function(f){var k=F.getProperty(f,"key");if(e.indexOf(k)>-1){return!!F.getProperty(f,"value");}return false;});};a.hasChangeApplyFinishedCustomData=function(C,o,m){return Promise.resolve().then(m.getAggregation.bind(m,C,"customData")).then(function(d){d=d||[];var e=[a._getCustomDataKey(o,a.appliedChangesCustomDataKey),a._getCustomDataKey(o,a.failedChangesCustomDataKeyJs),a._getCustomDataKey(o,a.notApplicableChangesCustomDataKey)];return Promise.all(d.map(function(f){return Promise.resolve().then(m.getProperty.bind(m,f,"key")).then(function(k){if(e.indexOf(k)>-1){return m.getProperty(f,"value");}return undefined;}).then(function(v){return!!v;});})).then(function(v){return v.includes(true);});});};function g(s,C){var r=C.getRevertData();if(s&&r!==undefined){return JSON.stringify(r);}return"true";}a.addAppliedCustomData=function(C,o,p,s){var d=g(s,o);var e=a._getCustomDataKey(o,a.appliedChangesCustomDataKey);return w(C,e,d,p);};a.addFailedCustomData=function(C,o,p,i){var s=a._getCustomDataKey(o,i);return w(C,s,"true",p);};a.sync.destroyAppliedCustomData=function(C,o,m){var k=a._getCustomDataKey(o,a.appliedChangesCustomDataKey);var d=b(C,k);if(d.customData){m.destroy(d.customData);}};a.destroyAppliedCustomData=function(C,o,m){var k=a._getCustomDataKey(o,a.appliedChangesCustomDataKey);return c(C,m,k).then(function(d){if(d.customData){m.destroy(d.customData);}});};a.getCustomDataIdentifier=function(s,e,x){if(s){return a.appliedChangesCustomDataKey;}if(!e){return a.notApplicableChangesCustomDataKey;}if(x){return a.failedChangesCustomDataKeyXml;}return a.failedChangesCustomDataKeyJs;};a._getCustomDataKey=function(C,i){return i+"."+C.getId();};function w(C,k,v,p){return c(C,p.modifier,k).then(function(m){if(!m.customData){return p.modifier.createAndAddCustomData(C,k,v,p.appComponent);}return p.modifier.setProperty(m.customData,"value",v);});}function b(C,s){var d=F.getAggregation(C,"customData")||[];var r={};d.some(function(o){var k=F.getProperty(o,"key");if(k===s){r.customData=o;r.customDataValue=F.getProperty(o,"value");return true;}return false;});return r;}function c(C,m,s){return Promise.resolve().then(m.getAggregation.bind(m,C,"customData")).then(function(d){d=d||[];var r={};return d.reduce(function(p,o){return p.then(m.getProperty.bind(m,o,"key")).then(function(k){if(k===s){r.customData=o;return m.getProperty(o,"value");}return undefined;}).then(function(e){if(e){r.customDataValue=e;}});},Promise.resolve()).then(function(){return r;});});}return a;},true);
