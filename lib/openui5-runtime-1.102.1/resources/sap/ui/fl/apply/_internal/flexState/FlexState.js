/*
 * ! OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_omit","sap/base/util/each","sap/base/util/merge","sap/base/util/ObjectPath","sap/base/Log","sap/ui/core/Component","sap/ui/fl/apply/_internal/flexState/appDescriptorChanges/prepareAppDescriptorMap","sap/ui/fl/apply/_internal/flexState/changes/prepareChangesMap","sap/ui/fl/apply/_internal/flexState/compVariants/prepareCompVariantsMap","sap/ui/fl/apply/_internal/flexState/controlVariants/prepareVariantsMap","sap/ui/fl/apply/_internal/flexState/Loader","sap/ui/fl/apply/_internal/flexState/ManifestUtils","sap/ui/fl/initial/_internal/StorageUtils","sap/ui/fl/LayerUtils","sap/ui/fl/Utils"],function(_,e,m,O,L,C,p,a,b,c,d,M,S,f,U){"use strict";var F={};var g={};var h={};var i={};var j;var k;var l;var n={appDescriptorChanges:{prepareFunction:p,pathInResponse:[]},changes:{prepareFunction:a,pathInResponse:["changes"]},variants:{prepareFunction:c,pathInResponse:["variants","variantChanges","variantDependentControlChanges","variantManagementChanges"]},compVariants:{prepareFunction:b,pathInResponse:["comp.variants","comp.standardVariants","comp.defaultVariants","comp.changes"]}};var o={compVariants:{},variants:{}};function q(P){var J=C.get(P.componentId);P.componentData=P.componentData||J.getComponentData()||{};P.manifest=P.manifest||P.rawManifest||J.getManifestObject();P.reference=P.reference||M.getFlexReference(P);}function r(R,J){if(!g[R]){throw new Error("State is not yet initialized");}if(!g[R].preparedMaps[J]){if(!g[R].storageResponse){g[R].storageResponse=x(g[R].unfilteredStorageResponse);}var P={unfilteredStorageResponse:g[R].unfilteredStorageResponse,storageResponse:g[R].storageResponse,componentId:g[R].componentId,componentData:g[R].componentData};g[R].preparedMaps[J]=F.callPrepareFunction(J,P);}return g[R].preparedMaps[J];}function s(R){return r(R,"appDescriptorChanges");}function t(R){return r(R,"changes");}function u(R){return r(R,"variants");}function v(R){return r(R,"compVariants");}function w(P){if(P.reference.endsWith(".Component")){var J=P.reference.split(".");J.pop();var R=J.join(".");g[R]=m({},{storageResponse:{changes:S.getEmptyFlexDataResponse()},unfilteredStorageResponse:{changes:S.getEmptyFlexDataResponse()},preparedMaps:{},componentId:P.componentId,partialFlexState:P.partialFlexState});i[R]=i[P.reference];}}function x(R){var J=m({},R);var K=J.changes;var N=H("URLParsing");if(f.isLayerFilteringRequired(N)){e(n,function(P,Q){Q.pathInResponse.forEach(function(T){O.set(T,f.filterChangeDefinitionsByMaxLayer(O.get(T,K),N),K);});});}return J;}function y(P){i[P.reference]=d.loadFlexData(P).then(function(R){g[P.reference]=m({},{unfilteredStorageResponse:R,preparedMaps:{},componentId:P.componentId,componentData:P.componentData,partialFlexState:P.partialFlexState});w(P);z(P.reference);return R;});return i[P.reference];}function z(R){var J=H("ShellNavigation");if(J&&!h[R]){h[R]=B.bind(null,R);J.registerNavigationFilter(h[R]);}}function A(R){var J=H("ShellNavigation");if(J){if(h[R]){J.unregisterNavigationFilter(h[R]);delete h[R];}}}function B(R,N,J){var K=H("ShellNavigation");if(K){try{var P=f.getMaxLayerTechnicalParameter(N,H("URLParsing"));var Q=f.getMaxLayerTechnicalParameter(J,H("URLParsing"));if(P!==Q){F.clearFilteredResponse(R);}}catch(T){L.error(T.message);}return K.NavigationFilterStatus.Continue;}return undefined;}function D(J){var K=g[J.reference];if(K.partialFlexState===true&&J.partialFlexState!==true){K.partialFlexState=false;J.partialFlexData=m({},K.unfilteredStorageResponse.changes);J.reInitialize=true;}return J;}function E(J){var K=g[J.reference].componentId;if(!J.reInitialize&&K!==J.componentId){J.reInitialize=true;}return J;}function G(){return Promise.all([U.getUShellService("ShellNavigation"),U.getUShellService("URLParsing")]).then(function(J){j=J[0];k=J[1];}).catch(function(J){L.error("Error getting service from Unified Shell: "+J.message);});}function H(J){if(U.getUshellContainer()){if(J==="ShellNavigation"){return j;}else if(J==="URLParsing"){return k;}}return undefined;}function I(){return Promise.all([U.requireAsync("sap/ui/fl/ChangePersistenceFactory")]).then(function(J){l=J[0];}).catch(function(J){L.error("Error loading modules: "+J.message);});}F.initialize=function(P){return Promise.all([G(),I()]).then(function(){q(P);var J=P.reference;if(i[J]){return i[J].then(D.bind(null,P)).then(E).then(function(K){return K.reInitialize?y(K):g[J].unfilteredStorageResponse;});}return y(P);}).then(function(P){if(!g[P.reference].componentData){var J=C.get(P.componentId);g[P.reference].componentData=J?J.getComponentData():P.componentData;}}.bind(null,P));};F.clearAndInitialize=function(P){q(P);F.clearState(P.reference);F.clearState(U.normalizeReference(P.reference));return F.initialize(P);};F.clearState=function(R){if(R){A(R);delete g[R];delete i[R];if(l&&(l._instanceCache||{}).hasOwnProperty(R)){l._instanceCache[R].removeDirtyChanges();}}else{Object.keys(g).forEach(function(R){A(R);});g={};i={};}};F.setInitialNonFlCompVariantData=function(R,P,J,V){o.compVariants[R]={};o.compVariants[R][P]={};o.compVariants[R][P].standardVariant=J;o.compVariants[R][P].variants=V;};F.getInitialNonFlCompVariantData=function(R){return o.compVariants[R];};F.setFakeStandardVariant=function(R,J,K){var V=F.getVariantsState(R);if(!V[Object.keys(K)[0]]){m(V,K);o.variants[R]=o.variants[R]||{};o.variants[R][J]=o.variants[R][J]||{};m(o.variants[R][J],K);}};F.resetFakedStandardVariants=function(R,J){if(o.variants[R]){delete o.variants[R][J];}};F.clearFilteredResponse=function(R){if(g[R]){g[R].preparedMaps={};delete g[R].storageResponse;}};F.getUIChanges=function(R){return t(R).changes;};F.getAppDescriptorChanges=function(R){return s(R).appDescriptorChanges;};F.getVariantsState=function(R){var V=u(R);if(o.variants[R]){e(o.variants[R],function(J,K){if(g[R].componentId===J){e(K,function(N,P){if(!V[N]){V[N]=P;}});}});}return V;};F.getUI2Personalization=function(R){return g[R].unfilteredStorageResponse.changes.ui2personalization;};F.getCompVariantsMap=function(R){return v(R);};F.callPrepareFunction=function(J,P){return n[J].prepareFunction(P);};F.getStorageResponse=function(R){if(i[R]){return i[R].then(function(){return g[R].unfilteredStorageResponse;});}return undefined;};F.getFlexObjectsFromStorageResponse=function(R){return g[R]&&g[R].unfilteredStorageResponse.changes;};return F;});
