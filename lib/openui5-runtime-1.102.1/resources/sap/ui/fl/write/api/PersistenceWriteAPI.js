/*
 * ! OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/includes","sap/base/util/restricted/_omit","sap/base/Log","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/fl/apply/_internal/changes/FlexCustomData","sap/ui/fl/apply/_internal/ChangesController","sap/ui/fl/apply/_internal/appVariant/DescriptorChangeTypes","sap/ui/fl/write/_internal/condenser/Condenser","sap/ui/fl/write/_internal/flexState/FlexObjectState","sap/ui/fl/write/_internal/Storage","sap/ui/fl/apply/_internal/flexState/ManifestUtils","sap/ui/fl/apply/_internal/flexState/controlVariants/VariantManagementState","sap/ui/fl/write/api/FeaturesAPI","sap/ui/fl/Layer","sap/ui/fl/LayerUtils","sap/ui/fl/registry/Settings","sap/ui/fl/Utils"],function(i,_,L,J,F,C,D,a,b,S,M,V,c,d,e,f,g){"use strict";var P={};function h(o){return(o._getMap&&i(D.getChangeTypes(),o._getMap().changeType))||(o.getChangeType&&i(D.getChangeTypes(),o.getChangeType()));}function j(p){p.includeCtrlVariants=true;p.invalidateCache=false;return P._getUIChanges(p).then(function(l){return l.length>0;});}function k(l,o){var m=g.getAppComponentForControl(o);var n=m.getModel(g.VARIANT_MODEL_NAME);var s=n&&n.sFlexReference;var v=V.getVariantManagementReferences(s);if(v.length===0){return l;}var p=v.map(function(q){return n.getCurrentVariantReference(q);});return l.filter(function(q){return p.some(function(r){return q.getVariantReference()===r||!q.getVariantReference();});});}P.hasHigherLayerChanges=function(p){p.upToLayer=p.upToLayer||e.getCurrentLayer();return b.getFlexObjects(p).then(function(l){return l.filter(function(o){return e.isOverLayer(o.getLayer(),p.upToLayer);});}).then(function(l){return l.length>0;});};P.save=function(p){return b.saveFlexObjects(p);};P.getResetAndPublishInfo=function(p){return Promise.all([j(p),c.isPublishAvailable()]).then(function(r){var H=r[0];var I=r[1];var l=p.layer!==d.USER&&p.layer!==d.PUBLIC;var o={isResetEnabled:H,isPublishEnabled:false,allContextsProvided:true};if(l){return S.getFlexInfo(p).then(function(R){o.allContextsProvided=R.allContextsProvided===undefined||R.allContextsProvided;o.isResetEnabled=R.isResetEnabled;o.isPublishEnabled=I&&R.isPublishEnabled;return o;}).catch(function(E){L.error("Sending request to flex/info route failed: "+E.message);return o;});}return o;});};P.getResetAndPublishInfoFromSession=function(o){var p=M.getFlexReferenceForControl(o)||"true";return JSON.parse(window.sessionStorage.getItem("sap.ui.fl.info."+p));};P.reset=function(p){var A=C.getAppComponentForSelector(p.selector);var o=C.getFlexControllerInstance(A);var l=[p.layer,p.generator,A,p.selectorIds,p.changeTypes];return o.resetChanges.apply(o,l);};P.publish=function(p){p.styleClass=p.styleClass||"";var A=C.getAppComponentForSelector(p.selector);return C.getFlexControllerInstance(A)._oChangePersistence.transportAllUIChanges({},p.styleClass,p.layer,p.appVariantDescriptors);};P.add=function(p){if(h(p.change)){return p.change.store();}var A=C.getAppComponentForSelector(p.selector);return C.getFlexControllerInstance(A).addPreparedChange(p.change,A);};P.remove=function(p){var o;var A;return Promise.resolve().then(function(){if(!p.selector){return Promise.reject(new Error("An invalid selector was passed so change could not be removed with id: "+p.change.getId()));}A=C.getAppComponentForSelector(p.selector);if(!A){return Promise.reject(new Error("Invalid application component for selector, change could not be removed with id: "+p.change.getId()));}if(h(p.change)){var l=C.getDescriptorFlexControllerInstance(A);l.deleteChange(p.change,A);return undefined;}var E=J.bySelector(p.change.getSelector(),A);o=C.getFlexControllerInstance(A);if(E){F.sync.destroyAppliedCustomData(E,p.change,J);}o.deleteChange(p.change,A);return undefined;});};P.getChangesWarning=function(p){return this._getUIChanges(p).then(function(l){var H=l.some(function(q){return q.isChangeFromOtherSystem();});var s=f.getInstanceOrUndef();var m=s&&s.isProductiveSystemWithTransports();var n=l.length===0;var o={showWarning:false};if(H){o={showWarning:true,warningType:"mixedChangesWarning"};}if(m&&n){o={showWarning:true,warningType:"noChangesAndPSystemWarning"};}return o;});};P._condense=function(p){return Promise.resolve().then(function(){if(!p.selector){throw Error("An invalid selector was passed");}var A=C.getAppComponentForSelector(p.selector);if(!A){throw Error("Invalid application component for selector");}if(!p.changes||p.changes&&!Array.isArray(p.changes)){throw Error("Invalid array of changes");}return a.condense(A,p.changes);});};P._getUIChanges=function(p){if(p.layer){p.currentLayer=p.layer;}return b.getFlexObjects(p).then(function(l){if(p.onlyCurrentVariants){return k(l,p.selector);}return l;});};return P;});
