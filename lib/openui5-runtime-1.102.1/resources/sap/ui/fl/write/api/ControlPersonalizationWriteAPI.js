/*
 * ! OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/Log","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/Core","sap/ui/core/Element","sap/ui/fl/apply/_internal/controlVariants/Utils","sap/ui/fl/apply/api/FlexRuntimeInfoAPI","sap/ui/fl/initial/_internal/changeHandlers/ChangeHandlerStorage","sap/ui/fl/registry/Settings","sap/ui/fl/FlexControllerFactory","sap/ui/fl/Layer","sap/ui/fl/Utils"],function(L,J,C,E,V,F,a,S,b,c,U){"use strict";var m={};function d(o,s){if(!o.changeSpecificData){return Promise.reject(new Error("No changeSpecificData available"));}if(!o.changeSpecificData.changeType){return Promise.reject(new Error("No valid changeType"));}if(!(o.selectorControl instanceof E)){return Promise.reject(new Error("No valid selectorControl"));}var h=o.selectorControl.getMetadata().getName();return a.getChangeHandler(o.changeSpecificData.changeType,h,o.selectorControl,J,s);}function g(A,o,u){var v=V.getRelevantVariantManagementControlId(o,[],u);return J.getSelector(v,A).id;}function e(A){var v=V.getAllVariantManagementControlIds(A);return v.reduce(function(h,s){var o=C.byId(s).getFor();if(o.length){h.push(J.getSelector(s,A).id);}return h;},[]);}function l(M){L.error(M);return Promise.reject(M);}var f={add:function(p){if(!p.changes.length){return Promise.resolve([]);}var r=(p.changes[0].selectorElement||p.changes[0].selectorControl);var A=U.getAppComponentForControl(r);var s=F.getFlexReference({element:r});var o=b.createForControl(A);var v=A.getModel(U.VARIANT_MODEL_NAME);var h=c.USER;var i=[];function j(){var n=[];return p.changes.reduce(function(q,P){return q.then(function(){P.selectorControl=P.selectorElement;return d(P,h);}).then(function(){if(!p.ignoreVariantManagement){if(!P.changeSpecificData.variantReference){var t=g(A,P.selectorControl,p.useStaticArea);if(t){var u=v.oData[t].currentVariant;P.changeSpecificData.variantReference=u;}}}else{delete P.changeSpecificData.variantReference;}P.changeSpecificData=Object.assign(P.changeSpecificData,{developerMode:false,layer:h});return o.addChange(P.changeSpecificData,P.selectorControl);}).then(function(t){n.push({changeInstance:t,selectorControl:P.selectorControl});}).catch(function(t){L.error("A Change was not added successfully. Reason:",t.message);});},Promise.resolve()).then(function(){return n;});}function k(n){return n.reduce(function(q,t){return q.then(function(){return o.applyChange(t.changeInstance,t.selectorControl);}).then(function(u){i.push(u);}).catch(function(u){L.error("A Change was not applied successfully. Reason:",u.message);});},Promise.resolve());}return j().then(k).then(function(){(m[s]||[]).forEach(function(n){n(i);});return i;});},reset:function(p){if(!p.selectors||p.selectors.length===0){return l("At least one control ID has to be provided as a parameter");}var A=p.selectors[0].appComponent||U.getAppComponentForControl(p.selectors[0]);if(!A){return l("App Component could not be determined");}var s=p.selectors.map(function(v){var h=v.id||v.getId();var i=A.getLocalId(h);return i||h;});var o=b.createForControl(A);return o.resetChanges(c.USER,undefined,A,s,p.changeTypes);},restore:function(p){if(!p||!p.selector){return Promise.reject("No selector was provided");}var A=U.getAppComponentForControl(p.selector);if(!A){return Promise.reject("App Component could not be determined");}var o=b.createForControl(A);return o.removeDirtyChanges(c.USER,A,p.selector,p.generator,p.changeTypes);},save:function(p){var A=p.selector.appComponent||U.getAppComponentForControl(p.selector);if(!A){return l("App Component could not be determined");}var o=b.createForControl(A);var v=A.getModel(U.VARIANT_MODEL_NAME);var h=e(A);return o.saveSequenceOfDirtyChanges(p.changes,A).then(function(r){v.checkDirtyStateForControlModels(h);return r;});},buildSelectorFromElementIdAndType:function(p){var A=U.getAppComponentForControl(p.element);if(!A||!p.elementId||!p.elementType){throw new Error("Not enough information given to build selector.");}return{elementId:p.elementId,elementType:p.elementType,appComponent:A,id:p.elementId,controlType:p.elementType};},isCondensingEnabled:function(){return S.getInstance().then(function(s){return s.isCondensingEnabled(c.USER);});},attachChangeCreation:function(o,h){var s=F.getFlexReference({element:o});m[s]=(m[s]||[]).concat(h);},detachChangeCreation:function(o,h){var s=F.getFlexReference({element:o});if(Array.isArray(m[s])){m[s]=m[s].filter(function(r){return r!==h;});}},detachAllChangeCreationListeners:function(o){if(o){var s=F.getFlexReference({element:o});delete m[s];}else{m={};}}};return f;});
