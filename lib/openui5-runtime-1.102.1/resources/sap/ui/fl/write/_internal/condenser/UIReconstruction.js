/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_isEqual","sap/base/util/each","sap/ui/fl/changeHandler/condenser/Classification","sap/ui/fl/write/_internal/condenser/classifications/Create","sap/ui/fl/write/_internal/condenser/classifications/Destroy","sap/ui/fl/write/_internal/condenser/classifications/Move","sap/ui/fl/write/_internal/condenser/Utils"],function(_,e,C,d,D,M,U){"use strict";var f={};var I={create:d,destroy:D,move:M};function g(a,c){e(a,function(O,b){e(b,function(r,t){c(b,O,t,r);});});}function s(E,O,N){E.splice(N,0,E.splice(O,1)[0]);}function h(a,c){var b={};g(a,function(r,t,v,A){var T=v[U.TARGET_UI];T.forEach(function(w){c.forEach(function(x){if(w===x.affectedControl){if(!b[t]){b[t]={};}var y=b[t];if(!y[A]){y[A]=[];}var z=y[A];z.push(x);}});});});return b;}function i(c){return!c.some(function(E){return E.classification!==C.Create;});}function j(E){return!E.some(function(v){return U.isUnknown(v);});}function k(c){return c.getTargetIndex(c.change);}function l(c){c.sort(function(a,b){var r=k(a);var N=k(b);return r-N;});}function m(E){return!E.some(function(v){return!U.isUnknown(v);});}function n(a,b){var c;if(a.length<b.length){c=b.slice(a.length);if(!m(c)){return false;}b=b.slice(0,a.length);}else if(a.length>b.length){c=a.slice(b.length,a.length);if(!m(c)){return false;}a=a.slice(0,b.length);}return _(a,b);}function o(c,a,b,t,r){var v={};r.forEach(function(w){var c=w.targetContainer;if(!v[c]){v[c]={};}var x=v[c];if(!x[a]){x[a]=U.initializeArrayWithPlaceholders(0,b.length-1);}I[w.classification].simulate(x[a],w,b);});var S=v[c][a];if(n(t,S)){return true;}return false;}function u(r,a){g(a,function(b,c,t){t[U.TARGET_UI].forEach(function(T,v){if(!U.isUnknown(T)){var w=r[T];var S=w[U.INDEX_RELEVANT];e(S,function(x,y){if(x!==C.Destroy){y.forEach(function(z){z.setTargetIndex(z.change,v);z.change.condenserState="select";});}});}});});}function p(r,a){g(a,function(b,c,t,K){var v=t[U.INITIAL_UI];var T=t[U.TARGET_UI];if(n(v,T)){T.forEach(function(w){var x=r[w];if(x!==undefined){e(x[U.INDEX_RELEVANT],function(y,z){z.forEach(function(A){A.change.condenserState="delete";});});delete x[U.INDEX_RELEVANT];}});delete b[K];}});}function q(r,a){g(a,function(b,c,t){var v=t[U.INITIAL_UI];var T=t[U.TARGET_UI];v.forEach(function(w,x){var y=r[w];if(!y||!y[U.INDEX_RELEVANT]){var P=U.PLACEHOLDER+x;var z=T.indexOf(w);if(z>=0){T[z]=P;}}});});}f.swapChanges=function(S,a){var b=S.map(function(c){return a.indexOf(c);}).sort();S.forEach(function(c){a[b.shift()]=c;});};f.sortIndexRelatedChanges=function(a,c){var S=[];var b=h(a,c);g(b,function(A,r,c,t){var T=a[r][t][U.TARGET_UI];var v=a[r][t][U.INITIAL_UI];var w=true;if(j(T)||i(c)){l(c);}else if(!o(r,t,v,T,c)){w=false;var x=c.length;while(x!==0&&!w){var O=0;var N=1;while(N<c.length&&!w){s(c,O,N);w=o(r,t,v,T,c);O++;N++;}x--;}}if(!w){throw Error("no correct sorting found for the container: "+r);}c.forEach(function(y){S=S.concat(y.change);});});return S;};f.addChange=function(a,c){return I[c.classification].addToReconstructionMap(a,c);};f.compareAndUpdate=function(r,a){p(r,a);q(r,a);u(r,a);};return f;});
