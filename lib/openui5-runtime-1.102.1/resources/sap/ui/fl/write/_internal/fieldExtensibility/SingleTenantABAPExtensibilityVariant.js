/*
 * ! OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/write/_internal/fieldExtensibility/ABAPExtensibilityVariant","sap/ui/fl/write/_internal/fieldExtensibility/UriParser","sap/ui/fl/write/_internal/fieldExtensibility/Utils"],function(A,U,a){"use strict";var e="/sap/opu/odata/SAP/APS_CUSTOM_FIELD_MAINTENANCE_SRV/";var E={None:-1,Both:0,Fields:1,Logic:2};var n=[{semanticObject:"CustomField",action:"develop"},{semanticObject:"CustomField",action:"manage"},{semanticObject:"CustomLogic",action:"maintain"}];var t=["BTN_FREP_CCF","BTN_ADD_FIELD","BTN_ADD_LOGIC"];var S=A.extend("sap.ui.fl.write._internal.fieldExtensibility.SingleTenantABAPExtensibilityVariant",{_iExtensibilityType:E.None,getExtensionData:function(){return this._oExtensionDataPromise.then(function(b){if(this._containsData(b)){return this._convertBusinessContextsToExtensionData(b);}return null;}.bind(this));},getNavigationUri:function(){return this._oExtensionDataPromise.then(function(b){if(this._containsData(b)&&this._iExtensibilityType!==E.None){return a.getNavigationUriForIntent({target:n[this._iExtensibilityType],params:{businessContexts:b.map(function(B){return B.BusinessContext;}),serviceVersion:this._mServiceInfo.serviceVersion,serviceName:this._mServiceInfo.serviceName,entityType:this._mBindingInfo.entityTypeName}});}Promise.resolve(null);}.bind(this));},getTexts:function(){return this._oExtensionDataPromise.then(function(b){if(this._containsData(b)){return{tooltip:a.getText(t[this._iExtensibilityType]),headerText:a.getText("BUSINESS_CONTEXT_TITLE")};}return null;}.bind(this));},isActive:function(){return this._oExtensionDataPromise.then(function(b){return this._containsData(b);}.bind(this));},_adjustExtensibilityTypeByAuthorizations:function(N,i){if(N[i]){return i;}else if(N[E.Both]){return E.Both;}else if(i===E.Both){if(N[E.Fields]){return E.Fields;}else if(N[E.Logic]){return E.Logic;}}return E.None;},_containsData:function(b){return Boolean(b&&b.length>0);},_convertBusinessContextsToExtensionData:function(b){var c=b.map(function(B){return{description:B.BusinessContextDescription,businessContext:B.BusinessContext};});return{extensionData:c};},_determineExtensionData:function(){return new Promise(function(r,R){a.isNavigationSupportedForIntents(n).then(function(N){var i=N.some(function(b){return b===true;});if(i){a.executeRequest(this._getExtensionDataServiceUri(),this._getExtensionDataServiceParameters()).then(function(o){if(o.errorOccurred===false){var b=this._extractBusinessContextsFromResponse(o.result);this._iExtensibilityType=this._determineExtensibilityType(N,b);if(this._iExtensibilityType!==E.None){r(b);}else{r(null);}}else if(o.statusCode===404&&this._mServiceInfo.serviceType===U.mServiceType.v4){r(null);}else{R(o);}}.bind(this));}else{r(null);}}.bind(this));}.bind(this));},_determineExtensibilityType:function(N,b){var i=this._determineExtensibilityTypeFromBusinessContexts(b);if(i!==E.None){return this._adjustExtensibilityTypeByAuthorizations(N,i);}return i;},_determineExtensibilityTypeFromBusinessContexts:function(b){var s=false;var c=false;b.forEach(function(B){if(B.hasOwnProperty("SupportsLogicEnhancements")===false||B.SupportsLogicEnhancements===true){s=true;}if(B.hasOwnProperty("SupportsStructuralEnhancements")===false||B.SupportsStructuralEnhancements===true){c=true;}});if(s&&c){return E.Both;}else if(!s&&c){return E.Fields;}else if(s&&!c){return E.Logic;}return null;},_extractBusinessContextsFromResponse:function(r){return r.results||[];},_getExtensionDataServiceParameters:function(){var p={EntitySetName:"",EntityTypeName:this._mBindingInfo.entityTypeName};if(this._mServiceInfo.serviceType===U.mServiceType.v4){p.ResourcePath=U.sODataV4ResourcePathPrefix+this._mServiceInfo.serviceName+"/"+this._mServiceInfo.serviceVersion;}else{p.ServiceName=this._mServiceInfo.serviceName;p.ServiceVersion=this._mServiceInfo.serviceVersion;}return p;},_getExtensionDataServiceUri:function(){if(this._mServiceInfo.serviceType===U.mServiceType.v4){return e+"GetBusinessContextsByResourcePath";}return e+"GetBusinessContextsByEntityType";}});return S;});
