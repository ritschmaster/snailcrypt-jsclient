/*
 * ! OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_omit","sap/base/util/restricted/_pick","sap/base/util/UriParameters","sap/ui/fl/Layer","sap/ui/fl/Change","sap/ui/fl/apply/_internal/flexObjects/UpdatableChange","sap/ui/fl/apply/_internal/flexObjects/CompVariant","sap/ui/fl/apply/_internal/flexObjects/RevertData","sap/ui/fl/apply/_internal/flexObjects/CompVariantRevertData","sap/ui/fl/apply/_internal/flexObjects/States","sap/ui/fl/Utils","sap/ui/fl/apply/_internal/flexState/FlexState","sap/ui/fl/apply/_internal/flexState/compVariants/CompVariantMerger","sap/ui/fl/registry/Settings","sap/ui/fl/write/_internal/Storage","sap/ui/fl/write/_internal/Versions","sap/ui/fl/write/api/Version"],function(_,a,U,L,C,b,c,R,d,S,e,F,f,g,h,V,j){"use strict";function k(i,P){var D=l("/draftFilenames",P);if(D){return i.getState()===C.states.NEW||D.includes(i.getFileName());}return true;}function l(P,i){var I=g.getInstanceOrUndef().isVersioningEnabled(i.layer);if(I&&i.layer===L.CUSTOMER){return V.getVersionsModel({reference:e.normalizeReference(i.reference),layer:i.layer}).getProperty(P);}return undefined;}function m(i,P){if(!["defaultVariant","updateVariant"].includes(i.getChangeType())){return false;}var A=i.getLayer()===P.layer;var B=i.getDefinition().packageName;var N=!B||B==="$TMP";return A&&N&&k(i,P);}function n(M,i){if(i.isVariant()){return M.variants;}switch(i.getChangeType()){case"defaultVariant":return M.defaultVariants;case"standardVariant":return M.standardVariants;default:return M.changes;}}function u(O,A){for(var i=0;i<O.length;i++){if(O[i].fileName===A.fileName){O.splice(i,1,A);break;}}}function o(i,A){var P=l("/persistedVersion",{layer:i.getLayer(),reference:i.getDefinition().reference});return h.update({flexObject:i.getDefinition(),layer:i.getLayer(),transport:i.getRequest(),parentVersion:P}).then(function(B){if(B&&B.response){i.setResponse(B.response);if(P){V.onAllChangesSaved({reference:B.response.reference,layer:B.response.layer});}}else{i.setState(S.PERSISTED);}return A;}).then(function(A){var O=n(A.changes.comp,i);u(O,i.getDefinition());return i.getDefinition();});}function p(A,B,D,P){function E(O,A){for(var i=O.length-1;i>=0;i--){if((O[i].fileName||O[i].getFileName())===A.fileName){O.splice(i,1);break;}}}return h.remove({flexObject:A.getDefinition(),layer:A.getLayer(),transport:A.getRequest(),parentVersion:P}).then(function(){delete B.byId[A.getId()];if(A.getChangeType()==="standardVariant"){B.standardVariantChange=undefined;}else{E(n(B,A),A.getDefinition());}return D;}).then(function(D){E(n(D.changes.comp,A),A.getDefinition());return A.getDefinition();});}function q(i){return i&&[S.NEW,S.DIRTY,S.DELETED].includes(i.getState());}function r(i){return i.variants.concat(i.changes).concat(i.defaultVariants).concat(i.standardVariantChange);}function s(P){var i={};if(typeof(P.texts)==="object"){Object.keys(P.texts).forEach(function(A){i[A]={value:P.texts[A],type:"XFLD"};});}return i;}function t(P){if(P.layer){return P.layer;}if(P.isUserDependent){return L.USER;}var i=U.fromQuery(window.location.search).get("sap-ui-layer")||"";i=i.toUpperCase();if(i){return i;}if(!P.fileType==="variant"){return L.CUSTOMER;}var A=g.getInstanceOrUndef().isPublicLayerAvailable();return A?L.PUBLIC:L.CUSTOMER;}function v(P){var i=F.getCompVariantsMap(P.reference)._getOrCreate(P.persistencyKey);return i.byId[P.id];}function w(i){if(i instanceof c){i.removeAllRevertInfo();}}function x(i,P){i.storeExecuteOnSelection(P.executeOnSelection);i.storeFavorite(P.favorite);i.storeContexts(P.contexts);if(P.name){i.setText("variantName",P.name);}i.storeContent(P.content||i.getContent());return i;}function y(i,P){i.setExecuteOnSelection(P.executeOnSelection);i.setFavorite(P.favorite);i.setContexts(P.contexts);if(P.name){i.setName(P.name);}i.setContent(P.content||i.getContent());return i;}var z={};z.setDefault=function(P){var i={defaultVariantName:P.defaultVariantId};P.layer=P.layer||U.fromQuery(window.location.search).get("sap-ui-layer")||L.USER;var A=F.getCompVariantsMap(P.reference)._getOrCreate(P.persistencyKey);var B="defaultVariant";var D=A.defaultVariants;var E=D[D.length-1];if(!E||!m(E,P)){var G={fileName:e.createDefaultFileName(B),fileType:"change",changeType:B,layer:P.layer,content:i,namespace:e.createNamespace(P,"changes"),reference:P.reference,selector:{persistencyKey:P.persistencyKey},support:P.support||{}};G.support.generator=G.support.generator||"CompVariantState."+B;G.support.sapui5Version=sap.ui.version;E=new b(G);A.defaultVariants.push(E);A.byId[E.getId()]=E;E.addRevertInfo(new R({type:z.operationType.NewChange}));}else{E.addRevertInfo(new R({type:z.operationType.ContentUpdate,content:{previousState:E.getState(),previousContent:E.getContent()}}));E.setContent(i);}return E;};z.revertSetDefaultVariantId=function(P){var i=F.getCompVariantsMap(P.reference)._getOrCreate(P.persistencyKey);var D=i.defaultVariants;var A=D[D.length-1];var B=A.popLatestRevertInfo();if(B.getType()===z.operationType.ContentUpdate){A.setContent(B.getContent().previousContent);A.setState(B.getContent().previousState);}else{A.setState(C.states.DELETED);i.defaultVariants.pop();}};z.addVariant=function(P){if(!P){return undefined;}var i=P.changeSpecificData;var I={id:i.id,changeType:i.type,service:i.ODataService,content:i.content||{},reference:P.reference,fileType:"variant",packageName:i.packageName,layer:t(i),selector:{persistencyKey:P.persistencyKey},texts:s(i),command:P.command,generator:P.generator};if(i.favorite!==undefined){I.favorite=i.favorite;}if(i.executeOnSelection!==undefined){I.executeOnSelection=i.executeOnSelection;}if(i.contexts!==undefined){I.contexts=i.contexts;}var A=c.createInitialFileContent(I);var B=new c(A);var D=F.getCompVariantsMap(P.reference);var M=D._getOrCreate(P.persistencyKey);M.variants.push(B);M.byId[B.getId()]=B;return B;};z.updateVariant=function(P){function i(H,I){var K=H.getLayer()===I;var M=H.getPackage();var N=!M||M==="$TMP";var O=H.getChanges().some(function(Q){return Q.getLayer()===I;});return H.getPersisted()&&K&&N&&!O&&k(H,P);}function A(H){return H.getChanges().reverse().find(function(K){return K.getChangeType()==="updateVariant"&&m(K,P);});}function B(P,H,O,K){var M={type:O,change:K,content:{previousState:H.getState(),previousContent:H.getContent(),previousFavorite:H.getFavorite(),previousExecuteOnSelection:H.getExecuteOnSelection(),previousContexts:H.getContexts()}};if(P.name){M.content.previousName=H.getText("variantName");}H.addRevertInfo(new d(M));}function D(P,H){B(P,H,z.operationType.ContentUpdate);if(P.executeOnSelection!==undefined){H.storeExecuteOnSelection(P.executeOnSelection);}if(P.favorite!==undefined){H.storeFavorite(P.favorite);}if(P.contexts){H.storeContexts(P.contexts);}if(P.name){H.storeName(P.name);}if(P.transportId){H.setRequest(P.transportId);}H.storeContent(P.content||H.getContent());}function E(P,H,K){var M=K.getRevertData()||[];var N=K.getContent();var O={previousContent:Object.assign({},N),previousState:K.getState(),change:a(Object.assign({},P),["favorite","executeOnSelection","contexts","content","name"])};M.push(O);K.setRevertData(M);if(P.executeOnSelection!==undefined){H.setExecuteOnSelection(P.executeOnSelection);N.executeOnSelection=P.executeOnSelection;}if(P.favorite!==undefined){H.setFavorite(P.favorite);N.favorite=P.favorite;}if(P.contexts){H.setContexts(P.contexts);N.contexts=P.contexts;}if(P.content){H.setContent(P.content);N.variantContent=P.content;}if(P.name){H.setName(P.name);N.texts={variantName:{value:P.name,type:"XFLD"}};}K.setContent(N);if(P.transportId){K.setRequest(P.transportId);}f.applyChangeOnVariant(H,K);B(P,H,z.operationType.UpdateVariantViaChangeUpdate,K);}function G(P,H){function K(N){var O=N.getDefinition();var Q=F.getCompVariantsMap(N.getComponent());var T=N.getSelector().persistencyKey;Q[T].changes.push(N);Q[T].byId[N.getId()]=N;return O;}var M=C.createInitialFileContent({changeType:"updateVariant",layer:I,fileType:"change",reference:P.reference,packageName:P.packageName,content:{},selector:{persistencyKey:P.persistencyKey,variantId:H.getId()}});["favorite","executeOnSelection","contexts"].forEach(function(O){if(P[O]!==undefined){M.content[O]=P[O];}});if(P.content!==undefined){M.content.variantContent=P.content;}if(P.name){M.texts.variantName={value:P.name,type:"XFLD"};}var N=new C(M);if(P.transportId){N.setRequest(P.transportId);}K(N);B(P,H,z.operationType.NewChange,N);f.applyChangeOnVariant(H,N);}var H=v(P);var I=t(P);if(i(H,I)){D(P,H);}else{var J=A(H);if(J){E(P,H,J);}else{G(P,H);}}return H;};z.operationType={StateUpdate:"StateUpdate",ContentUpdate:"ContentUpdate",NewChange:"NewChange",UpdateVariantViaChange:"UpdateVariantViaChange",UpdateVariantViaChangeUpdate:"UpdateVariantViaChangeUpdate"};z.removeVariant=function(P){var i=v(P);if(!P.revert){var A=new d({type:z.operationType.StateUpdate,content:{previousState:i.getState()}});i.addRevertInfo(A);}i.markForDeletion();return i;};z.revert=function(P){function i(E){var H=E.getSelector().persistencyKey;var I=F.getCompVariantsMap(E.getComponent());delete I[H].byId[E.getId()];I[H].changes=I[H].changes.filter(function(J){return J!==E;});}var A=v(P);var B=A.getRevertInfo().pop();A.removeRevertInfo(B);var D=B.getContent();var E;switch(B.getType()){case z.operationType.ContentUpdate:x(A,Object.assign({name:D.previousName,content:D.previousContent,favorite:D.previousFavorite,executeOnSelection:D.previousExecuteOnSelection,contexts:D.previousContexts},a(P,["reference","persistencyKey","id"])));break;case z.operationType.NewChange:E=B.getChange();A.removeChange(E);i(E);y(A,Object.assign({name:D.previousName,content:D.previousContent,favorite:D.previousFavorite,executeOnSelection:D.previousExecuteOnSelection,contexts:D.previousContexts},a(P,["reference","persistencyKey","id"])));break;case z.operationType.UpdateVariantViaChangeUpdate:E=B.getChange();y(A,Object.assign({name:D.previousName,content:D.previousContent,favorite:D.previousFavorite,executeOnSelection:D.previousExecuteOnSelection,contexts:D.previousContexts},a(P,["reference","persistencyKey","id"])));var G=E.getRevertData().pop();E.setContent(G.previousContent);E.setState(G.previousState);break;case z.operationType.StateUpdate:default:break;}A.setState(D.previousState);return A;};z.overrideStandardVariant=function(P){var i=F.getCompVariantsMap(P.reference)[P.persistencyKey];var A=i.byId[i.standardVariant.getId()];A.setExecuteOnSelection(!!P.executeOnSelection);var B=A.getChanges();A.removeAllChanges();B.forEach(function(D){f.applyChangeOnVariant(A,D);});};z.persist=function(P){function i(H,I,J){return h.write({flexObjects:[H.getDefinition()],layer:H.getLayer(),transport:H.getRequest(),isLegacyVariant:H.isVariant(),parentVersion:J}).then(function(K){if(K&&K.response&&K.response[0]){H.setResponse(K.response[0]);if(J){V.onAllChangesSaved({reference:K.response[0].reference,layer:K.response[0].layer});}}else{H.setState(S.PERSISTED);}return I;}).then(function(I){n(I.changes.comp,H).push(H.getDefinition());return H.getDefinition();});}function A(H,G,I,J){switch(H.getState()){case S.NEW:w(H);return i(H,I,J);case S.DIRTY:w(H);return o(H,I,J);case S.DELETED:w(H);return p(H,G,I,J);default:break;}}var B=P.reference;var D=P.persistencyKey;var E=F.getCompVariantsMap(B);var G=E._getOrCreate(D);return F.getStorageResponse(B).then(function(H){var I=r(G).filter(q);var J=I.map(function(K,M){if(M===0){var N=l("/persistedVersion",{layer:K.getLayer(),reference:K.getDefinition().reference});return A(K,G,H,N).then(function(){var J=I.map(function(K,M){if(M!==0){var O=N?j.Number.Draft:undefined;return A(K,G,H,O);}});return J;});}});return Promise.all(J);});};z.persistAll=function(i){var A=_(F.getCompVariantsMap(i),"_getOrCreate","_initialize");var P=Object.keys(A).map(function(B){return z.persist({reference:i,persistencyKey:B});});return Promise.all(P);};return z;});
