/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/base/ManagedObject","sap/ui/core/Fragment","sap/m/MessageToast","sap/ui/fl/write/_internal/fieldExtensibility/cap/editor/getEditorConfig","sap/base/util/ObjectPath","sap/base/util/deepClone","sap/ui/model/resource/ResourceModel","sap/ui/model/json/JSONModel"],function(M,F,a,g,O,d,R,J){"use strict";var t=sap.ui.getCore().getLibraryResourceBundle("sap.ui.fl");function s(D,i,c){var e=D.getContent()[0];e.setJson(d(i));e.setConfig(g(c));return e;}function p(o){if(!o||!o.element){return{};}var j=d(o);if(!O.get(["element","@Common.Label"],j)){var n=O.get(["element","name"],j);O.set(["element","@Common.Label"],n,j);}var r=O.get(["element","@assert.range"],j);if(O.get(["element","type"],j)==="cds.String"&&Array.isArray(r)){O.set(["element","enum"],r.reduce(function(e,b){e[b]={};return e;},{}),j);O.set(["element","@assert.range"],true,j);}if(j.element.annotations){j.element=Object.assign({},j.element,j.element.annotations);delete j.element.annotations;}var c={extend:j.extend,elements:{}};c.elements[j.element.name]=j.element;return c;}var C=M.extend("sap.ui.fl.write._internal.fieldExtensibility.cap.dialog.CustomFieldCAPDialog",{metadata:{library:"sap.ui.fl",properties:{_dialog:{type:"sap.m.Dialog",visibility:"hidden"}}}});C.prototype.open=function(e,r){var i={element:{name:"NewField",type:"cds.String"},extend:e.boundEntitySet.$Type};var D=this.getProperty("_dialog");if(D){this._oEditor.setJson(d(i));D.open();}else{F.load({name:"sap.ui.fl.write._internal.fieldExtensibility.cap.dialog.CustomFieldCAPDialog",controller:this}).then(function(A){this._oDialogModel=new J({isValid:true});this._oDialogModel.setDefaultBindingMode("OneWay");A.setModel(this._oDialogModel,"dialog");A.setModel(new R({bundle:t}),"i18n");A.addStyleClass(r);this.setProperty("_dialog",A);this._oJson=d(i);this._oEditor=s(A,this._oJson,{entityTypes:e.entityTypes});this._oEditor.attachJsonChange(function(E){this._oJson=E.getParameter("json");}.bind(this));this._oEditor.attachValidationErrorChange(function(E){var h=E.getParameter("hasError");this._oDialogModel.setData({isValid:!h});}.bind(this));A.open();}.bind(this));}};C.prototype.exit=function(){var D=this.getProperty("_dialog");if(D){D.destroy();}if(this.oEditor){this.oEditor.destroy();}};C.prototype.onSave=function(){var c=p(this._oJson);var P={extensions:[JSON.stringify(c)]};var A=new Promise(function(r,b){var x=new XMLHttpRequest();x.open("POST","/-/cds/extensibility/addExtension");x.setRequestHeader("Content-Type","application/json");x.onload=function(){if(x.status>=200&&x.status<400){r(x.response);}else{b({status:x.status,message:x.statusText});}};x.send(JSON.stringify(P));});A.then(function(){a.show(t.getText("CAP_ADD_FIELD_SUCCESS"));});this.getProperty("_dialog").close();};C.prototype.onCancel=function(){this.getProperty("_dialog").close();};return C;});
