/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_union","sap/base/util/includes","sap/base/util/merge","sap/base/util/UriParameters","sap/base/Log","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/Component","sap/ui/fl/apply/_internal/changes/Applier","sap/ui/fl/apply/_internal/changes/Utils","sap/ui/fl/apply/_internal/flexState/changes/DependencyHandler","sap/ui/fl/apply/_internal/flexState/controlVariants/VariantManagementState","sap/ui/fl/apply/_internal/flexState/FlexState","sap/ui/fl/initial/_internal/StorageUtils","sap/ui/fl/registry/Settings","sap/ui/fl/write/_internal/condenser/Condenser","sap/ui/fl/write/_internal/Storage","sap/ui/fl/write/api/Version","sap/ui/fl/Cache","sap/ui/fl/Change","sap/ui/fl/LayerUtils","sap/ui/fl/Layer","sap/ui/fl/Utils","sap/ui/fl/Variant","sap/ui/model/json/JSONModel","sap/ui/performance/Measurement"],function(u,i,m,U,L,J,C,A,a,D,V,F,S,b,c,d,e,f,g,h,j,k,l,n,M){"use strict";var o=function(P){this._mComponent=P;this._mChanges=D.createEmptyDependencyMap();this._bChangesMapCreated=false;this._mChangesInitial=m({},this._mChanges);if(!this._mComponent||!this._mComponent.name){L.error("The Control does not belong to an SAPUI5 component. Personalization and changes for this control might not work as expected.");throw new Error("Missing component name.");}this._aDirtyChanges=[];this._oMessagebundle=undefined;this._mChangesEntries={};this._bHasChangesOverMaxLayer=false;this.HIGHER_LAYER_CHANGES_EXIST="higher_layer_changes_exist";};function p(P,Q){var R;if(Q instanceof g){R=Q;this._mChangesEntries[R.getFileName()]=R;}else{if(!this._mChangesEntries[Q.fileName]){this._mChangesEntries[Q.fileName]=new g(Q);}R=this._mChangesEntries[Q.fileName];R.setState(g.states.PERSISTED);}return R;}o.prototype.getComponentName=function(){return this._mComponent.name;};o.prototype.getCacheKey=function(P){return f.getCacheKey(this._mComponent,P);};function q(P){var Q=P instanceof g?P.getDefinition():P;var R=false;if((Q.fileType==="ctrl_variant")||(Q.fileType==="ctrl_variant_change")||(Q.fileType==="ctrl_variant_management_change")){R=Q.variantManagementReference||Q.variantReference||(Q.selector&&Q.selector.id);}return Q.fileType==="change"||R;}o.prototype.getChangesForComponent=function(P,Q){return k.getUShellService("URLParsing").then(function(R){this._oUShellURLParsingService=R;return f.getChangesFillingCache(this._mComponent,P,Q);}.bind(this)).then(function(P,W){var R=m({},W);var T=P&&P.component&&k.getAppComponentForControl(P.component);var X=S.isStorageResponseFilled(R.changes);if(!X){return[];}var Y=R.changes.changes;if(!this._oMessagebundle&&R.messagebundle&&T){if(!T.getModel("i18nFlexVendor")){if(Y.some(function(d1){return d1.layer===j.VENDOR;})){this._oMessagebundle=R.messagebundle;var Z=new n(this._oMessagebundle);T.setModel(Z,"i18nFlexVendor");}}}var $=P&&P.currentLayer;var _=!(P&&P.ignoreMaxLayerParameter);var a1=function(){return true;};if($){Y=h.filterChangeOrChangeDefinitionsByCurrentLayer(Y,$);}else if(h.isLayerFilteringRequired(this._oUShellURLParsingService)&&_){a1=r.bind(this);Y=Y.filter(a1);}else if(this._bHasChangesOverMaxLayer&&!_){this._bHasChangesOverMaxLayer=false;return this.HIGHER_LAYER_CHANGES_EXIST;}var b1=R.changes&&P&&P.includeCtrlVariants;var c1=this._getAllCtrlVariantChanges(R,b1,a1);Y=Y.concat(c1);return this._checkAndGetChangeInstances(Y,R);}.bind(this,P));};o.prototype._checkAndGetChangeInstances=function(P,Q){return P.filter(q).map(p.bind(this,Q));};function r(P){if(h.isOverMaxLayer(s(P),this._oUShellURLParsingService)){if(!this._bHasChangesOverMaxLayer){this._bHasChangesOverMaxLayer=true;}return false;}return true;}function s(P){var Q;if(P instanceof l||P instanceof g){Q=P.getLayer();}else{Q=P.layer;}return Q;}o.prototype._getAllCtrlVariantChanges=function(P,Q,R){if(!Q){return V.getInitialChanges({reference:this._mComponent.name});}return["variants","variantChanges","variantDependentControlChanges","variantManagementChanges"].reduce(function(T,W){if(P.changes[W]){return T.concat(P.changes[W]);}return T;},[]).filter(R);};o.prototype.loadChangesMapForComponent=function(P){return this.getChangesForComponent({component:P}).then(Q.bind(this));function Q(R){M.start("fl.createDependencyMap","Measurement of creating initial dependency map");this._mChanges=D.createEmptyDependencyMap();R.forEach(this.addChangeAndUpdateDependencies.bind(this,P));this._mChangesInitial=m({},this._mChanges);M.end("fl.createDependencyMap","Measurement of creating initial dependency map");this._bChangesMapCreated=true;return this.getChangesMapForComponent.bind(this);}};o.prototype.checkForOpenDependenciesForControl=function(P,Q){return D.checkForOpenDependenciesForControl(this._mChanges,J.getControlIdBySelector(P,Q),Q);};function t(P){var Q=m({},this._mChangesInitial.mDependencies);return Q[P.getId()];}function v(P,Q,R,T){var W;var X=[];P.controlsDependencies.forEach(function(Y){if(!J.bySelector(Y,R)){W=J.getControlIdBySelector(Y,R);X.push(Y);this._mChanges.mControlsWithDependencies[W]=this._mChanges.mControlsWithDependencies[W]||[];if(!i(this._mChanges.mControlsWithDependencies[W],T.getId())){this._mChanges.mControlsWithDependencies[W].push(T.getId());}}}.bind(this));P.dependencies=Q;P.controlsDependencies=X;if(Q.length||X.length){this._mChanges.mDependencies[T.getId()]=P;}}o.prototype.copyDependenciesFromInitialChangesMapSync=function(P,Q,R){var T=t.call(this,P);if(T){var W=[];T.dependencies.forEach(function(X){if(Q(X)){this._mChanges.mDependentChangesOnMe[X]=this._mChanges.mDependentChangesOnMe[X]||[];this._mChanges.mDependentChangesOnMe[X].push(P.getId());W.push(X);}}.bind(this));v.call(this,T,W,R,P);}return this._mChanges;};o.prototype.copyDependenciesFromInitialChangesMap=function(P,Q,R){var T=t.call(this,P);if(T){var W=[];return T.dependencies.reduce(function(X,Y){return X.then(function(){return Q(Y);}).then(function(Z){if(Z){this._mChanges.mDependentChangesOnMe[Y]=this._mChanges.mDependentChangesOnMe[Y]||[];this._mChanges.mDependentChangesOnMe[Y].push(P.getId());W.push(Y);}}.bind(this));}.bind(this),Promise.resolve()).then(function(){v.call(this,T,W,R,P);return this._mChanges;}.bind(this));}return Promise.resolve(this._mChanges);};o.prototype.addChangeAndUpdateDependencies=function(P,Q,R){Q.setInitialApplyState();if(R){D.insertChange(Q,this._mChanges,R);}D.addChangeAndUpdateDependencies(Q,P,this._mChanges);};o.prototype._addRunTimeCreatedChangeAndUpdateDependencies=function(P,Q){D.addRuntimeChangeAndUpdateDependencies(Q,P,this._mChanges,this._mChangesInitial);};o.prototype.getChangesMapForComponent=function(){return this._mChanges;};o.prototype.getAllUIChanges=function(P){var Q=u(this.getChangesMapForComponent().aChanges,P.includeDirtyChanges&&this.getDirtyChanges()).filter(function(R){return(Boolean(R)&&R.getFileType()==="change"&&h.compareAgainstCurrentLayer(R.getLayer(),P.layer)===0);});return Q;};o.prototype.isChangeMapCreated=function(){return this._bChangesMapCreated;};o.prototype.getChangesForView=function(P){return this.getChangesForComponent(P).then(function(Q){return Q.filter(a.filterChangeByView.bind(undefined,P));});};o.prototype.addChange=function(P,Q){var R=this.addDirtyChange(P);this._addRunTimeCreatedChangeAndUpdateDependencies(Q,R);this._mChangesEntries[R.getFileName()]=R;this._addPropagationListener(Q);return R;};o.prototype.addDirtyChange=function(P){var Q;if(P instanceof g||P instanceof l){Q=P;}else{Q=new g(P);}if(this._aDirtyChanges.indexOf(Q)===-1){this._aDirtyChanges.push(Q);}return Q;};o.prototype._addPropagationListener=function(P){var Q=k.getAppComponentForControl(P);if(Q instanceof C){var R=function(Y){return!Y._bIsSapUiFlFlexControllerApplyChangesOnControl;};var T=Q.getPropagationListeners().every(R);if(T){var W=sap.ui.require("sap/ui/fl/FlexControllerFactory");var X=W.create(this.getComponentName());var Y=A.applyAllChangesForControl.bind(A,this.getChangesMapForComponent.bind(this),Q,X);Y._bIsSapUiFlFlexControllerApplyChangesOnControl=true;Q.addPropagationListener(Y);}}};o.prototype._deleteNotSavedChanges=function(P,Q,R){P.filter(function(T){return!Q.some(function(W){return T.getId()===W.getId();});}).forEach(function(T){if(R){this.removeChange(T);f.deleteChange(this._mComponent,T.getDefinition());}else{this.deleteChange(T);}}.bind(this));};function w(P,Q){var R=P.map(function(W){return W[Q]();});var T=R.filter(function(W,X,R){return R.indexOf(W)===X;});return T.length===1;}function x(P,Q){var R=false;if(!P||Q.length<2||!w(Q,"getLayer")){return false;}var T=Q[0].getLayer();if([j.CUSTOMER,j.USER].includes(T)){R=true;}var W=U.fromURL(window.location.href);if(W.has("sap-ui-xx-condense-changes")){R=W.get("sap-ui-xx-condense-changes")==="true";}return R;}function y(P){var Q=b.getInstanceOrUndef()&&b.getInstanceOrUndef().isCondensingEnabled();if(Q&&!w(P,"getNamespace")){Q=false;}return Q;}function z(P,Q,R,T){this._massUpdateCacheAndDirtyState(Q,R);this._deleteNotSavedChanges(P,Q,T);}function B(P,Q){if(!P.length){return[];}var R=P[0].getLayer();var T=this._mChanges.aChanges.filter(function(W){if(R===j.CUSTOMER&&Q){return W.getState()===g.states.PERSISTED&&Q.includes(W.getFileName());}return W.getState()===g.states.PERSISTED&&h.compareAgainstCurrentLayer(W.getLayer(),R)===0;});return T.concat(P);}o.prototype.saveDirtyChanges=function(P,Q,R,T,W){var X=R||this._aDirtyChanges;var Y=B.call(this,X,W);var Z=(y(Y)&&x(P,Y));var $=Z?Y:X;var _=$.slice(0);var a1=X.slice(0);var b1=G(X);var c1=H(X);if(c1.length===1&&b1.length===1&&c1[0]===g.states.NEW){var d1=Promise.resolve(_);if(x(P,_)){d1=c.condense(P,_);}return d1.then(function(e1){var f1=b1[0];var g1=X[0].getDefinition().layer;if(Z){return d.condense({allChanges:$,condensedChanges:e1,layer:g1,transport:f1,isLegacyVariant:false,parentVersion:T}).then(function(h1){z.call(this,$,e1,Q,true);return h1;}.bind(this));}if(e1.length){return d.write({layer:g1,flexObjects:I(e1),transport:f1,isLegacyVariant:false,parentVersion:T}).then(function(h1){z.call(this,$,e1,Q);return h1;}.bind(this));}this._deleteNotSavedChanges($,e1);}.bind(this));}return this.saveSequenceOfDirtyChanges(a1,Q,T);};o.prototype.saveSequenceOfDirtyChanges=function(P,Q,R){var T;if(R){var W=P.filter(function(X){return X.getState()===g.states.NEW;});T=[].concat(W).shift();}return P.reduce(function(X,Y){return X.then(E.bind(undefined,Y,T,R)).then(this._updateCacheAndDirtyState.bind(this,Y,Q));}.bind(this),Promise.resolve());};function E(P,Q,R){switch(P.getState()){case g.states.NEW:if(R!==undefined){R=P===Q?R:e.Number.Draft;}return d.write({layer:P.getLayer(),flexObjects:[P.getDefinition()],transport:P.getRequest(),parentVersion:R});case g.states.DELETED:return d.remove({flexObject:P.getDefinition(),layer:P.getLayer(),transport:P.getRequest(),parentVersion:R});default:}}o.prototype._updateCacheAndDirtyState=function(P,Q){this._aDirtyChanges=this._aDirtyChanges.filter(function(R){return P.getId()!==R.getId();});if(!Q){if(k.isChangeRelatedToVariants(P)){V.updateVariantsState({reference:this._mComponent.name,changeToBeAddedOrDeleted:P});}else{switch(P.getState()){case g.states.NEW:P.setState(g.states.PERSISTED);f.addChange(this._mComponent,P.getDefinition());break;case g.states.DELETED:f.deleteChange(this._mComponent,P.getDefinition());break;case g.states.DIRTY:P.setState(g.states.PERSISTED);f.updateChange(this._mComponent,P.getDefinition());break;}}}};o.prototype._massUpdateCacheAndDirtyState=function(P,Q){P.forEach(function(R){this._updateCacheAndDirtyState(R,Q);},this);};function G(P){var R=[];P.forEach(function(Q){var T=Q.getRequest();if(R.indexOf(T)===-1){R.push(T);}});return R;}function H(P){var Q=[];P.forEach(function(R){var T=R.getState();if(Q.indexOf(T)===-1){Q.push(T);}});return Q;}function I(P){var Q=[];P.forEach(function(R){Q.push(R.getDefinition());});return Q;}o.prototype.getDirtyChanges=function(){return this._aDirtyChanges;};o.prototype.deleteChange=function(P,R){var Q=this._aDirtyChanges.indexOf(P);if(Q>-1){if(P.getState()===g.states.DELETED){return;}this._aDirtyChanges.splice(Q,1);this._deleteChangeInMap(P,R);return;}P.markForDeletion();this.addDirtyChange(P);this._deleteChangeInMap(P,R);};o.prototype.removeChange=function(P){var Q=this._aDirtyChanges.indexOf(P);if(Q>-1){this._aDirtyChanges.splice(Q,1);}this._deleteChangeInMap(P);};o.prototype._deleteChangeInMap=function(P,R){var Q=P.getId();D.removeChangeFromMap(this._mChanges,Q);D.removeChangeFromDependencies(R?this._mChangesInitial:this._mChanges,Q);};function K(P,Q){return(Q.getRequest()==="$TMP"||Q.getRequest()==="")&&Q.getLayer()===P;}function N(P,Q){return Q.getState()===g.states.PERSISTED&&Q.getLayer()===P;}function O(){var P=[];var Q=F.getCompVariantsMap(this.getComponentName());for(var R in Q){for(var T in Q[R].byId){P.push(Q[R].byId[T]);}}return P;}o.prototype.transportAllUIChanges=function(R,P,Q,T){return this.getChangesForComponent({currentLayer:Q,includeCtrlVariants:true}).then(function(W){var X=O.call(this);W=W.concat(X.filter(K.bind(this,Q)));return d.publish({transportDialogSettings:{rootControl:R,styleClass:P},layer:Q,reference:this.getComponentName(),localChanges:W,appVariantDescriptors:T});}.bind(this));};o.prototype._getChangesFromMapByNames=function(P){return this._mChanges.aChanges.filter(function(Q){return P.indexOf(Q.getFileName())!==-1;});};o.prototype.removeDirtyChanges=function(P,Q,R,T,W){var X=[].concat(P||[]);var Y=this._aDirtyChanges;var Z=Y.filter(function($){var _=true;if(X.length&&!X.includes($.getLayer())){return false;}if(T&&$.getDefinition().support.generator!==T){return false;}if(R){var a1=$.getSelector();_=R.getId()===J.getControlIdBySelector(a1,Q);}if(W){_=_&&W.indexOf($.getChangeType())!==-1;}return _;});Z.forEach(function($){var _=Y.indexOf($);Y.splice(_,1);});return Promise.resolve(Z);};o.prototype.resetChanges=function(P,Q,R,T){var W=R&&R.length>0;var X=T&&T.length>0;var Y=b.getInstanceOrUndef()&&b.getInstanceOrUndef().isPublicLayerAvailable();var Z=Q===undefined&&R===undefined&&T===undefined;var $=[];if(Y&&Z){$=O.call(this).filter(N.bind(this,P));}return this.getChangesForComponent({currentLayer:P,includeCtrlVariants:true}).then(function(_){_=_.concat($);var a1={reference:this.getComponentName(),layer:P,changes:_};if(Q){a1.generator=Q;}if(W){a1.selectorIds=R;}if(X){a1.changeTypes=T;}return d.reset(a1);}.bind(this)).then(function(_){var a1=[];if(R||T){var b1=[];if(_&&_.response&&_.response.length>0){_.response.forEach(function(c1){b1.push(c1.fileName);});}f.removeChanges(this._mComponent,b1);a1=this._getChangesFromMapByNames(b1);}return a1;}.bind(this));};return o;});
