/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/changeHandler/condenser/Classification","sap/ui/fl/changeHandler/Base","sap/ui/fl/apply/api/DelegateMediatorAPI","sap/base/util/merge","sap/base/util/ObjectPath"],function(C,B,D,m,O){"use strict";function i(f){return typeof f==="function";}function g(c){if(c.modelType){return c.modelType;}else if(c.oDataServiceVersion){return"sap.ui.model.odata.v2.ODataModel";}}var a={createAddViaDelegateChangeHandler:function(A){function b(n){return n+A.fieldSuffix;}function c(e,S){if(i(A[S])){return!!A[S]({changeDefinition:e});}return!!A[S];}function s(e){return c(e,"skipCreateLabel");}function d(e){return c(e,"skipCreateLayout");}function f(e,p){var o=p.modifier.bySelector(e.getSelector(),p.appComponent);var M=g(e.getDefinition().content);return D.getDelegateForControl({control:o,modifier:p.modifier,modelType:M,supportsDefault:A.supportsDefault}).then(function(k){var l=!i(k.instance.createLayout);return l||d(e.getDefinition());});}function h(e,k,o){var l=m({},k);l.fieldSelector.id=b(l.fieldSelector.id);return o.createControlForProperty(l).then(function(S){if(s(e)){return S;}var n=k.modifier.getId(S.control);k.labelFor=n;return o.createLabel(k).then(function(L){return{label:L,control:S.control,valueHelp:S.valueHelp};});});}function j(e,k,p){var l=m({aggregationName:A.aggregationName,payload:k.payload||{},parentSelector:e.content.parentId},p);var o=k.instance;return Promise.resolve().then(function(){if(i(o.createLayout)&&!d(e)){return o.createLayout(l);}}).then(function(L){if(O.get("control",L)){L.layoutControl=true;return L;}return h(e,l,o);});}return{applyChange:function(o,e,p){var k=o.getDefinition();var l=p.appComponent;var n=k.content;var F=n.newFieldSelector;var q={appComponent:p.appComponent,view:p.view,fieldSelector:F,bindingPath:n.bindingPath,modifier:p.modifier,element:e};if(p.modifier.bySelector(F,l,p.view)){return B.markAsNotApplicable("Control to be created already exists:"+(F.id||F),true);}var r={newFieldSelector:F};o.setRevertData(r);var M=g(n);return D.getDelegateForControl({control:e,modifier:p.modifier,modelType:M,supportsDefault:A.supportsDefault}).then(function(t){return j(k,t,q);}).then(function(I){var t=m({},{control:e,innerControls:I,change:o},p);return Promise.resolve().then(function(){return A.addProperty(t);}).then(function(){if(I.valueHelp){var v=p.modifier.getSelector(p.modifier.getId(I.valueHelp),l);r.valueHelpSelector=v;}});});},revertChange:function(o,e,p){var k=p.appComponent;var M=p.modifier;var F=o.getRevertData().newFieldSelector;var v=o.getRevertData().valueHelpSelector;var n=M.bySelector(F,k);var P=o.getDependentControl(A.parentAlias,p)||e;return Promise.resolve().then(M.removeAggregation.bind(M,P,A.aggregationName,n)).then(M.destroy.bind(M,n)).then(function(){if(v){var V=M.bySelector(v,k);return Promise.resolve().then(M.removeAggregation.bind(M,P,"dependents",V)).then(M.destroy.bind(M,V));}}).then(function(){var l=m({},{control:e,change:o},p);if(i(A.revertAdditionalControls)){return Promise.resolve().then(function(){return A.revertAdditionalControls(l);}).then(function(){o.resetRevertData();});}});},completeChangeContent:function(o,S,p){var k=p.appComponent;var l=o.getDefinition();if(!l.content){l.content={};}if(S.parentId){if(i(A.mapParentIdIntoChange)){A.mapParentIdIntoChange(o,S,p);}else{o.addDependentControl(S.parentId,A.parentAlias,p);}try{l.content.parentId=p.modifier.getSelector(S.parentId,k);}catch(e){}}else{throw new Error("mSpecificChangeInfo.parentId attribute required");}if(S.bindingPath){l.content.bindingPath=S.bindingPath;}else{throw new Error("mSpecificChangeInfo.bindingPath attribute required");}if(S.newControlId){l.content.newFieldSelector=p.modifier.getSelector(S.newControlId,k);}else{throw new Error("mSpecificChangeInfo.newControlId attribute required");}if(S.index===undefined){throw new Error("mSpecificChangeInfo.targetIndex attribute required");}else{l.content.newFieldIndex=S.index;}if(S.oDataServiceVersion){l.content.oDataServiceVersion=S.oDataServiceVersion;}if(S.modelType&&A.supportsDefault){l.content.modelType=S.modelType;}},getChangeVisualizationInfo:function(o){var r=o.getRevertData();if(r&&r.labelSelector){return{affectedControls:[r.labelSelector]};}return{affectedControls:[o.getContent().newFieldSelector]};},getCondenserInfo:function(o,p){return f(o,p).then(function(e){if(!e){return undefined;}if(!o.getContent().newFieldSelector||!o.getContent().parentId||!A.aggregationName){return undefined;}return{affectedControl:o.getContent().newFieldSelector,classification:C.Create,targetContainer:o.getContent().parentId,targetAggregation:A.aggregationName,setTargetIndex:function(o,n){o.getContent().newFieldIndex=n;},getTargetIndex:function(o){return o.getContent().newFieldIndex;}};});}};}};return a;});
