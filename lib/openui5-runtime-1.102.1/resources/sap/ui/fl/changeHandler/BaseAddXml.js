/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/changeHandler/Base","sap/base/util/LoaderExtensions","sap/ui/fl/changeHandler/common/revertAddedControls","sap/ui/fl/Utils"],function(B,L,r,F){"use strict";var a={};a.applyChange=function(c,C,p,m){var M=p.modifier;var v=p.view;var A=m.aggregationName;var o;var i=m.index;var R=[];var s=c.getModuleName();var f;var n;var b=function(){var P=[];n.forEach(function(N,I){var d=function(){return Promise.resolve().then(M.insertAggregation.bind(M,C,A,N,i+I,v,m.skipAdjustIndex)).then(function(){R.push({id:M.getId(N),aggregationName:A});});};P.push(d);});return F.execPromiseQueueSequentially(P,true,true).then(function(){c.setRevertData(R);return n;});};return Promise.resolve().then(M.findAggregation.bind(M,C,A)).then(function(d){o=d;if(!o){return Promise.reject(new Error("The given Aggregation is not available in the given control: "+M.getId(C)));}return L.loadResource(s,{dataType:"text"});}).then(function(l){f=l;return B.instantiateFragment(c,p);}).then(function(d){n=d;var P=[];n.forEach(function(N,I){var e=function(){return Promise.resolve().then(M.validateType.bind(M,N,o,C,f,I)).then(function(V){if(!V){a._destroyArrayOfControls(n);return Promise.reject(new Error("The content of the xml fragment does not match the type of the targetAggregation: "+o.type));}});};P.push(e);});return F.execPromiseQueueSequentially(P,true,true).then(b);});};a.revertChange=r;a._throwMissingAttributeError=function(A){throw new Error("Attribute missing from the change specific content'"+A+"'");};a._destroyArrayOfControls=function(c){c.forEach(function(C){if(C.destroy){C.destroy();}});};a.completeChangeContent=function(c,s,C){if(!C){C=c.getDefinition();if(!C.content){C.content={};}}if(s.fragmentPath){C.content.fragmentPath=s.fragmentPath;}else{a._throwMissingAttributeError("fragmentPath");}var m=C.reference.replace(/\.Component/g,"").replace(/\./g,"/");m+="/changes/";m+=C.content.fragmentPath;c.setModuleName(m);};return a;},true);
