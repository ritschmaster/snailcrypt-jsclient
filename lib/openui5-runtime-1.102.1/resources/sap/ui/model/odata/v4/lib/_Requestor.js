/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./_Batch","./_GroupLock","./_Helper","./_V2Requestor","sap/base/Log","sap/ui/base/SyncPromise","sap/ui/core/cache/CacheManager","sap/ui/thirdparty/jquery"],function(_,a,b,c,L,S,C,q){"use strict";var B={Accept:"multipart/mixed"},s="sap.ui.model.odata.v4.optimisticBatch:",d="sap.ui.model.odata.v4.lib._Requestor",m="@com.sap.vocabularies.Common.v1.Messages",r=/(\$\w+)=~/g,e=/^\d+$/;function g(H){var o=Object.assign({},H);delete o["X-CSRF-Token"];return o;}function f(H){var R;H=H.toLowerCase();for(R in this.headers){if(R.toLowerCase()===H){return this.headers[R];}}}function h(i,H,Q,M){this.mBatchQueue={};this.bBatchSent=false;this.mHeaders=H||{};this.aLockedGroupLocks=[];this.oModelInterface=M;this.oOptimisticBatch=null;this.sQueryParams=b.buildQuery(Q);this.mRunningChangeRequests={};this.iSessionTimer=0;this.iSerialNumber=0;this.sServiceUrl=i;this.vStatistics=Q&&Q["sap-statistics"];this.processSecurityTokenHandlers();}h.prototype.mFinalHeaders={"Content-Type":"application/json;charset=UTF-8;IEEE754Compatible=true"};h.prototype.mPredefinedPartHeaders={Accept:"application/json;odata.metadata=minimal;IEEE754Compatible=true"};h.prototype.mPredefinedRequestHeaders={Accept:"application/json;odata.metadata=minimal;IEEE754Compatible=true","OData-MaxVersion":"4.0","OData-Version":"4.0","X-CSRF-Token":"Fetch"};h.prototype.mReservedHeaders={accept:true,"accept-charset":true,"content-encoding":true,"content-id":true,"content-language":true,"content-length":true,"content-transfer-encoding":true,"content-type":true,"if-match":true,"if-none-match":true,isolation:true,"odata-isolation":true,"odata-maxversion":true,"odata-version":true,prefer:true,"sap-contextid":true};h.prototype.addChangeSet=function(G){var i=[],R=this.getOrCreateBatchQueue(G);i.iSerialNumber=this.getSerialNumber();R.iChangeSet+=1;R.splice(R.iChangeSet,0,i);};h.prototype.addChangeToGroup=function(o,G){var R;if(this.getGroupSubmitMode(G)==="Direct"){o.$resolve(this.request(o.method,o.url,this.lockGroup(G,this,true,true),o.headers,o.body,o.$submit,o.$cancel));}else{R=this.getOrCreateBatchQueue(G);R[R.iChangeSet].push(o);}};h.prototype.addQueryString=function(R,M,Q){var i;Q=this.convertQueryOptions(M,Q,false,true);R=R.replace(r,function(j,o){var v=Q[o];delete Q[o];return b.encodePair(o,v);});i=b.buildQuery(Q);if(!i){return R;}return R+(R.includes("?")?"&"+i.slice(1):i);};h.prototype.batchRequestSent=function(G,R,H){var p,i;if(H){if(!(G in this.mRunningChangeRequests)){this.mRunningChangeRequests[G]=[];}p=new S(function(j){i=j;});p.$resolve=i;p.$requests=R;this.mRunningChangeRequests[G].push(p);}};h.prototype.batchResponseReceived=function(G,R,H){var p;if(H){p=this.mRunningChangeRequests[G].filter(function(P){if(P.$requests===R){P.$resolve();return false;}return true;});if(p.length){this.mRunningChangeRequests[G]=p;}else{delete this.mRunningChangeRequests[G];}}};h.prototype.buildQueryString=function(M,Q,D,i){return b.buildQuery(this.convertQueryOptions(M,Q,D,i));};h.prototype.cancelChanges=function(G){if(this.mRunningChangeRequests[G]){throw new Error("Cannot cancel the changes for group '"+G+"', the batch request is running");}this.cancelChangesByFilter(function(){return true;},G);this.cancelGroupLocks(G);};h.prototype.cancelChangesByFilter=function(F,G){var k=false,t=this;function l(n){var o=t.mBatchQueue[n],p,u,E,i,j;for(j=o.length-1;j>=0;j-=1){if(Array.isArray(o[j])){u=o[j];for(i=u.length-1;i>=0;i-=1){p=u[i];if(p.$cancel&&F(p)){p.$cancel();E=new Error("Request canceled: "+p.method+" "+p.url+"; group: "+n);E.canceled=true;p.$reject(E);u.splice(i,1);k=true;}}}}}if(G){if(this.mBatchQueue[G]){l(G);}}else{for(G in this.mBatchQueue){l(G);}}return k;};h.prototype.cancelGroupLocks=function(G){this.aLockedGroupLocks.forEach(function(o){if((!G||G===o.getGroupId())&&o.isModifying()&&o.isLocked()){o.cancel();}});};h.prototype.checkConflictingStrictRequest=function(R,j,k){function l(o,i){return k!==i&&o.some(n);}function n(R){return R.headers["Prefer"]==="handling=strict";}if(n(R)&&j.slice(0,j.iChangeSet+1).some(l)){throw new Error("All requests with strict handling must belong to the same change set");}};h.prototype.checkForOpenRequests=function(){var t=this;if(Object.keys(this.mRunningChangeRequests).length||Object.keys(this.mBatchQueue).some(function(G){return t.mBatchQueue[G].some(function(R){return Array.isArray(R)?R.length:true;});})||this.aLockedGroupLocks.some(function(G){return G.isLocked();})){throw new Error("Unexpected open requests");}};h.prototype.checkHeaderNames=function(H){var k;for(k in H){if(this.mReservedHeaders[k.toLowerCase()]){throw new Error("Unsupported header: "+k);}}};h.prototype.cleanUpChangeSets=function(R){var j,H=false,i;function k(o){if(!l(o)){j.push(o);}}function l(o){if(o.method!=="PATCH"){return false;}return j.some(function(n){if(n.method==="PATCH"&&n.headers["If-Match"]===o.headers["If-Match"]){b.merge(n.body,o.body);o.$resolve(n.$promise);return true;}});}for(i=R.iChangeSet;i>=0;i-=1){j=[];R[i].forEach(k);if(j.length===0){R.splice(i,1);}else if(j.length===1&&this.isChangeSetOptional()){R[i]=j[0];}else{R[i]=j;}H=H||j.length>0;}return H;};h.prototype.clearSessionContext=function(t){if(t){this.oModelInterface.fireSessionTimeout();}delete this.mHeaders["SAP-ContextId"];if(this.iSessionTimer){clearInterval(this.iSessionTimer);this.iSessionTimer=0;}};h.prototype.convertExpand=function(E,i){var k,R=[],t=this;if(!E||typeof E!=="object"){throw new Error("$expand must be a valid object");}k=Object.keys(E);if(i){k=k.sort();}k.forEach(function(j){var v=E[j];if(v&&typeof v==="object"){R.push(t.convertExpandOptions(j,v,i));}else{R.push(j);}});return R.join(",");};h.prototype.convertExpandOptions=function(E,v,i){var j=[];this.doConvertSystemQueryOptions(undefined,v,function(o,O){j.push(o+"="+O);},undefined,i);return j.length?E+"("+j.join(";")+")":E;};h.prototype.convertQueryOptions=function(M,Q,D,i){var j={};if(!Q){return undefined;}this.doConvertSystemQueryOptions(M,Q,function(k,v){j[k]=v;},D,i);return j;};h.prototype.convertResourcePath=function(R){return R;};h.prototype.destroy=function(){this.clearSessionContext();};h.prototype.doCheckVersionHeader=function(G,R,v){var o=G("OData-Version"),D=!o&&G("DataServiceVersion");if(D){throw new Error("Expected 'OData-Version' header with value '4.0' but received"+" 'DataServiceVersion' header with value '"+D+"' in response for "+this.sServiceUrl+R);}if(o==="4.0"||!o&&v){return;}throw new Error("Expected 'OData-Version' header with value '4.0' but received value '"+o+"' in response for "+this.sServiceUrl+R);};h.prototype.doConvertResponse=function(R,i){return R;};h.prototype.doConvertSystemQueryOptions=function(i,Q,R,D,j){var t=this;Object.keys(Q).forEach(function(k){var v=Q[k];if(D&&k[0]==="$"){return;}switch(k){case"$expand":if(v!=="~"){v=t.convertExpand(v,j);}break;case"$select":if(Array.isArray(v)){v=j?v.slice().sort().join(","):v.join(",");}break;default:}R(k,v);});};h.prototype.fetchType=function(t,M){var i=this;if(M in t){return S.resolve(t[M]);}return this.fetchTypeForPath(M).then(function(T){var o,p=[];if(T){o=i.getModelInterface().fetchMetadata(M+"/"+m).getResult();if(o){T=Object.create(T);T[m]=o;}t[M]=T;(T.$Key||[]).forEach(function(k){if(typeof k==="object"){k=k[Object.keys(k)[0]];p.push(i.fetchType(t,M+"/"+k.slice(0,k.lastIndexOf("/"))));}});return S.all(p).then(function(){return T;});}});};h.prototype.fetchTypeForPath=function(M,A){return this.oModelInterface.fetchMetadata(M+(A?"/$Type":"/"));};h.prototype.formatPropertyAsLiteral=function(v,p){return b.formatLiteral(v,p.$Type);};h.prototype.getGroupSubmitMode=function(G){return this.oModelInterface.getGroupProperty(G,"submit");};h.prototype.getModelInterface=function(){return this.oModelInterface;};h.prototype.getOrCreateBatchQueue=function(G){var i,R=this.mBatchQueue[G];if(!R){i=[];i.iSerialNumber=0;R=this.mBatchQueue[G]=[i];R.iChangeSet=0;this.oModelInterface.onCreateGroup(G);}return R;};h.prototype.getPathAndAddQueryOptions=function(p,o,P){var A=[],n,N={},i,t=this;p=p.slice(1,-5);if(o.$Parameter){o.$Parameter.forEach(function(i){N[i.$Name]=i;});}if(o.$kind==="Function"){for(n in P){i=N[n];if(i){if(i.$isCollection){throw new Error("Unsupported collection-valued parameter: "+n);}A.push(encodeURIComponent(n)+"="+encodeURIComponent(t.formatPropertyAsLiteral(P[n],i)));}}p+="("+A.join(",")+")";}else{for(n in P){if(!(n in N)){delete P[n];}}}return p;};h.prototype.getSerialNumber=function(){this.iSerialNumber+=1;return this.iSerialNumber;};h.prototype.getServiceUrl=function(){return this.sServiceUrl;};h.prototype.getUnlockedAutoCopy=function(G){if(this.getGroupSubmitMode(G.getGroupId())!=="API"){return G.getUnlockedCopy();}return this.lockGroup("$auto",G.getOwner());};h.prototype.hasChanges=function(G,E){var R=this.mBatchQueue[G];if(R){return R.some(function(v){return Array.isArray(v)&&v.some(function(o){return o.headers["If-Match"]===E;});});}return false;};h.prototype.hasPendingChanges=function(G){var t=this;function i(M){if(!G){return Object.keys(M);}return G in M?[G]:[];}return i(this.mRunningChangeRequests).length>0||this.aLockedGroupLocks.some(function(o){var j=o.getGroupId();return(G===undefined||j===G)&&o.isModifying()&&o.isLocked()&&!j.startsWith("$inactive.");})||i(this.mBatchQueue).some(function(j){return!j.startsWith("$inactive.")&&t.mBatchQueue[j].some(function(R){return Array.isArray(R)&&R.some(function(o){return o.$cancel;});});});};h.prototype.isActionBodyOptional=function(){return false;};h.prototype.isBatchSent=function(){return this.bBatchSent;};h.prototype.isChangeSetOptional=function(){return true;};h.prototype.mergeGetRequests=function(R){var i=[],t=this;function j(o){return o.$queryOptions&&i.some(function(k){if(k.$queryOptions&&o.url===k.url&&o.$owner===k.$owner){b.aggregateExpandSelect(k.$queryOptions,o.$queryOptions);o.$resolve(k.$promise);if(k.$mergeRequests&&o.$mergeRequests){k.$mergeRequests(o.$mergeRequests());}return true;}return false;});}R.forEach(function(o){if(!j(o)){i.push(o);}});i.forEach(function(o){if(o.$queryOptions){o.url=t.addQueryString(o.url,o.$metaPath,o.$queryOptions);}});i.iChangeSet=R.iChangeSet;return i;};h.prototype.processBatch=function(G){var H,R=this.mBatchQueue[G]||[],t=this;function o(i){if(Array.isArray(i)){i.forEach(o);}else if(i.$submit){i.$submit();}}function j(E,i){if(Array.isArray(i)){i.forEach(j.bind(null,E));}else{i.$reject(E);}}function v(R,k){var l;R.forEach(function(n,p){var E,u,w,x=k[p];if(Array.isArray(x)){v(n,x);}else if(!x){E=new Error("HTTP request was not processed because the previous request failed");E.cause=l;E.$reported=true;n.$reject(E);}else if(x.status>=400){x.getResponseHeader=f;l=b.createError(x,"Communication error",n.url?t.sServiceUrl+n.url:undefined,n.$resourcePath);if(Array.isArray(n)){b.decomposeError(l,n,t.sServiceUrl).forEach(function(E,i){n[i].$reject(E);});}else{n.$reject(l);}}else{if(x.responseText){try{t.doCheckVersionHeader(f.bind(x),n.url,true);w=t.doConvertResponse(JSON.parse(x.responseText),n.$metaPath);}catch(y){n.$reject(y);return;}}else{w=n.method==="GET"?null:{};}t.reportHeaderMessages(n.url,f.call(x,"sap-messages"));u=f.call(x,"ETag");if(u){w["@odata.etag"]=u;}n.$resolve(w);}});}delete this.mBatchQueue[G];o(R);H=this.cleanUpChangeSets(R);if(R.length===0){return Promise.resolve();}this.bBatchSent=true;R=this.mergeGetRequests(R);this.batchRequestSent(G,R,H);return this.sendBatch(R,G).then(function(i){v(R,i);}).catch(function(E){var i=new Error("HTTP request was not processed because $batch failed");i.cause=E;j(i,R);throw E;}).finally(function(){t.batchResponseReceived(G,R,H);});};h.prototype.ready=function(){return S.resolve();};h.prototype.lockGroup=function(G,o,l,M,i){var j;j=new a(G,o,l,M,this.getSerialNumber(),i);if(l){this.aLockedGroupLocks.push(j);}return j;};h.prototype.processOptimisticBatch=function(R,G){var i,k,o=this.oOptimisticBatch,O,t=this;if(!o){return;}k=o.key;this.oOptimisticBatch=null;if(o.result){if(h.matchesOptimisticBatch(R,G,o.firstBatch.requests,o.firstBatch.groupId)){L.info("optimistic batch: success, response consumed",k,d);return o.result;}C.del(s+k).catch(this.oModelInterface.getReporter());L.warning("optimistic batch: mismatch, response skipped",k,d);}O=this.oModelInterface.getOptimisticBatchEnabler();if(O){i=R.some(function(j){return Array.isArray(j)||j.method!=="GET";});if(i){L.warning("optimistic batch: modifying batch not supported",k,d);return;}Promise.resolve(O(k)).then(function(E){if(E){return C.set(s+k,{groupId:G,requests:R.map(function(j){return{headers:g(j.headers),method:"GET",url:j.url};})}).then(function(){L.info("optimistic batch: enabled, batch payload saved",k,d);});}L.info("optimistic batch: disabled",k,d);}).catch(t.oModelInterface.getReporter());}};h.prototype.processSecurityTokenHandlers=function(){var t=this;this.oSecurityTokenPromise=null;sap.ui.getCore().getConfiguration().getSecurityTokenHandlers().some(function(H){var o=H(t.sServiceUrl);if(o!==undefined){t.oSecurityTokenPromise=o.then(function(i){t.checkHeaderNames(i);Object.assign(t.mHeaders,{"X-CSRF-Token":undefined},i);t.oSecurityTokenPromise=null;}).catch(function(E){L.error("An error occurred within security token handler: "+H,E,d);throw E;});return true;}});};h.prototype.refreshSecurityToken=function(o){var t=this;if(!this.oSecurityTokenPromise){if(o!==this.mHeaders["X-CSRF-Token"]){return Promise.resolve();}this.oSecurityTokenPromise=new Promise(function(R,i){q.ajax(t.sServiceUrl+t.sQueryParams,{method:"HEAD",headers:Object.assign({},t.mHeaders,{"X-CSRF-Token":"Fetch"})}).then(function(j,k,l){var n=l.getResponseHeader("X-CSRF-Token");if(n){t.mHeaders["X-CSRF-Token"]=n;}else{delete t.mHeaders["X-CSRF-Token"];}t.oSecurityTokenPromise=null;R();},function(j){t.oSecurityTokenPromise=null;i(b.createError(j,"Could not refresh security token"));});});}return this.oSecurityTokenPromise;};h.prototype.relocate=function(j,o,n){var R=this.mBatchQueue[j],t=this,F=R&&R[0].some(function(k,i){if(k.body===o){t.addChangeToGroup(k,n);R[0].splice(i,1);return true;}});if(!F){throw new Error("Request not found in group '"+j+"'");}};h.prototype.relocateAll=function(i,n,E){var j=0,R=this.mBatchQueue[i],t=this;if(R){R[0].slice().forEach(function(o){if(!E||o.headers["If-Match"]===E){t.addChangeToGroup(o,n);R[0].splice(j,1);}else{j+=1;}});}};h.prototype.removePatch=function(p){var i=this.cancelChangesByFilter(function(o){return o.$promise===p;});if(!i){throw new Error("Cannot reset the changes, the batch request is running");}};h.prototype.removePost=function(G,E){var o=b.getPrivateAnnotation(E,"postBody"),i=this.cancelChangesByFilter(function(j){return j.body===o;},G);if(!i){throw new Error("Cannot reset the changes, the batch request is running");}};h.prototype.reportHeaderMessages=function(R,M){if(M){this.oModelInterface.reportTransitionMessages(JSON.parse(M),R);}};h.prototype.request=function(M,R,G,H,p,i,j,k,o,A,Q,O,l){var n,E,t=G&&G.getGroupId()||"$direct",P,u=Infinity,v,w=this;if(t==="$cached"){E=new Error("Unexpected request: "+M+" "+R);E.$cached=true;throw E;}if(G&&G.isCanceled()){if(j){j();}E=new Error("Request already canceled");E.canceled=true;return Promise.reject(E);}if(G){G.unlock();u=G.getSerialNumber();}R=this.convertResourcePath(R);o=o||R;if(this.getGroupSubmitMode(t)!=="Direct"){P=new Promise(function(x,y){var z=w.getOrCreateBatchQueue(t);v={method:M,url:R,headers:Object.assign({},w.mPredefinedPartHeaders,w.mHeaders,H,w.mFinalHeaders),body:p,$cancel:j,$mergeRequests:l,$metaPath:k,$owner:O,$queryOptions:Q,$reject:y,$resolve:x,$resourcePath:o,$submit:i};if(M==="GET"){z.push(v);}else if(A){z[0].unshift(v);}else{n=z.iChangeSet;while(z[n].iSerialNumber>u){n-=1;}w.checkConflictingStrictRequest(v,z,n);z[n].push(v);}});v.$promise=P;return P;}if(this.vStatistics!==undefined){Q=Object.assign({"sap-statistics":this.vStatistics},Q);}if(Q){R=w.addQueryString(R,k,Q);}if(i){i();}return this.sendRequest(M,R,Object.assign({},H,this.mFinalHeaders),JSON.stringify(p),o).then(function(x){w.reportHeaderMessages(x.resourcePath,x.messages);return w.doConvertResponse(x.body,k);});};h.prototype.sendBatch=function(R,G){var o=_.serializeBatchRequest(R,this.getGroupSubmitMode(G)==="Auto"?"Group ID: "+G:"Group ID (API): "+G);return this.processOptimisticBatch(R,G)||this.sendRequest("POST","$batch"+this.sQueryParams,Object.assign(o.headers,B),o.body).then(function(i){if(i.messages!==null){throw new Error("Unexpected 'sap-messages' response header for batch request");}return _.deserializeBatchResponse(i.contentType,i.body);});};h.prototype.sendOptimisticBatch=function(){var k=window.location.href,t=this;C.get(s+k).then(function(F){var o={key:k};if(F){if(t.isBatchSent()){L.error("optimistic batch: #sendBatch called before optimistic batch "+"payload could be read",undefined,d);return;}o.firstBatch=F;o.result=t.sendBatch(F.requests,F.groupId);L.info("optimistic batch: sent ",k,d);}t.oOptimisticBatch=o;}).catch(this.oModelInterface.getReporter());};h.prototype.sendRequest=function(M,R,H,p,o){var i=this.sServiceUrl+R,t=this;return new Promise(function(j,k){function l(I){var O=t.mHeaders["X-CSRF-Token"];return q.ajax(i,{contentType:H&&H["Content-Type"],data:p,headers:Object.assign({},t.mPredefinedRequestHeaders,t.mHeaders,b.resolveIfMatchHeader(H)),method:M}).then(function(v,n,u){var E=u.getResponseHeader("ETag"),w=u.getResponseHeader("X-CSRF-Token");try{t.doCheckVersionHeader(u.getResponseHeader,R,!v);}catch(x){k(x);return;}if(w){t.mHeaders["X-CSRF-Token"]=w;}t.setSessionContext(u.getResponseHeader("SAP-ContextId"),u.getResponseHeader("SAP-Http-Session-Timeout"));if(!v){v=M==="GET"?null:{};}if(E&&typeof v==="object"){v["@odata.etag"]=E;}j({body:v,contentType:u.getResponseHeader("Content-Type"),messages:u.getResponseHeader("sap-messages"),resourcePath:R});},function(n){var u=n.getResponseHeader("SAP-ContextId"),v=n.getResponseHeader("X-CSRF-Token"),w;if(!I&&n.status===403&&v&&v.toLowerCase()==="required"){t.refreshSecurityToken(O).then(function(){l(true);},k);}else{w="Communication error";if(u){t.setSessionContext(u,n.getResponseHeader("SAP-Http-Session-Timeout"));}else if(t.mHeaders["SAP-ContextId"]){w="Session not found on server";L.error(w,undefined,d);t.clearSessionContext(true);}k(b.createError(n,w,i,o));}});}if(t.oSecurityTokenPromise&&M!=="GET"){t.oSecurityTokenPromise.then(l);}else{l();}});};h.prototype.setSessionContext=function(i,j){var t=e.test(j)?parseInt(j):0,k=Date.now()+30*60*1000,l=this;this.clearSessionContext();if(i){l.mHeaders["SAP-ContextId"]=i;if(t>=60){this.iSessionTimer=setInterval(function(){if(Date.now()>=k){l.clearSessionContext(true);}else{q.ajax(l.sServiceUrl+l.sQueryParams,{method:"HEAD",headers:{"SAP-ContextId":l.mHeaders["SAP-ContextId"]}}).fail(function(n){if(n.getResponseHeader("SAP-Err-Id")==="ICMENOSESSION"){L.error("Session not found on server",undefined,d);l.clearSessionContext(true);}});}},(t-5)*1000);}else if(j!==null){L.warning("Unsupported SAP-Http-Session-Timeout header",j,d);}}};h.prototype.submitBatch=function(G){var i,p,t=this;p=S.all(this.aLockedGroupLocks.map(function(o){return o.waitFor(G);}));i=p.isPending();if(i){L.info("submitBatch('"+G+"') is waiting for locks",null,d);}return p.then(function(){if(i){L.info("submitBatch('"+G+"') continues",null,d);}t.aLockedGroupLocks=t.aLockedGroupLocks.filter(function(o){return o.isLocked();});return t.processBatch(G);});};h.prototype.waitForBatchResponseReceived=function(G){return this.mBatchQueue[G][0][0].$promise;};h.prototype.waitForRunningChangeRequests=function(G){var p=this.mRunningChangeRequests[G];if(p){return p.length>1?S.all(p):p[0];}return S.resolve();};h.matchesOptimisticBatch=function(A,j,o,O){return j===O&&A.length===o.length&&A.every(function(k,i){return k.url===o[i].url&&b.deepEqual(g(k.headers),o[i].headers);});};h.create=function(i,M,H,Q,o){var R=new h(i,H,Q,M);if(o==="2.0"){c(R);}return R;};return h;},false);
