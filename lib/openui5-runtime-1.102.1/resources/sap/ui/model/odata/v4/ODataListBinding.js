/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./Context","./ODataParentBinding","./lib/_AggregationCache","./lib/_AggregationHelper","./lib/_Cache","./lib/_GroupLock","./lib/_Helper","./lib/_Parser","sap/base/Log","sap/base/util/uid","sap/ui/base/SyncPromise","sap/ui/model/Binding","sap/ui/model/ChangeReason","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/FilterProcessor","sap/ui/model/FilterType","sap/ui/model/ListBinding","sap/ui/model/Sorter","sap/ui/model/odata/OperationMode"],function(C,a,_,b,c,d,e,f,L,u,S,B,g,F,h,j,k,l,m,O){"use strict";var s="sap.ui.model.odata.v4.ODataListBinding",n={AggregatedDataStateChange:true,change:true,createActivate:true,createCompleted:true,createSent:true,dataReceived:true,dataRequested:true,DataStateChange:true,patchCompleted:true,patchSent:true,refresh:true},o=l.extend("sap.ui.model.odata.v4.ODataListBinding",{constructor:p});function p(M,P,i,v,q,r){l.call(this,M,P);a.call(this);if(P.endsWith("/")){throw new Error("Invalid path: "+P);}r=e.clone(r)||{};this.checkBindingParameters(r,["$$aggregation","$$canonicalPath","$$getKeepAliveContext","$$groupId","$$operationMode","$$ownRequest","$$patchWithoutSideEffects","$$sharedRequest","$$updateGroupId"]);this.iActiveContexts=0;this.aApplicationFilters=e.toArray(q);this.sChangeReason=M.bAutoExpandSelect&&!r.$$aggregation?"AddVirtualContext":undefined;this.iCreatedContexts=0;this.oDiff=undefined;this.aFilters=[];this.sGroupId=r.$$groupId;this.bHasAnalyticalInfo=false;this.oHeaderContext=this.bRelative?null:C.createNewContext(M,this,P);this.sOperationMode=r.$$operationMode||M.sOperationMode;this.mPreviousContextsByPath={};this.aPreviousData=[];this.bRefreshKeptElements=false;this.bSharedRequest=r.$$sharedRequest||M.bSharedRequests;this.aSorters=e.toArray(v);this.sUpdateGroupId=r.$$updateGroupId;if(!this.sOperationMode&&(this.aSorters.length||this.aApplicationFilters.length)){throw new Error("Unsupported operation mode: "+this.sOperationMode);}this.applyParameters(r);if(!this.bRelative||i&&!i.fetchValue){this.createReadGroupLock(this.getGroupId(),true);}this.setContext(i);M.bindingCreated(this);}a(o.prototype);o.prototype.attachCreateActivate=function(i,q){this.attachEvent("createActivate",i,q);};o.prototype.detachCreateActivate=function(i,q){this.detachEvent("createActivate",i,q);};o.prototype.attachCreateCompleted=function(i,q){this.attachEvent("createCompleted",i,q);};o.prototype.detachCreateCompleted=function(i,q){this.detachEvent("createCompleted",i,q);};o.prototype.attachCreateSent=function(i,q){this.attachEvent("createSent",i,q);};o.prototype.detachCreateSent=function(i,q){this.detachEvent("createSent",i,q);};o.prototype._delete=function(G,E,q,r,D){var t,v=false,P=q.iIndex===undefined?e.getRelativePath(q.getPath(),this.oHeaderContext.getPath()):String(q.iIndex),R=false,w=this;return this.deleteFromCache(G,E,P,r,D,function(I,x){var y,z,A,H,i;if(q.isKeepAlive()){q.resetKeepAlive();t=true;}if(q.created()){w.destroyCreated(q);v=true;}else if(I>=0){for(i=I;i<w.aContexts.length;i+=1){q=w.aContexts[i];if(q){w.mPreviousContextsByPath[q.getPath()]=q;}}A=w.getResolvedPath();w.aContexts.splice(I,1);for(i=I;i<w.aContexts.length;i+=1){if(w.aContexts[i]){H=i-w.iCreatedContexts;z=e.getPrivateAnnotation(x[i],"predicate");y=A+(z||"/"+H);q=w.mPreviousContextsByPath[y];if(q){delete w.mPreviousContextsByPath[y];if(q.iIndex===H){q.checkUpdate();}else{q.iIndex=H;}}else{q=C.create(w.oModel,w,y,H);}w.aContexts[i]=q;}}w.iMaxLength-=1;v=true;}else if(w.bLengthFinal){R=true;}}).then(function(){var i=w.iMaxLength;if(R){w.iMaxLength=w.fetchValue("$count",undefined,true).getResult()-w.iActiveContexts;v=i!==w.iMaxLength;}if(v){w._fireChange({reason:g.Remove});}else if(t){delete w.mPreviousContextsByPath[q.getPath()];q.destroy();}});};o.prototype.adjustPredicate=function(t,P,i){var q=this;function r(v,N){var I=q.aPreviousData.indexOf(v);if(I>=0){q.aPreviousData[I]=N;}}if(i){i.adjustPredicate(t,P,r);}else{a.prototype.adjustPredicate.apply(this,arguments);if(this.mCacheQueryOptions){this.fetchCache(this.oContext,true);}this.oHeaderContext.adjustPredicate(t,P);this.aContexts.forEach(function(i){i.adjustPredicate(t,P,r);});}};o.prototype.applyParameters=function(P,i){var A,q=this.mParameters&&this.mParameters.$$aggregation,r=this.mQueryOptions&&this.mQueryOptions.$apply;if("$$getKeepAliveContext"in P&&"$apply"in P){throw new Error("Cannot combine $$getKeepAliveContext and $apply");}if("$$aggregation"in P){if("$apply"in P){throw new Error("Cannot combine $$aggregation and $apply");}A=b.buildApply(P.$$aggregation).$apply;}this.mQueryOptions=this.oModel.buildQueryOptions(P,true);this.mParameters=P;if(A){this.mQueryOptions.$apply=A;}if(i===""){if(this.mQueryOptions.$apply===r&&(!this.mParameters.$$aggregation||!q||e.deepEqual(this.mParameters.$$aggregation,q))){return;}i=this.bHasAnalyticalInfo?g.Change:g.Filter;}if(this.isRootBindingSuspended()){this.setResumeChangeReason(i);return;}this.removeCachesAndMessages("");this.fetchCache(this.oContext);this.reset(i);if(this.oHeaderContext){this.oHeaderContext.checkUpdate();}};o.prototype.attachEvent=function(E,i,q,r){if(!(E in n)){throw new Error("Unsupported event '"+E+"': v4.ODataListBinding#attachEvent");}return l.prototype.attachEvent.apply(this,arguments);};o.prototype._checkDataStateMessages=function(D,r){if(r){D.setModelMessages(this.oModel.getMessagesByPath(r,true));}};o.prototype.checkKeepAlive=function(i){if(this.isRelative()&&!this.mParameters.$$ownRequest){throw new Error("Missing $$ownRequest at "+this);}if(i===this.oHeaderContext){throw new Error("Unsupported header context "+i);}if(this.mParameters.$$aggregation){throw new Error("Unsupported $$aggregation at "+this);}if(this.bSharedRequest){throw new Error("Unsupported $$sharedRequest at "+this);}};o.prototype.collapse=function(q){var r=this.aContexts,t=this.oCache.collapse(e.getRelativePath(q.getPath(),this.oHeaderContext.getPath())),M=q.getModelIndex(),i,v=this;if(t>0){r.splice(M+1,t).forEach(function(q){v.mPreviousContextsByPath[q.getPath()]=q;});for(i=M+1;i<r.length;i+=1){if(r[i]){r[i].iIndex=i;}}this.iMaxLength-=t;this._fireChange({reason:g.Change});}};o.prototype.create=function(I,q,A,r){var t,v=this.fetchResourcePath(),w,G=this.getUpdateGroupId(),x,R=this.getResolvedPath(),T="($uid="+u()+")",y=R+T,i,z=this;if(!R){throw new Error("Binding is unresolved: "+this);}this.checkSuspended();A=!!A;if(A&&!(this.bLengthFinal||this.mParameters.$count)){throw new Error("Must know the final length to create at the end. Consider setting $count");}if(this.bFirstCreateAtEnd&&!A){throw new Error("Cannot create at the start after creation at end");}if(r){if(this.isRelative()&&!this.mParameters.$$ownRequest){throw new Error("Missing $$ownRequest at "+this);}G="$inactive."+G;}else{this.iActiveContexts+=1;}if(this.bFirstCreateAtEnd===undefined){this.bFirstCreateAtEnd=A;}x=this.lockGroup(G,true,true,function(){if(!z.aContexts.includes(t)){t.destroy();return;}z.destroyCreated(t);return Promise.resolve().then(function(){z._fireChange({reason:g.Remove});});});w=this.createInCache(x,v,R,T,I,this.bFirstCreateAtEnd!==A,function(E){z.oModel.reportError("POST on '"+v+"' failed; will be repeated automatically",s,E);z.fireEvent("createCompleted",{context:t,success:false});},function(){z.fireEvent("createSent",{context:t});}).then(function(D){var G,P;if(!(I&&I["@$ui5.keepTransientPath"])){P=e.getPrivateAnnotation(D,"predicate");if(P){z.adjustPredicate(T,P,t);z.oModel.checkMessages();}}z.fireEvent("createCompleted",{context:t,success:true});G=z.getGroupId();if(q){return t.refreshDependentBindings(t.getPath().slice(1),G,true);}if(z.oModel.isApiGroup(G)){G="$auto";}return z.refreshSingle(t,z.lockGroup(G));},function(E){x.unlock(true);throw E;});this.iCreatedContexts+=1;t=C.create(this.oModel,this,y,-this.iCreatedContexts,w,r);t.fetchValue().then(function(E){if(E){e.setPrivateAnnotation(E,"context",t);e.setPrivateAnnotation(E,"firstCreateAtEnd",z.bFirstCreateAtEnd);}});if(this.bFirstCreateAtEnd!==A){this.aContexts.splice(this.iCreatedContexts-1,0,t);for(i=this.iCreatedContexts-1;i>=0;i-=1){this.aContexts[i].iIndex=i-this.iCreatedContexts;}}else{this.aContexts.unshift(t);}this._fireChange({reason:g.Add});return t;};o.prototype.createContexts=function(q,r){var t=false,v,w,x=r.$count,y,z=this.bLengthFinal,M=this.oModel,P=this.getResolvedPath(),A,D,E=q>this.aContexts.length,i,G=this;function H(){var N=G.iMaxLength+G.iCreatedContexts,i;if(N>=G.aContexts.length){return;}for(i=N;i<G.aContexts.length;i+=1){if(G.aContexts[i]){G.aContexts[i].destroy();}}while(N>0&&!G.aContexts[N-1]){N-=1;}G.aContexts.length=N;t=true;}for(i=0;i<r.length;i+=1){if(this.aContexts[q+i]===undefined&&r[i]){t=true;y=q+i-this.iCreatedContexts;A=e.getPrivateAnnotation(r[i],"predicate");w=P+(A||"/"+y);v=this.mPreviousContextsByPath[w];if(v&&(!v.created()||v.isKeepAlive())){delete this.mPreviousContextsByPath[w];v.iIndex=y;v.checkUpdate();}else{v=C.create(M,this,w,y);}this.aContexts[q+i]=v;}}D=Object.keys(this.mPreviousContextsByPath);if(D.length){M.addPrerenderingTask(this.destroyPreviousContexts.bind(this,D));}if(x!==undefined){this.bLengthFinal=true;this.iMaxLength=x-this.iActiveContexts;H();}else{if(!r.length){this.iMaxLength=q-this.iCreatedContexts;H();}else if(this.aContexts.length>this.iMaxLength+this.iCreatedContexts){this.iMaxLength=Infinity;}if(!(E&&r.length===0)){this.bLengthFinal=this.aContexts.length===this.iMaxLength+this.iCreatedContexts;}}if(this.bLengthFinal!==z){t=true;}return t;};o.prototype.destroy=function(){if(this.bHasAnalyticalInfo&&this.aContexts===undefined){return;}this.aContexts.forEach(function(i){i.destroy();});this.destroyPreviousContexts();if(this.oHeaderContext){this.oHeaderContext.destroy();}this.oModel.bindingDestroyed(this);this.aApplicationFilters=undefined;this.aContexts=undefined;this.oDiff=undefined;this.aFilters=undefined;this.oHeaderContext=undefined;this.mPreviousContextsByPath=undefined;this.aPreviousData=undefined;this.mQueryOptions=undefined;this.aSorters=undefined;a.prototype.destroy.call(this);l.prototype.destroy.call(this);};o.prototype.destroyCreated=function(q){var I=q.getModelIndex(),i;this.iCreatedContexts-=1;if(!q.isInactive()){this.iActiveContexts-=1;}for(i=0;i<I;i+=1){this.aContexts[i].iIndex+=1;}if(!this.iCreatedContexts){this.bFirstCreateAtEnd=undefined;}this.aContexts.splice(I,1);this.destroyLater(q);};o.prototype.destroyLater=function(i){if(this.iCurrentEnd){this.mPreviousContextsByPath[i.getPath()]=i;}else{i.destroy();}};o.prototype.destroyPreviousContexts=function(P){var i=this.mPreviousContextsByPath;if(i){(P||Object.keys(i)).forEach(function(q){var r=i[q];if(r){if(P&&r.isKeepAlive()){r.iIndex=undefined;}else{if(!r.isTransient()){r.destroy();}delete i[q];}}});}};o.prototype.doCreateCache=function(r,q,i,D,G,t){var v,K,w=this;if(t&&t.getResourcePath()===r&&t.$deepResourcePath===D){v=this.oHeaderContext.getPath();K=Object.keys(this.mPreviousContextsByPath).filter(function(P){return w.mPreviousContextsByPath[P].isKeepAlive();});if(this.iCreatedContexts||K.length){t.reset(K.map(function(P){return e.getRelativePath(P,v);}),G);t.setQueryOptions(q,true);return t;}}q=this.inheritQueryOptions(q,i);return this.getCacheAndMoveKeepAliveContexts(r,q)||_.create(this.oModel.oRequestor,r,D,this.mParameters.$$aggregation,q,this.oModel.bAutoExpandSelect,this.bSharedRequest);};o.prototype.doFetchQueryOptions=function(i){var t=this;return this.fetchResolvedQueryOptions(i).then(function(q){return t.fetchFilter(i,q.$filter).then(function(r){return e.mergeQueryOptions(q,t.getOrderby(q.$orderby),r);});});};o.prototype.doReplaceWith=function(i,E,P){var I=i.iIndex,K=i.isKeepAlive(),N,q=i.fnOnBeforeDestroy,r,t=this.oHeaderContext.getPath()+P,R=this.mPreviousContextsByPath[t];if(R){if(R===i){return R;}if(R.iIndex!==undefined){throw new Error("Unexpected index: "+R);}R.iIndex=I;delete this.mPreviousContextsByPath[t];}else{R=C.create(this.oModel,this,t,I);N=true;}i.iIndex=undefined;if(I===undefined){this.mPreviousContextsByPath[t]=R;this.oCache.addKeptElement(E);}else{this.aContexts[I]=R;this.oCache.doReplaceWith(I,E);}if(K){this.mPreviousContextsByPath[i.getPath()]=i;if(N){if(q){r=(q.$original||q).bind(null,R);r.$original=q;}R.setKeepAlive(true,r);}}else{this.destroyLater(i);}this._fireChange({reason:g.Change});return R;};o.prototype.doSetProperty=function(){};o.prototype.expand=function(q){var D=false,t=this;this.checkSuspended();return this.oCache.expand(this.lockGroup(),e.getRelativePath(q.getPath(),this.oHeaderContext.getPath()),function(){D=true;t.fireDataRequested();}).then(function(r){var v=t.aContexts,M,w,i;if(r>0){M=q.getModelIndex();for(i=v.length-1;i>M;i-=1){w=v[i];if(w){w.iIndex+=r;v[i+r]=w;delete v[i];}}t.iMaxLength+=r;t._fireChange({reason:g.Change});}if(D){t.fireDataReceived({});}},function(E){if(D){t.fireDataReceived({error:E});}throw E;});};o.prototype.fetchContexts=function(i,q,M,G,A,D){var P,t=this;if(this.bFirstCreateAtEnd){i+=this.iCreatedContexts;}G=G||this.lockGroup();P=this.fetchData(i,q,M,G,D);if(A){P=Promise.resolve(P);}return P.then(function(r){var E;if(!t.aContexts){E=new Error("Binding already destroyed");E.canceled=true;throw E;}return r&&t.createContexts(i,r.value);},function(E){G.unlock(true);throw E;});};o.prototype.fetchData=function(i,q,M,G,D){var r=this.oContext,t=this;return this.oCachePromise.then(function(v){if(t.bRelative&&r!==t.oContext){return undefined;}if(v){return v.read(i,q,M,G,D).then(function(R){t.assertSameCache(v);return R;});}G.unlock();return r.fetchValue(t.sReducedPath).then(function(R){var w;R=R||[];w=R.$count;R=R.slice(i,i+q);R.$count=w;return{value:R};});});};o.prototype.fetchDownloadUrl=function(){var U=this.oModel.mUriParameters;if(!this.isResolved()){throw new Error("Binding is unresolved");}return this.withCache(function(i,P){return i.getDownloadUrl(P,U);});};o.prototype.fetchFilter=function(i,q){var r,t,M,v;function w(A,E,W){var D,G,T,V;function H(I){return T?"tolower("+I+")":I;}T=E==="Edm.String"&&A.bCaseSensitive===false;G=H(decodeURIComponent(A.sPath));V=H(e.formatLiteral(A.oValue1,E));switch(A.sOperator){case h.BT:D=G+" ge "+V+" and "+G+" le "+H(e.formatLiteral(A.oValue2,E));break;case h.NB:D=z(G+" lt "+V+" or "+G+" gt "+H(e.formatLiteral(A.oValue2,E)),W);break;case h.EQ:case h.GE:case h.GT:case h.LE:case h.LT:case h.NE:D=G+" "+A.sOperator.toLowerCase()+" "+V;break;case h.Contains:case h.EndsWith:case h.NotContains:case h.NotEndsWith:case h.NotStartsWith:case h.StartsWith:D=A.sOperator.toLowerCase().replace("not","not ")+"("+G+","+V+")";break;default:throw new Error("Unsupported operator: "+A.sOperator);}return D;}function x(A,D,W){var R;if(!A){return S.resolve();}if(A.aFilters){return S.all(A.aFilters.map(function(E){return x(E,D,A.bAnd);})).then(function(E){return z(E.join(A.bAnd?" and ":" or "),W&&!A.bAnd);});}R=M.resolve(y(A.sPath,D),v);return M.fetchObject(R).then(function(P){var E,G,H;if(!P){throw new Error("Type cannot be determined, no metadata for path: "+R);}H=A.sOperator;if(H===h.All||H===h.Any){E=A.oCondition;G=A.sVariable;if(H===h.Any&&!E){return A.sPath+"/any()";}D=Object.create(D);D[G]=y(A.sPath,D);return x(E,D).then(function(I){return A.sPath+"/"+A.sOperator.toLowerCase()+"("+G+":"+I+")";});}return w(A,P.$Type,W);});}function y(P,A){var D=P.split("/");D[0]=A[D[0]];return D[0]?D.join("/"):P;}function z(A,W){return W?"("+A+")":A;}r=j.combineFilters(this.aFilters,this.aApplicationFilters);if(!r){return S.resolve([q]);}t=b.splitFilter(r,this.mParameters.$$aggregation);M=this.oModel.getMetaModel();v=M.getMetaContext(this.oModel.resolve(this.sPath,i));return S.all([x(t[0],{},q).then(function(A){return A&&q?A+" and ("+q+")":A||q;}),x(t[1],{})]);};o.prototype.fetchValue=function(P,i,q){var r=q&&this.oCache!==undefined?S.resolve(this.oCache):this.oCachePromise,t=this;return r.then(function(v){var G,R;if(v){G=q?d.$cached:t.lockGroup();R=t.getRelativePath(P);if(R!==undefined){return v.fetchValue(G,R,undefined,i);}}if(t.oContext){return t.oContext.fetchValue(P,i,q);}});};o.prototype.filter=function(v,i){var q=e.toArray(v);if(this.sOperationMode!==O.Server){throw new Error("Operation mode has to be sap.ui.model.odata.OperationMode.Server");}if(i===k.Control&&e.deepEqual(q,this.aFilters)||e.deepEqual(q,this.aApplicationFilters)){return this;}if(this.hasPendingChanges(true)){throw new Error("Cannot filter due to pending changes");}if(i===k.Control){this.aFilters=q;}else{this.aApplicationFilters=q;}if(this.isRootBindingSuspended()){this.setResumeChangeReason(g.Filter);return this;}this.createReadGroupLock(this.getGroupId(),true);this.removeCachesAndMessages("");this.fetchCache(this.oContext);this.reset(g.Filter);if(this.oHeaderContext){this.oHeaderContext.checkUpdate();}return this;};o.prototype.fireCreateActivate=function(i){this.iActiveContexts+=1;this.fireEvent("createActivate");};o.prototype.getAllCurrentContexts=function(){var E=[];this.withCache(function(i,P){E=i.getAllElements(P);},"",true);if(this.createContexts(0,E)){this._fireChange({reason:g.Change});}return this.aContexts.filter(function(i){return i;}).concat(Object.values(this.mPreviousContextsByPath).filter(function(i){return i.isKeepAlive();}));};o.prototype.getCacheAndMoveKeepAliveContexts=function(r,q){var i,t,v=this;if(!this.mParameters.$$getKeepAliveContext){return undefined;}i=this.oModel.releaseKeepAliveBinding("/"+r);if(!i){return undefined;}Object.keys(i.mParameters).concat(Object.keys(this.mParameters)).forEach(function(P){if((P[0]!=="$"||P==="$$patchWithoutSideEffects"||P==="$$updateGroupId")&&v.mParameters[P]!==i.mParameters[P]){throw new Error(v+": parameter does not match getKeepAliveContext: "+P);}});this.mLateQueryOptions=e.clone(q);e.aggregateExpandSelect(this.mLateQueryOptions,i.mLateQueryOptions);this.mPreviousContextsByPath=i.mPreviousContextsByPath;Object.values(this.mPreviousContextsByPath).forEach(function(w){w.oBinding=v;});t=i.oCache;t.setQueryOptions(q);i.oCache=null;i.oCachePromise=S.resolve(null);i.mPreviousContextsByPath={};i.destroy();return t;};o.prototype.getContexts=function(i,q,M,K){var r,t,D=false,v=false,G,P,R=!!this.sChangeReason,w=this.getResolvedPath(),V,x=this;L.debug(this+"#getContexts("+i+", "+q+", "+M+")",undefined,s);this.checkSuspended();i=i||0;if(i!==0&&this.bUseExtendedChangeDetection){throw new Error("Unsupported operation: v4.ODataListBinding#getContexts,"+" iStart must be 0 if extended change detection is enabled, but is "+i);}if(this.bUseExtendedChangeDetection){if(M!==undefined){throw new Error("Unsupported operation: v4.ODataListBinding#getContexts,"+" iMaximumPrefetchSize must not be set if extended change detection is"+" enabled");}if(K){throw new Error("Unsupported operation: v4.ODataListBinding#getContexts,"+" must not use bKeepCurrent if extended change detection is enabled");}}if(M&&K){throw new Error("Unsupported operation: v4.ODataListBinding#getContexts,"+" must not use both iMaximumPrefetchSize and bKeepCurrent");}if(!this.isResolved()){this.aPreviousData=[];return[];}r=this.sChangeReason||g.Change;this.sChangeReason=undefined;if(r==="AddVirtualContext"){this.oModel.addPrerenderingTask(function(){var y=x.bUseExtendedChangeDetection;if(x.aContexts===undefined){V.destroy();return;}if(!x.isRootBindingSuspended()){x.bUseExtendedChangeDetection=false;x.getContexts(i,q,M);x.bUseExtendedChangeDetection=y;}x.oModel.addPrerenderingTask(function(){if(x.aContexts&&!x.isRootBindingSuspended()){x.sChangeReason="RemoveVirtualContext";x._fireChange({detailedReason:"RemoveVirtualContext",reason:g.Change});x.reset(g.Refresh);}V.destroy();});},true);V=C.create(this.oModel,this,w+"/"+C.VIRTUAL,C.VIRTUAL);return[V];}if(r==="RemoveVirtualContext"||(this.oContext&&this.oContext.iIndex===C.VIRTUAL)){return[];}q=q||this.oModel.iSizeLimit;if(!M||M<0){M=0;}G=this.oReadGroupLock;this.oReadGroupLock=undefined;if(!this.oDiff){P=this.fetchContexts(i,q,M,G,R,function(){D=true;x.fireDataRequested();});this.resolveRefreshPromise(P);P.then(function(y){if(x.bUseExtendedChangeDetection){x.oDiff={aDiff:x.getDiff(q),iLength:q};}if(v){if(y||(x.oDiff&&x.oDiff.aDiff.length)){x._fireChange({reason:r});}else{x.oDiff=undefined;}}if(D){x.fireDataReceived({data:{}});}},function(E){if(D){x.fireDataReceived(E.canceled?{data:{}}:{error:E});}throw E;}).catch(function(E){x.oModel.reportError("Failed to get contexts for "+x.oModel.sServiceUrl+w.slice(1)+" with start index "+i+" and length "+q,s,E);});v=true;}if(!K){this.iCurrentBegin=i;this.iCurrentEnd=i+q;}t=this.getContextsInViewOrder(i,q);if(this.bUseExtendedChangeDetection){if(this.oDiff&&q!==this.oDiff.iLength){throw new Error("Extended change detection protocol violation: Expected "+"getContexts(0,"+this.oDiff.iLength+"), but got getContexts(0,"+q+")");}t.dataRequested=!this.oDiff;t.diff=this.oDiff?this.oDiff.aDiff:[];}this.oDiff=undefined;return t;};o.prototype.getContextsInViewOrder=function(q,r){var t,v,i;if(this.bFirstCreateAtEnd){t=[];v=Math.min(r,this.getLength()-q);for(i=0;i<v;i+=1){t[i]=this.aContexts[this.getModelIndex(q+i)];}}else{t=this.aContexts.slice(q,q+r);}return t;};o.prototype.getCount=function(){var H=this.getHeaderContext();return H?H.getProperty("$count"):undefined;};o.prototype.getCurrentContexts=function(){var i,q=Math.min(this.iCurrentEnd,this.iMaxLength+this.iCreatedContexts)-this.iCurrentBegin;i=this.getContextsInViewOrder(this.iCurrentBegin,q);if(q<Infinity){while(i.length<q){i.push(undefined);}}return i;};o.prototype.getDependentBindings=function(){var t=this;return this.oModel.getDependentBindings(this).filter(function(D){return D.oContext.isKeepAlive()||!(D.oContext.getPath()in t.mPreviousContextsByPath);});};o.prototype.getDiff=function(i){var P=this.aPreviousData,t=this;this.aPreviousData=this.getContextsInViewOrder(0,i).map(function(q){return t.getContextData(q);});return this.diffData(P,this.aPreviousData);};o.prototype.getDistinctValues=function(i){throw new Error("Unsupported operation: v4.ODataListBinding#getDistinctValues");};o.prototype.getDownloadUrl=e.createGetMethod("fetchDownloadUrl",true);o.prototype.getEntryData=function(i){return JSON.stringify(i.getValue());};o.prototype.getEntryKey=function(i){return i.getPath();};o.prototype.getFilterInfo=function(i){var q=j.combineFilters(this.aFilters,this.aApplicationFilters),r=null,t;if(q){r=q.getAST(i);}if(this.mQueryOptions.$filter){t={expression:this.mQueryOptions.$filter,syntax:"OData "+this.oModel.getODataVersion(),type:"Custom"};if(r){r={left:r,op:"&&",right:t,type:"Logical"};}else{r=t;}}return r;};o.prototype.getGeneration=function(){return this.oHeaderContext.getGeneration(true)||a.prototype.getGeneration.call(this);};o.prototype.getHeaderContext=function(){return this.isResolved()?this.oHeaderContext:null;};o.prototype.getModelIndex=function(v){if(!this.bFirstCreateAtEnd){return v;}if(!this.bLengthFinal){return this.aContexts.length-v-1;}return v<this.getLength()-this.iCreatedContexts?v+this.iCreatedContexts:this.getLength()-v-1;};o.prototype.getKeepAliveContext=function(P,r,G){var i=this.mPreviousContextsByPath[P]||this.aContexts.find(function(t){return t&&t.getPath()===P;}),q=this.oModel.getPredicateIndex(P),R=this.getResolvedPath();this.checkSuspended();this.oModel.checkGroupId(G);if(!i){if(!R){throw new Error("Binding is unresolved: "+this);}if(P.slice(0,q)!==R){throw new Error(this+": Not a valid context path: "+P);}i=C.create(this.oModel,this,P);this.mPreviousContextsByPath[P]=i;this.oCachePromise.then(function(t){var E=t.createEmptyElement(P.slice(q));if(G){e.setPrivateAnnotation(E,"groupId",G);}});this.oModel.getMetaModel().requestObject(e.getMetaPath(R)+"/").then(function(t){return i.requestProperty(t.$Key.map(function(K){return typeof K==="object"?Object.values(K)[0]:K;}));}).catch(this.oModel.getReporter());}i.setKeepAlive(true,i.fnOnBeforeDestroy,r);return i;};o.prototype.getLength=function(){if(this.bLengthFinal){return this.iMaxLength+this.iCreatedContexts;}return this.aContexts.length?this.aContexts.length+10:0;};o.prototype.getOrderby=function(i){var q=[],t=this;this.aSorters.forEach(function(r){if(r instanceof m){q.push(r.sPath+(r.bDescending?" desc":""));}else{throw new Error("Unsupported sorter: "+r+" - "+t);}});if(i){q.push(i);}return q.join(",");};o.prototype.getQueryOptions=function(w){var r={},t=this;if(w){throw new Error("Unsupported parameter value: bWithSystemQueryOptions: "+w);}Object.keys(this.mQueryOptions).forEach(function(K){if(K[0]!=="$"){r[K]=e.clone(t.mQueryOptions[K]);}});return r;};o.prototype.getQueryOptionsFromParameters=function(){return this.mQueryOptions;};o.prototype.hasPendingChangesForPath=function(i){if(this.oCache===undefined){return this.iActiveContexts>0;}return a.prototype.hasPendingChangesForPath.apply(this,arguments);};o.prototype.inheritQueryOptions=function(q,i){var I;if(!Object.keys(this.mParameters).length){I=this.getQueryOptionsForPath("",i);if(q.$orderby&&I.$orderby){q.$orderby+=","+I.$orderby;}if(q.$filter&&I.$filter){q.$filter="("+q.$filter+") and ("+I.$filter+")";}q=Object.assign({},I,q);e.aggregateExpandSelect(q,I);}return q;};o.prototype.initialize=function(){if(this.isResolved()){if(this.getRootBinding().isSuspended()){this.sResumeChangeReason=this.sChangeReason==="AddVirtualContext"?g.Change:g.Refresh;}else if(this.sChangeReason==="AddVirtualContext"){this._fireChange({detailedReason:"AddVirtualContext",reason:g.Change});}else{this.sChangeReason=g.Refresh;this._fireRefresh({reason:g.Refresh});}}};o.prototype.isFirstCreateAtEnd=function(){return this.bFirstCreateAtEnd;};o.prototype.isKeepAliveBindingFor=function(P){return this.mParameters.$$getKeepAliveContext&&this.getResolvedPath()===P&&(!this.isRootBindingSuspended()||this.aContexts.length||Object.keys(this.mPreviousContextsByPath).length);};o.prototype.isLengthFinal=function(){return this.bLengthFinal;};o.prototype.refreshInternal=function(r,G,q,K){var t=this;function v(i){return i.map(function(w){if(w.bIsBeingDestroyed||w.getContext().isKeepAlive()&&w.hasPendingChanges()){return;}return w.refreshInternal(r,G,false,K);});}if(this.isRootBindingSuspended()){this.refreshSuspended(G);this.bRefreshKeptElements=true;return S.all(v(t.getDependentBindings()));}this.createReadGroupLock(G,this.isRoot());return this.oCachePromise.then(function(w){var A=t.iActiveContexts,x=t.iCreatedContexts,y=t.aContexts.slice(0,x),D,z,P=t.oRefreshPromise;if(w&&!P){t.removeCachesAndMessages(r);t.fetchCache(t.oContext,false,true,K?G:undefined);z=t.refreshKeptElements(G);if(t.iCurrentEnd>0){P=t.createRefreshPromise().catch(function(E){if(!K||E.canceled){throw E;}return t.fetchResourcePath(t.oContext).then(function(R){var i;if(!t.bRelative||w.getResourcePath()===R){if(t.oCache===w){w.restore(true);}else{w.setActive(true);t.oCache=w;t.oCachePromise=S.resolve(w);}t.iActiveContexts=A;t.iCreatedContexts=x;for(i=0;i<x;i+=1){y[i].iIndex=i-x;delete t.mPreviousContextsByPath[y[i].getPath()];}t.aContexts=y;t._fireChange({reason:g.Change});}throw E;});}).finally(function(){if(w.restore){w.restore(false);}});}}D=t.getDependentBindings();t.reset(g.Refresh,K?false:undefined,G);return S.all(v(D).concat(P,z)).then(function(){return t.oHeaderContext.checkUpdateInternal();});});};o.prototype.refreshKeptElements=function(G){var t=this;return this.oCachePromise.then(function(i){return i.refreshKeptElements(t.lockGroup(G),function q(P,I){if(I===undefined){t.mPreviousContextsByPath[t.getResolvedPath()+P].resetKeepAlive();}else{t.destroyCreated(t.aContexts[I]);}});}).catch(function(E){t.oModel.reportError("Failed to refresh kept-alive elements",s,E);throw E;});};o.prototype.refreshSingle=function(q,G,A){var r=q.getPath(),R=r.slice(1),t=this;if(q===this.oHeaderContext){throw new Error("Unsupported header context: "+q);}return this.withCache(function(v,P,w){var D=false,x=false,K=q.isKeepAlive(),y=e.getRelativePath(r,t.oHeaderContext.getPath()),z=[];function E(i){if(D){t.fireDataReceived(i);}}function H(){D=true;t.fireDataRequested();}function I(J){var M=q.getModelIndex(),i;if(q.created()){t.destroyCreated(q);x=true;}else{if(M===undefined){delete t.mPreviousContextsByPath[r];}else{t.aContexts.splice(M,1);t.iMaxLength-=1;for(i=M;i<t.aContexts.length;i+=1){if(t.aContexts[i]){t.aContexts[i].iIndex-=1;}}if(J){t.mPreviousContextsByPath[r]=q;}}if(!J){x=true;q.destroy();}}if(M!==undefined){t._fireChange({reason:g.Remove});}}z.push((A?v.refreshSingleWithRemove(G,P,q.getModelIndex(),y,K,H,I):v.refreshSingle(G,P,q.getModelIndex(),y,K,H)).then(function(){var U=[];E({data:{}});w.assertSameCache(v);if(!x){U.push(q.checkUpdateInternal());if(A){U.push(q.refreshDependentBindings(R,G.getGroupId()));}}return S.all(U);},function(i){E({error:i});throw i;}).catch(function(i){G.unlock(true);t.oModel.reportError("Failed to refresh entity: "+q,s,i);if(!i.canceled){throw i;}}));if(!A){z.push(q.refreshDependentBindings(R,G.getGroupId()));}return S.all(z);});};o.prototype.requestContexts=function(i,q,G){var t=this;if(!this.isResolved()){throw new Error("Unresolved binding: "+this.sPath);}this.checkSuspended();this.oModel.checkGroupId(G);i=i||0;q=q||this.oModel.iSizeLimit;return Promise.resolve(this.fetchContexts(i,q,0,this.lockGroup(G,true))).then(function(r){if(r){t._fireChange({reason:g.Change});}return t.getContextsInViewOrder(i,q);},function(E){t.oModel.reportError("Failed to get contexts for "+t.oModel.sServiceUrl+t.getResolvedPath().slice(1)+" with start index "+i+" and length "+q,s,E);throw E;});};o.prototype.requestDownloadUrl=e.createRequestMethod("fetchDownloadUrl");o.prototype.requestFilterForMessages=function(i){var M=this.oModel.getMetaModel(),q,r=this.oHeaderContext&&this.oHeaderContext.getPath(),t=this;if(!r){return Promise.resolve(null);}q=e.getMetaPath(r);return M.requestObject(q+"/").then(function(E){var v,P={};t.oModel.getMessagesByPath(r,true).filter(function(w){return!i||i(w);}).forEach(function(w){w.getTargets().forEach(function(T){var x=T.slice(r.length).split("/")[0];if(x&&!x.startsWith("($uid=")){P[x]=true;}});});v=Object.keys(P).map(function(w){return o.getFilterForPredicate(w,E,M,q);});if(v.length===0){return null;}return v.length===1?v[0]:new F({filters:v});});};o.prototype.requestSideEffects=function(G,P,i){var q,M,r=this.oModel,N={},t,v,R=this.oHeaderContext.getPath().length,w=i&&i!==this.oHeaderContext,x=this;function y(z){return z.catch(function(E){r.reportError("Failed to request side effects",s,E);if(!E.canceled){throw E;}});}if(this.mParameters.$$aggregation){if(w){throw new Error("Must not request side effects for a context of a binding with $$aggregation");}if(b.isAffected(this.mParameters.$$aggregation,this.aFilters.concat(this.aApplicationFilters),P)){return this.refreshInternal("",G,false,true);}return S.resolve();}if(P.indexOf("")<0){if(w){q=[i];}else{q=this.getCurrentContexts().filter(function(z){return!z.isTransient();});Object.keys(this.mPreviousContextsByPath).forEach(function(z){var A=x.mPreviousContextsByPath[z];if(A.isKeepAlive()){q.push(A);}});}t=q.map(function(i){return i.getPath().slice(R);});M=t.some(function(z){return z[0]!=="(";});if(!M){v=this.oCache?[this.oCache.requestSideEffects(this.lockGroup(G),P,N,t,w)]:[];this.visitSideEffects(G,P,w?i:undefined,N,v);return S.all(v.map(y)).then(function(){return x.refreshDependentListBindingsWithoutCache();});}}if(w){return this.refreshSingle(i,this.lockGroup(G),false);}if(this.iCurrentEnd===0){return S.resolve();}return this.refreshInternal("",G,false,true);};o.prototype.reset=function(q,D,G){var r,t=0,E=this.iCurrentEnd===0,K=G&&G!==this.getUpdateGroupId(),i,v=this;if(D===true){this.iActiveContexts=0;this.iCreatedContexts=0;}if(this.aContexts){this.aContexts.slice(this.iCreatedContexts).forEach(function(r){v.mPreviousContextsByPath[r.getPath()]=r;});for(i=0;i<this.iCreatedContexts;i+=1){r=this.aContexts[i];if(D===false?K&&r.isTransient()||r.isInactive()!==undefined:r.isTransient()){this.aContexts[t]=r;t+=1;}else{this.iActiveContexts-=1;this.mPreviousContextsByPath[r.getPath()]=r;}}for(i=0;i<t;i+=1){this.aContexts[i].iIndex=i-t;}this.aContexts.length=this.iCreatedContexts=t;}else{this.aContexts=[];}if(!this.iCreatedContexts){this.bFirstCreateAtEnd=undefined;}this.iCurrentBegin=this.iCurrentEnd=0;this.iMaxLength=Infinity;this.bLengthFinal=false;if(q&&!(E&&q===g.Change)){this.sChangeReason=q;this._fireRefresh({reason:q});}};o.prototype.resetKeepAlive=function(){var P=this.mPreviousContextsByPath;function r(i){if(i.isKeepAlive()){i.resetKeepAlive();}}Object.keys(P).forEach(function(i){r(P[i]);});this.aContexts.forEach(r);};o.prototype.restoreCreated=function(){var t=this;this.withCache(function(q,P){q.getCreatedElements(P).forEach(function(E,i){t.aContexts[i]=e.getPrivateAnnotation(E,"context");t.bFirstCreateAtEnd=e.getPrivateAnnotation(E,"firstCreateAtEnd");t.iCreatedContexts+=1;if(!E["@$ui5.context.isInactive"]){t.iActiveContexts+=1;}});}).catch(this.oModel.getReporter());};o.prototype.resumeInternal=function(i,P){var q=this.getDependentBindings(),r=this.sResumeChangeReason,R=P||r,t=this;this.sResumeChangeReason=undefined;if(R){this.removeCachesAndMessages("");this.reset();this.fetchCache(this.oContext,!P);if(this.bRefreshKeptElements){this.bRefreshKeptElements=false;t.refreshKeptElements(t.getGroupId());}}q.forEach(function(D){D.resumeInternal(!R,!!r&&!D.oContext.isKeepAlive());});if(this.sChangeReason==="AddVirtualContext"){this._fireChange({detailedReason:"AddVirtualContext",reason:r});}else if(r){this._fireRefresh({reason:r});}this.oHeaderContext.checkUpdate();};o.prototype.setAggregation=function(A){var P;function i(q){return q.some(function(r){return r&&r.isKeepAlive();});}if(this.hasPendingChanges()){throw new Error("Cannot set $$aggregation due to pending changes");}if(i(this.aContexts)||i(Object.values(this.mPreviousContextsByPath))){throw new Error("Cannot set $$aggregation due to a kept-alive context");}P=Object.assign({},this.mParameters);if(A===undefined){delete P.$$aggregation;}else{P.$$aggregation=e.clone(A);this.resetKeepAlive();}this.applyParameters(P,"");};o.prototype.setContext=function(i){var r;if(this.oContext!==i){if(this.bRelative){this.checkSuspended(true);this.reset(undefined,true);this.resetKeepAlive();this.fetchCache(i);if(i){this.restoreCreated();r=this.oModel.resolve(this.sPath,i);if(this.oHeaderContext&&this.oHeaderContext.getPath()!==r){this.mPreviousContextsByPath[this.oHeaderContext.getPath()]=this.oHeaderContext;this.oHeaderContext=null;}if(!this.oHeaderContext){this.oHeaderContext=C.create(this.oModel,this,r);}if(this.bHasPathReductionToParent&&this.oModel.bAutoExpandSelect&&!this.mParameters.$$aggregation){this.sChangeReason="AddVirtualContext";}if(i.getBinding&&i.getBinding().getRootBinding().isSuspended()){this.oContext=i;this.setResumeChangeReason(g.Context);return;}}B.prototype.setContext.call(this,i,{detailedReason:this.sChangeReason});}else{this.oContext=i;}}};o.prototype.sort=function(v){var i=e.toArray(v);if(this.sOperationMode!==O.Server){throw new Error("Operation mode has to be sap.ui.model.odata.OperationMode.Server");}if(e.deepEqual(i,this.aSorters)){return this;}if(this.hasPendingChanges(true)){throw new Error("Cannot sort due to pending changes");}this.aSorters=i;if(this.isRootBindingSuspended()){this.setResumeChangeReason(g.Sort);return this;}this.createReadGroupLock(this.getGroupId(),true);this.removeCachesAndMessages("");this.fetchCache(this.oContext);this.reset(g.Sort);if(this.oHeaderContext){this.oHeaderContext.checkUpdate();}return this;};o.prototype.updateAnalyticalInfo=function(A){var i={aggregate:{},group:{},search:this.mParameters.$$aggregation&&this.mParameters.$$aggregation.search},H=false,t=this;A.forEach(function(q){var D={};if("total"in q){if("grouped"in q){throw new Error("Both dimension and measure: "+q.name);}if(q.as){D.name=q.name;i.aggregate[q.as]=D;}else{i.aggregate[q.name]=D;}if(q.min){D.min=true;H=true;}if(q.max){D.max=true;H=true;}if(q.with){D.with=q.with;}}else if(!("grouped"in q)||q.inResult||q.visible){i.group[q.name]=D;}});this.bHasAnalyticalInfo=true;this.setAggregation(i);if(H){return{measureRangePromise:Promise.resolve(this.getRootBindingResumePromise().then(function(){return t.oCachePromise;}).then(function(q){return q.getMeasureRangePromise();}))};}};o.getFilterForPredicate=function(P,E,M,i){var q,v=f.parseKeyPredicate(P);if(""in v){v[E.$Key[0]]=v[""];delete v[""];}q=E.$Key.map(function(K){var r,t;if(typeof K==="string"){t=r=K;}else{r=Object.keys(K)[0];t=K[r];}return new F(t,h.EQ,e.parseLiteral(decodeURIComponent(v[r]),M.getObject(i+"/"+t+"/$Type"),t));});return q.length===1?q[0]:new F({and:true,filters:q});};return o;});
