/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./ODataContextBinding","./ODataListBinding","./ODataMetaModel","./ODataPropertyBinding","./SubmitMode","./lib/_GroupLock","./lib/_Helper","./lib/_MetadataRequestor","./lib/_Parser","./lib/_Requestor","sap/base/assert","sap/base/Log","sap/ui/base/SyncPromise","sap/ui/core/cache/CacheManager","sap/ui/core/library","sap/ui/core/message/Message","sap/ui/model/BindingMode","sap/ui/model/Context","sap/ui/model/Model","sap/ui/model/odata/OperationMode","sap/ui/thirdparty/URI"],function(O,a,b,c,S,_,d,e,f,g,h,L,i,C,j,M,B,k,l,m,U){"use strict";var r=/^\w+$/,s="sap.ui.model.odata.v4.ODataModel",E=["$count","$expand","$filter","$levels","$orderby","$search","$select"],G=["$$groupId","$$patchWithoutSideEffects","$$updateGroupId"],n=/^(\$auto(\.\w+)?|\$direct|\w+)$/,o=j.MessageType,p=[undefined,o.Success,o.Information,o.Warning,o.Error],q={messageChange:true,sessionTimeout:true},t={annotationURI:true,autoExpandSelect:true,earlyRequests:true,groupId:true,groupProperties:true,httpHeaders:true,metadataUrlParams:true,odataVersion:true,operationMode:true,serviceUrl:true,sharedRequests:true,supportReferences:true,synchronizationMode:true,updateGroupId:true},u=["$apply","$count","$expand","$filter","$orderby","$search","$select"],v=/^[ -~]+$/,w=l.extend("sap.ui.model.odata.v4.ODataModel",{constructor:x});function x(P){var y,z,A=sap.ui.getCore().getConfiguration().getLanguageTag(),D,F,H,I,J,K=this;l.call(this);if(!P||P.synchronizationMode!=="None"){throw new Error("Synchronization mode must be 'None'");}D=P.odataVersion||"4.0";this.sODataVersion=D;if(D!=="4.0"&&D!=="2.0"){throw new Error("Unsupported value for parameter odataVersion: "+D);}for(F in P){if(!(F in t)){throw new Error("Unsupported parameter: "+F);}}H=P.serviceUrl;if(!H){throw new Error("Missing service root URL");}I=new U(H);if(I.path()[I.path().length-1]!=="/"){throw new Error("Service root URL must end with '/'");}if(P.operationMode&&P.operationMode!==m.Server){throw new Error("Unsupported operation mode: "+P.operationMode);}this.sOperationMode=P.operationMode;J=this.buildQueryOptions(I.query(true),false,true);this.mUriParameters=J;if(sap.ui.getCore().getConfiguration().getStatistics()){J=Object.assign({"sap-statistics":true},J);}this.sServiceUrl=I.query("").toString();this.sGroupId=P.groupId;if(this.sGroupId===undefined){this.sGroupId="$auto";}if(this.sGroupId!=="$auto"&&this.sGroupId!=="$direct"){throw new Error("Group ID must be '$auto' or '$direct'");}this.checkGroupId(P.updateGroupId,false,"Invalid update group ID: ");this.sUpdateGroupId=P.updateGroupId||this.getGroupId();this.mGroupProperties={};for(y in P.groupProperties){K.checkGroupId(y,true);z=P.groupProperties[y];if(typeof z!=="object"||Object.keys(z).length!==1||!(z.submit in S)){throw new Error("Group '"+y+"' has invalid properties: '"+z+"'");}}this.mGroupProperties=d.clone(P.groupProperties)||{};this.mGroupProperties.$auto={submit:S.Auto};this.mGroupProperties.$direct={submit:S.Direct};if(P.autoExpandSelect!==undefined&&typeof P.autoExpandSelect!=="boolean"){throw new Error("Value for autoExpandSelect must be true or false");}this.bAutoExpandSelect=P.autoExpandSelect===true;if("sharedRequests"in P&&P.sharedRequests!==true){throw new Error("Value for sharedRequests must be true");}this.bSharedRequests=P.sharedRequests===true;this.mHeaders={"Accept-Language":A};this.mMetadataHeaders={"Accept-Language":A};this.oMetaModel=new b(e.create(this.mMetadataHeaders,D,Object.assign({},J,P.metadataUrlParams)),this.sServiceUrl+"$metadata",P.annotationURI,this,P.supportReferences);this.oInterface={fetchEntityContainer:this.oMetaModel.fetchEntityContainer.bind(this.oMetaModel),fetchMetadata:this.oMetaModel.fetchObject.bind(this.oMetaModel),fireSessionTimeout:function(){K.fireEvent("sessionTimeout");},getGroupProperty:this.getGroupProperty.bind(this),getOptimisticBatchEnabler:this.getOptimisticBatchEnabler.bind(this),getReporter:this.getReporter.bind(this),onCreateGroup:function(y){if(K.isAutoGroup(y)){K.addPrerenderingTask(K._submitBatch.bind(K,y,true));}},reportStateMessages:this.reportStateMessages.bind(this),reportTransitionMessages:this.reportTransitionMessages.bind(this)};this.oRequestor=g.create(this.sServiceUrl,this.oInterface,this.mHeaders,J,D);this.changeHttpHeaders(P.httpHeaders);this.bEarlyRequests=P.earlyRequests;if(this.bEarlyRequests){this.oMetaModel.fetchEntityContainer(true);this.initializeSecurityToken();this.oRequestor.sendOptimisticBatch();}this.aAllBindings=[];this.mKeepAliveBindingsByPath={};this.mSupportedBindingModes={OneTime:true,OneWay:true};if(P.sharedRequests){this.sDefaultBindingMode=B.OneWay;}else{this.sDefaultBindingMode=B.TwoWay;this.mSupportedBindingModes.TwoWay=true;}this.aPrerenderingTasks=null;this.fnOptimisticBatchEnabler=null;}w.prototype._submitBatch=function(y,z){var A=this;return this.oRequestor.submitBatch(y).catch(function(D){A.reportError("$batch failed",s,D);if(!z){throw D;}});};w.prototype.addPrerenderingTask=function(P,F){var R,T,y=this;function z(A){clearTimeout(T);while(A.length){A.shift()();}if(y.aPrerenderingTasks===A){y.aPrerenderingTasks=null;}}if(!this.aPrerenderingTasks){this.aPrerenderingTasks=[];R=z.bind(null,this.aPrerenderingTasks);sap.ui.getCore().addPrerenderingTask(R);T=setTimeout(function(){T=setTimeout(R,0);},0);}if(F){this.aPrerenderingTasks.unshift(P);}else{this.aPrerenderingTasks.push(P);}};w.prototype.attachEvent=function(y,z,A,D){if(!(y in q)){throw new Error("Unsupported event '"+y+"': v4.ODataModel#attachEvent");}return l.prototype.attachEvent.apply(this,arguments);};w.prototype.attachSessionTimeout=function(F,y){return this.attachEvent("sessionTimeout",F,y);};w.prototype.bindContext=function(P,y,z){return new O(this,P,y,z);};w.prototype.bindingCreated=function(y){this.aAllBindings.push(y);};w.prototype.bindingDestroyed=function(y){var I=this.aAllBindings.indexOf(y);if(I<0){throw new Error("Unknown "+y);}this.aAllBindings.splice(I,1);};w.prototype.bindList=function(P,y,z,F,A){return new a(this,P,y,z,F,A);};w.prototype.bindProperty=function(P,y,z){return new c(this,P,y,z);};w.prototype.bindTree=function(y,z,A,D,F){throw new Error("Unsupported operation: v4.ODataModel#bindTree");};w.prototype.buildQueryOptions=function(P,y,z){var A,T=d.clone(P)||{};function D(F,H,I){var J,K,N,V=F[H];if(!y||I.indexOf(H)<0){throw new Error("System query option "+H+" is not supported");}if((H==="$expand"||H==="$select")&&typeof V==="string"){V=f.parseSystemQueryOption(H+"="+V)[H];F[H]=V;}if(H==="$expand"){for(N in V){K=V[N];if(K===null||typeof K!=="object"){K=V[N]={};}for(J in K){D(K,J,E);}}}else if(H==="$count"){if(typeof V==="boolean"){if(!V){delete F.$count;}}else{switch(typeof V==="string"&&V.toLowerCase()){case"false":delete F.$count;break;case"true":F.$count=true;break;default:throw new Error("Invalid value for $count: "+V);}}}}if(P){for(A in P){if(A.startsWith("$$")){delete T[A];}else if(A[0]==="@"){throw new Error("Parameter "+A+" is not supported");}else if(A[0]==="$"){D(T,A,u);}else if(!z&&A.startsWith("sap-")&&!A.startsWith("sap-valid-")){throw new Error("Custom query option "+A+" is not supported");}}}return T;};w.prototype.changeHttpHeaders=function(H){var y,z,A={},D,K;this.oRequestor.checkHeaderNames(H);for(K in H){z=K.toLowerCase();D=H[K];if(A[z]){throw new Error("Duplicate header "+K);}else if(!(typeof D==="string"&&v.test(D)||D===undefined)){throw new Error("Unsupported value for header '"+K+"': "+D);}else{if(z==="x-csrf-token"){K="X-CSRF-Token";}A[z]={key:K,value:D};}}this.oRequestor.checkForOpenRequests();for(K in this.mHeaders){z=K.toLowerCase();y=A[z];if(y){delete this.mHeaders[K];delete this.mMetadataHeaders[K];if(y.value!==undefined){this.mHeaders[y.key]=y.value;this.mMetadataHeaders[y.key]=y.value;}delete A[z];}}for(K in A){y=A[K];if(y.value!==undefined){this.mHeaders[y.key]=y.value;if(K!=="x-csrf-token"){this.mMetadataHeaders[y.key]=y.value;}}}};w.prototype.checkBatchGroupId=function(y){this.checkGroupId(y);if(this.isDirectGroup(y)){throw new Error("Group ID does not use batch requests: "+y);}};w.prototype.checkGroupId=function(y,A,z){if(!A&&y===undefined||typeof y==="string"&&(A?r:n).test(y)){return;}throw new Error((z||"Invalid group ID: ")+y);};w.prototype.createBindingContext=function(P,y){var D,z,A,R,F;function H(A){var I=A.indexOf("."),J=A.indexOf("/");return I>0&&(J<0||I<J);}if(arguments.length>2){throw new Error("Only the parameters sPath and oContext are supported");}if(y&&y.getBinding){throw new Error("Unsupported type: oContext must be of type sap.ui.model.Context, "+"but was sap.ui.model.odata.v4.Context");}R=this.resolve(P,y);if(R===undefined){throw new Error("Cannot create binding context from relative path '"+P+"' without context");}F=R.indexOf("#");if(F>=0){D=R.slice(0,F);A=R.slice(F+1);if(A[0]==="#"){A=A.slice(1);}else if(D.length>1&&A[0]!=="@"&&H(A)){return new k(this,R);}if(A[0]==="/"){A="."+A;}z=this.oMetaModel.getMetaContext(D);return this.oMetaModel.createBindingContext(A,z);}return new k(this,R);};w.prototype.createUI5Message=function(R,y,z){var I=typeof R.target==="string",A=R.longtextUrl,T,D=this;function F(H){return D.normalizeMessageTarget(H[0]==="/"?H:d.buildPath("/"+y,z,H));}if(I){y=y&&y.split("?")[0];T=[F(R.target)];if(R.additionalTargets){R.additionalTargets.forEach(function(H){T.push(F(H));});}}if(A&&y){A=d.makeAbsolute(A,this.sServiceUrl+y);}return new M({code:R.code,descriptionUrl:A||undefined,message:R.message,persistent:!I||R.transition,processor:this,target:I?T:"",technical:R.technical,technicalDetails:d.createTechnicalDetails(R),type:p[R.numericSeverity]||o.None});};w.prototype.destroy=function(){this.oMetaModel.destroy();this.oRequestor.destroy();this.mHeaders=undefined;this.mMetadataHeaders=undefined;return l.prototype.destroy.apply(this,arguments);};w.prototype.destroyBindingContext=function(){throw new Error("Unsupported operation: v4.ODataModel#destroyBindingContext");};w.prototype.detachSessionTimeout=function(F,y){return this.detachEvent("sessionTimeout",F,y);};w.prototype.filterMatchingMessages=function(y,P){return d.hasPathPrefix(y,P)?this.mMessages[y]:[];};w.prototype.getAllBindings=function(){return this.aAllBindings.slice();};w.prototype.getContext=function(){throw new Error("Unsupported operation: v4.ODataModel#getContext");};w.prototype.getDependentBindings=function(P){return this.aAllBindings.filter(function(y){var z=y.getContext();return y.isRelative()&&(z===P||z&&z.getBinding&&z.getBinding()===P);});};w.prototype.getGroupId=function(){return this.sGroupId;};w.prototype.getGroupProperty=function(y,P){switch(P){case"submit":if(y.startsWith("$auto.")){return S.Auto;}return this.mGroupProperties[y]?this.mGroupProperties[y].submit:S.API;default:throw new Error("Unsupported group property: '"+P+"'");}};w.prototype.getHttpHeaders=function(I){var H=Object.assign({},this.mHeaders);if(!I){delete H["SAP-ContextId"];}if(H["X-CSRF-Token"]===null){delete H["X-CSRF-Token"];}return H;};w.prototype.getMessages=function(y){return this.getMessagesByPath(y.getPath(),true).sort(M.compare);};w.prototype.getMetaModel=function(){return this.oMetaModel;};w.prototype.getObject=function(){throw new Error("Unsupported operation: v4.ODataModel#getObject");};w.prototype.getODataVersion=function(){return this.sODataVersion;};w.prototype.getOriginalProperty=function(){throw new Error("Unsupported operation: v4.ODataModel#getOriginalProperty");};w.prototype.getProperty=function(){throw new Error("Unsupported operation: v4.ODataModel#getProperty");};w.prototype.getKeepAliveContext=function(P,R,y){var z,A,D;if(!this.bAutoExpandSelect){throw new Error("Missing parameter autoExpandSelect");}if(P[0]!=="/"){throw new Error("Not a list context path to an entity: "+P);}y=y||{};Object.keys(y).forEach(function(F){if(F.startsWith("sap-")&&!F.startsWith("sap-valid-")||F[0]==="$"&&!G.includes(F)){throw new Error("Invalid parameter: "+F);}});D=P.slice(0,this.getPredicateIndex(P));z=this.mKeepAliveBindingsByPath[D];if(!z){A=this.aAllBindings.filter(function(F){if(F.mParameters&&F.mParameters.$$getKeepAliveContext){F.removeCachesAndMessages(D.slice(1),true);}return F.isKeepAliveBindingFor&&F.isKeepAliveBindingFor(D);});if(A.length>1){throw new Error("Multiple bindings with $$getKeepAliveContext for: "+P);}z=A[0];if(!z){z=this.bindList(D,undefined,undefined,undefined,y);this.mKeepAliveBindingsByPath[D]=z;}}return z.getKeepAliveContext(P,R,y.$$groupId);};w.prototype.getPredicateIndex=function(P){var y=P.indexOf("(",P.lastIndexOf("/"));if(y<0||!P.endsWith(")")){throw new Error("Not a list context path to an entity: "+P);}return y;};w.prototype.getUpdateGroupId=function(){return this.sUpdateGroupId;};w.prototype.getReporter=function(){var y=this;return function(z){if(!z.$reported){y.reportError(z.message,s,z);}};};w.prototype.hasPendingChanges=function(y){if(y!==undefined){this.checkBatchGroupId(y);if(this.isAutoGroup(y)&&this.oRequestor.hasPendingChanges("$parked."+y)){return true;}}return this.oRequestor.hasPendingChanges(y);};w.prototype.initializeSecurityToken=function(){this.oRequestor.refreshSecurityToken().catch(function(){});};w.prototype.isApiGroup=function(y){return this.getGroupProperty(y,"submit")===S.API;};w.prototype.isAutoGroup=function(y){return this.getGroupProperty(y,"submit")===S.Auto;};w.prototype.isDirectGroup=function(y){return this.getGroupProperty(y,"submit")===S.Direct;};w.prototype.isList=function(){throw new Error("Unsupported operation: v4.ODataModel#isList");};w.prototype.lockGroup=function(y,z,A,D,F){return this.oRequestor.lockGroup(y,z,A,D,F);};w.prototype.refresh=function(y){if(typeof y==="boolean"){throw new Error("Unsupported parameter bForceUpdate");}this.checkGroupId(y);this.getBindings().forEach(function(z){if(z.isRoot()){z.refresh(z.isSuspended()?undefined:y);}});};w.prototype.releaseKeepAliveBinding=function(P){var y=this.mKeepAliveBindingsByPath[P];if(y){delete this.mKeepAliveBindingsByPath[P];return y;}};w.prototype.reportError=function(y,R,z){var D;if(z.canceled==="noDebugLog"){return;}D=z.stack.includes(z.message)?z.stack:z.message+"\n"+z.stack;if(z.canceled){L.debug(y,D,R);return;}L.error(y,D,R);if(z.$reported){return;}z.$reported=true;this.reportTransitionMessages(d.extractMessages(z),z.resourcePath);};w.prototype.reportStateMessages=function(R,P,y){var D="/"+R,N=[],z=[],A=this;Object.keys(P).forEach(function(F){P[F].forEach(function(H){N.push(A.createUI5Message(H,R,F));});});(y||[""]).forEach(function(F){var H=d.buildPath(D,F);Object.keys(A.mMessages).forEach(function(I){if(I===H||I.startsWith(H+"/")||I.startsWith(H+"(")){z=z.concat(A.mMessages[I].filter(function(J){return!J.persistent;}));}});});if(N.length||z.length){this.fireMessageChange({newMessages:N,oldMessages:z});}};w.prototype.reportTransitionMessages=function(y,R){var z=this;if(y&&y.length){this.fireMessageChange({newMessages:y.map(function(A){A.transition=true;return z.createUI5Message(A,R);})});}};w.prototype.normalizeMessageTarget=function(T){var y,F,z="",A=this;if(T.includes("$uid=")){return T;}y=T.split("/").map(function(D){var H,I=D.indexOf("("),P,J,K;function N(Q){if(Q in J){return encodeURIComponent(decodeURIComponent(J[Q]));}F=true;}if(I<0){z=d.buildPath(z,D);return D;}H=D.slice(0,I);z=d.buildPath(z,H);J=f.parseKeyPredicate(D.slice(I));if(""in J){return H+"("+N("")+")";}K=A.oRequestor.fetchTypeForPath("/"+z).getResult();if(!(K&&K.$Key)){F=true;return D;}P=K.$Key.map(function(Q){var V=N(Q);return K.$Key.length>1?Q+"="+V:V;});return H+"("+P.join(",")+")";}).join("/");return F?T:y;};w.prototype.requestCanonicalPath=function(y){h(y.getModel()===this,"oEntityContext must belong to this model");return y.requestCanonicalPath();};w.prototype.requestSideEffects=function(y,A){if(!A.length){return undefined;}return i.all(this.aAllBindings.filter(function(z){return z.isRoot();}).map(function(R){return R.requestAbsoluteSideEffects(y,A);}));};w.prototype.resetChanges=function(y){y=y||this.sUpdateGroupId;this.checkBatchGroupId(y);if(this.isAutoGroup(y)){this.oRequestor.cancelChanges("$parked."+y);}this.oRequestor.cancelChanges(y);this.aAllBindings.forEach(function(z){if(y===z.getUpdateGroupId()){z.resetInvalidDataState();}});};w.prototype.resolve=function(P,y){var R;if(P&&P[0]==="/"){R=P;}else if(y){R=y.getPath();if(P){if(!R.endsWith("/")){R+="/";}R+=P;}}if(R&&R!=="/"&&R[R.length-1]==="/"&&!R.includes("#")){R=R.slice(0,R.length-1);}return R;};w.prototype.setLegacySyntax=function(){throw new Error("Unsupported operation: v4.ODataModel#setLegacySyntax");};w.prototype.getOptimisticBatchEnabler=function(){return this.fnOptimisticBatchEnabler;};w.prototype.setOptimisticBatchEnabler=function(y){if(!this.bEarlyRequests){throw new Error("The earlyRequests model parameter is not set");}if(this.oRequestor.isBatchSent()){throw new Error("The setter is called after a non-optimistic batch is sent");}if(typeof y!=="function"){throw new Error("The given fnOptimisticBatchEnabler parameter is not a function");}if(this.fnOptimisticBatchEnabler){throw new Error("The setter is called more than once");}this.fnOptimisticBatchEnabler=y;};w.prototype.submitBatch=function(y){var z=this;this.checkBatchGroupId(y);if(this.isAutoGroup(y)){this.oRequestor.relocateAll("$parked."+y,y);}else{this.oRequestor.addChangeSet(y);}return new Promise(function(A){z.addPrerenderingTask(function(){A(z._submitBatch(y));});});};w.prototype.toString=function(){return s+": "+this.sServiceUrl;};w.prototype.withUnresolvedBindings=function(y,P){return this.aAllBindings.filter(function(z){return!z.isResolved();}).some(function(z){return z[y](P);});};w.cleanUpOptimisticBatch=function(y){return C.delWithFilters({olderThan:y,prefix:"sap.ui.model.odata.v4.optimisticBatch:"});};return w;});
