/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/assert","sap/base/Log","sap/base/security/encodeURL","sap/base/util/each","sap/ui/core/CalendarType","sap/ui/core/format/DateFormat","sap/ui/model/FilterProcessor","sap/ui/model/Sorter"],function(a,L,e,b,C,D,F,S){"use strict";var d,o,c,r=/^([-+]?)0*(\d+)(\.\d+|)$/,f=/\/(Annotations|ServiceNames|ServiceCollection)(\(|%28)/,t,g=/\.$/,h=/0+$/;function s(){if(!d){d=D.getDateInstance({pattern:"'datetime'''yyyy-MM-dd'T'HH:mm:ss''",calendarType:C.Gregorian});o=D.getDateInstance({pattern:"'datetime'''yyyy-MM-dd'T'HH:mm:ss.SSS''",calendarType:C.Gregorian});c=D.getDateInstance({pattern:"'datetimeoffset'''yyyy-MM-dd'T'HH:mm:ss'Z'''",calendarType:C.Gregorian});t=D.getTimeInstance({pattern:"'time''PT'HH'H'mm'M'ss'S'''",calendarType:C.Gregorian});}}var O=function(){};O.createSortParams=function(n){var z;if(!n||n.length==0){return undefined;}z="$orderby=";for(var i=0;i<n.length;i++){var A=n[i];if(A instanceof S){z+=A.sPath;z+=A.bDescending?"%20desc":"%20asc";z+=",";}else{L.error("Trying to use "+A+" as a Sorter, but it is a "+typeof A);}}z=z.slice(0,-1);return z;};function j(i){if(i&&typeof i.convert==="function"){i=i.convert();}return i;}O.createFilterParams=function(i,M,E){var n;if(Array.isArray(i)){i=i.map(j);n=F.groupFilters(i);}else{n=j(i);}if(!n){return undefined;}return"$filter="+this._createFilterParams(n,M,E);};O._createFilterParams=function(n,M,E){var z=this,A=Array.isArray(n)?F.groupFilters(n):n;function B(A,i){A=j(A);if(A.aFilters){return G(A,i);}return z._createFilterSegment(A.sPath,M,E,A.sOperator,A.oValue1,A.oValue2,A.bCaseSensitive);}function G(H,I){var J=H.aFilters,K=!!H.bAnd,P="";if(J.length===0){return K?"true":"false";}if(J.length===1){if(J[0]._bMultiFilter){return B(J[0]);}return B(J[0],true);}if(!I){P+="(";}P+=B(J[0]);for(var i=1;i<J.length;i++){P+=K?"%20and%20":"%20or%20";P+=B(J[i]);}if(!I){P+=")";}return P;}if(!A){return undefined;}return B(A,true);};O._createUrlParamsArray=function(P){var U,T=typeof P,i;if(Array.isArray(P)){return P;}U=[];if(T==="string"||P instanceof String){if(P){U.push(P);}}else if(T==="object"){i=this._encodeURLParameters(P);if(i){U.push(i);}}return U;};O._encodeURLParameters=function(P){if(!P){return"";}var U=[];b(P,function(n,V){if(typeof V==="string"||V instanceof String){V=encodeURIComponent(V);}n=n.startsWith('$')?n:encodeURIComponent(n);U.push(n+"="+V);});return U.join("&");};O.setOrigin=function(i,P){var n,z,A;if(!i||!P||i.indexOf(";mo")>0){return i;}if(typeof P=="string"){n=P;}else{n=P.alias;if(!n){z=P.system;A=P.client;if(!z||!A){L.warning("ODataUtils.setOrigin: No Client or System ID given for Origin");return i;}n="sid("+z+"."+A+")";}}var U=i.split("?");var B=U[0];var E=U[1]?"?"+U[1]:"";var T="";if(B[B.length-1]==="/"){B=B.substring(0,B.length-1);T="/";}var G=/(\/[^\/]+)$/g;var H=/(;o=[^\/;]+)/g;var I=B.match(G)[0];var J=I.match(H);var K=J?J[0]:null;if(K){if(P.force){var M=I.replace(K,";o="+n);B=B.replace(I,M);return B+T+E;}return i;}B=B+";o="+n+T;return B+E;};O.setAnnotationOrigin=function(A,P){var i;var n=A.search(f);var H=P&&P.preOriginBaseUri?P.preOriginBaseUri.indexOf(".xsodata"):-1;if(n>=0){if(A.indexOf("/$value",n)===-1){L.warning("ODataUtils.setAnnotationOrigin: Annotation url is missing $value segment.");i=A;}else{var z=A.substring(0,n);var B=A.substring(n,A.length);var E=O.setOrigin(z,P);i=E+B;}}else if(H>=0){i=O.setOrigin(A,P);}else{i=A.replace(P.preOriginBaseUri,P.postOriginBaseUri);}return i;};O._resolveMultiFilter=function(M,n,E){var z=this,A=M.aFilters,B="";if(A){B+="(";b(A,function(i,G){if(G._bMultiFilter){B+=z._resolveMultiFilter(G,n,E);}else if(G.sPath){B+=z._createFilterSegment(G.sPath,n,E,G.sOperator,G.oValue1,G.oValue2,"",G.bCaseSensitive);}if(i<(A.length-1)){if(M.bAnd){B+="%20and%20";}else{B+="%20or%20";}}});B+=")";}return B;};O._createFilterSegment=function(P,M,E,i,V,n,z){var A,T;if(z===undefined){z=true;}if(E){A=M._getPropertyMetadata(E,P);T=A&&A.type;a(A,"PropertyType for property "+P+" of EntityType "+E.name+" not found!");}if(T){V=this.formatValue(V,T,z);n=(n!=null)?this.formatValue(n,T,z):null;}else{a(null,"Type for filter property could not be found in metadata!");}if(V){V=e(String(V));}if(n){n=e(String(n));}if(!z&&T==="Edm.String"){P="toupper("+P+")";}switch(i){case"EQ":case"NE":case"GT":case"GE":case"LT":case"LE":return P+"%20"+i.toLowerCase()+"%20"+V;case"BT":return"("+P+"%20ge%20"+V+"%20and%20"+P+"%20le%20"+n+")";case"NB":return"not%20("+P+"%20ge%20"+V+"%20and%20"+P+"%20le%20"+n+")";case"Contains":return"substringof("+V+","+P+")";case"NotContains":return"not%20substringof("+V+","+P+")";case"StartsWith":return"startswith("+P+","+V+")";case"NotStartsWith":return"not%20startswith("+P+","+V+")";case"EndsWith":return"endswith("+P+","+V+")";case"NotEndsWith":return"not%20endswith("+P+","+V+")";default:L.error("ODataUtils :: Unknown filter operator "+i);return"true";}};O.formatValue=function(V,T,i){var n,z;if(i===undefined){i=true;}if(V===null||V===undefined){return"null";}s();switch(T){case"Edm.String":V=i?V:V.toUpperCase();z="'"+String(V).replace(/'/g,"''")+"'";break;case"Edm.Time":if(typeof V==="object"){z=t.format(new Date(V.ms),true);}else{z="time'"+V+"'";}break;case"Edm.DateTime":n=V instanceof Date?V:new Date(V);if(n.getMilliseconds()>0){z=o.format(n,true);}else{z=d.format(n,true);}break;case"Edm.DateTimeOffset":n=V instanceof Date?V:new Date(V);z=c.format(n,true);break;case"Edm.Guid":z="guid'"+V+"'";break;case"Edm.Decimal":z=V+"m";break;case"Edm.Int64":z=V+"l";break;case"Edm.Double":z=V+"d";break;case"Edm.Float":case"Edm.Single":z=V+"f";break;case"Edm.Binary":z="binary'"+V+"'";break;default:z=String(V);break;}return z;};O.parseValue=function(V){var i=V[0],n=V[V.length-1];s();if(i==="'"){return V.slice(1,-1).replace(/''/g,"'");}else if(V.startsWith("time'")){return{__edmType:"Edm.Time",ms:t.parse(V,true).getTime()};}else if(V.startsWith("datetime'")){if(V.indexOf(".")===-1){return d.parse(V,true);}else{return o.parse(V,true);}}else if(V.startsWith("datetimeoffset'")){return c.parse(V,true);}else if(V.startsWith("guid'")){return V.slice(5,-1);}else if(V==="null"){return null;}else if(n==="m"||n==="l"||n==="d"||n==="f"){return V.slice(0,-1);}else if(!isNaN(i)||i==="-"){return parseInt(V);}else if(V==="true"||V==="false"){return V==="true";}else if(V.startsWith("binary'")){return V.slice(7,-1);}throw new Error("Cannot parse value '"+V+"', no Edm type found");};function k(V,i){if(V===i){return 0;}if(V===null||i===null||V===undefined||i===undefined){return NaN;}return V>i?1:-1;}function p(V){var M;if(typeof V!=="string"){return undefined;}M=r.exec(V);if(!M){return undefined;}return{sign:M[1]==="-"?-1:1,integerLength:M[2].length,abs:M[2]+M[3].replace(h,"").replace(g,"")};}function l(V,i){var n,z,R;if(V===i){return 0;}n=p(V);z=p(i);if(!n||!z){return NaN;}if(n.sign!==z.sign){return n.sign>z.sign?1:-1;}R=k(n.integerLength,z.integerLength)||k(n.abs,z.abs);return n.sign*R;}var m=/^PT(\d\d)H(\d\d)M(\d\d)S$/;function q(V){if(typeof V==="string"&&m.test(V)){V=parseInt(RegExp.$1)*3600000+parseInt(RegExp.$2)*60000+parseInt(RegExp.$3)*1000;}if(V instanceof Date){return V.getTime();}if(V&&V.__edmType==="Edm.Time"){return V.ms;}return V;}O.compare=function(V,i,A){return A?l(V,i):k(q(V),q(i));};O.getComparator=function(E){switch(E){case"Edm.Date":case"Edm.DateTime":case"Edm.DateTimeOffset":case"Edm.Time":return O.compare;case"Edm.Decimal":case"Edm.Int64":return l;default:return k;}};var u=/([(=,])('.*?')([,)])/g,v=/[MLDF](?=[,)](?:[^']*'[^']*')*[^']*$)/g,w=/([(=,])(X')/g,N=function(i,n,z,A){return n+encodeURIComponent(decodeURIComponent(z))+A;},x=function(i){return i.toLowerCase();},y=function(i,n){return n+"binary'";};O._normalizeKey=function(K){return K.replace(u,N).replace(v,x).replace(w,y);};O._mergeIntervals=function(i){if(i.length){return{start:i[0].start,end:i[i.length-1].end};}return undefined;};O._getReadIntervals=function(E,z,A,P,B){var i,G,n,H=-1,I=[],R=O._getReadRange(E,z,A,P);if(B===undefined){B=Infinity;}G=Math.min(R.start+R.length,B);n=Math.min(G,Math.max(R.start,E.length)+1);for(i=R.start;i<n;i+=1){if(E[i]!==undefined){if(H>=0){I.push({start:H,end:i});H=-1;}}else if(H<0){H=i;}}if(H>=0){I.push({start:H,end:G});}return I;};O._getReadRange=function(E,n,z,P){function A(n,B){var i;for(i=n;i<B;i+=1){if(E[i]===undefined){return true;}}return false;}if(A(n+z,n+z+P/2)){z+=P;}if(A(Math.max(n-P/2,0),n)){z+=P;n-=P;if(n<0){z+=n;if(isNaN(z)){z=Infinity;}n=0;}}return{length:z,start:n};};return O;},true);
