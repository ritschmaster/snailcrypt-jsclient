/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/Log","sap/base/util/each","sap/ui/model/ChangeReason","sap/ui/model/Filter","sap/ui/model/FilterType","sap/ui/model/ListBinding","sap/ui/model/FilterProcessor","sap/ui/model/Sorter","sap/ui/model/SorterProcessor"],function(L,e,C,F,a,b,c,S,d){"use strict";var f=b.extend("sap.ui.model.ClientListBinding",{constructor:function(m,p,o,s,g,P){b.apply(this,arguments);this.mNormalizeCache={};this.oModel.checkFilterOperation(this.aApplicationFilters);this.oCombinedFilter=c.combineFilters(this.aFilters,this.aApplicationFilters);this.bIgnoreSuspend=false;this.aLastContextData=undefined;this.aLastContexts=undefined;this.iLastLength=undefined;this.iLastStartIndex=undefined;this.update();},metadata:{publicMethods:["getLength"]}});f.prototype._getContexts=function(s,l){if(!s){s=0;}if(!l){l=Math.min(this.iLength,this.oModel.iSizeLimit);}var E=Math.min(s+l,this.aIndices.length),o,g=[],p=this.getResolvedPath();if(p&&!p.endsWith("/")){p+="/";}for(var i=s;i<E;i++){o=this.oModel.getContext(p+this.aIndices[i]);g.push(o);}return g;};f.prototype._updateLastStartAndLength=function(s,l,m,k){if(k){this._checkKeepCurrentSupported(m);}else{this.iLastStartIndex=s;this.iLastLength=l;}};f.prototype.getContexts=function(s,l,m,k){var g,h,j=this.iLastStartIndex+this.iLastLength;s=s||0;l=l||Math.min(this.iLength,this.oModel.iSizeLimit);this._updateLastStartAndLength(s,l,m,k);h=this._getContexts(s,l);if(this.bUseExtendedChangeDetection){g=[];try{for(var i=0;i<h.length;i++){g.push(this.getContextData(h[i]));}if(this.aLastContextData&&s<j){h.diff=this.diffData(this.aLastContextData,g);}this.aLastContextData=g;this.aLastContexts=h.slice(0);}catch(E){this.aLastContextData=undefined;this.aLastContexts=undefined;this.bUseExtendedChangeDetection=false;L.warning("Disabled extended change detection for binding path '"+this.getResolvedPath()+"'; context data could not be serialized",E,this.getMetadata().getName());}}return h;};f.prototype.getCurrentContexts=function(){if(this.bUseExtendedChangeDetection){return this.aLastContexts||[];}else{return this.getContexts(this.iLastStartIndex,this.iLastLength);}};f.prototype.getAllCurrentContexts=function(){return this._getContexts(0,Infinity);};f.prototype.setContext=function(o){if(this.oContext!=o){this.oContext=o;if(this.isRelative()){this.update();this._fireChange({reason:C.Context});}}};f.prototype.getLength=function(){return this.iLength;};f.prototype._getLength=function(){return this.aIndices.length;};f.prototype.updateIndices=function(){this.aIndices=[];for(var i=0;i<this.oList.length;i++){this.aIndices.push(i);}};f.prototype.sort=function(s){if(this.bSuspended){this.checkUpdate(true);}if(!s){this.aSorters=null;this.updateIndices();this.applyFilter();}else{if(s instanceof S){s=[s];}this.aSorters=s;this.applySort();}this.bIgnoreSuspend=true;this._fireChange({reason:C.Sort});this._fireSort({sorter:s});this.bIgnoreSuspend=false;return this;};f.prototype.applySort=function(){var t=this;if(!this.aSorters||this.aSorters.length==0){return;}this.aIndices=d.apply(this.aIndices,this.aSorters,function(r,p){return t.oModel.getProperty(p,t.oList[r]);});};f.prototype.filter=function(g,s){this.oModel.checkFilterOperation(g);if(this.bSuspended){this.checkUpdate(true);}this.updateIndices();if(g instanceof F){g=[g];}if(s==a.Application){this.aApplicationFilters=g||[];}else if(s==a.Control){this.aFilters=g||[];}else{this.aFilters=g||[];this.aApplicationFilters=[];}this.oCombinedFilter=c.combineFilters(this.aFilters,this.aApplicationFilters);if(this.aFilters.length===0&&this.aApplicationFilters.length===0){this.iLength=this._getLength();}else{this.applyFilter();}this.applySort();this.bIgnoreSuspend=true;this._fireChange({reason:C.Filter});if(s==a.Application){this._fireFilter({filters:this.aApplicationFilters});}else{this._fireFilter({filters:this.aFilters});}this.bIgnoreSuspend=false;return this;};f.prototype.applyFilter=function(){var t=this;this.aIndices=c.apply(this.aIndices,this.oCombinedFilter,function(r,p){return t.oModel.getProperty(p,t.oList[r]);},this.mNormalizeCache);this.iLength=this.aIndices.length;};f.prototype.getDistinctValues=function(p){var r=[],m={},v,t=this;e(this.oList,function(i,o){v=t.oModel.getProperty(p,o);if(!m[v]){m[v]=true;r.push(v);}});return r;};return f;});
