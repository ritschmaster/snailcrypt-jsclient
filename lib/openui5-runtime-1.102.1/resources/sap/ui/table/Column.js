/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./ColumnMenu","./utils/TableUtils","./library","sap/ui/core/Element","sap/ui/core/Popup","sap/ui/core/library","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/FilterType","sap/ui/model/Sorter","sap/ui/model/Type","sap/ui/model/type/String","sap/base/util/ObjectPath","sap/base/util/JSTokenizer","sap/base/Log"],function(C,T,a,E,P,c,F,b,d,S,f,g,O,J,L){"use strict";var H=c.HorizontalAlign,h=a.SortOrder,V=c.ValueState;var j={Standard:"Standard",Creation:"Creation"};var _=T.createWeakMapFacade();var k=new window.WeakMap();var m=E.extend("sap.ui.table.Column",{metadata:{library:"sap.ui.table",properties:{width:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:null},minWidth:{type:"int",group:"Dimension",defaultValue:0},flexible:{type:"boolean",group:"Behavior",defaultValue:true,deprecated:true},resizable:{type:"boolean",group:"Behavior",defaultValue:true},hAlign:{type:"sap.ui.core.HorizontalAlign",group:"Appearance",defaultValue:H.Begin},sorted:{type:"boolean",group:"Appearance",defaultValue:false},sortOrder:{type:"sap.ui.table.SortOrder",group:"Appearance",defaultValue:h.Ascending},sortProperty:{type:"string",group:"Behavior",defaultValue:null},filtered:{type:"boolean",group:"Appearance",defaultValue:false},filterProperty:{type:"string",group:"Behavior",defaultValue:null},filterValue:{type:"string",group:"Behavior",defaultValue:null},filterOperator:{type:"string",group:"Behavior",defaultValue:null},defaultFilterOperator:{type:"string",group:"Behavior",defaultValue:null},filterType:{type:"any",group:"Misc",defaultValue:null},grouped:{type:"boolean",group:"Appearance",defaultValue:false},visible:{type:"boolean",group:"Appearance",defaultValue:true},name:{type:"string",group:"Appearance",defaultValue:null},showFilterMenuEntry:{type:"boolean",group:"Appearance",defaultValue:true},showSortMenuEntry:{type:"boolean",group:"Appearance",defaultValue:true},headerSpan:{type:"any",group:"Behavior",defaultValue:1},autoResizable:{type:"boolean",group:"Behavior",defaultValue:false}},defaultAggregation:"label",aggregations:{label:{type:"sap.ui.core.Control",altTypes:["string"],multiple:false},multiLabels:{type:"sap.ui.core.Control",multiple:true,singularName:"multiLabel"},template:{type:"sap.ui.core.Control",altTypes:["string"],multiple:false},creationTemplate:{type:"sap.ui.core.Control",multiple:false,visibility:"hidden"},menu:{type:"sap.ui.unified.Menu",multiple:false}},associations:{columnHeaderMenu:{type:"sap.ui.core.IColumnHeaderMenu",multiple:false,visibility:"hidden"}},events:{columnMenuOpen:{allowPreventDefault:true,parameters:{menu:{type:"sap.ui.unified.Menu"}}}}}});m._DEFAULT_FILTER_TYPE=new g();m.prototype.init=function(){this.mSkipPropagation={template:true,creationTemplate:true};_(this).oSorter=null;_(this).mCellContentVisibilitySettings=p(this);_(this).bHasDefaultLabel=false;_(this).bHasDefaultTemplate=false;this._initTemplateClonePool();};m.prototype._initTemplateClonePool=function(){this._mTemplateClones=Object.keys(j).reduce(function(t,s){t[s]=[];return t;},{});};m.prototype.exit=function(){this._destroyTemplateClones();};m.prototype.setParent=function(){var r=E.prototype.setParent.apply(this,arguments);var M=this.getAggregation("menu");if(M&&typeof M._updateReferences==="function"){M._updateReferences(this);}return r;};m.prototype.invalidate=function(e){if(e!==this.getTemplate()&&e!==this.getCreationTemplate()&&!T.isA(e,"sap.ui.table.ColumnMenu")){E.prototype.invalidate.apply(this,arguments);}};m.prototype.setLabel=function(l){var e=l;if(typeof l==="string"){if(_(this).bHasDefaultLabel){this.getLabel().setText(l);return this;}e=a.TableHelper.createLabel({text:l});_(this).bHasDefaultLabel=true;}else if(_(this).bHasDefaultLabel){this.destroyLabel();_(this).bHasDefaultLabel=false;}return this.setAggregation("label",e);};m.prototype.setTemplate=function(t){var e=t;var i=this._getTable();var l=this.getTemplate();var N=true;if(typeof t==="string"){if(_(this).bHasDefaulTemplate){this.getTemplate().bindProperty("text",t);N=false;}else{e=a.TableHelper.createTextView().bindProperty("text",t);_(this).bHasDefaulTemplate=true;}}else if(_(this).bHasDefaulTemplate){this.destroyTemplate();_(this).bHasDefaulTemplate=false;}if(N){this.setAggregation("template",e,true);}if(this.getVisible()){this.invalidate();}this._destroyTemplateClones("Standard");if(i&&this.getVisible()){if(e){i.invalidateRowsAggregation();}if(!l||!e){var r=i.getCreationRow();if(r){r._update();}}}return this;};m.prototype.destroyTemplate=function(){this.destroyAggregation("template");this._destroyTemplateClones("Standard");var t=this._getTable();var e=t?t.getCreationRow():null;if(e){e._update();}return this;};m.prototype.setCreationTemplate=function(e){var t=this._getTable();this.setAggregation("creationTemplate",e,true);this._destroyTemplateClones("Creation");if(e&&t&&this.getVisible()){var i=t.getCreationRow();if(i){i._update();}}return this;};m.prototype.getCreationTemplate=function(){return this.getAggregation("creationTemplate");};m.prototype.destroyCreationTemplate=function(){this.destroyAggregation("creationTemplate",true);this._destroyTemplateClones("Creation");return this;};m.prototype.getMenu=function(){var M=this.getAggregation("menu");if(!M){M=this._createMenu();this.setMenu(M);}return M;};m.prototype._invalidateMenu=function(){var M=this.getAggregation("menu");if(M&&this._bMenuIsColumnMenu){M._invalidate();}};m.prototype._menuHasItems=function(){var M=this.getAggregation("menu");var t=this._getTable();var e=(M?M.getItems().length>0:false)||(t?t.getEnableColumnFreeze():false)||(t?t.getShowColumnVisibilityMenu():false)||this.isSortableByMenu()||this.isFilterableByMenu()||this.isGroupableByMenu();if(e){return true;}return T.Hook.call(t,T.Hook.Keys.Column.MenuItemNotification,this).some(function(i){return i;});};m.prototype.isFilterableByMenu=function(){return!!(this.getFilterProperty()&&this.getShowFilterMenuEntry());};m.prototype.isSortableByMenu=function(){return!!(this.getSortProperty()&&this.getShowSortMenuEntry());};m.prototype.isGroupableByMenu=function(){var t=this.getParent();return!!(t&&t.getEnableGrouping&&t.getEnableGrouping()&&this.getSortProperty());};m.prototype.setMenu=function(M){this.setAggregation("menu",M,true);this._bMenuIsColumnMenu=T.isA(M,"sap.ui.table.ColumnMenu");return this;};m.prototype._createMenu=function(){if(!this._defaultMenu){this._defaultMenu=new C(this.getId()+"-menu",{ariaLabelledBy:this});}return this._defaultMenu;};m.prototype.setSortProperty=function(s){this.setProperty("sortProperty",s);this._invalidateMenu();return this;};m.prototype.setShowSortMenuEntry=function(s){if(this.getShowSortMenuEntry()!=s){this._invalidateMenu();}return this.setProperty("showSortMenuEntry",s);};m.prototype.setSorted=function(e){this.setProperty("sorted",e,true);this._updateIcons();return this;};m.prototype.setSortOrder=function(t){this.setProperty("sortOrder",t,true);this._updateIcons();return this;};m.prototype.setFilterProperty=function(s){this._invalidateMenu();return this.setProperty("filterProperty",s);};m.prototype.setShowFilterMenuEntry=function(s){if(this.getShowFilterMenuEntry()!=s){this._invalidateMenu();}return this.setProperty("showFilterMenuEntry",s);};m.prototype.setFiltered=function(e){this.setProperty("filtered",e,true);this._updateIcons();return this;};m.prototype.setFilterValue=function(s){this.setProperty("filterValue",s,true);var M=this.getMenu();if(this._bMenuIsColumnMenu){M._setFilterValue(s);}return this;};m.prototype.setFilterOperator=function(s){return this.setProperty("filterOperator",s,true);};m.prototype._openMenu=function(D){var M=this.getMenu();if(!this._menuHasItems()){return false;}var e=this.fireColumnMenuOpen({menu:M});if(e){var i=P.Dock;var l=D;if(!D){D=this.getDomRef();l=this.getFocusDomRef();}M.open(null,l,i.BeginTop,i.BeginBottom,D);return true;}else{return true;}};m.prototype.toggleSort=function(){this.sort(this.getSorted()&&this.getSortOrder()===h.Ascending);};m.prototype.sort=function(D,A){var t=this.getParent();if(t){t.pushSortedColumn(this,A);var N=D?h.Descending:h.Ascending;var e=t.fireSort({column:this,sortOrder:N,columnAdded:A});if(e){var s=t.getSortedColumns();var r=t.getColumns();for(var i=0,l=r.length;i<l;i++){if(s.indexOf(r[i])<0){r[i].setProperty("sorted",false,true);r[i].setProperty("sortOrder",h.Ascending,true);r[i]._updateIcons(true);delete _(r[i]).oSorter;}}this.setProperty("sorted",true,true);this.setProperty("sortOrder",N,true);_(this).oSorter=new S(this.getSortProperty(),this.getSortOrder()===h.Descending);var u=[];for(var i=0,l=s.length;i<l;i++){s[i]._updateIcons(true);u.push(_(s[i]).oSorter);}t._resetColumnHeaderHeights();t._updateRowHeights(t._collectRowHeights(true),true);var B=t.getBinding();if(B){if(this._updateTableAnalyticalInfo){this._updateTableAnalyticalInfo(true);}B.sort(u);}else{L.warning("Sorting not performed because no binding present",this);}}}return this;};m.prototype._updateIcons=function(s){var t=this.getParent(),e=this.getSorted(),i=this.getFiltered();if(!t||!t.getDomRef()){return;}this.$().parents(".sapUiTableCHT").find('td[data-sap-ui-colindex="'+this.getIndex()+'"]:not([colspan]):not(.sapUiTableHidden):first').toggleClass("sapUiTableColFiltered",i).toggleClass("sapUiTableColSorted",e).toggleClass("sapUiTableColSortedD",e&&this.getSortOrder()===h.Descending);t._getAccExtension().updateAriaStateOfColumn(this);if(!s){t._resetColumnHeaderHeights();t._updateRowHeights(t._collectRowHeights(true),true);}};m.prototype._renderSortIcon=function(){this._updateIcons();};m.prototype._getFilter=function(){var e,s=this.getFilterProperty(),i=this.getFilterValue(),l=this.getFilterOperator(),r,t,u=this.getFilterType()||m._DEFAULT_FILTER_TYPE,I=u instanceof g,B;if(i){if(!l){B=i.match(/(.*)\s*\.\.\s*(.*)/);if(i.indexOf("=")==0){l=b.EQ;r=i.substr(1);}else if(i.indexOf("!=")==0){l=b.NE;r=i.substr(2);}else if(i.indexOf("<=")==0){l=b.LE;r=i.substr(2);}else if(i.indexOf("<")==0){l=b.LT;r=i.substr(1);}else if(i.indexOf(">=")==0){l=b.GE;r=i.substr(2);}else if(i.indexOf(">")==0){l=b.GT;r=i.substr(1);}else if(B){if(B[1]&&B[2]){l=b.BT;r=B[1];t=B[2];}else if(B[1]&&!B[2]){l=b.GE;r=B[1];}else{l=b.LE;r=B[2];}}else if(I&&i.indexOf("*")==0&&i.lastIndexOf("*")==i.length-1){l=b.Contains;r=i.substr(1,i.length-2);}else if(I&&i.indexOf("*")==0){l=b.EndsWith;r=i.substr(1);}else if(I&&i.lastIndexOf("*")==i.length-1){l=b.StartsWith;r=i.substr(0,i.length-1);}else{if(this.getDefaultFilterOperator()){l=this.getDefaultFilterOperator();}else{if(I){l=b.Contains;}else{l=b.EQ;}}r=i.substr(0);}if(!t){e=new F(s,l,this._parseFilterValue(r));}else{e=new F(s,l,this._parseFilterValue(r),this._parseFilterValue(t));}}else{e=new F(s,l,this._parseFilterValue(i));}}return e;};m.prototype.filter=function(s){var t=this.getParent();if(t&&t.isBound("rows")){var r=t.fireFilter({column:this,value:s});if(r){this.setProperty("filtered",!!s,true);this.setProperty("filterValue",s,true);var M=this.getMenu();if(this._bMenuIsColumnMenu){M._setFilterValue(s);}var u=[];var w=t.getColumns();for(var i=0,l=w.length;i<l;i++){var x=w[i],y;M=x.getMenu();try{y=x._getFilter();if(x._bMenuIsColumnMenu){M._setFilterState(V.None);}}catch(e){if(x._bMenuIsColumnMenu){M._setFilterState(V.Error);}continue;}if(y){u.push(y);}}t.getBinding().filter(u,d.Control);this._updateIcons();}}return this;};m.prototype._parseFilterValue=function(s){var e=this.getFilterType();if(e){if(typeof e==="function"){s=e(s);}else{s=e.parseValue(s,"string");}}return s;};m.prototype.shouldRender=function(){return this.getVisible()&&!this.getGrouped()&&this.getTemplate()!=null;};m.prototype.setProperty=function(N,e){var t=this._getTable();var i=t&&this.getProperty(N)!=e;var l=i&&N==="visible";var I=i&&(N==="visible"||N==="headerSpan");var r=E.prototype.setProperty.apply(this,arguments);if(l){t.invalidateRowsAggregation();var s=t.getCreationRow();if(s){s._update();}}if(I){t._invalidateComputedFixedColumnCount();}return r;};m.prototype.setFilterType=function(t){var e=t;if(typeof(t)==="string"){try{var i=J.parseJS(t);if(typeof(i.type)==="string"){var l=O.get(i.type);e=l&&new l(i.formatOptions,i.constraints);}}catch(r){var l=O.get(t);e=l&&new l();}if(!(e instanceof f)){L.error("The filter type is not an instance of sap.ui.model.Type! Ignoring the filter type!");e=undefined;}}this.setProperty("filterType",e,true);return this;};m.prototype.getIndex=function(){var t=this.getParent();if(t){return t.indexOfColumn(this);}else{return-1;}};m.prototype._getFreeTemplateClone=function(t){var e=this._mTemplateClones[t];var l=null;if(!e){return null;}for(var i=0;i<e.length;i++){if(!e[i]||e[i].bIsDestroyed){e.splice(i,1);i--;}else if(!l&&!e[i].getParent()){l=e[i];}}return l;};m.prototype.getTemplateClone=function(i,s){if(typeof i!=="number"||this.getTemplate()==null){return null;}var t=s==null?"Standard":s;var e=this._getFreeTemplateClone(t);if(!e&&j.hasOwnProperty(t)){var G=this["get"+(t==="Standard"?"":t)+"Template"];var l=G.call(this);if(l){e=l.clone();this._mTemplateClones[t].push(e);}}if(e){k.set(e,this);var r=this.getParent();if(r){r._getAccExtension().addColumnHeaderLabel(this,e);}}return e;};function n(e){for(var i=0;i<e.length;i++){if(e[i]!=null&&!e[i].bIsDestroyed){e[i].destroy();}}}m.prototype._destroyTemplateClones=function(t){if(t==null){for(var s in j){n(this._mTemplateClones[s]);}this._initTemplateClonePool();}else{n(this._mTemplateClones[t]);this._mTemplateClones[t]=[];}};m.prototype._closeMenu=function(){var M=this.getAggregation("menu");if(M){M.close();}};m.prototype._getTable=function(){var e=this.getParent();return T.isA(e,"sap.ui.table.Table")?e:null;};m.prototype._setCellContentVisibilitySettings=function(s){v(s);_(this).mCellContentVisibilitySettings=p(this,s);};m.prototype._getCellContentVisibilitySettings=function(){return _(this).mCellContentVisibilitySettings;};m.prototype.getColumnHeaderMenu=function(){return sap.ui.getCore().byId(this.getAssociation("columnHeaderMenu"));};function v(s){if(s==null){return;}o(s,null,false,["standard","groupHeader","summary"]);o(s.standard,"standard",true);o(s.groupHeader,"groupHeader",true,["nonExpandable","expanded","collapsed"]);o(s.summary,"summary",true,["group","total"]);}function o(e,s,A,i){if(e!=null&&!(A&&typeof e==="boolean"||i&&typeof e==="object")){throw new Error("Invalid value"+(s?" for '"+s+"'":""));}if(i&&e!=null&&typeof e==="object"){Object.keys(e).forEach(function(l){if(i.includes(l)){if(s!=null){o(e[l],s+"."+l,true);}}else{throw new Error("Unsupported setting '"+(s?s+".":"")+l+"'");}});}}function p(e,s){s=s?s:{};return{standard:q(s.standard),groupHeader:{nonExpandable:q(s.groupHeader,"nonExpandable"),expanded:q(s.groupHeader,"expanded"),collapsed:q(s.groupHeader,"collapsed")},summary:{group:q(s.summary,"group"),total:q(s.summary,"total")}};}function q(s,K){if(typeof s==="boolean"){return s;}else if(K&&s){return s[K]!==false;}else{return true;}}m.ofCell=function(e){return k.get(e)||null;};return m;});
