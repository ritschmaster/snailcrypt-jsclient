/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['./AnalyticalColumn','./Column','./Table','./TreeTable',"./TableRenderer",'./library','sap/ui/model/analytics/ODataModelAdapter','sap/ui/model/Sorter','sap/ui/unified/MenuItem','./utils/TableUtils',"./plugins/BindingSelection","sap/base/Log","sap/base/assert","sap/ui/thirdparty/jquery"],function(A,C,T,a,b,c,O,S,M,d,B,L,e,q){"use strict";var G=c.GroupEventType;var f=c.SortOrder;var g=c.TreeAutoExpandMode;var _=d.createWeakMapFacade();var h=T.extend("sap.ui.table.AnalyticalTable",{metadata:{library:"sap.ui.table",properties:{sumOnTop:{type:"boolean",group:"Appearance",defaultValue:false,deprecated:true},numberOfExpandedLevels:{type:"int",group:"Misc",defaultValue:0,deprecated:true},autoExpandMode:{type:"string",group:"Misc",defaultValue:"Bundled",deprecated:true},columnVisibilityMenuSorter:{type:"any",group:"Appearance",defaultValue:null},collapseRecursive:{type:"boolean",defaultValue:true,deprecated:true},dirty:{type:"boolean",group:"Appearance",defaultValue:null,deprecated:true}},designtime:"sap/ui/table/designtime/AnalyticalTable.designtime"},renderer:b});h.prototype._getFixedBottomRowContexts=function(){var o=this.getBinding();return o?[o.getGrandTotalNode()]:[];};h.prototype._getContexts=a.prototype._getContexts;h.prototype._getRowContexts=a.prototype._getRowContexts;h.prototype.init=function(){T.prototype.init.apply(this,arguments);this.addStyleClass("sapUiAnalyticalTable");this.setShowColumnVisibilityMenu(true);this.setEnableColumnFreeze(true);this.setEnableCellFilter(true);this.setProperty("rowCountConstraints",{fixedTop:false,fixedBottom:false});this._aGroupedColumns=[];this._bSuspendUpdateAnalyticalInfo=false;this._mGroupHeaderMenuItems=null;d.Grouping.setToDefaultGroupMode(this);d.Hook.register(this,d.Hook.Keys.Row.UpdateState,u,this);d.Hook.register(this,d.Hook.Keys.Table.OpenMenu,n,this);d.Hook.register(this,d.Hook.Keys.Row.Expand,k,this);d.Hook.register(this,d.Hook.Keys.Row.Collapse,m,this);};h.prototype.exit=function(){T.prototype.exit.apply(this,arguments);this._cleanupGroupHeaderMenuItems();};h.prototype._adaptLocalization=function(r,l){return T.prototype._adaptLocalization.apply(this,arguments).then(function(){if(l){this._cleanupGroupHeaderMenuItems();}}.bind(this));};h.prototype.setFixedRowCount=function(){L.error("The property fixedRowCount is not supported by control sap.ui.table.AnalyticalTable!");return this;};h.prototype.setFixedBottomRowCount=function(){L.error("The property fixedBottomRowCount is managed by control sap.ui.table.AnalyticalTable!");return this;};h.prototype.setDirty=function(D){L.error("The property dirty of control sap.ui.table.AnalyticalTable is deprecated. Please use showOverlay instead.");this.setProperty("dirty",D,true);this.setShowOverlay(this.getDirty());return this;};h.prototype.setEnableGrouping=function(){L.error("The property enableGrouping is not supported by the sap.ui.table.AnalyticalTable control");return this;};h.prototype.setGroupBy=function(){L.warning("The groupBy association is not supported by the sap.ui.table.AnalyticalTable control");return this;};h.prototype.getModel=function(N){var o=T.prototype.getModel.apply(this,arguments);var r=this.getBindingInfo("rows");if(o&&r&&r.model==N){O.apply(o);}return o;};h.prototype.updateRows=function(r){T.prototype.updateRows.apply(this,arguments);if(r!=="sort"){this._invalidateColumnMenus();}};h.prototype._bindRows=function(o){delete _(this).bPendingRequest;this._applyAnalyticalBindingInfo(o);T.prototype._bindRows.call(this,o);};h.prototype._bindAggregation=function(N,o){if(N==="rows"){this._invalidateColumnMenus();this._applyODataModelAnalyticalAdapter(o.model);this._setFirstVisibleRowIndex(0,{onlySetProperty:true});}T.prototype._bindAggregation.call(this,N,o);if(N==="rows"){this._updateTotalRow(true);d.Binding.metadataLoaded(this).then(function(){this._updateColumns(true);}.bind(this));}};h.prototype._applyAnalyticalBindingInfo=function(o){var j=this.getColumns();for(var i=0,l=j.length;i<l;i++){if(j[i].getSorted()){o.sorter=o.sorter||[];o.sorter.push(new S(j[i].getSortProperty()||j[i].getLeadingProperty(),j[i].getSortOrder()===f.Descending));}}o.parameters=o.parameters||{};o.parameters.analyticalInfo=this._getColumnInformation();if(!o.parameters.hasOwnProperty("sumOnTop")){o.parameters.sumOnTop=this.getSumOnTop();}if(!o.parameters.hasOwnProperty("numberOfExpandedLevels")){o.parameters.numberOfExpandedLevels=this.getNumberOfExpandedLevels();}if(o.parameters.numberOfExpandedLevels>this._aGroupedColumns.length){o.parameters.numberOfExpandedLevels=0;}if(!o.parameters.hasOwnProperty("autoExpandMode")){var E=this.getAutoExpandMode();if(E!=g.Bundled&&E!=g.Sequential){E=g.Bundled;}o.parameters.autoExpandMode=E;}};h.prototype._applyODataModelAnalyticalAdapter=function(o){if(o){O.apply(o);}};h.prototype._getColumnInformation=function(){var j=[],t=this.getColumns();for(var i=0;i<this._aGroupedColumns.length;i++){var o=sap.ui.getCore().byId(this._aGroupedColumns[i]);if(!o){continue;}j.push({name:o.getLeadingProperty(),visible:o.getVisible(),grouped:o.getGrouped(),total:o.getSummed(),sorted:o.getSorted(),sortOrder:o.getSortOrder(),inResult:o.getInResult(),formatter:o.getGroupHeaderFormatter()});}for(var i=0;i<t.length;i++){var o=t[i];if(this._aGroupedColumns.indexOf(o.getId())>-1){continue;}if(!(o instanceof A)){L.error("You have to use AnalyticalColumns for the Analytical table");}j.push({name:o.getLeadingProperty(),visible:o.getVisible(),grouped:o.getGrouped(),total:o.getSummed(),sorted:o.getSorted(),sortOrder:o.getSortOrder(),inResult:o.getInResult(),formatter:o.getGroupHeaderFormatter()});}return j;};function u(s){var o=this.getBinding();var i=this.getBindingInfo("rows");var N=s.context;s.context=N.context;if(!s.context){return;}if(o.nodeHasChildren(N)){s.type=s.Type.GroupHeader;s.expandable=true;}else if(N.nodeState.sum){s.type=s.Type.Summary;}s.level=N.level+(s.type===s.Type.Summary?1:0);s.expanded=N.nodeState.expanded;s.contentHidden=s.expanded&&!i.parameters.sumOnTop;s.title=s.type===s.Type.GroupHeader?o.getGroupName(N.context,N.level):"";}function k(r){this.expand(r.getIndex());}function m(r){this.collapse(r.getIndex());}h.prototype.onRowsUpdated=function(p){T.prototype.onRowsUpdated.apply(this,arguments);var r=this.getRows();var o=this.getBinding();var F=this._getVisibleColumns()[0];for(var R=0;R<r.length;R++){var i=r[R];var j=i.getCells();var l=j.length;for(var s=0;s<l;s++){var t=C.ofCell(j[s]);var I=o?o.isMeasure(t.getLeadingProperty()):false;var $=q(j[s].$().closest("td"));var H=false;if(i.isSummary()&&I){H=!t.getSummed();}else if(i.isGroupHeader()&&t===F){H=!I;}$.toggleClass("sapUiTableCellHidden",H);}}};function n(o,i){var r=o.isOfType(d.CELLTYPE.ANYCONTENTCELL)?this.getRows()[o.rowIndex]:null;if(!r||!r.isGroupHeader()){this._removeGroupHeaderMenuItems(i);return;}this._iGroupedLevel=r.getLevel();this._addGroupHeaderMenuItems(i);}h.prototype._addGroupHeaderMenuItems=function(o){var t=this;function j(){var i=t._iGroupedLevel-1;if(t._aGroupedColumns[i]){var r=t.getColumns().filter(function(p){return t._aGroupedColumns[i]===p.getId();})[0];return{column:r,index:i};}else{return undefined;}}if(!this._mGroupHeaderMenuItems){this._mGroupHeaderMenuItems={};}if(!this._mGroupHeaderMenuItems["visibility"]){this._mGroupHeaderMenuItems["visibility"]=new M({text:d.getResourceText("TBL_SHOW_COLUMN"),select:function(){var l=j();if(l){var p=l.column,s=p.getShowIfGrouped();p.setShowIfGrouped(!s);t.fireGroup({column:p,groupedColumns:p.getParent()._aGroupedColumns,type:(!s?G.showGroupedColumn:G.hideGroupedColumn)});}}});}o.addItem(this._mGroupHeaderMenuItems["visibility"]);if(!this._mGroupHeaderMenuItems["ungroup"]){this._mGroupHeaderMenuItems["ungroup"]=new M({text:d.getResourceText("TBL_UNGROUP"),select:function(){var l=j();if(l&&l.column){var U=l.column;U.setGrouped(false);t.fireGroup({column:U,groupedColumns:t._aGroupedColumns,type:G.ungroup});}}});}o.addItem(this._mGroupHeaderMenuItems["ungroup"]);if(!this._mGroupHeaderMenuItems["ungroupall"]){this._mGroupHeaderMenuItems["ungroupall"]=new M({text:d.getResourceText("TBL_UNGROUP_ALL"),select:function(){var r=t.getColumns();t.suspendUpdateAnalyticalInfo();for(var i=0;i<r.length;i++){r[i].setGrouped(false);}t.resumeUpdateAnalyticalInfo();t.fireGroup({column:undefined,groupedColumns:[],type:G.ungroupAll});}});}o.addItem(this._mGroupHeaderMenuItems["ungroupall"]);if(!this._mGroupHeaderMenuItems["moveup"]){this._mGroupHeaderMenuItems["moveup"]=new M({text:d.getResourceText("TBL_MOVE_UP"),select:function(){var l=j();if(l){var p=l.column;var i=t._aGroupedColumns.indexOf(p.getId());if(i>0){t._aGroupedColumns[i]=t._aGroupedColumns.splice(i-1,1,t._aGroupedColumns[i])[0];t.updateAnalyticalInfo();t.fireGroup({column:p,groupedColumns:p.getParent()._aGroupedColumns,type:G.moveUp});}}},icon:"sap-icon://arrow-top"});}o.addItem(this._mGroupHeaderMenuItems["moveup"]);if(!this._mGroupHeaderMenuItems["movedown"]){this._mGroupHeaderMenuItems["movedown"]=new M({text:d.getResourceText("TBL_MOVE_DOWN"),select:function(){var l=j();if(l){var p=l.column;var i=t._aGroupedColumns.indexOf(p.getId());if(i<t._aGroupedColumns.length){t._aGroupedColumns[i]=t._aGroupedColumns.splice(i+1,1,t._aGroupedColumns[i])[0];t.updateAnalyticalInfo();t.fireGroup({column:p,groupedColumns:p.getParent()._aGroupedColumns,type:G.moveDown});}}},icon:"sap-icon://arrow-bottom"});}o.addItem(this._mGroupHeaderMenuItems["movedown"]);if(!this._mGroupHeaderMenuItems["sortasc"]){this._mGroupHeaderMenuItems["sortasc"]=new M({text:d.getResourceText("TBL_SORT_ASC"),select:function(){var l=j();if(l){var p=l.column;p.sort(false);}},icon:"sap-icon://up"});}o.addItem(this._mGroupHeaderMenuItems["sortasc"]);if(!this._mGroupHeaderMenuItems["sortdesc"]){this._mGroupHeaderMenuItems["sortdesc"]=new M({text:d.getResourceText("TBL_SORT_DESC"),select:function(){var l=j();if(l){var p=l.column;p.sort(true);}},icon:"sap-icon://down"});}o.addItem(this._mGroupHeaderMenuItems["sortdesc"]);if(!this._mGroupHeaderMenuItems["collapse"]){this._mGroupHeaderMenuItems["collapse"]=new M({text:d.getResourceText("TBL_COLLAPSE_LEVEL"),select:function(){t.getBinding().collapseToLevel(t._iGroupedLevel-1);t.setFirstVisibleRow(0);t._getSelectionPlugin().clearSelection();}});}o.addItem(this._mGroupHeaderMenuItems["collapse"]);if(!this._mGroupHeaderMenuItems["collapseall"]){this._mGroupHeaderMenuItems["collapseall"]=new M({text:d.getResourceText("TBL_COLLAPSE_ALL"),select:function(){t.getBinding().collapseToLevel(0);t.setFirstVisibleRow(0);t._getSelectionPlugin().clearSelection();}});}o.addItem(this._mGroupHeaderMenuItems["collapseall"]);if(!this._mGroupHeaderMenuItems["expand"]){this._mGroupHeaderMenuItems["expand"]=new M({text:d.getResourceText("TBL_EXPAND_LEVEL"),select:function(){t.getBinding().expandToLevel(t._iGroupedLevel);t.setFirstVisibleRow(0);t._getSelectionPlugin().clearSelection();}});}o.addItem(this._mGroupHeaderMenuItems["expand"]);if(!this._mGroupHeaderMenuItems["expandall"]){this._mGroupHeaderMenuItems["expandall"]=new M({text:d.getResourceText("TBL_EXPAND_ALL"),select:function(){t.expandAll();}});}o.addItem(this._mGroupHeaderMenuItems["expandall"]);var l=j();if(l){var p=l.column;if(p.getShowIfGrouped()){this._mGroupHeaderMenuItems["visibility"].setText(d.getResourceText("TBL_HIDE_COLUMN"));}else{this._mGroupHeaderMenuItems["visibility"].setText(d.getResourceText("TBL_SHOW_COLUMN"));}this._mGroupHeaderMenuItems["moveup"].setEnabled(l.index>0);this._mGroupHeaderMenuItems["movedown"].setEnabled(l.index<this._aGroupedColumns.length-1);}else{this._mGroupHeaderMenuItems["moveup"].setEnabled(true);this._mGroupHeaderMenuItems["movedown"].setEnabled(true);}};h.prototype._removeGroupHeaderMenuItems=function(o){if(!this._mGroupHeaderMenuItems){return;}for(var i in this._mGroupHeaderMenuItems){o.removeItem(this._mGroupHeaderMenuItems[i]);}};h.prototype._cleanupGroupHeaderMenuItems=function(){for(var i in this._mGroupHeaderMenuItems){this._mGroupHeaderMenuItems[i].destroy();}this._mGroupHeaderMenuItems=null;};h.prototype.getContextByIndex=function(i){var o=this.getBinding();return i>=0&&o?o.getContextByIndex(i):null;};h.prototype.getContextInfoByIndex=function(i){var o=this.getBinding();return i>=0&&o?o.getNodeByIndex(i):null;};h.prototype.suspendUpdateAnalyticalInfo=function(){this._bSuspendUpdateAnalyticalInfo=true;};h.prototype.resumeUpdateAnalyticalInfo=function(s,F){this._bSuspendUpdateAnalyticalInfo=false;this._updateColumns(s,F);};h.prototype.addColumn=function(v,s){var o=this._getColumn(v);if(o.getGrouped()){this._addGroupedColumn(o.getId());}T.prototype.addColumn.call(this,o,s);this._updateColumns(s);return this;};h.prototype.insertColumn=function(v,i,s){var o=this._getColumn(v);if(o.getGrouped()){this._addGroupedColumn(o.getId());}T.prototype.insertColumn.call(this,o,i,s);this._updateColumns(s);return this;};h.prototype.removeColumn=function(v,s){var r=T.prototype.removeColumn.apply(this,arguments);if(!this._bReorderInProcess){this._aGroupedColumns=q.grep(this._aGroupedColumns,function(V){if(v.getId){return V!=v.getId();}else{return V==v;}});}this.updateAnalyticalInfo(s);return r;};h.prototype.removeAllColumns=function(s){this._aGroupedColumns=[];var r=T.prototype.removeAllColumns.apply(this,arguments);this._updateColumns(s);return r;};h.prototype._getColumn=function(v){if(typeof v==="string"){var o=new A({leadingProperty:v,template:v,managed:true});return o;}else if(v instanceof A){return v;}else{throw new Error("Wrong column type. You need to define a string (property) or pass an AnalyticalColumnObject");}};h.prototype._updateColumns=function(s,F){if(!this._bSuspendUpdateAnalyticalInfo){this._updateTableColumnDetails();this.updateAnalyticalInfo(s,F);if(this.bOutput){this.invalidate();}}};h.prototype.updateAnalyticalInfo=function(s,F){if(this._bSuspendUpdateAnalyticalInfo){return;}var o=this.getBinding();if(o){var i=this._getColumnInformation();var N=o.getNumberOfExpandedLevels()||0;if(N>this._aGroupedColumns.length){o.setNumberOfExpandedLevels(0);}o.updateAnalyticalInfo(i,F);this._updateTotalRow(s);if(!s){this._getRowContexts();}}};h.prototype.refreshRows=function(){T.prototype.refreshRows.apply(this,arguments);this._updateTotalRow();};h.prototype._updateTotalRow=function(s){var o=this.getBinding();this.setProperty("rowCountConstraints",{fixedTop:false,fixedBottom:o?o.providesGrandTotal()&&o.hasTotaledMeasures():false},s);};h.prototype._updateTableColumnDetails=function(){if(this._bSuspendUpdateAnalyticalInfo){return;}var l=this.getBinding(),r=l&&l.getAnalyticalQueryResult();if(r){var p=this.getColumns(),t=[],U=[],D=[],v={},w,x;for(var i=0;i<p.length;i++){w=p[i];w._isLastGroupableLeft=false;w._bLastGroupAndGrouped=false;w._bDependendGrouped=false;if(!w.getVisible()){continue;}var y=w.getLeadingProperty();x=r.findDimensionByPropertyName(y);if(x){var z=x.getName();if(!v[z]){v[z]={dimension:x,columns:[w]};}else{v[z].columns.push(w);}if(w.getGrouped()&&t.indexOf(z)==-1){t.push(z);}if(D.indexOf(z)==-1){D.push(z);}}}U=q.grep(D,function(s){return t.indexOf(t,s)==-1;});if(t.length>0){q.each(t,function(i,s){q.each(v[s].columns,function(j,o){if(!o.getGrouped()){o._bDependendGrouped=true;}});});if(t.length==D.length){x=r.findDimensionByPropertyName(sap.ui.getCore().byId(this._aGroupedColumns[this._aGroupedColumns.length-1]).getLeadingProperty());var E=v[x.getName()].columns;q.each(E,function(i,o){o._bLastGroupAndGrouped=true;});}}if(U.length==1){q.each(v[U[0]].columns,function(j,o){o._isLastGroupableLeft=true;});}}};h.prototype._getFirstMeasureColumnIndex=function(){var o=this.getBinding(),r=o&&o.getAnalyticalQueryResult(),j=this._getVisibleColumns();if(!r){return-1;}for(var i=0;i<j.length;i++){var l=j[i],s=l.getLeadingProperty();if(r.findMeasureByName(s)||r.findMeasureByPropertyName(s)){return i;}}};h.prototype.getTotalSize=function(){var o=this.getBinding();if(o){return o.getTotalSize();}return 0;};h.prototype._onPersoApplied=function(){T.prototype._onPersoApplied.apply(this,arguments);this._aGroupedColumns=[];var j=this.getColumns();for(var i=0,l=j.length;i<l;i++){if(j[i].getGrouped()){this._addGroupedColumn(j[i].getId());}}this._updateColumns();};h.prototype._addGroupedColumn=function(s){if(this._aGroupedColumns.indexOf(s)===-1){this._aGroupedColumns.push(s);}};h.prototype._removeGroupedColumn=function(s){var i=this._aGroupedColumns.indexOf(s);if(i>=0){this._aGroupedColumns.splice(i,1);}};h.prototype.getGroupedColumns=function(){return this._aGroupedColumns;};h.prototype.setCollapseRecursive=function(i){var o=this.getBinding();if(o){e(o.setCollapseRecursive,"Collapse Recursive is not supported by the used binding");if(o.setCollapseRecursive){o.setCollapseRecursive(i);}}this.setProperty("collapseRecursive",!!i,true);return this;};h.prototype.expand=a.prototype.expand;h.prototype.collapse=a.prototype.collapse;h.prototype.expandAll=function(){var o=this.getBinding();if(o){o.expandToLevel(this._aGroupedColumns.length);this.setFirstVisibleRow(0);this._getSelectionPlugin().clearSelection();}return this;};h.prototype.collapseAll=a.prototype.collapseAll;h.prototype.isExpanded=a.prototype.isExpanded;h.prototype.getAnalyticalInfoOfRow=function(r){var o=this.getBinding();var j=r?r.getRowBindingContext():null;if(!d.isA(r,"sap.ui.table.Row")||r.getParent()!==this||!o||!j){return null;}var I=j===o.getGrandTotalContext();var l=null;var p=-1;if(I){l=o.getGrandTotalContextInfo();p=0;}else{l=this.getContextInfoByIndex(r.getIndex());if(l){p=l.level;}}var s=l&&o.nodeHasChildren&&o.nodeHasChildren(l);var t=!s&&!I&&l&&l.nodeState&&l.nodeState.sum;var v=[];if(t||s){var w=this.getGroupedColumns();if(w.length>0&&p>0&&p<=w.length){for(var i=0;i<p;i++){v.push(w[i]);}}}return{grandTotal:I,group:s,groupTotal:t,level:p,context:j,groupedColumns:v};};h.prototype._createLegacySelectionPlugin=function(){return new B();};h.prototype._setRowCountConstraints=function(){};h.prototype._onBindingDataRequested=function(E){if(E.getParameter("__simulateAsyncAnalyticalBinding")){return;}var o=this.getBinding();if(!o.bUseBatchRequests){_(this).bPendingRequest=true;}T.prototype._onBindingDataRequested.apply(this,arguments);};h.prototype._onBindingDataReceived=function(E){if(E.getParameter("__simulateAsyncAnalyticalBinding")){return;}var o=this.getBinding();if(!o.bUseBatchRequests){_(this).bPendingRequest=false;}T.prototype._onBindingDataReceived.apply(this,arguments);};h.prototype._hasPendingRequests=function(){if(_(this).hasOwnProperty("bPendingRequest")){return _(this).bPendingRequest;}else{return T.prototype._hasPendingRequests.apply(this,arguments);}};return h;});
